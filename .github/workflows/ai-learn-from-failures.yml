name: ðŸ§  AI Team - Learn from Failures

# Automatically captures deployment failures and updates the AI knowledge base
# Part of the Never-Repeat-Mistakes system

on:
  workflow_run:
    workflows: ["ðŸš€ ChatterFix Production Deployment"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  learn-from-failure:
    name: ðŸ§  Capture & Learn
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install google-cloud-firestore requests

      - name: Fetch failure logs
        id: logs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the failed workflow run logs
          RUN_ID=${{ github.event.workflow_run.id }}

          echo "Fetching logs for run $RUN_ID..."

          # Get failed jobs
          FAILED_JOBS=$(gh run view $RUN_ID --json jobs --jq '.jobs[] | select(.conclusion == "failure") | .name')
          echo "failed_jobs<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_JOBS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get log snippet
          LOG_SNIPPET=$(gh run view $RUN_ID --log-failed 2>/dev/null | tail -50 || echo "Could not fetch logs")
          echo "log_snippet<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG_SNIPPET" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze and create learning record
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > analyze_failure.py << 'PYTHON'
          import json
          import os
          import requests
          from datetime import datetime

          failed_jobs = """${{ steps.logs.outputs.failed_jobs }}"""
          log_snippet = """${{ steps.logs.outputs.log_snippet }}"""
          run_id = "${{ github.event.workflow_run.id }}"
          sha = "${{ github.event.workflow_run.head_sha }}"

          # Create failure record
          failure_record = {
              "timestamp": datetime.utcnow().isoformat(),
              "workflow": "production-deployment",
              "run_id": run_id,
              "commit_sha": sha,
              "failed_jobs": failed_jobs,
              "log_snippet": log_snippet[:2000],  # Truncate for storage
              "status": "needs_analysis"
          }

          print("ðŸ“ Failure Record Created:")
          print(json.dumps(failure_record, indent=2))

          # Save for issue creation
          with open("failure_record.json", "w") as f:
              json.dump(failure_record, f)
          PYTHON

          python analyze_failure.py

      - name: Create learning issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FAILED_JOBS="${{ steps.logs.outputs.failed_jobs }}"
          RUN_ID=${{ github.event.workflow_run.id }}
          SHA=${{ github.event.workflow_run.head_sha }}

          gh issue create \
            --title "ðŸ§  AI Learning: Deployment Failure - $(date +%Y-%m-%d)" \
            --body "## ðŸš¨ Deployment Failure Detected

**Run ID:** $RUN_ID
**Commit:** $SHA
**Failed Jobs:**
\`\`\`
$FAILED_JOBS
\`\`\`

### Log Snippet
\`\`\`
${{ steps.logs.outputs.log_snippet }}
\`\`\`

---

### AI Team Action Items
- [ ] Analyze root cause
- [ ] Add to mistake patterns in CLAUDE.md
- [ ] Update \`ai-precommit-review.py\` if applicable
- [ ] Verify fix prevents recurrence

*ðŸ¤– Auto-generated by AI Learning System*" \
            --label "ai-learning,deployment-failure,automated"
