name: ðŸ§  AI Team - Learn from Failures

# Automatically captures deployment failures and updates the AI knowledge base
# Part of the Never-Repeat-Mistakes system

on:
  workflow_run:
    workflows: ["ðŸš€ ChatterFix Production Deployment"]
    types:
      - completed

permissions:
  contents: read
  issues: write

jobs:
  learn-from-failure:
    name: ðŸ§  Capture & Learn
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install google-cloud-firestore requests

      - name: Fetch failure logs
        id: logs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get the failed workflow run logs
          RUN_ID=${{ github.event.workflow_run.id }}

          echo "Fetching logs for run $RUN_ID..."

          # Get failed jobs
          FAILED_JOBS=$(gh run view $RUN_ID --json jobs --jq '.jobs[] | select(.conclusion == "failure") | .name')
          echo "failed_jobs<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILED_JOBS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Get log snippet
          LOG_SNIPPET=$(gh run view $RUN_ID --log-failed 2>/dev/null | tail -50 || echo "Could not fetch logs")
          echo "log_snippet<<EOF" >> $GITHUB_OUTPUT
          echo "$LOG_SNIPPET" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze and create learning record
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cat > analyze_failure.py << 'PYTHON'
          import json
          import os
          import requests
          from datetime import datetime

          failed_jobs = """${{ steps.logs.outputs.failed_jobs }}"""
          log_snippet = """${{ steps.logs.outputs.log_snippet }}"""
          run_id = "${{ github.event.workflow_run.id }}"
          sha = "${{ github.event.workflow_run.head_sha }}"

          # Create failure record
          failure_record = {
              "timestamp": datetime.utcnow().isoformat(),
              "workflow": "production-deployment",
              "run_id": run_id,
              "commit_sha": sha,
              "failed_jobs": failed_jobs,
              "log_snippet": log_snippet[:2000],  # Truncate for storage
              "status": "needs_analysis"
          }

          print("ðŸ“ Failure Record Created:")
          print(json.dumps(failure_record, indent=2))

          # Save for issue creation
          with open("failure_record.json", "w") as f:
              json.dump(failure_record, f)
          PYTHON

          python analyze_failure.py

      - name: Store mistake in AI Team memory
        env:
          AI_TEAM_API_URL: ${{ secrets.AI_TEAM_API_URL }}
        run: |
          # Store the failure in AI Team's memory system for learning
          # This ensures the AI Team never repeats this mistake

          FAILED_JOBS="${{ steps.logs.outputs.failed_jobs }}"
          LOG_SNIPPET="${{ steps.logs.outputs.log_snippet }}"
          RUN_ID=${{ github.event.workflow_run.id }}
          SHA=${{ github.event.workflow_run.head_sha }}

          # Default to localhost if not configured (for local testing)
          API_URL="${AI_TEAM_API_URL:-http://localhost:5050}"

          # Create JSON payload
          cat > /tmp/mistake_payload.json << EOF
          {
            "description": "Deployment failure in production workflow. Failed jobs: ${FAILED_JOBS:-unknown}. Run ID: ${RUN_ID}",
            "mistake_type": "deployment_failure",
            "severity": "high",
            "project": "chatterfix",
            "context": {
              "run_id": "${RUN_ID}",
              "commit_sha": "${SHA}",
              "failed_jobs": "${FAILED_JOBS:-unknown}",
              "log_snippet": "${LOG_SNIPPET:0:500}",
              "workflow": "production-deployment",
              "source": "github-actions"
            },
            "prevention_strategy": "Review CI/CD logs before deployment. Run local tests. Check for similar past failures.",
            "tags": ["ci-cd", "deployment", "automated", "github-actions"]
          }
          EOF

          # Try to store in AI Team memory (non-blocking if API unavailable)
          echo "ðŸ“¡ Storing failure in AI Team memory..."
          curl -s -X POST "${API_URL}/api/memory/mistake" \
            -H "Content-Type: application/json" \
            -d @/tmp/mistake_payload.json \
            --connect-timeout 10 \
            --max-time 30 || echo "âš ï¸ AI Team API not available - continuing with issue creation"

      - name: Create learning issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          FAILED_JOBS="${{ steps.logs.outputs.failed_jobs }}"
          RUN_ID=${{ github.event.workflow_run.id }}
          SHA=${{ github.event.workflow_run.head_sha }}
          LOG_SNIPPET="${{ steps.logs.outputs.log_snippet }}"

          # Create issue body using heredoc to avoid YAML escaping issues
          BODY=$(cat <<'ISSUE_BODY'
          ## ðŸš¨ Deployment Failure Detected

          **Run ID:** RUN_ID_PLACEHOLDER
          **Commit:** SHA_PLACEHOLDER
          **Failed Jobs:**
          ```
          FAILED_JOBS_PLACEHOLDER
          ```

          ### Log Snippet
          ```
          LOG_SNIPPET_PLACEHOLDER
          ```

          ---

          ### AI Team Action Items
          - [ ] Analyze root cause
          - [ ] Add to mistake patterns in CLAUDE.md
          - [ ] Update `ai-precommit-review.py` if applicable
          - [ ] Verify fix prevents recurrence

          > ðŸ’¡ This failure has been automatically stored in the AI Team's memory system.
          > The team will learn from this and prevent similar mistakes in the future.

          *ðŸ¤– Auto-generated by AI Learning System*
          ISSUE_BODY
          )

          # Replace placeholders
          BODY="${BODY//RUN_ID_PLACEHOLDER/$RUN_ID}"
          BODY="${BODY//SHA_PLACEHOLDER/$SHA}"
          BODY="${BODY//FAILED_JOBS_PLACEHOLDER/$FAILED_JOBS}"
          BODY="${BODY//LOG_SNIPPET_PLACEHOLDER/$LOG_SNIPPET}"

          gh issue create \
            --title "ðŸ§  AI Learning: Deployment Failure - $(date +%Y-%m-%d)" \
            --body "$BODY" \
            --label "bug"
