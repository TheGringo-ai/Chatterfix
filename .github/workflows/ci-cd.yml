name: ChatterFix CMMS CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write
  id-token: write

env:
  DOCKER_IMAGE: chatterfix-cmms
  REGISTRY: gcr.io
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install security tools
        run: |
          pip install safety bandit semgrep
          
      - name: Run dependency security scan
        run: |
          safety check -r requirements.txt --output json > safety-report.json || true
          
      - name: Run static security analysis
        run: |
          bandit -r . -f json -o bandit-report.json || true
          
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: '*-report.json'
          
      - name: Security gate check
        run: |
          python scripts/security-gate-check.py

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    # Run in parallel with security-scan for faster CI

    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-core-${{ hashFiles('requirements-core.txt') }}

      - name: Install dependencies (fast - using core requirements)
        run: |
          pip install uv
          uv pip install --system -r requirements-core.txt
          uv pip install --system -r requirements-dev.txt
          
      - name: Run tests
        env:
          ENVIRONMENT: testing
          REDIS_URL: redis://localhost:6379
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=html
          
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: chatterfix-coverage

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: security-scan  # Only wait for security, tests run in parallel

    strategy:
      matrix:
        service:
          - name: core-web
            dockerfile: Dockerfile
            context: .
            image: chatterfix-core
          - name: ocr-service
            dockerfile: services/ocr-service/Dockerfile
            context: services/ocr-service
            image: chatterfix-ocr
          - name: ai-team-service
            dockerfile: ai-team-service/Dockerfile
            context: ai-team-service
            image: chatterfix-ai-team
      fail-fast: false

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check GCR credentials
        id: check_creds
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "has_creds=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ GCP_SA_KEY secret not configured - skipping Docker push"
          else
            echo "has_creds=true" >> $GITHUB_OUTPUT
            echo "âœ… GCR credentials available"
          fi

      - name: Log in to Google Container Registry
        if: steps.check_creds.outputs.has_creds == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Extract metadata for ${{ matrix.service.name }}
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ matrix.service.image }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push ${{ matrix.service.name }} Docker image
        if: steps.check_creds.outputs.has_creds == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Multi-tier caching for faster builds
          cache-from: |
            type=gha
            type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ matrix.service.image }}:buildcache
          cache-to: |
            type=gha,mode=max
            type=registry,ref=${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ matrix.service.image }}:buildcache,mode=max
          # BuildKit optimizations
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Run Trivy vulnerability scanner on ${{ matrix.service.name }}
        if: steps.check_creds.outputs.has_creds == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ matrix.service.image }}:latest
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service.name }}.sarif'

      - name: Upload Trivy scan results for ${{ matrix.service.name }}
        if: steps.check_creds.outputs.has_creds == 'true'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results-${{ matrix.service.name }}.sarif'

  # NOTE: Deployment is handled by production-ci-cd.yml workflow
  # This workflow focuses on security scanning, testing, and building
  # The deploy jobs below are disabled to avoid conflicts

  # deploy-staging:
  #   Disabled - No staging environment configured

  # deploy-production:
  #   Disabled - Handled by production-ci-cd.yml which deploys to chatterfix-cmms

  ai-enhancement:
    name: AI-Enhanced Development
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Don't block PR on AI review failure

    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          df -h

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install AI tools (lightweight)
        run: |
          pip install google-generativeai openai pydantic requests bandit

      - name: Get changed files
        id: changed
        run: |
          FILES=$(git diff --name-only origin/main...HEAD | grep -E '\.(py|js|ts|tsx)$' | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: AI Code Review
        id: ai_review
        run: |
          echo "## ðŸ¤– AI Team Code Review" > ai-insights.md
          echo "" >> ai-insights.md
          echo "**PR:** #${{ github.event.pull_request.number }}" >> ai-insights.md
          echo "**Commit:** \`${{ github.sha }}\`" >> ai-insights.md
          echo "" >> ai-insights.md

          # Run AI pre-commit review and capture output
          echo "### Pattern Analysis" >> ai-insights.md
          echo "\`\`\`" >> ai-insights.md
          python scripts/ai-precommit-review.py --verbose ${{ steps.changed.outputs.files }} 2>&1 | tee -a ai-insights.md || true
          echo "\`\`\`" >> ai-insights.md
          echo "" >> ai-insights.md

          # Run bandit security scan
          echo "### Security Scan (Bandit)" >> ai-insights.md
          echo "\`\`\`" >> ai-insights.md
          bandit -r app/ -ll -q 2>&1 | head -30 | tee -a ai-insights.md || echo "No high-severity issues" >> ai-insights.md
          echo "\`\`\`" >> ai-insights.md
          echo "" >> ai-insights.md

          echo "---" >> ai-insights.md
          echo "*ðŸ¤– AI Team: Claude (Architect) â€¢ Gemini (Innovation) â€¢ Grok (Strategy) â€¢ ChatGPT (Development)*" >> ai-insights.md

      - name: Comment AI insights on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const insights = fs.readFileSync('ai-insights.md', 'utf8');

            // Check for existing AI comment and update instead of creating new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const aiComment = comments.find(c => c.body.includes('ðŸ¤– AI Team Code Review'));

            if (aiComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: aiComment.id,
                body: insights
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: insights
              });
            }

  # performance-monitoring:
  #   Disabled - Performance monitoring is optional and can be run manually
  #   To run: locust --headless --users 50 --spawn-rate 5 --run-time 300s --host https://chatterfix.com