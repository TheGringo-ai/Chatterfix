name: Deploy Now (Skip Checks)

on:
  workflow_dispatch:
    inputs:
      skip_all_checks:
        description: 'Skip all pre-deployment checks'
        required: false
        type: boolean
        default: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create credentials file
        run: |
          mkdir -p /tmp
          echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: fredfix
      
      - name: Enable Required APIs
        run: |
          gcloud services enable run.googleapis.com
          gcloud services enable cloudbuild.googleapis.com
          gcloud services enable artifactregistry.googleapis.com
          gcloud services enable cloudaicompanion.googleapis.com
          gcloud services enable storage-api.googleapis.com
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy chatterfix-cmms \
            --source . \
            --region us-central1 \
            --set-env-vars="USE_FIRESTORE=true,GOOGLE_CLOUD_PROJECT=fredfix,FIREBASE_API_KEY=AIzaSyAaXlvuopHtTZglfghnlc_hBqGr1YzPrBk" \
            --memory=2Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --allow-unauthenticated \
            --port=8080 \
            --quiet
      
      - name: Get Service URL
        run: |
          URL=$(gcloud run services describe chatterfix-cmms --region us-central1 --format="value(status.url)")
          echo "ðŸš€ Deployment complete!"
          echo "ðŸ“± Service URL: $URL"
          echo "ðŸ”¥ Firebase + Firestore enabled"
          echo "âœ¨ Enhanced ChatterFix with photos, avatars, and AI features"