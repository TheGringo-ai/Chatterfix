name: ğŸ¤– Fix It Fred Command Deployment

on:
  repository_dispatch:
    types: [deploy-command]
  workflow_dispatch:
    inputs:
      command:
        description: 'Deployment command from Fix It Fred'
        required: true
        default: 'deploy to production'
      source:
        description: 'Source service making the request'
        required: false
        default: 'fix-it-fred'

env:
  GCP_PROJECT_ID: fredfix
  GCP_ZONE: us-east1-b
  INSTANCE_NAME: chatterfix-cmms-production

jobs:
  parse-command:
    name: ğŸ§  Parse Natural Language Command
    runs-on: ubuntu-latest
    outputs:
      action: ${{ steps.parse.outputs.action }}
      environment: ${{ steps.parse.outputs.environment }}
      create_pr: ${{ steps.parse.outputs.create_pr }}

    steps:
    - name: ğŸ“‹ Parse Command
      id: parse
      run: |
        COMMAND="${{ github.event.client_payload.command || inputs.command }}"
        echo "Parsing command: $COMMAND"

        # Determine action
        if echo "$COMMAND" | grep -qi "deploy.*production\|ship.*it\|go.*live"; then
          echo "action=deploy" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "create_pr=false" >> $GITHUB_OUTPUT
        elif echo "$COMMAND" | grep -qi "deploy.*staging\|deploy.*dev"; then
          echo "action=deploy" >> $GITHUB_OUTPUT
          echo "environment=staging" >> $GITHUB_OUTPUT
          echo "create_pr=false" >> $GITHUB_OUTPUT
        elif echo "$COMMAND" | grep -qi "create.*pr\|pull.*request"; then
          echo "action=create_pr" >> $GITHUB_OUTPUT
          echo "environment=none" >> $GITHUB_OUTPUT
          echo "create_pr=true" >> $GITHUB_OUTPUT
        elif echo "$COMMAND" | grep -qi "status\|check"; then
          echo "action=status" >> $GITHUB_OUTPUT
          echo "environment=none" >> $GITHUB_OUTPUT
          echo "create_pr=false" >> $GITHUB_OUTPUT
        else
          echo "action=deploy" >> $GITHUB_OUTPUT
          echo "environment=production" >> $GITHUB_OUTPUT
          echo "create_pr=false" >> $GITHUB_OUTPUT
        fi

        echo "âœ… Command parsed successfully"

  deploy:
    name: ğŸš€ Deploy to ${{ needs.parse-command.outputs.environment }}
    needs: parse-command
    runs-on: ubuntu-latest
    if: needs.parse-command.outputs.action == 'deploy'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}

    - name: âš™ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}

    - name: ğŸ“¦ Prepare Deployment Package
      run: |
        echo "ğŸ“¦ Packaging ChatterFix CMMS files..."
        mkdir -p deploy-package

        # Copy core application files
        cp -r core/cmms/* deploy-package/

        # Create deployment archive
        cd deploy-package
        tar czf ../chatterfix-deployment.tar.gz .
        cd ..

        echo "âœ… Package created: $(du -h chatterfix-deployment.tar.gz)"

    - name: ğŸ“¤ Upload to GCP
      run: |
        echo "ğŸ“¤ Uploading deployment package to VM..."

        # Upload via metadata (for small files) or Cloud Storage (for large files)
        gcloud compute scp chatterfix-deployment.tar.gz \
          ${{ env.INSTANCE_NAME }}:/tmp/chatterfix-deployment.tar.gz \
          --zone=${{ env.GCP_ZONE }} || \
          gcloud compute instances add-metadata ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --metadata deployment-ready=true

    - name: ğŸ”„ Deploy on VM
      run: |
        echo "ğŸ”„ Triggering deployment on VM..."

        DEPLOY_SCRIPT='#!/bin/bash
set -e
export HOME=/root

echo "ğŸš€ Fix It Fred Automated Deployment"
echo "===================================="
echo "Environment: ${{ needs.parse-command.outputs.environment }}"
echo "Triggered by: ${{ github.event.client_payload.source || inputs.source }}"
echo "Time: $(date)"

# Stop current service
echo "ğŸ›‘ Stopping ChatterFix..."
pkill -f "python3 app.py" || true
sleep 2

# Extract new version
if [ -f /tmp/chatterfix-deployment.tar.gz ]; then
    echo "ğŸ“¦ Extracting deployment package..."
    cd /home/yoyofred_gringosgambit_com/chatterfix-docker/app
    tar xzf /tmp/chatterfix-deployment.tar.gz
    echo "âœ… Files extracted"
else
    echo "â„¹ï¸  No deployment package, using existing files"
fi

# Ensure dependencies
echo "ğŸ“š Checking dependencies..."
pip3 install --quiet fastapi uvicorn jinja2 httpx python-multipart aiofiles pydantic

# Start service
echo "ğŸš€ Starting ChatterFix..."
cd /home/yoyofred_gringosgambit_com/chatterfix-docker/app
export OLLAMA_HOST=http://localhost:11434
export PORT=8080

# Load environment
if [ -f .env ]; then
    set -a
    source .env
    set +a
fi

nohup python3 app.py > /tmp/chatterfix.log 2>&1 &
CHATTERFIX_PID=$!

echo "â³ Waiting for service to start..."
sleep 10

if ps -p $CHATTERFIX_PID > /dev/null; then
    echo "âœ… ChatterFix started successfully (PID: $CHATTERFIX_PID)"
    tail -15 /tmp/chatterfix.log
else
    echo "âŒ ChatterFix failed to start"
    cat /tmp/chatterfix.log
    exit 1
fi

echo "ğŸ‰ Deployment complete!"
'

        # Upload and execute deployment script
        echo "$DEPLOY_SCRIPT" | gcloud compute ssh ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --command "cat > /tmp/deploy.sh && chmod +x /tmp/deploy.sh && sudo /tmp/deploy.sh"

    - name: ğŸ©º Health Check
      run: |
        echo "ğŸ” Getting VM external IP..."
        VM_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --format="value(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "ğŸŒ VM IP: $VM_IP"

        # Health check with retries
        for i in {1..10}; do
          echo "ğŸ©º Health check attempt $i/10..."
          if curl -s -f "http://$VM_IP:8080/api/ollama/status" > /dev/null; then
            echo "âœ… Deployment successful!"
            curl -s "http://$VM_IP:8080/api/ollama/status"
            exit 0
          else
            echo "â³ Service starting... (attempt $i)"
            sleep 20
          fi
        done

        echo "âŒ Deployment health check failed"
        exit 1

    - name: ğŸ‰ Deployment Summary
      run: |
        VM_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --format="value(networkInterfaces[0].accessConfigs[0].natIP)")

        echo "ğŸ‰ DEPLOYMENT COMPLETE!"
        echo "====================="
        echo "ğŸ¤– Deployed by: Fix It Fred"
        echo "ğŸŒ URL: http://$VM_IP:8080"
        echo "ğŸ”§ Environment: ${{ needs.parse-command.outputs.environment }}"
        echo "ğŸ“Š Status: http://$VM_IP:8080/api/ollama/status"
        echo "ğŸš€ Deployment API: http://$VM_IP:8080/api/fix-it-fred/deploy"

  create-pr:
    name: ğŸ“ Create Pull Request
    needs: parse-command
    runs-on: ubuntu-latest
    if: needs.parse-command.outputs.create_pr == 'true'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ”€ Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ¤– Automated update from Fix It Fred"
        title: "ğŸ¤– Fix It Fred Automated Update"
        body: |
          ## ğŸ¤– Automated Update from Fix It Fred

          This PR was automatically created by Fix It Fred based on a deployment command.

          **Command**: ${{ github.event.client_payload.command || inputs.command }}
          **Source**: ${{ github.event.client_payload.source || inputs.source }}
          **Time**: ${{ github.event.client_payload.timestamp }}

          Please review the changes before merging.

          ---
          ğŸ¤– *Generated by Fix It Fred*
        branch: fix-it-fred-auto-update
        labels: automated, fix-it-fred

  status-check:
    name: ğŸ“Š Repository Status Check
    needs: parse-command
    runs-on: ubuntu-latest
    if: needs.parse-command.outputs.action == 'status'

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“Š Get Status
      run: |
        echo "ğŸ“Š Repository Status"
        echo "==================="
        echo "ğŸŒ¿ Branch: $(git branch --show-current)"
        echo "ğŸ“ Latest commit: $(git log -1 --oneline)"
        echo "ğŸ“¦ Changed files:"
        git status --short

        echo ""
        echo "âœ… Status check complete"
