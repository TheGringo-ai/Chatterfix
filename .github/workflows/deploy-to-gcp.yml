name: ğŸš€ Deploy ChatterFix CMMS to GCP

on:
  push:
    branches: [ main, main-clean ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'false'

env:
  GCP_PROJECT_ID: fredfix
  GCP_ZONE: us-east1-b
  INSTANCE_NAME: chatterfix-cmms-production

jobs:
  deploy:
    name: ğŸ”§ Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        
    - name: âš™ï¸ Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: ğŸ§¹ Prepare Clean Deployment Script
      run: |
        # Make deployment script executable
        chmod +x clean-deploy-vm.sh
        
        # Verify script contents
        echo "âœ… Deployment script ready:"
        head -5 clean-deploy-vm.sh
        
    - name: ğŸš€ Deploy to GCP Instance
      run: |
        echo "ğŸ§¹ Step 1: VM Cleanup with startup script..."
        gcloud compute instances add-metadata ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --metadata-from-file startup-script=clean-deploy-vm.sh
          
        echo "ğŸ”„ Triggering VM reset and cleanup..."
        gcloud compute instances reset ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }}
          
        echo "â³ Waiting for VM restart and cleanup..."
        sleep 120  # 2 minutes for restart
        
        echo "ğŸš€ Step 2: Deploy working backend scripts..."
        
        # Deploy working backend on port 8081
        if [ -f deploy-working-backend.sh ]; then
          echo "ğŸ“¤ Copying working backend script..."
          gcloud compute scp deploy-working-backend.sh ${{ env.INSTANCE_NAME }}:/tmp/deploy-working-backend.sh \
            --zone=${{ env.GCP_ZONE }}
          
          echo "ğŸš€ Executing working backend deployment..."
          gcloud compute ssh ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="chmod +x /tmp/deploy-working-backend.sh && /tmp/deploy-working-backend.sh"
        fi
        
        # Deploy emergency backend as fallback
        if [ -f deploy-emergency-backend.sh ]; then
          echo "ğŸ“¤ Copying emergency backend script..."
          gcloud compute scp deploy-emergency-backend.sh ${{ env.INSTANCE_NAME }}:/tmp/deploy-emergency-backend.sh \
            --zone=${{ env.GCP_ZONE }}
          
          echo "ğŸš¨ Executing emergency backend deployment..."
          gcloud compute ssh ${{ env.INSTANCE_NAME }} \
            --zone=${{ env.GCP_ZONE }} \
            --command="chmod +x /tmp/deploy-emergency-backend.sh && /tmp/deploy-emergency-backend.sh"
        fi
        
        echo "â³ Waiting for backend services to start..."
        sleep 60  # 1 minute for backend startup
        
    - name: ğŸ©º Health Check
      run: |
        echo "ğŸ” Getting VM external IP..."
        VM_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
        
        echo "ğŸŒ VM IP: $VM_IP"
        
        # Health check with retries
        for i in {1..10}; do
          echo "ğŸ©º Health check attempt $i/10..."
          if curl -s -f "http://$VM_IP:8080/health" > /dev/null; then
            echo "âœ… Deployment successful!"
            curl -s "http://$VM_IP:8080/health" | jq '.'
            break
          else
            echo "â³ Service starting... (attempt $i)"
            sleep 30
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ Deployment failed - health check timeout"
            exit 1
          fi
        done
        
    - name: ğŸ“Š Deployment Summary
      run: |
        VM_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
          
        echo "ğŸ‰ DEPLOYMENT COMPLETE!"
        echo "====================="
        echo "ğŸŒ URL: http://$VM_IP"
        echo "ğŸ” Login: admin / admin123"
        echo "ğŸ“Š Health: http://$VM_IP:8080/health"
        echo "ğŸ¤– AI Assistant: Enabled"
        echo "ğŸ§¹ Status: Clean deployment"
        
        # Optional: Post to Slack/Discord webhook if secrets are configured
        if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš€ ChatterFix CMMS deployed successfully to http://$VM_IP\"}" \
            ${{ secrets.SLACK_WEBHOOK }} || true
        fi

  notify-on-failure:
    name: ğŸ“¢ Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: ğŸš¨ Deployment Failed
      run: |
        echo "âŒ DEPLOYMENT FAILED!"
        echo "Check the logs above for details."
        
        # Optional: Post failure notification
        if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ ChatterFix CMMS deployment failed! Check GitHub Actions logs.\"}" \
            ${{ secrets.SLACK_WEBHOOK }} || true
        fi