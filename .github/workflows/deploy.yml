name: ChatterFix CMMS CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_ID: fredfix
  REGION: us-central1
  BACKEND_SERVICE: chatterfix-consolidated-cmms
  FRONTEND_SERVICE: chatterfix-unified-gateway-updated

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest httpx fastapi
        if [ -f consolidated_requirements.txt ]; then pip install -r consolidated_requirements.txt; fi
        if [ -f tests/requirements.txt ]; then pip install -r tests/requirements.txt; fi
        
    - name: Run unit tests
      run: |
        python -m pytest tests/ -v --tb=short
        
    - name: Test backend imports
      run: |
        python -c "from modules.work_orders import router as work_orders_router"
        python -c "from modules.assets import router as assets_router"
        python -c "from modules.parts import router as parts_router"
        python -c "from modules.shared import verify_api_key, get_health_status"

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev
      
    - name: Build and deploy backend
      run: |
        # Build Docker image
        cp Dockerfile.consolidated Dockerfile
        gcloud builds submit --tag us-central1-docker.pkg.dev/$PROJECT_ID/chatterfix/$BACKEND_SERVICE .
        
        # Deploy to Cloud Run
        gcloud run deploy $BACKEND_SERVICE \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/chatterfix/$BACKEND_SERVICE \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --memory 1Gi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 3 \
          --port 8080 \
          --set-env-vars="GCS_BUCKET=chatterfix-attachments,CHATTERFIX_API_KEY=${{ secrets.CHATTERFIX_API_KEY }},RATE_LIMIT_REQUESTS=20,RATE_LIMIT_WINDOW=60" \
          --timeout=300
          
    - name: Backend health check
      run: |
        sleep 30
        SERVICE_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(status.url)")
        curl -f -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$SERVICE_URL/health" || exit 1
        echo "‚úÖ Backend health check passed"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [test, deploy-backend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker us-central1-docker.pkg.dev
      
    - name: Get backend URL
      id: backend
      run: |
        BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(status.url)")
        echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
        
    - name: Build and deploy frontend
      run: |
        cd frontend
        
        # Create dynamic Dockerfile
        cat > Dockerfile.frontend << EOF
        FROM python:3.11-slim
        WORKDIR /app
        RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
        COPY requirements.txt .
        RUN pip install --no-cache-dir -r requirements.txt
        COPY phase6b-unified-gateway.py main.py
        EXPOSE 8080
        HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
          CMD curl -f http://localhost:8080/health || exit 1
        CMD ["python", "main.py"]
        EOF
        
        # Build and deploy
        cp Dockerfile.frontend Dockerfile
        gcloud builds submit --tag us-central1-docker.pkg.dev/$PROJECT_ID/chatterfix/$FRONTEND_SERVICE .
        
        gcloud run deploy $FRONTEND_SERVICE \
          --image us-central1-docker.pkg.dev/$PROJECT_ID/chatterfix/$FRONTEND_SERVICE \
          --platform managed \
          --region $REGION \
          --allow-unauthenticated \
          --memory 512Mi \
          --cpu 1 \
          --min-instances 0 \
          --max-instances 2 \
          --port 8080 \
          --set-env-vars="WORK_ORDERS_URL=${{ steps.backend.outputs.url }},ASSETS_URL=${{ steps.backend.outputs.url }},PARTS_URL=${{ steps.backend.outputs.url }},CUSTOMER_SUCCESS_URL=${{ steps.backend.outputs.url }},REVENUE_INTELLIGENCE_URL=${{ steps.backend.outputs.url }},DATA_ROOM_URL=${{ steps.backend.outputs.url }},CHATTERFIX_API_KEY=${{ secrets.CHATTERFIX_API_KEY }}" \
          --timeout=300
          
    - name: Frontend health check
      run: |
        sleep 30
        SERVICE_URL=$(gcloud run services describe $FRONTEND_SERVICE --region=$REGION --format="value(status.url)")
        curl -f "$SERVICE_URL/health" || exit 1
        echo "‚úÖ Frontend health check passed"

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      
    - name: Run integration tests
      run: |
        # Get service URLs
        BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(status.url)")
        FRONTEND_URL=$(gcloud run services describe $FRONTEND_SERVICE --region=$REGION --format="value(status.url)")
        
        echo "üîç Testing backend endpoints..."
        
        # Test work orders endpoint
        WORK_ORDERS_COUNT=$(curl -s -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$BACKEND_URL/work_orders/" | jq '.work_orders | length')
        if [ "$WORK_ORDERS_COUNT" -gt 0 ]; then
          echo "‚úÖ Work orders endpoint: $WORK_ORDERS_COUNT items"
        else
          echo "‚ùå Work orders endpoint failed"
          exit 1
        fi
        
        # Test assets endpoint
        ASSETS_COUNT=$(curl -s -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$BACKEND_URL/assets/" | jq '.assets | length')
        if [ "$ASSETS_COUNT" -gt 0 ]; then
          echo "‚úÖ Assets endpoint: $ASSETS_COUNT items"
        else
          echo "‚ùå Assets endpoint failed"
          exit 1
        fi
        
        # Test parts endpoint
        PARTS_COUNT=$(curl -s -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$BACKEND_URL/parts/" | jq '.parts | length')
        if [ "$PARTS_COUNT" -gt 0 ]; then
          echo "‚úÖ Parts endpoint: $PARTS_COUNT items"
        else
          echo "‚ùå Parts endpoint failed"
          exit 1
        fi
        
        # Test health endpoint
        HEALTH_STATUS=$(curl -s -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$BACKEND_URL/health" | jq -r '.status')
        if [ "$HEALTH_STATUS" = "healthy" ]; then
          echo "‚úÖ Health endpoint: $HEALTH_STATUS"
        else
          echo "‚ùå Health endpoint failed: $HEALTH_STATUS"
          exit 1
        fi
        
        echo "üîç Testing frontend proxy..."
        
        # Test frontend proxy to backend
        PROXY_COUNT=$(curl -s "$FRONTEND_URL/api/work-orders/" | jq '.work_orders | length' 2>/dev/null || echo "0")
        if [ "$PROXY_COUNT" -gt 0 ]; then
          echo "‚úÖ Frontend proxy: $PROXY_COUNT work orders"
        else
          echo "‚ö†Ô∏è Frontend proxy may have authentication issues (expected in CI)"
        fi
        
        echo "üéâ Integration tests completed successfully!"
        
    - name: Performance benchmark
      run: |
        BACKEND_URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format="value(status.url)")
        
        echo "üìä Running performance benchmarks..."
        
        # Test response times
        for endpoint in "health" "work_orders/" "assets/" "parts/"; do
          echo "Testing $endpoint..."
          time curl -s -H "x-api-key: ${{ secrets.CHATTERFIX_API_KEY }}" "$BACKEND_URL/$endpoint" > /dev/null
        done
        
        echo "‚úÖ Performance benchmark completed"

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: always()
    
    steps:
    - name: Notify success
      if: needs.integration-test.result == 'success'
      run: |
        echo "üéâ ChatterFix CMMS deployment successful!"
        echo "Backend: https://chatterfix-consolidated-cmms-650169261019.us-central1.run.app"
        echo "Frontend: https://chatterfix-unified-gateway-updated-650169261019.us-central1.run.app"
        
    - name: Notify failure
      if: needs.integration-test.result == 'failure'
      run: |
        echo "‚ùå ChatterFix CMMS deployment failed!"
        echo "Check the logs for details."
        exit 1