name: ğŸ§ª ChatterFix Development Deployment

# Deploys to DEV environment when testing branch is updated
# Safe testing environment before promoting to production

on:
  push:
    branches: [testing]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip health checks and tests'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: fredfix
  SERVICE_NAME: gringo-core
  REGION: us-central1
  MEMORY: 1Gi
  CPU: 1
  MIN_INSTANCES: 0
  MAX_INSTANCES: 5

permissions:
  contents: read
  id-token: write

jobs:
  # Quick validation job
  validate:
    name: ğŸ” Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Validate basic dependencies
        run: |
          echo "ğŸ” Checking requirements.txt..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt --dry-run
          echo "âœ… Dependencies validation passed"

      - name: Validate Docker build
        run: |
          echo "ğŸ³ Testing Docker build..."
          docker build --target builder --quiet .
          echo "âœ… Docker build validation passed"

  # Main deployment job
  deploy:
    name: ğŸ§ª Deploy to DEV
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    if: needs.validate.result == 'success'

    environment:
      name: development
      url: https://gringo-core-650169261019.us-central1.run.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: Build Docker Image
        id: build
        run: |
          IMAGE_TAG="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:dev-latest"

          echo "ğŸ—ï¸ Building Docker image for DEV..."
          docker build \
            --platform linux/amd64 \
            --tag "$IMAGE_TAG" \
            --tag "$IMAGE_LATEST" \
            --build-arg USE_FIRESTORE=true \
            --build-arg GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }} \
            .

          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_latest=$IMAGE_LATEST" >> $GITHUB_OUTPUT
          echo "âœ… Docker image built successfully"

      - name: Push Docker Image to GCR
        run: |
          echo "ğŸ“¤ Pushing image to Google Container Registry..."
          docker push ${{ steps.build.outputs.image_tag }}
          docker push ${{ steps.build.outputs.image_latest }}
          echo "âœ… Image pushed to GCR"

      - name: Deploy to Cloud Run (DEV)
        id: deploy
        run: |
          echo "ğŸ§ª Deploying to DEV environment..."

          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ steps.build.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=${{ env.MEMORY }} \
            --cpu=${{ env.CPU }} \
            --min-instances=${{ env.MIN_INSTANCES }} \
            --max-instances=${{ env.MAX_INSTANCES }} \
            --timeout=300 \
            --concurrency=80 \
            --set-env-vars="USE_FIRESTORE=true,GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},ENVIRONMENT=development,LOG_LEVEL=debug,AI_TEAM_SERVICE_URL=https://ai-team-service-650169261019.us-central1.run.app" \
            --set-secrets="SECRET_KEY=SECRET_KEY:latest,JWT_SECRET_KEY=jwt-secret-key:latest,FIREBASE_API_KEY=FIREBASE_API_KEY:latest,GEMINI_API_KEY=GEMINI_API_KEY:latest,OPENAI_API_KEY=openai-api-key:latest,XAI_API_KEY=xai-api-key:latest" \
            --labels=managed-by=github-actions,environment=development,version=${{ github.sha }} \
            --quiet

          echo "âœ… DEV deployment completed"

      - name: Get Service URL
        id: service_url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.latestReadyRevisionName)')

          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "ğŸŒ DEV URL: $URL"
          echo "ğŸ“¦ Revision: $REVISION"

      - name: Health Check
        if: ${{ !inputs.skip_tests }}
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "ğŸ¥ Running health check on $SERVICE_URL/health"

          sleep 15  # Wait for deployment to stabilize

          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."

            if curl -f --max-time 15 "$SERVICE_URL/health"; then
              echo "âœ… Health check passed!"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âš ï¸ Health check failed but continuing (DEV environment)"
              fi
              echo "âš ï¸ Retrying in 10 seconds..."
              sleep 10
            fi
          done

      - name: Deployment Success Summary
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ§ª DEV DEPLOYMENT SUCCESSFUL                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ DEV URL: ${{ steps.service_url.outputs.url }}"
          echo "ğŸ·ï¸ Revision: ${{ steps.service_url.outputs.revision }}"
          echo "ğŸ“Š Memory: ${{ env.MEMORY }}, CPU: ${{ env.CPU }}"
          echo "ğŸ”§ Environment: Development"
          echo ""
          echo "âœ… Ready for testing!"
          echo ""
          echo "When ready to deploy to production:"
          echo "  1. Create PR: testing â†’ main"
          echo "  2. Merge to trigger production deployment"
