name: ü§ñ Fix It Fred Auto-Deploy

on:
  push:
    branches: [main, main-clean]
    paths-ignore:
      - "README.md"
      - "docs/**"
      - "*.md"
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean
      health_check_only:
        description: 'Perform health check only (no deployment)'
        required: false
        default: false
        type: boolean

env:
  PROJECT_ID: fredfix
  INSTANCE_NAME: chatterfix-cmms-production
  ZONE: us-east1-b
  REPO_PATH: /home/yoyofred_gringosgambit_com/chatterfix-docker

jobs:
  pre-deployment-analysis:
    name: üîç Pre-deployment Analysis
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.analysis.outputs.should-deploy }}
      changes-detected: ${{ steps.analysis.outputs.changes-detected }}
      has-credentials: ${{ steps.creds.outputs.has-creds }}
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 10  # Get recent history for analysis

      - name: üîç Check Credentials
        id: creds
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "has-creds=true" >> $GITHUB_OUTPUT
            echo "‚úÖ GCP credentials available"
          else
            echo "has-creds=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è GCP credentials not configured"
          fi

      - name: üîë Setup GCP Authentication
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: üìä Analyze Changes
        id: analysis
        run: |
          echo "üîç Analyzing changes for deployment..."
          
          # Check if this is a forced deployment
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "üöÄ Force deployment requested"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "changes-detected=forced" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if health check only
          if [ "${{ github.event.inputs.health_check_only }}" == "true" ]; then
            echo "ü©∫ Health check only requested"
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "changes-detected=health-only" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Analyze changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          SIGNIFICANT_CHANGES=false
          
          echo "üìù Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for significant changes that require deployment
          while IFS= read -r file; do
            case "$file" in
              *.py|*.js|*.html|*.css|*.sh|*.yml|*.yaml|requirements*.txt|package*.json)
                echo "‚úÖ Significant change detected: $file"
                SIGNIFICANT_CHANGES=true
                ;;
              *.md|*.txt|docs/*|README*)
                echo "üìÑ Documentation change: $file (no deployment needed)"
                ;;
              *)
                echo "üîç Other change: $file"
                SIGNIFICANT_CHANGES=true
                ;;
            esac
          done <<< "$CHANGED_FILES"
          
          if [ "$SIGNIFICANT_CHANGES" = "true" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "changes-detected=true" >> $GITHUB_OUTPUT
            echo "üöÄ Deployment required due to significant changes"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "changes-detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No deployment needed - only documentation changes"
          fi

  vm-health-check:
    name: ü©∫ VM Health Check
    runs-on: ubuntu-latest
    needs: pre-deployment-analysis
    if: needs.pre-deployment-analysis.outputs.has-credentials == 'true'
    outputs:
      vm-healthy: ${{ steps.health.outputs.healthy }}
      fred-daemon-status: ${{ steps.health.outputs.fred-status }}
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîë Setup GCP Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ü©∫ Comprehensive Health Check
        id: health
        run: |
          echo "ü©∫ Running comprehensive VM health check..."
          
          # Check VM status
          VM_STATUS=$(gcloud compute instances describe $INSTANCE_NAME \
            --zone=$ZONE --format="value(status)" 2>/dev/null || echo "UNKNOWN")
          
          if [ "$VM_STATUS" != "RUNNING" ]; then
            echo "‚ùå VM is not running: $VM_STATUS"
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ VM is running"
          
          # Check Fix It Fred DevOps daemon
          FRED_STATUS=$(gcloud compute ssh $INSTANCE_NAME --zone=$ZONE \
            --command="systemctl is-active fix-it-fred-devops.service" 2>/dev/null || echo "inactive")
          
          echo "fred-status=$FRED_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$FRED_STATUS" = "active" ]; then
            echo "‚úÖ Fix It Fred DevOps daemon is running"
          else
            echo "‚ö†Ô∏è Fix It Fred DevOps daemon is not active: $FRED_STATUS"
          fi
          
          # Check core services
          HEALTH_SCRIPT='
          echo "üîç Checking core services..."
          
          # Check nginx
          if systemctl is-active nginx >/dev/null 2>&1; then
            echo "‚úÖ nginx: active"
          else
            echo "‚ùå nginx: inactive"
          fi
          
          # Check application endpoints
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "‚úÖ Main application: healthy"
          else
            echo "‚ö†Ô∏è Main application: not responding"
          fi
          
          # Check disk space
          DISK_USAGE=$(df / | tail -1 | awk "{print \$5}" | sed "s/%//")
          if [ "$DISK_USAGE" -lt 85 ]; then
            echo "‚úÖ Disk usage: ${DISK_USAGE}%"
          else
            echo "‚ö†Ô∏è High disk usage: ${DISK_USAGE}%"
          fi
          
          # Check memory
          FREE_MEM=$(free | grep Mem | awk "{print int(\$7/\$2 * 100)}")
          if [ "$FREE_MEM" -gt 10 ]; then
            echo "‚úÖ Free memory: ${FREE_MEM}%"
          else
            echo "‚ö†Ô∏è Low memory: ${FREE_MEM}%"
          fi
          
          echo "ü©∫ Health check completed"
          '
          
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="$HEALTH_SCRIPT"
          
          echo "healthy=true" >> $GITHUB_OUTPUT

  auto-deploy:
    name: üöÄ Autonomous Deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment-analysis, vm-health-check]
    if: needs.pre-deployment-analysis.outputs.should-deploy == 'true' && needs.vm-health-check.outputs.vm-healthy == 'true'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4

      - name: üîë Setup GCP Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚òÅÔ∏è Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: üì¶ Prepare Deployment Package
        run: |
          echo "üì¶ Preparing deployment package..."
          
          # Create deployment metadata
          cat > deployment-metadata.json << EOF
          {
            "deployment_id": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "triggered_by": "${{ github.event_name }}",
            "force_deploy": "${{ github.event.inputs.force_deploy }}",
            "changes_detected": "${{ needs.pre-deployment-analysis.outputs.changes-detected }}"
          }
          EOF
          
          echo "‚úÖ Deployment package prepared"

      - name: üöÄ Deploy to VM
        run: |
          echo "üöÄ Starting autonomous deployment..."
          
          # Upload deployment metadata
          gcloud compute scp deployment-metadata.json \
            $INSTANCE_NAME:/tmp/deployment-metadata.json --zone=$ZONE
          
          # Upload Fix It Fred DevOps files
          gcloud compute scp fix_it_fred_devops_daemon.py \
            $INSTANCE_NAME:$REPO_PATH/fix_it_fred_devops_daemon.py --zone=$ZONE
          
          gcloud compute scp fix-it-fred-devops.service \
            $INSTANCE_NAME:/tmp/fix-it-fred-devops.service --zone=$ZONE
          
          # Deployment script
          DEPLOY_SCRIPT='
          echo "ü§ñ Fix It Fred Autonomous Deployment Starting..."
          
          cd '"$REPO_PATH"'
          
          # Pull latest changes
          echo "üì° Pulling latest changes..."
          git fetch origin
          git pull origin '"${{ github.ref_name }}"'
          
          # Install/update dependencies if needed
          if [ -f requirements.txt ]; then
            echo "üì¶ Updating dependencies..."
            pip3 install --user -r requirements.txt
          fi
          
          # Update Fix It Fred DevOps service
          echo "üîß Updating Fix It Fred DevOps service..."
          sudo cp /tmp/fix-it-fred-devops.service /etc/systemd/system/
          sudo systemctl daemon-reload
          
          # Restart Fix It Fred DevOps daemon
          if systemctl is-active fix-it-fred-devops.service >/dev/null 2>&1; then
            echo "üîÑ Restarting Fix It Fred DevOps daemon..."
            sudo systemctl restart fix-it-fred-devops.service
          else
            echo "üöÄ Starting Fix It Fred DevOps daemon..."
            sudo systemctl enable fix-it-fred-devops.service
            sudo systemctl start fix-it-fred-devops.service
          fi
          
          # Signal daemon to perform immediate health check
          sleep 5
          if systemctl is-active fix-it-fred-devops.service >/dev/null 2>&1; then
            echo "üì° Signaling daemon for immediate health check..."
            sudo systemctl kill --signal=SIGUSR1 fix-it-fred-devops.service
          fi
          
          echo "‚úÖ Autonomous deployment completed"
          '
          
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="$DEPLOY_SCRIPT"

      - name: üîç Post-Deployment Verification
        run: |
          echo "üîç Verifying deployment..."
          
          # Wait for services to stabilize
          sleep 30
          
          VERIFY_SCRIPT='
          echo "üîç Post-deployment verification..."
          
          # Check Fix It Fred DevOps daemon
          if systemctl is-active fix-it-fred-devops.service >/dev/null 2>&1; then
            echo "‚úÖ Fix It Fred DevOps daemon: active"
          else
            echo "‚ùå Fix It Fred DevOps daemon: inactive"
            systemctl status fix-it-fred-devops.service --no-pager -l
          fi
          
          # Check application health
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "‚úÖ Main application: healthy"
          else
            echo "‚ö†Ô∏è Main application: not responding"
          fi
          
          # Check logs for errors
          echo "üìù Recent daemon logs:"
          journalctl -u fix-it-fred-devops.service --no-pager -n 10
          '
          
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="$VERIFY_SCRIPT"

  post-deployment:
    name: üìä Post-Deployment Report
    runs-on: ubuntu-latest
    needs: [pre-deployment-analysis, vm-health-check, auto-deploy]
    if: always()
    
    steps:
      - name: üìä Generate Deployment Report
        run: |
          echo "üìä DEPLOYMENT REPORT"
          echo "==================="
          echo ""
          echo "üéØ **Deployment Summary**"
          echo "- Deployment ID: ${{ github.run_id }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Trigger: ${{ github.event_name }}"
          echo ""
          echo "üìã **Analysis Results**"
          echo "- Should Deploy: ${{ needs.pre-deployment-analysis.outputs.should-deploy }}"
          echo "- Changes Detected: ${{ needs.pre-deployment-analysis.outputs.changes-detected }}"
          echo "- VM Healthy: ${{ needs.vm-health-check.outputs.vm-healthy }}"
          echo "- Fred Daemon: ${{ needs.vm-health-check.outputs.fred-daemon-status }}"
          echo ""
          echo "üéØ **Final Status**"
          if [ "${{ needs.auto-deploy.result }}" = "success" ]; then
            echo "‚úÖ **DEPLOYMENT SUCCESSFUL**"
            echo ""
            echo "ü§ñ Fix It Fred DevOps daemon is now managing:"
            echo "- ‚úÖ Continuous health monitoring"
            echo "- ‚úÖ Automatic service healing"
            echo "- ‚úÖ Future autonomous deployments"
            echo "- ‚úÖ System resource management"
          elif [ "${{ needs.pre-deployment-analysis.outputs.should-deploy }}" = "false" ]; then
            echo "‚ÑπÔ∏è **NO DEPLOYMENT NEEDED**"
            echo "- Only documentation or non-significant changes detected"
          else
            echo "‚ö†Ô∏è **DEPLOYMENT ATTENTION REQUIRED**"
            echo "- Check the deployment logs for details"
          fi
          
          echo ""
          echo "üîó **Monitoring Links**"
          echo "- VM Console: https://console.cloud.google.com/compute/instances"
          echo "- Application: https://www.chatterfix.com"
          echo "- Health Check: https://www.chatterfix.com/health"