name: Production Monitoring

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:

jobs:
  health-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Production Health
        id: health-check
        run: |
          echo "ğŸ” Checking production health..."
          
          # Check main site
          MAIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://chatterfix.com --max-time 30)
          echo "Main site status: $MAIN_STATUS"
          
          # Check analytics dashboard
          ANALYTICS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://chatterfix.com/analytics/dashboard --max-time 30)
          echo "Analytics status: $ANALYTICS_STATUS"
          
          # Check API health
          API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://chatterfix.com/health --max-time 30)
          echo "API health status: $API_STATUS"
          
          # Set outputs for notification
          echo "main_status=$MAIN_STATUS" >> $GITHUB_OUTPUT
          echo "analytics_status=$ANALYTICS_STATUS" >> $GITHUB_OUTPUT
          echo "api_status=$API_STATUS" >> $GITHUB_OUTPUT
          
          # Check if any service is down
          if [ "$MAIN_STATUS" -ge 500 ] || [ "$API_STATUS" -ge 500 ]; then
            echo "service_down=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "service_down=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Notify on Slack (if configured)
        if: failure()
        run: |
          echo "ğŸš¨ Service health check failed!"
          echo "Main: ${{ steps.health-check.outputs.main_status }}"
          echo "Analytics: ${{ steps.health-check.outputs.analytics_status }}"
          echo "API: ${{ steps.health-check.outputs.api_status }}"
          # Add Slack webhook notification here if desired
          
  performance-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Performance Test
        run: |
          echo "âš¡ Running performance tests..."
          
          # Test response time
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}\n' https://chatterfix.com)
          echo "Response time: ${RESPONSE_TIME}s"
          
          # Alert if response time > 5 seconds
          if (( $(echo "$RESPONSE_TIME > 5.0" | bc -l) )); then
            echo "ğŸŒ Slow response time detected: ${RESPONSE_TIME}s"
            exit 1
          fi
          
          echo "âœ… Performance check passed"