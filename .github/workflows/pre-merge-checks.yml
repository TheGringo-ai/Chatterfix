name: Pre-Merge Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install bandit safety pytest black flake8 mypy
      
      - name: Run Pre-Deployment Checks
        run: |
          chmod +x deployment/pre-deploy-check.sh
          ./deployment/pre-deploy-check.sh --skip-tests
      
      - name: Code Quality Check
        run: |
          echo "Running code quality checks..."
          black app/ --check || echo "⚠️ Code formatting issues found"
          flake8 app/ --max-line-length=100 --ignore=E203,W503 --count || echo "⚠️ Linting issues found"
      
      - name: Security Scan
        run: |
          echo "Running security scan..."
          bandit -r app/ -f json -o bandit-report.json || true
          if [ -f bandit-report.json ]; then
            echo "Security scan completed - check artifacts for report"
          fi
      
      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: bandit-report.json
      
      - name: Check for Breaking Changes
        run: |
          echo "Checking for potential breaking changes..."
          # Check if database schema files were modified
          if git diff --name-only origin/main | grep -E "(database|migration|schema)"; then
            echo "⚠️ WARNING: Database-related files were modified"
            echo "Please ensure migrations are backward compatible"
          fi
      
      - name: PR Check Summary
        if: always()
        run: |
          echo "✅ Pre-merge validation completed"
          echo "Review the checks above before merging"
