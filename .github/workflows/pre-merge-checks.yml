name: Pre-Merge Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  validation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit safety pytest black flake8 mypy
      
      - name: Run Pre-Deployment Checks
        run: |
          chmod +x deployment/pre-deploy-check.sh
          ./deployment/pre-deploy-check.sh --skip-tests
      
      - name: Code Quality Check
        run: |
          echo "Running code quality checks..."
          black app/ --check || echo "⚠️ Code formatting issues found"
          flake8 app/ --max-line-length=100 --ignore=E203,W503 --count || echo "⚠️ Linting issues found"
      
      - name: Quick Security Check
        run: |
          echo "Running quick security check..."
          echo "⚠️ For full security scan, see the Security Scan workflow"
          bandit -r app/ --severity-level high -q || echo "⚠️ High severity security issues found"
      
      - name: Check for Breaking Changes
        run: |
          echo "Checking for potential breaking changes..."
          # Check if database schema files were modified
          if git diff --name-only origin/main | grep -E "(database|migration|schema)"; then
            echo "⚠️ WARNING: Database-related files were modified"
            echo "Please ensure migrations are backward compatible"
          fi
      
      - name: PR Check Summary
        if: always()
        run: |
          echo "✅ Pre-merge validation completed"
          echo "Review the checks above before merging"
