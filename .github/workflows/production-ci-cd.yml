name: ğŸš€ ChatterFix Production Deployment

# Optimized CI/CD pipeline for ChatterFix CMMS
# Based on proven deployment patterns with reliability improvements

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip health checks and tests'
        required: false
        type: boolean
        default: false
      force_deploy:
        description: 'Force deployment even if tests fail'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: fredfix
  SERVICE_NAME: chatterfix-cmms
  REGION: us-central1
  MEMORY: 2Gi
  CPU: 1
  MIN_INSTANCES: 1
  MAX_INSTANCES: 10

permissions:
  contents: read
  id-token: write

jobs:
  # Quick validation job for safety
  validate:
    name: ğŸ” Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Validate basic dependencies
        run: |
          echo "ğŸ” Checking requirements.txt..."
          python -m pip install --upgrade pip
          pip install -r requirements.txt --dry-run
          echo "âœ… Dependencies validation passed"
      
      - name: Validate Docker build
        run: |
          echo "ğŸ³ Testing Docker build..."
          docker build --target builder --quiet .
          echo "âœ… Docker build validation passed"
      
      - name: Validate secrets
        run: |
          echo "ğŸ” Validating required secrets..."
          MISSING_SECRETS=()
          
          [ -z "${{ secrets.GCP_SA_KEY }}" ] && MISSING_SECRETS+=("GCP_SA_KEY")
          [ -z "${{ secrets.FIREBASE_API_KEY }}" ] && MISSING_SECRETS+=("FIREBASE_API_KEY")
          [ -z "${{ secrets.GEMINI_API_KEY }}" ] && MISSING_SECRETS+=("GEMINI_API_KEY")
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Missing critical secrets: ${MISSING_SECRETS[*]}"
            exit 1
          fi
          
          echo "âœ… All required secrets validated"

  # Main deployment job
  deploy:
    name: ğŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    if: github.ref == 'refs/heads/main' && (needs.validate.result == 'success' || github.event.inputs.force_deploy == 'true')
    
    environment:
      name: production
      url: https://chatterfix.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker --quiet
      
      - name: Get Current Revision (for rollback)
        id: current_revision
        run: |
          CURRENT=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --format='value(status.latestReadyRevisionName)' 2>/dev/null || echo "none")
          echo "revision=$CURRENT" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Current active revision: $CURRENT"
      
      - name: Build Docker Image
        id: build
        run: |
          IMAGE_TAG="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          IMAGE_LATEST="gcr.io/${{ env.PROJECT_ID }}/${{ env.SERVICE_NAME }}:latest"
          
          echo "ğŸ—ï¸ Building Docker image..."
          docker build \
            --platform linux/amd64 \
            --tag "$IMAGE_TAG" \
            --tag "$IMAGE_LATEST" \
            --build-arg USE_FIRESTORE=true \
            --build-arg GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }} \
            .
          
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_latest=$IMAGE_LATEST" >> $GITHUB_OUTPUT
          echo "âœ… Docker image built successfully"
      
      - name: Push Docker Image to GCR
        run: |
          echo "ğŸ“¤ Pushing image to Google Container Registry..."
          docker push ${{ steps.build.outputs.image_tag }}
          docker push ${{ steps.build.outputs.image_latest }}
          echo "âœ… Image pushed to GCR"
      
      - name: Deploy to Cloud Run
        id: deploy
        run: |
          echo "ğŸš€ Deploying to Cloud Run..."
          
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image=${{ steps.build.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=${{ env.MEMORY }} \
            --cpu=${{ env.CPU }} \
            --min-instances=${{ env.MIN_INSTANCES }} \
            --max-instances=${{ env.MAX_INSTANCES }} \
            --timeout=300 \
            --concurrency=80 \
            --set-env-vars="USE_FIRESTORE=true,GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},ENVIRONMENT=production,LOG_LEVEL=info,AI_TEAM_SERVICE_URL=https://ai-team-service-650169261019.us-central1.run.app,FIREBASE_API_KEY=${{ secrets.FIREBASE_API_KEY }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }},GROK_API_KEY=${{ secrets.GROK_API_KEY }}" \
            --labels=managed-by=github-actions,environment=production,version=${{ github.sha }} \
            --quiet
          
          echo "âœ… Deployment completed"
      
      - name: Get Service URL
        id: service_url
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          REVISION=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.latestReadyRevisionName)')
          
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "revision=$REVISION" >> $GITHUB_OUTPUT
          echo "ğŸŒ Service URL: $URL"
          echo "ğŸ“¦ New Revision: $REVISION"
      
      - name: Wait for Deployment Stabilization
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30
          echo "âœ… Deployment stabilization complete"
      
      - name: Health Check
        id: health_check
        if: ${{ !inputs.skip_tests }}
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "ğŸ¥ Running health check on $SERVICE_URL/health"
          
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Health check attempt $i/$MAX_RETRIES..."
            
            if curl -f --max-time 15 "$SERVICE_URL/health"; then
              echo "âœ… Health check passed!"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "âŒ Health check failed after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "âš ï¸ Retrying in 10 seconds..."
              sleep 10
            fi
          done
      
      - name: Smoke Tests
        if: ${{ !inputs.skip_tests }}
        continue-on-error: true
        run: |
          SERVICE_URL="${{ steps.service_url.outputs.url }}"
          echo "ğŸ§ª Running smoke tests..."
          
          # Test root endpoint
          echo "Testing root endpoint..."
          curl -f "$SERVICE_URL" --max-time 10 --silent > /dev/null && echo "âœ… Root endpoint OK" || echo "âš ï¸ Root endpoint issue"
          
          # Test custom domain
          echo "Testing custom domain..."
          curl -f "https://chatterfix.com/" --max-time 10 --silent > /dev/null && echo "âœ… Custom domain OK" || echo "âš ï¸ Custom domain issue"
          
          echo "âœ… Smoke tests completed"
      
      - name: Deployment Success Summary
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                 ğŸ‰ DEPLOYMENT SUCCESSFUL                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸŒ Service URL: ${{ steps.service_url.outputs.url }}"
          echo "ğŸ·ï¸ Revision: ${{ steps.service_url.outputs.revision }}"
          echo "ğŸŒ Custom Domain: https://chatterfix.com"
          echo "ğŸ“Š Memory: ${{ env.MEMORY }}, CPU: ${{ env.CPU }}"
          echo "ğŸ”§ Environment: Production"
          echo ""
          echo "ğŸš€ ChatterFix CMMS is live and operational!"
      
      - name: Rollback on Failure
        if: failure() && steps.current_revision.outputs.revision != 'none'
        run: |
          echo "âŒ Deployment failed - initiating rollback..."
          
          PREVIOUS_REVISION="${{ steps.current_revision.outputs.revision }}"
          
          gcloud run services update-traffic ${{ env.SERVICE_NAME }} \
            --to-revisions="$PREVIOUS_REVISION=100" \
            --region=${{ env.REGION }}
          
          echo "â†©ï¸ Rolled back to revision: $PREVIOUS_REVISION"
          
          # Verify rollback
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          
          if curl -f "$SERVICE_URL/health" --max-time 15 --silent > /dev/null; then
            echo "âœ… Rollback successful - service is healthy"
          else
            echo "âŒ Rollback verification failed - manual intervention required"
            exit 1
          fi
      
      - name: Failure Summary
        if: failure()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                   âŒ DEPLOYMENT FAILED                         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Check the logs above for details."
          echo ""
          echo "Manual rollback command:"
          echo "gcloud run services update-traffic ${{ env.SERVICE_NAME }} \\"
          echo "  --to-revisions=${{ steps.current_revision.outputs.revision }}=100 \\"
          echo "  --region ${{ env.REGION }}"