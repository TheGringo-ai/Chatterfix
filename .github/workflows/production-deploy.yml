name: üöÄ Production Deployment - Smart Monorepo

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1

jobs:
  # üß† Detect Changes - Smart Path Filtering
  changes:
    runs-on: ubuntu-latest
    outputs:
      monolith: ${{ steps.filter.outputs.monolith }}
      predictor: ${{ steps.filter.outputs.predictor }}
      linesmart: ${{ steps.filter.outputs.linesmart }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            monolith:
              - 'app/**'
              - 'Dockerfile'
              - 'main.py'
              - 'requirements.txt'
              - 'deploy.sh'
            predictor:
              - 'services/predictive-engine/**'
            linesmart:
              - 'services/linesmart-training-service/**'

  # üè≠ Job A: ChatterFix Core Monolith
  deploy-monolith:
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.monolith == 'true' }}
    steps:
      - name: üöö Checkout Repository
        uses: actions/checkout@v4

      - name: üîê Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ‚öôÔ∏è Configure Docker for GCR
        run: gcloud auth configure-docker --quiet

      - name: üê≥ Build and Push Docker Image
        run: |
          docker build -t gcr.io/${{ env.PROJECT_ID }}/gringo-core:latest .
          docker push gcr.io/${{ env.PROJECT_ID }}/gringo-core:latest

      - name: üöÄ Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gringo-core
          image: gcr.io/${{ env.PROJECT_ID }}/gringo-core:latest
          region: ${{ env.REGION }}
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --concurrency=100
            --max-instances=10
            --timeout=300
            --port=8080
            --set-env-vars=ENVIRONMENT=production,GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }},ALLOWED_HOSTS="*"

      - name: üß™ Health Check
        run: |
          SERVICE_URL=$(gcloud run services describe gringo-core --region=${{ env.REGION }} --format="value(status.url)")
          echo "üåç Deployed URL: $SERVICE_URL"
          
          # Wait for deployment to be ready
          sleep 10
          
          # Test health endpoint
          if curl -s -f "$SERVICE_URL/health" > /dev/null; then
            echo "‚úÖ Health check passed!"
          else
            echo "‚ö†Ô∏è Health check failed"
            exit 1
          fi