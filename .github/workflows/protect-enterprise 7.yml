name: ChatterFix Enterprise Architecture Protection

on:
  pull_request:
    branches: [ main, main-clean ]
  push:
    branches: [ main, main-clean ]

jobs:
  enforce-structure:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Check for unauthorized root files
      run: |
        echo "üîç Checking for new root-level files..."
        NEW_ROOT_FILES=$(git diff --name-only --diff-filter=A HEAD~1 | grep -E '^[^/]+\.(py|js|ts|sh)$' || true)
        if [ ! -z "$NEW_ROOT_FILES" ]; then
          echo "‚ùå ERROR: New root-level files detected:"
          echo "$NEW_ROOT_FILES"
          echo "All new code must go in frontend/, backend/, ai/, or infra/ directories"
          exit 1
        fi
        echo "‚úÖ No unauthorized root files"
        
    - name: Enforce directory structure
      run: |
        echo "üîç Validating directory structure..."
        for file in $(git diff --name-only --diff-filter=A HEAD~1); do
          if [[ "$file" =~ \.(py|js|ts|tsx)$ ]]; then
            if [[ ! "$file" =~ ^(frontend/|backend/|ai/|infra/|docs/|legacy/|\\.github/) ]]; then
              echo "‚ùå ERROR: File in wrong location: $file"
              echo "Code must be in: frontend/, backend/, ai/, infra/, docs/, or legacy/"
              exit 1
            fi
          fi
        done
        echo "‚úÖ Directory structure validated"
        
    - name: Check file count limits
      run: |
        echo "üîç Checking file count limits..."
        NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 | wc -l)
        if [ "$NEW_FILES" -gt 30 ]; then
          echo "‚ùå ERROR: Too many new files ($NEW_FILES > 30)"
          echo "Large changes should be split into smaller PRs"
          exit 1
        fi
        echo "‚úÖ File count acceptable ($NEW_FILES files)"
        
    - name: Require labels for architecture changes
      if: github.event_name == 'pull_request'
      run: |
        echo "üîç Checking for architecture change labels..."
        CHANGED_DIRS=$(git diff --name-only HEAD~1 | cut -d'/' -f1 | sort -u)
        
        # Check if PR has required labels based on changed directories
        if echo "$CHANGED_DIRS" | grep -q "ai"; then
          echo "AI directory changes detected - requires 'ai-changes' label"
        fi
        if echo "$CHANGED_DIRS" | grep -q "infra"; then
          echo "Infrastructure changes detected - requires 'infra-changes' label"  
        fi
        if echo "$CHANGED_DIRS" | grep -q "backend"; then
          echo "Backend changes detected - requires 'backend-changes' label"
        fi
        echo "‚úÖ Architecture change validation complete"
        
    - name: Validate import paths
      run: |
        echo "üîç Validating import paths..."
        INVALID_IMPORTS=$(grep -r "from core\.cmms\." --include="*.py" . || true)
        if [ ! -z "$INVALID_IMPORTS" ]; then
          echo "‚ùå ERROR: Legacy import paths detected:"
          echo "$INVALID_IMPORTS"
          echo "Update imports to use new structure (backend.app.*, ai.services.*)"
          exit 1
        fi
        echo "‚úÖ Import paths validated"
        
    - name: Check for required documentation
      run: |
        echo "üîç Checking documentation requirements..."
        if git diff --name-only HEAD~1 | grep -E "(backend/|ai/|infra/)" | head -1 > /dev/null; then
          echo "Architecture changes detected - documentation update recommended"
          if ! git diff --name-only HEAD~1 | grep -q "docs/"; then
            echo "‚ö†Ô∏è  Consider updating documentation in docs/ directory"
          fi
        fi
        echo "‚úÖ Documentation check complete"

  test-build:
    runs-on: ubuntu-latest
    needs: enforce-structure
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: Test backend imports
      run: |
        echo "üîç Testing backend service imports..."
        python3 -c "
        import sys
        import os
        
        # Test that moved files can be imported
        try:
            # Add backend to path for testing
            sys.path.insert(0, 'backend/app')
            
            # Test key imports (if files exist)
            test_files = [
                'backend/app/main.py',
                'backend/app/api/work_orders.py', 
                'backend/app/api/assets.py'
            ]
            
            for file_path in test_files:
                if os.path.exists(file_path):
                    with open(file_path, 'r') as f:
                        compile(f.read(), file_path, 'exec')
                    print(f'‚úÖ Syntax OK: {file_path}')
                else:
                    print(f'‚ö†Ô∏è  Skipped: {file_path} (not found)')
                    
        except Exception as e:
            print(f'‚ùå Import test failed: {e}')
            sys.exit(1)
        "
        
    - name: Summary
      run: |
        echo "üéâ ChatterFix Enterprise Architecture Protection Complete"
        echo "‚úÖ Structure enforced"
        echo "‚úÖ Import paths validated" 
        echo "‚úÖ File limits respected"
        echo "‚úÖ Build tests passed"