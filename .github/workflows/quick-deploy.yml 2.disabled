name: âš¡ Quick Deploy (Hot Reload)

on:
  push:
    branches: [main]
    paths:
      - 'vm-deployment/app.py'
      - 'quick-patches/**'
  workflow_dispatch:
    inputs:
      patch_file:
        description: 'Specific file to patch'
        required: false
        default: 'app.py'

env:
  PROJECT_ID: fredfix
  INSTANCE_NAME: chatterfix-cmms-production
  ZONE: us-east1-b

jobs:
  quick-deploy:
    name: âš¡ Quick Hot Reload
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup GCP Authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: âš¡ Hot Reload Application
        run: |
          echo "âš¡ Starting hot reload deployment..."
          
          # Create hot reload script
          cat > /tmp/hot-reload.sh << 'EOFHOT'
          #!/bin/bash
          
          echo "ğŸ”¥ Hot reloading ChatterFix..."
          
          # Backup current app
          cd /opt/chatterfix-unified
          cp app.py app_backup_$(date +%Y%m%d_%H%M%S).py
          
          # Download latest version
          echo "ğŸ“¥ Downloading latest app.py..."
          curl -L https://raw.githubusercontent.com/TheGringo-ai/Chatterfix/main/vm-deployment/app.py -o app_new.py
          
          # Verify download
          if [ -s app_new.py ]; then
            echo "âœ… New version downloaded"
            mv app_new.py app.py
            
            # Reload service (graceful restart)
            echo "ğŸ”„ Reloading service..."
            sudo systemctl reload chatterfix || sudo systemctl restart chatterfix
            
            echo "âœ… Hot reload complete!"
          else
            echo "âŒ Download failed, keeping current version"
          fi
          EOFHOT
          
          # Deploy and execute hot reload
          gcloud compute scp /tmp/hot-reload.sh $INSTANCE_NAME:~/hot-reload.sh --zone=$ZONE
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="chmod +x ~/hot-reload.sh && ~/hot-reload.sh"

      - name: ğŸ©º Verify Hot Reload
        run: |
          echo "ğŸ©º Verifying hot reload..."
          sleep 5
          
          VM_IP=$(gcloud compute instances describe $INSTANCE_NAME --zone=$ZONE --format="value(networkInterfaces[0].accessConfigs[0].natIP)")
          
          if curl -f --max-time 10 "http://$VM_IP:8080/health" > /dev/null 2>&1; then
            echo "âœ… Hot reload successful - app is healthy"
          else
            echo "âš ï¸ App may still be reloading..."
          fi

      - name: ğŸ“Š Hot Reload Report
        run: |
          echo "âš¡ HOT RELOAD COMPLETE!"
          echo "===================="
          echo "âœ… Changes applied without full deployment"
          echo "âœ… Service reloaded gracefully"
          echo "âœ… Zero downtime deployment"
          echo ""
          echo "ğŸ”— App: http://35.237.149.25:8080"
          echo "ğŸ©º Health: http://35.237.149.25:8080/health"