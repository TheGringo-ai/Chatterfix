name: 🧪 Test GCP Authentication

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/test-gcp-auth.yml'

env:
  PROJECT_ID: fredfix
  INSTANCE_NAME: chatterfix-cmms-production
  ZONE: us-east1-b

jobs:
  test-auth:
    name: 🔐 Test GCP Authentication
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🔍 Check Credentials
        id: creds
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "has-creds=true" >> $GITHUB_OUTPUT
            echo "✅ GCP_SA_KEY secret is available"
          else
            echo "has-creds=false" >> $GITHUB_OUTPUT
            echo "❌ GCP_SA_KEY secret is missing"
          fi

      - name: 🔑 Setup GCP Authentication
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ☁️ Set up Cloud SDK
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: 🧪 Test VM Connection
        if: steps.creds.outputs.has-creds == 'true'
        run: |
          echo "🧪 Testing SSH connection to VM..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="echo 'SSH test successful' && whoami && uptime"

      - name: ✅ Test Complete
        run: |
          echo "🎉 GCP Authentication test completed!"
          if [ "${{ steps.creds.outputs.has-creds }}" == "true" ]; then
            echo "✅ All tests passed"
          else
            echo "⚠️ Missing credentials - configure GCP_SA_KEY secret"
          fi