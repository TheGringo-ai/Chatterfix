name: ğŸ§ª Test GCP Authentication

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/test-gcp-auth.yml'

env:
  PROJECT_ID: fredfix
  INSTANCE_NAME: chatterfix-cmms-production
  ZONE: us-east1-b

jobs:
  test-auth:
    name: ğŸ” Test GCP Authentication
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Check Credentials
        id: creds
        run: |
          if [ -n "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "has-creds=true" >> $GITHUB_OUTPUT
            echo "âœ… GCP_SA_KEY secret is available"
          else
            echo "has-creds=false" >> $GITHUB_OUTPUT
            echo "âŒ GCP_SA_KEY secret is missing"
          fi

      - name: ğŸ”‘ Setup GCP Authentication
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: â˜ï¸ Set up Cloud SDK
        if: steps.creds.outputs.has-creds == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸ§ª Test VM Connection
        if: steps.creds.outputs.has-creds == 'true'
        run: |
          echo "ğŸ§ª Testing SSH connection to VM..."
          gcloud compute ssh $INSTANCE_NAME --zone=$ZONE --command="echo 'SSH test successful' && whoami && uptime"

      - name: âœ… Test Complete
        run: |
          echo "ğŸ‰ GCP Authentication test completed!"
          if [ "${{ steps.creds.outputs.has-creds }}" == "true" ]; then
            echo "âœ… All tests passed"
          else
            echo "âš ï¸ Missing credentials - configure GCP_SA_KEY secret"
          fi