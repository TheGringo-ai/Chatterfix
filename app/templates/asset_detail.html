{% extends "base.html" %}

{% block title %}{{ asset.name }} - Asset Details{% endblock %}

{% block head %}
<style>
    .asset-detail-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .section-card {
        background: linear-gradient(135deg, rgba(30, 60, 114, 0.6) 0%, rgba(42, 82, 152, 0.6) 100%);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .section-header h3 {
        margin: 0;
        font-size: 1.2rem;
    }

    .media-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
    }

    .media-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
        background: var(--bg-tertiary);
        cursor: pointer;
        transition: transform 0.3s;
    }

    .media-item:hover {
        transform: scale(1.05);
    }

    .media-item img,
    .media-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
        border-left: 2px solid rgba(255, 255, 255, 0.2);
        padding-left: 1.5rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -6px;
        top: 0;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #3498db;
    }

    .health-score {
        text-align: center;
        padding: 2rem;
    }

    .health-score-circle {
        width: 150px;
        height: 150px;
        margin: 0 auto;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        font-weight: bold;
        position: relative;
    }

    .spec-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .spec-item {
        background: var(--bg-glass);
        padding: 1rem;
        border-radius: 8px;
    }

    .spec-label {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-bottom: 0.3rem;
    }

    .spec-value {
        font-size: 1.1rem;
        font-weight: 600;
    }

    @media (max-width: 1024px) {
        .asset-detail-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Asset Header -->
<div class="cmms-header">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <h1>{{ asset.name }}</h1>
                <span
                    class="cmms-badge {% if asset.status == 'Active' %}badge-operational{% elif asset.status == 'Maintenance' %}badge-maintenance{% else %}badge-down{% endif %}">
                    {{ asset.status }}
                </span>
                <span
                    style="color: {% if asset.criticality == 'Critical' %}#e74c3c{% elif asset.criticality == 'High' %}#f39c12{% else %}#3498db{% endif %};">
                    <i class="fas fa-exclamation-triangle"></i> {{ asset.criticality }}
                </span>
            </div>
            <p>{{ asset.description or 'No description' }}</p>
            <div style="font-size: 0.9rem; opacity: 0.8;">
                <span>üìç {{ asset.location or 'No Location' }}</span> ‚Ä¢
                <span>üè∑Ô∏è {{ asset.asset_tag or 'No Tag' }}</span> ‚Ä¢
                <span>üî¢ {{ asset.serial_number or 'No Serial' }}</span>
            </div>
        </div>
        <div style="text-align: right; display: flex; gap: 0.5rem;">
            <button class="cmms-btn" onclick="document.getElementById('editAssetModal').style.display='block'">
                <i class="fas fa-edit"></i> Edit Asset
            </button>
            <button class="cmms-btn-secondary" onclick="window.location.href='/assets'">
                <i class="fas fa-arrow-left"></i> Back to Assets
            </button>
        </div>
    </div>
</div>

<!-- Edit Asset Modal -->
<div id="editAssetModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Asset</h2>
            <button class="modal-close" onclick="document.getElementById('editAssetModal').style.display='none'">&times;</button>
        </div>
        <form action="/assets/{{ asset.id }}/update" method="POST">
            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Asset Name *</label>
                    <input type="text" name="name" value="{{ asset.name }}" required>
                </div>
                <div class="form-group">
                    <label>Asset Tag</label>
                    <input type="text" name="asset_tag" value="{{ asset.asset_tag or '' }}">
                </div>
                <div class="form-group" style="grid-column: span 2;">
                    <label>Description</label>
                    <textarea name="description" rows="2">{{ asset.description or '' }}</textarea>
                </div>
                <div class="form-group">
                    <label>Serial Number</label>
                    <input type="text" name="serial_number" value="{{ asset.serial_number or '' }}">
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" name="model" value="{{ asset.model or '' }}">
                </div>
                <div class="form-group">
                    <label>Manufacturer</label>
                    <input type="text" name="manufacturer" value="{{ asset.manufacturer or '' }}">
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location" value="{{ asset.location or '' }}">
                </div>
                <div class="form-group">
                    <label>Department</label>
                    <input type="text" name="department" value="{{ asset.department or '' }}">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active" {% if asset.status == 'Active' %}selected{% endif %}>Active</option>
                        <option value="Inactive" {% if asset.status == 'Inactive' %}selected{% endif %}>Inactive</option>
                        <option value="Maintenance" {% if asset.status == 'Maintenance' %}selected{% endif %}>Maintenance</option>
                        <option value="Retired" {% if asset.status == 'Retired' %}selected{% endif %}>Retired</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Criticality</label>
                    <select name="criticality">
                        <option value="Low" {% if asset.criticality == 'Low' %}selected{% endif %}>Low</option>
                        <option value="Medium" {% if asset.criticality == 'Medium' %}selected{% endif %}>Medium</option>
                        <option value="High" {% if asset.criticality == 'High' %}selected{% endif %}>High</option>
                        <option value="Critical" {% if asset.criticality == 'Critical' %}selected{% endif %}>Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Condition Rating (1-10)</label>
                    <input type="number" name="condition_rating" min="1" max="10" value="{{ asset.condition_rating or 5 }}">
                </div>
                <div class="form-group">
                    <label>Purchase Date</label>
                    <input type="date" name="purchase_date" value="{{ asset.purchase_date or '' }}">
                </div>
                <div class="form-group">
                    <label>Warranty Expiry</label>
                    <input type="date" name="warranty_expiry" value="{{ asset.warranty_expiry or '' }}">
                </div>
                <div class="form-group">
                    <label>Purchase Cost ($)</label>
                    <input type="number" step="0.01" name="purchase_cost" value="{{ asset.purchase_cost or '' }}">
                </div>
            </div>
            <div class="form-actions" style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="cmms-btn-secondary" onclick="document.getElementById('editAssetModal').style.display='none'">
                    Cancel
                </button>
                <button type="submit" class="cmms-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<div class="asset-detail-grid">
    <!-- Left Column -->
    <div>
        <!-- AI Health Dashboard -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-robot"></i> AI Health Analysis</h3>
                <button class="cmms-btn cmms-btn-sm" onclick="refreshHealthScore()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div class="health-score">
                <div id="health-score-display" class="health-score-circle"
                    style="background: conic-gradient(#27ae60 0% 75%, rgba(255,255,255,0.1) 75% 100%);">
                    <span id="health-score-value">75</span>
                </div>
                <div style="margin-top: 1rem;">
                    <div id="health-risk" style="font-size: 1.2rem; font-weight: 600;">Medium Risk</div>
                    <div id="health-analysis" style="margin-top: 0.5rem; opacity: 0.8;">Loading AI analysis...</div>
                </div>
            </div>
        </div>

        <!-- Media Gallery (Images & Videos) -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-images"></i> Photos & Videos</h3>
                <button class="cmms-btn cmms-btn-sm"
                    onclick="document.getElementById('uploadMediaModal').style.display='block'">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
            <div class="media-gallery">
                {% set image_video_media = media|selectattr("file_type", "in", ["image", "video"])|list %}
                {% for item in image_video_media %}
                <div class="media-item" onclick="viewMedia('{{ item.file_path }}', '{{ item.file_type }}')">
                    {% if item.file_type == 'image' %}
                    <img src="/{{ item.file_path }}" alt="{{ item.title }}">
                    {% elif item.file_type == 'video' %}
                    <video src="/{{ item.file_path }}"></video>
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem;">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% if not image_video_media %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; opacity: 0.5;">
                    No photos or videos uploaded yet
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Documents & Manuals -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-folder-open"></i> Documents & Manuals</h3>
                <button class="cmms-btn cmms-btn-sm"
                    onclick="document.getElementById('uploadMediaModal').style.display='block'">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
            <div class="documents-list">
                {% set document_media = media|rejectattr("file_type", "in", ["image", "video"])|list %}
                {% for doc in document_media %}
                <div class="document-item" onclick="viewMedia('{{ doc.file_path }}', '{{ doc.file_type }}')"
                     style="display: flex; align-items: center; padding: 1rem; background: var(--bg-glass); border-radius: 8px; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s;">
                    <div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        {% if doc.file_path.endswith('.pdf') %}
                        <i class="fas fa-file-pdf" style="font-size: 1.5rem; color: #e74c3c;"></i>
                        {% elif doc.file_path.endswith('.doc') or doc.file_path.endswith('.docx') %}
                        <i class="fas fa-file-word" style="font-size: 1.5rem; color: #2b579a;"></i>
                        {% elif doc.file_path.endswith('.xls') or doc.file_path.endswith('.xlsx') %}
                        <i class="fas fa-file-excel" style="font-size: 1.5rem; color: #217346;"></i>
                        {% elif doc.file_path.endswith('.ppt') or doc.file_path.endswith('.pptx') %}
                        <i class="fas fa-file-powerpoint" style="font-size: 1.5rem; color: #d24726;"></i>
                        {% elif doc.file_path.endswith('.txt') %}
                        <i class="fas fa-file-alt" style="font-size: 1.5rem; color: #6c757d;"></i>
                        {% else %}
                        <i class="fas fa-file" style="font-size: 1.5rem; color: #3498db;"></i>
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">{{ doc.title or doc.file_path.split('/')|last }}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">
                            <span class="cmms-badge" style="font-size: 0.7rem; padding: 2px 8px;">
                                {% if doc.file_type == 'manual' %}üìñ Manual
                                {% elif doc.file_type == 'datasheet' %}üìä Datasheet
                                {% elif doc.file_type == 'warranty' %}üìú Warranty
                                {% elif doc.file_type == 'certificate' %}üèÜ Certificate
                                {% else %}üìÑ Document{% endif %}
                            </span>
                            {% if doc.description %}
                            <span style="margin-left: 0.5rem;">{{ doc.description }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <a href="/{{ doc.file_path }}" download onclick="event.stopPropagation();"
                           class="cmms-btn cmms-btn-sm" style="background: rgba(255,255,255,0.1);">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
                {% if not document_media %}
                <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                    <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div>No documents uploaded yet</div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                        Upload equipment manuals, datasheets, warranty docs, etc.
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Specifications -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-info-circle"></i> Specifications</h3>
            </div>
            <div class="spec-grid">
                <div class="spec-item">
                    <div class="spec-label">Model</div>
                    <div class="spec-value">{{ asset.model or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Manufacturer</div>
                    <div class="spec-value">{{ asset.manufacturer or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Serial Number</div>
                    <div class="spec-value">{{ asset.serial_number or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Asset Tag</div>
                    <div class="spec-value">{{ asset.asset_tag or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Department</div>
                    <div class="spec-value">{{ asset.department or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Condition Rating</div>
                    <div class="spec-value">{{ asset.condition_rating or 5 }}/10</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Purchase Date</div>
                    <div class="spec-value">{{ asset.purchase_date or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Warranty Expiry</div>
                    <div class="spec-value">{{ asset.warranty_expiry or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Purchase Cost</div>
                    <div class="spec-value">${{ asset.purchase_cost or 0 }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Installation Date</div>
                    <div class="spec-value">{{ asset.installation_date or 'N/A' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Last Service</div>
                    <div class="spec-value">{{ asset.last_service_date or 'Never' }}</div>
                </div>
                <div class="spec-item">
                    <div class="spec-label">Next Service</div>
                    <div class="spec-value">{{ asset.next_service_date or 'Not Scheduled' }}</div>
                </div>
            </div>
        </div>

        <!-- Associated Parts -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-cog"></i> Associated Parts ({{ parts|length }})</h3>
                <button class="cmms-btn cmms-btn-sm" onclick="alert('Add parts feature coming soon')">
                    <i class="fas fa-plus"></i> Add Part
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table class="cmms-table">
                    <thead>
                        <tr>
                            <th>Part Name</th>
                            <th>Part Number</th>
                            <th>Stock</th>
                            <th>Last Replaced</th>
                            <th>Interval (days)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for part in parts %}
                        <tr>
                            <td>{{ part.name }}</td>
                            <td>{{ part.part_number }}</td>
                            <td>
                                <span
                                    style="color: {% if part.current_stock <= part.minimum_stock %}#e74c3c{% else %}#27ae60{% endif %};">
                                    {{ part.current_stock }}
                                </span>
                            </td>
                            <td>{{ part.last_replaced or 'Never' }}</td>
                            <td>{{ part.replacement_interval_days or 'N/A' }}</td>
                        </tr>
                        {% endfor %}
                        {% if not parts %}
                        <tr>
                            <td colspan="5" style="text-align: center; opacity: 0.5;">No parts associated</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Maintenance History -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-history"></i> Maintenance History ({{ history|length }})</h3>
                <button class="cmms-btn cmms-btn-sm"
                    onclick="document.getElementById('logMaintenanceModal').style.display='block'">
                    <i class="fas fa-plus"></i> Log Event
                </button>
            </div>
            <div class="timeline">
                {% for event in history %}
                <div class="timeline-item">
                    <div style="font-weight: 600; margin-bottom: 0.3rem;">
                        {{ event.maintenance_type }} - {{ event.description }}
                    </div>
                    <div style="font-size: 0.85rem; opacity: 0.7;">
                        <div>üë§ {{ event.technician or 'Unknown' }}</div>
                        <div>üí∞ Cost: ${{ event.total_cost or 0 }} (Labor: ${{ event.labor_cost or 0 }}, Parts: ${{
                            event.parts_cost or 0 }})</div>
                        <div>‚è±Ô∏è Downtime: {{ event.downtime_hours or 0 }} hours</div>
                        <div>üìÖ {{ event.created_date }}</div>
                    </div>
                </div>
                {% endfor %}
                {% if not history %}
                <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                    No maintenance history recorded
                </div>
                {% endif %}
            </div>
        </div>

        <!-- PM Schedule Section -->
        <div class="section-card" id="pm-schedule-section">
            <div class="section-header">
                <h3><i class="fas fa-calendar-check"></i> PM Schedule</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="cmms-btn cmms-btn-sm" onclick="generateAIPMSchedule()" id="aiGenerateBtn">
                        <i class="fas fa-robot"></i> AI Generate from Manuals
                    </button>
                    <button class="cmms-btn cmms-btn-sm" onclick="document.getElementById('addPMModal').style.display='block'">
                        <i class="fas fa-plus"></i> Add PM
                    </button>
                </div>
            </div>

            <!-- AI Analysis Status -->
            <div id="ai-pm-status" style="display: none; margin-bottom: 1rem; padding: 1rem; background: rgba(52, 152, 219, 0.2); border-radius: 8px; border-left: 4px solid #3498db;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-spinner fa-spin" id="ai-pm-spinner"></i>
                    <span id="ai-pm-message">Analyzing equipment manuals...</span>
                </div>
            </div>

            <!-- PM Schedule Table -->
            <div style="overflow-x: auto;">
                <table class="cmms-table" id="pm-schedule-table">
                    <thead>
                        <tr>
                            <th>Task</th>
                            <th>Type</th>
                            <th>Frequency</th>
                            <th>Next Due</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pm-schedule-body">
                        {% for pm in pm_schedules %}
                        <tr data-pm-id="{{ pm.id }}">
                            <td>
                                <strong>{{ pm.title }}</strong>
                                {% if pm.description %}
                                <div style="font-size: 0.8rem; opacity: 0.7;">{{ pm.description[:50] }}{% if pm.description|length > 50 %}...{% endif %}</div>
                                {% endif %}
                            </td>
                            <td>
                                <span class="cmms-badge" style="font-size: 0.75rem;">
                                    {% if pm.schedule_type == 'time_based' %}‚è∞ Time
                                    {% elif pm.schedule_type == 'usage_based' %}üìä Usage
                                    {% elif pm.schedule_type == 'condition_based' %}üîç Condition
                                    {% else %}üìã {{ pm.schedule_type }}{% endif %}
                                </span>
                            </td>
                            <td>
                                {% if pm.interval_days %}Every {{ pm.interval_days }} days
                                {% elif pm.interval_hours %}Every {{ pm.interval_hours }} hours
                                {% else %}As needed{% endif %}
                            </td>
                            <td>
                                {% if pm.next_due_date %}
                                <span style="color: {% if pm.is_overdue %}#e74c3c{% elif pm.due_soon %}#f39c12{% else %}#27ae60{% endif %};">
                                    {{ pm.next_due_date }}
                                </span>
                                {% else %}Not scheduled{% endif %}
                            </td>
                            <td>
                                <span class="cmms-badge badge-{{ pm.priority|lower if pm.priority else 'medium' }}">
                                    {{ pm.priority or 'Medium' }}
                                </span>
                            </td>
                            <td>
                                <button class="cmms-btn cmms-btn-sm" style="padding: 4px 8px;" onclick="editPM('{{ pm.id }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="cmms-btn cmms-btn-sm" style="padding: 4px 8px; background: #c0392b;" onclick="deletePM('{{ pm.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if not pm_schedules %}
                <div id="no-pm-message" style="text-align: center; padding: 2rem; opacity: 0.5;">
                    <i class="fas fa-calendar-plus" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <div>No PM schedules configured</div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem;">
                        Click "AI Generate from Manuals" to automatically create a PM schedule based on uploaded equipment documentation.
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- AI Generated Recommendations (shown after analysis) -->
            <div id="ai-pm-recommendations" style="display: none; margin-top: 1.5rem;">
                <div style="padding: 1rem; background: rgba(39, 174, 96, 0.2); border-radius: 8px; border-left: 4px solid #27ae60; margin-bottom: 1rem;">
                    <strong><i class="fas fa-magic"></i> AI-Generated PM Recommendations</strong>
                    <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem;">
                        Review and add these to your PM schedule:
                    </div>
                </div>
                <div id="ai-pm-list"></div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                    <button class="cmms-btn" onclick="addAllAIPMs()">
                        <i class="fas fa-check-double"></i> Add All to Schedule
                    </button>
                    <button class="cmms-btn" style="background: #555;" onclick="dismissAIRecommendations()">
                        Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Column -->
    <div>
        <!-- Cost Analytics -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-chart-line"></i> Cost Analytics</h3>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; color: #e74c3c;">
                    ${{ cost_data.total_cost or 0 }}
                </div>
                <div style="opacity: 0.7; margin-bottom: 1.5rem;">Total Maintenance Cost</div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div style="background: var(--bg-glass); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${{ cost_data.labor_cost or 0 }}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">Labor</div>
                    </div>
                    <div style="background: var(--bg-glass); padding: 1rem; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold;">${{ cost_data.parts_cost or 0 }}</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">Parts</div>
                    </div>
                    <div style="background: var(--bg-glass); padding: 1rem; border-radius: 8px; grid-column: 1 / -1;">
                        <div style="font-size: 1.5rem; font-weight: bold;">{{ cost_data.total_downtime or 0 }}h</div>
                        <div style="font-size: 0.85rem; opacity: 0.7;">Total Downtime</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Recommendations -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-lightbulb"></i> AI Recommendations</h3>
                <button class="cmms-btn cmms-btn-sm" onclick="loadRecommendations()">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>
            <div id="ai-recommendations">
                <div style="text-align: center; padding: 2rem; opacity: 0.5;">
                    Click refresh to generate AI recommendations
                </div>
            </div>
        </div>

        <!-- Child Assets -->
        {% if children %}
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-sitemap"></i> Child Assets ({{ children|length }})</h3>
            </div>
            <div>
                {% for child in children %}
                <div class="item-card" onclick="window.location.href='/assets/{{ child.id }}'"
                    style="margin-bottom: 0.5rem; cursor: pointer;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>{{ child.name }}</strong>
                            <div style="font-size: 0.85rem; opacity: 0.7;">{{ child.location }}</div>
                        </div>
                        <span
                            class="cmms-badge {% if child.status == 'Active' %}badge-operational{% else %}badge-down{% endif %}">
                            {{ child.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Related Work Orders -->
        <div class="section-card">
            <div class="section-header">
                <h3><i class="fas fa-tasks"></i> Work Orders ({{ work_orders|length }})</h3>
            </div>
            <div>
                {% for wo in work_orders[:5] %}
                <div class="item-card" style="margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>#{{ wo.id }} {{ wo.title }}</strong>
                            <div style="font-size: 0.85rem; opacity: 0.7;">{{ wo.created_date }}</div>
                        </div>
                        <span
                            class="cmms-badge {% if wo.status == 'Completed' %}badge-operational{% else %}badge-maintenance{% endif %}">
                            {{ wo.status }}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% if not work_orders %}
                <div style="text-align: center; padding: 1rem; opacity: 0.5;">
                    No related work orders
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Media Modal -->
<div id="uploadMediaModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 10% auto; width: 500px; padding: 30px;">
        <h2><i class="fas fa-upload"></i> Upload File</h2>
        <form action="/assets/{{ asset.id }}/media" method="post" enctype="multipart/form-data"
            style="margin-top: 20px;">
            <div style="margin-bottom: 1rem;">
                <label>File</label>
                <input type="file" name="file" class="form-control" required
                    accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.csv,.ppt,.pptx,.odt,.ods,.odp,.rtf,.xml,.json">
                <small style="opacity: 0.7;">Supported: Images, Videos, PDF, Word, Excel, PowerPoint, Text files</small>
            </div>
            <div style="margin-bottom: 1rem;">
                <label>File Type</label>
                <select name="file_type" class="form-control" id="fileTypeSelect">
                    <option value="image">Image/Photo</option>
                    <option value="video">Video</option>
                    <option value="manual">Equipment Manual</option>
                    <option value="document">General Document</option>
                    <option value="datasheet">Datasheet/Specs</option>
                    <option value="warranty">Warranty Document</option>
                    <option value="certificate">Certificate/Compliance</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label>Title *</label>
                <input type="text" name="title" class="form-control" required placeholder="e.g., Installation Manual, Service Guide">
            </div>
            <div style="margin-bottom: 1rem;">
                <label>Description</label>
                <textarea name="description" class="form-control" rows="2" placeholder="Optional notes about this file"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="submit" class="cmms-btn">
                    <i class="fas fa-cloud-upload-alt"></i> Upload
                </button>
                <button type="button" class="cmms-btn" style="background: #555;"
                    onclick="document.getElementById('uploadMediaModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Log Maintenance Modal -->
<div id="logMaintenanceModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 5% auto; width: 600px; padding: 30px;">
        <h2><i class="fas fa-wrench"></i> Log Maintenance Event</h2>
        <form action="/assets/{{ asset.id }}/maintenance" method="post" style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>Maintenance Type *</label>
                    <select name="maintenance_type" class="form-control" required>
                        <option value="Preventive">Preventive</option>
                        <option value="Corrective">Corrective</option>
                        <option value="Predictive">Predictive</option>
                        <option value="Emergency">Emergency</option>
                    </select>
                </div>
                <div>
                    <label>Technician</label>
                    <input type="text" name="technician" class="form-control">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Description *</label>
                    <textarea name="description" class="form-control" rows="3" required></textarea>
                </div>
                <div>
                    <label>Downtime (hours)</label>
                    <input type="number" step="0.1" name="downtime_hours" class="form-control" value="0">
                </div>
                <div>
                    <label>Labor Cost ($)</label>
                    <input type="number" step="0.01" name="labor_cost" class="form-control" value="0">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Parts Cost ($)</label>
                    <input type="number" step="0.01" name="parts_cost" class="form-control" value="0">
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 20px;">
                <button type="submit" class="cmms-btn">Log Event</button>
                <button type="button" class="cmms-btn" style="background: #555;"
                    onclick="document.getElementById('logMaintenanceModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add PM Schedule Modal -->
<div id="addPMModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content glass-panel" style="margin: 5% auto; width: 650px; padding: 30px;">
        <h2><i class="fas fa-calendar-plus"></i> Add PM Schedule</h2>
        <form id="addPMForm" style="margin-top: 20px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="grid-column: 1 / -1;">
                    <label>Task Title *</label>
                    <input type="text" name="title" id="pmTitle" class="form-control" required
                           placeholder="e.g., Quarterly Belt Inspection, Monthly Lubrication">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Description</label>
                    <textarea name="description" id="pmDescription" class="form-control" rows="2"
                              placeholder="Detailed instructions for this maintenance task"></textarea>
                </div>
                <div>
                    <label>Schedule Type *</label>
                    <select name="schedule_type" id="pmScheduleType" class="form-control" required>
                        <option value="time_based">‚è∞ Time-Based (Calendar)</option>
                        <option value="usage_based">üìä Usage-Based (Hours/Cycles)</option>
                        <option value="condition_based">üîç Condition-Based</option>
                        <option value="preventive">üìã Preventive</option>
                        <option value="inspection">üîé Inspection</option>
                    </select>
                </div>
                <div>
                    <label>Priority *</label>
                    <select name="priority" id="pmPriority" class="form-control" required>
                        <option value="Low">Low</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="High">High</option>
                        <option value="Critical">Critical</option>
                    </select>
                </div>
                <div>
                    <label>Interval (Days)</label>
                    <input type="number" name="interval_days" id="pmIntervalDays" class="form-control"
                           placeholder="e.g., 30, 90, 365" min="1">
                </div>
                <div>
                    <label>Interval (Hours)</label>
                    <input type="number" name="interval_hours" id="pmIntervalHours" class="form-control"
                           placeholder="e.g., 500, 1000" min="1">
                </div>
                <div>
                    <label>First Due Date</label>
                    <input type="date" name="next_due_date" id="pmNextDueDate" class="form-control">
                </div>
                <div>
                    <label>Estimated Duration (hours)</label>
                    <input type="number" step="0.5" name="estimated_hours" id="pmEstimatedHours"
                           class="form-control" placeholder="e.g., 2" min="0.5">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Checklist Items (one per line)</label>
                    <textarea name="checklist" id="pmChecklist" class="form-control" rows="3"
                              placeholder="Check belt tension&#10;Inspect for wear&#10;Lubricate bearings"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 20px;">
                <button type="submit" class="cmms-btn">
                    <i class="fas fa-save"></i> Save PM Schedule
                </button>
                <button type="button" class="cmms-btn" style="background: #555;"
                    onclick="document.getElementById('addPMModal').style.display='none'">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Media Viewer Modal -->
<div class="modal fade" id="mediaViewerModal" tabindex="-1" aria-labelledby="mediaViewerTitle" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaViewerTitle">Media Viewer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeMediaViewer()"></button>
            </div>
            <div class="modal-body text-center" id="mediaViewerBody" style="padding: 2rem; min-height: 300px;">
                <!-- Content will be dynamically inserted -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeMediaViewer()">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Load AI Health Score
    async function refreshHealthScore() {
        const scoreDisplay = document.getElementById('health-score-display');
        const scoreValue = document.getElementById('health-score-value');
        const riskDisplay = document.getElementById('health-risk');
        const analysisDisplay = document.getElementById('health-analysis');

        scoreValue.textContent = '...';
        analysisDisplay.textContent = 'Analyzing...';

        try {
            const response = await fetch('/assets/{{ asset.id }}/ai-health');
            const data = await response.json();

            scoreValue.textContent = data.health_score;
            riskDisplay.textContent = data.risk_level + ' Risk';
            analysisDisplay.textContent = data.analysis;

            // Update circle gradient
            const percentage = data.health_score;
            let color = '#27ae60';
            if (percentage < 50) color = '#e74c3c';
            else if (percentage < 75) color = '#f39c12';

            scoreDisplay.style.background = `conic-gradient(${color} 0% ${percentage}%, rgba(255,255,255,0.1) ${percentage}% 100%)`;

            // Update risk color
            if (data.risk_level === 'High') riskDisplay.style.color = '#e74c3c';
            else if (data.risk_level === 'Medium') riskDisplay.style.color = '#f39c12';
            else riskDisplay.style.color = '#27ae60';
        } catch (error) {
            console.error('Error loading health score:', error);
            analysisDisplay.textContent = 'Error loading AI analysis';
        }
    }

    // Load AI Recommendations
    async function loadRecommendations() {
        const container = document.getElementById('ai-recommendations');
        container.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading recommendations...</div>';

        try {
            const response = await fetch('/assets/{{ asset.id }}/ai-recommendations');
            const data = await response.json();

            let html = '';
            if (Array.isArray(data.recommendations)) {
                data.recommendations.forEach(rec => {
                    html += `
                    <div class="item-card" style="margin-bottom: 0.75rem;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <strong>${rec.task || rec}</strong>
                                ${rec.estimated_cost ? `<div style="font-size: 0.85rem; opacity: 0.7;">Est. Cost: $${rec.estimated_cost}</div>` : ''}
                            </div>
                            ${rec.priority ? `<span class="cmms-badge badge-${rec.priority.toLowerCase()}">${rec.priority}</span>` : ''}
                        </div>
                    </div>
                `;
                });
            } else {
                html = `<div style="padding: 1rem; opacity: 0.8;">${data.recommendations}</div>`;
            }

            container.innerHTML = html || '<div style="text-align: center; padding: 2rem; opacity: 0.5;">No recommendations available</div>';
        } catch (error) {
            console.error('Error loading recommendations:', error);
            container.innerHTML = '<div style="text-align: center; padding: 2rem; opacity: 0.5;">Error loading recommendations</div>';
        }
    }

    // View media in modal
    function viewMedia(path, type) {
        const modal = document.getElementById('mediaViewerModal');
        const modalBody = document.getElementById('mediaViewerBody');
        const modalTitle = document.getElementById('mediaViewerTitle');

        // Set title
        modalTitle.textContent = path.split('/').pop() || 'Media Viewer';

        // Generate content based on type
        let content = '';
        const fullPath = '/' + path;

        if (type === 'image' || path.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i)) {
            content = `<img src="${fullPath}" alt="Asset Media" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px;">`;
        } else if (type === 'video' || path.match(/\.(mp4|webm|ogg|mov)$/i)) {
            content = `<video controls autoplay style="max-width: 100%; max-height: 70vh; border-radius: 8px;">
                <source src="${fullPath}" type="video/${path.split('.').pop()}">
                Your browser does not support video playback.
            </video>`;
        } else if (type === 'pdf' || path.match(/\.pdf$/i)) {
            content = `<iframe src="${fullPath}" style="width: 100%; height: 70vh; border: none; border-radius: 8px;"></iframe>`;
        } else {
            // Unknown type - provide download link
            content = `<div class="text-center p-5">
                <i class="fas fa-file fa-4x mb-3" style="opacity: 0.5;"></i>
                <p>Preview not available for this file type.</p>
                <a href="${fullPath}" download class="btn btn-primary mt-3">
                    <i class="fas fa-download me-2"></i>Download File
                </a>
            </div>`;
        }

        modalBody.innerHTML = content;

        // Show modal using Bootstrap
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    }

    // Close media viewer
    function closeMediaViewer() {
        const modal = document.getElementById('mediaViewerModal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        if (bsModal) {
            bsModal.hide();
        }
        // Stop any playing videos
        const videos = document.querySelectorAll('#mediaViewerBody video');
        videos.forEach(v => v.pause());
    }

    // Auto-load AI features on page load
    document.addEventListener('DOMContentLoaded', function () {
        refreshHealthScore();
        loadRecommendations();
    });

    // ========================================
    // PM SCHEDULE MANAGEMENT
    // ========================================

    let aiGeneratedPMs = []; // Store AI-generated recommendations

    // Generate AI PM Schedule from uploaded manuals
    async function generateAIPMSchedule() {
        const statusDiv = document.getElementById('ai-pm-status');
        const messageSpan = document.getElementById('ai-pm-message');
        const spinner = document.getElementById('ai-pm-spinner');
        const generateBtn = document.getElementById('aiGenerateBtn');

        // Show loading state
        statusDiv.style.display = 'block';
        generateBtn.disabled = true;
        messageSpan.textContent = 'Analyzing equipment manuals and documentation...';

        try {
            const response = await fetch('/assets/{{ asset.id }}/ai-generate-pm', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success && data.recommendations && data.recommendations.length > 0) {
                aiGeneratedPMs = data.recommendations;
                displayAIRecommendations(data.recommendations);

                // Show what data sources were used
                let sourceInfo = `Found ${data.recommendations.length} PM recommendations`;
                if (data.data_sources && data.data_sources.length > 0) {
                    const sourceNames = {
                        'uploaded_documents': 'üìÑ Manuals',
                        'work_order_history': 'üîß Work Orders',
                        'maintenance_history': 'üìã Maintenance History',
                        'ai_knowledge': 'ü§ñ AI Knowledge',
                        'default_templates': 'üìù Templates'
                    };
                    const sources = data.data_sources.map(s => sourceNames[s] || s).join(', ');
                    sourceInfo += ` using: ${sources}`;
                }
                messageSpan.textContent = sourceInfo;
                spinner.className = 'fas fa-check-circle';
                spinner.style.color = '#27ae60';
            } else if (data.no_documents) {
                messageSpan.textContent = 'No equipment manuals found. Please upload documentation first.';
                spinner.className = 'fas fa-exclamation-circle';
                spinner.style.color = '#f39c12';
            } else {
                messageSpan.textContent = data.message || 'No maintenance recommendations generated.';
                spinner.className = 'fas fa-info-circle';
                spinner.style.color = '#3498db';
            }
        } catch (error) {
            console.error('Error generating PM schedule:', error);
            messageSpan.textContent = 'Error analyzing documents. Please try again.';
            spinner.className = 'fas fa-times-circle';
            spinner.style.color = '#e74c3c';
        } finally {
            generateBtn.disabled = false;
        }
    }

    // Display AI-generated PM recommendations
    function displayAIRecommendations(recommendations) {
        const container = document.getElementById('ai-pm-list');
        const wrapper = document.getElementById('ai-pm-recommendations');

        let html = '';
        recommendations.forEach((rec, index) => {
            html += `
            <div class="ai-pm-item" data-index="${index}" style="display: flex; align-items: start; padding: 1rem; background: var(--bg-glass); border-radius: 8px; margin-bottom: 0.75rem;">
                <input type="checkbox" checked style="margin-right: 1rem; margin-top: 4px; width: 18px; height: 18px;" id="pm-check-${index}">
                <div style="flex: 1;">
                    <strong>${rec.title}</strong>
                    <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 0.25rem;">${rec.description || ''}</div>
                    <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.8rem;">
                        <span><i class="fas fa-clock"></i> ${rec.interval_days ? 'Every ' + rec.interval_days + ' days' : rec.interval_hours ? 'Every ' + rec.interval_hours + ' hours' : 'As needed'}</span>
                        <span class="cmms-badge badge-${(rec.priority || 'medium').toLowerCase()}" style="font-size: 0.7rem;">${rec.priority || 'Medium'}</span>
                        <span><i class="fas fa-tag"></i> ${rec.schedule_type || 'Preventive'}</span>
                    </div>
                </div>
                <button class="cmms-btn cmms-btn-sm" style="margin-left: 0.5rem;" onclick="addSingleAIPM(${index})">
                    <i class="fas fa-plus"></i> Add
                </button>
            </div>
            `;
        });

        container.innerHTML = html;
        wrapper.style.display = 'block';
    }

    // Add single AI-generated PM
    async function addSingleAIPM(index) {
        const pm = aiGeneratedPMs[index];
        const success = await savePMSchedule(pm);

        if (success) {
            // Add row to table dynamically for immediate feedback
            addPMRowToTable(pm);

            // Remove from AI recommendations list
            const item = document.querySelector(`.ai-pm-item[data-index="${index}"]`);
            if (item) item.remove();

            // Hide "no PM" message if visible
            const noMsg = document.getElementById('no-pm-message');
            if (noMsg) noMsg.style.display = 'none';

            // Check if any recommendations left
            if (document.querySelectorAll('.ai-pm-item').length === 0) {
                dismissAIRecommendations();
            }
        }
    }

    // Add PM row to table dynamically
    function addPMRowToTable(pm) {
        const tbody = document.getElementById('pm-schedule-body');
        const row = document.createElement('tr');

        let typeIcon = 'üìã';
        if (pm.schedule_type === 'time_based') typeIcon = '‚è∞ Time';
        else if (pm.schedule_type === 'usage_based') typeIcon = 'üìä Usage';
        else if (pm.schedule_type === 'condition_based') typeIcon = 'üîç Condition';

        let frequency = 'As needed';
        if (pm.interval_days) frequency = `Every ${pm.interval_days} days`;
        else if (pm.interval_hours) frequency = `Every ${pm.interval_hours} hours`;

        row.innerHTML = `
            <td>
                <strong>${pm.title}</strong>
                ${pm.description ? `<div style="font-size: 0.8rem; opacity: 0.7;">${pm.description.substring(0, 50)}${pm.description.length > 50 ? '...' : ''}</div>` : ''}
            </td>
            <td><span class="cmms-badge" style="font-size: 0.75rem;">${typeIcon}</span></td>
            <td>${frequency}</td>
            <td>${pm.next_due_date || 'Not scheduled'}</td>
            <td><span class="cmms-badge badge-${(pm.priority || 'medium').toLowerCase()}">${pm.priority || 'Medium'}</span></td>
            <td>
                <button class="cmms-btn cmms-btn-sm" style="padding: 4px 8px;"><i class="fas fa-edit"></i></button>
                <button class="cmms-btn cmms-btn-sm" style="padding: 4px 8px; background: #c0392b;"><i class="fas fa-trash"></i></button>
            </td>
        `;
        tbody.appendChild(row);
    }

    // Add all selected AI PMs
    async function addAllAIPMs() {
        const checkboxes = document.querySelectorAll('.ai-pm-item input[type="checkbox"]:checked');
        const indicesToAdd = [];

        checkboxes.forEach(cb => {
            const item = cb.closest('.ai-pm-item');
            indicesToAdd.push(parseInt(item.dataset.index));
        });

        for (const index of indicesToAdd) {
            await savePMSchedule(aiGeneratedPMs[index]);
        }

        dismissAIRecommendations();
        location.reload(); // Refresh to show new PMs
    }

    // Dismiss AI recommendations
    function dismissAIRecommendations() {
        document.getElementById('ai-pm-recommendations').style.display = 'none';
        document.getElementById('ai-pm-status').style.display = 'none';
        aiGeneratedPMs = [];
    }

    // Save PM Schedule
    async function savePMSchedule(pmData) {
        try {
            const response = await fetch('/assets/{{ asset.id }}/pm-schedule', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(pmData)
            });

            const data = await response.json();
            if (data.success) {
                // Optionally add to table dynamically
                console.log('PM Schedule saved:', data);
                return true;
            } else {
                alert('Error saving PM: ' + (data.message || 'Unknown error'));
                return false;
            }
        } catch (error) {
            console.error('Error saving PM:', error);
            alert('Error saving PM schedule');
            return false;
        }
    }

    // Handle Add PM Form submission
    document.getElementById('addPMForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const pmData = {
            title: document.getElementById('pmTitle').value,
            description: document.getElementById('pmDescription').value,
            schedule_type: document.getElementById('pmScheduleType').value,
            priority: document.getElementById('pmPriority').value,
            interval_days: parseInt(document.getElementById('pmIntervalDays').value) || null,
            interval_hours: parseInt(document.getElementById('pmIntervalHours').value) || null,
            next_due_date: document.getElementById('pmNextDueDate').value || null,
            estimated_hours: parseFloat(document.getElementById('pmEstimatedHours').value) || null,
            checklist: document.getElementById('pmChecklist').value.split('\n').filter(item => item.trim())
        };

        const success = await savePMSchedule(pmData);
        if (success) {
            document.getElementById('addPMModal').style.display = 'none';
            document.getElementById('addPMForm').reset();
            location.reload();
        }
    });

    // Edit PM
    function editPM(pmId) {
        // TODO: Load PM data and open modal for editing
        alert('Edit PM: ' + pmId + ' - Feature coming soon');
    }

    // Delete PM
    async function deletePM(pmId) {
        if (!confirm('Are you sure you want to delete this PM schedule?')) return;

        try {
            const response = await fetch(`/assets/{{ asset.id }}/pm-schedule/${pmId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();
            if (data.success) {
                const row = document.querySelector(`tr[data-pm-id="${pmId}"]`);
                if (row) row.remove();
            } else {
                alert('Error deleting PM: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error deleting PM:', error);
            alert('Error deleting PM schedule');
        }
    }
</script>
{% endblock %}