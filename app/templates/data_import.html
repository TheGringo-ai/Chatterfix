{% extends "base.html" %}
{% block title %}Data Import - ChatterFix{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-cloud-upload-alt me-2"></i>Smart Data Import</h2>
                    <p class="text-muted mb-0">Import your existing data with AI-powered column mapping</p>
                </div>
                <a href="/dashboard" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Import Type Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h5 class="card-title mb-3">What are you importing?</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="entityType" id="entityAssets" value="asset" checked>
                        <label class="btn btn-outline-primary" for="entityAssets">
                            <i class="fas fa-cogs me-2"></i>Assets/Equipment
                        </label>

                        <input type="radio" class="btn-check" name="entityType" id="entityParts" value="part">
                        <label class="btn btn-outline-success" for="entityParts">
                            <i class="fas fa-boxes me-2"></i>Parts/Inventory
                        </label>

                        <input type="radio" class="btn-check" name="entityType" id="entityUsers" value="user">
                        <label class="btn btn-outline-info" for="entityUsers">
                            <i class="fas fa-users me-2"></i>Users/Technicians
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drag and Drop Zone -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-body p-5">
                    <div id="dropZone" class="drop-zone text-center p-5 rounded-3 border-dashed">
                        <div id="dropZoneContent">
                            <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                            <h4>Drag & Drop Your File Here</h4>
                            <p class="text-muted mb-3">or click to browse</p>
                            <div class="d-flex justify-content-center gap-2 mb-3">
                                <span class="badge bg-primary"><i class="fas fa-file-csv me-1"></i>CSV</span>
                                <span class="badge bg-success"><i class="fas fa-file-excel me-1"></i>Excel</span>
                                <span class="badge bg-danger"><i class="fas fa-file-pdf me-1"></i>PDF Manuals</span>
                            </div>
                            <small class="text-muted">Maximum file size: 50MB</small>
                        </div>
                        <div id="uploadProgress" class="d-none">
                            <div class="spinner-border text-primary mb-3" role="status"></div>
                            <h5>Processing your file...</h5>
                            <p class="text-muted" id="uploadStatus">Uploading...</p>
                        </div>
                        <input type="file" id="fileInput" class="d-none" accept=".csv,.xlsx,.xls,.pdf">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapping Review Section (Hidden initially) -->
    <div id="mappingSection" class="d-none">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-magic me-2"></i>AI Column Mapping Suggestions</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-robot me-2"></i>
                            Our AI has analyzed your file and suggested the following mappings.
                            Please review and adjust if needed.
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Your Column</th>
                                        <th>Sample Data</th>
                                        <th>Maps To</th>
                                        <th>Confidence</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="mappingTableBody">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <div id="unmappedColumns" class="mt-3 d-none">
                            <h6 class="text-warning"><i class="fas fa-exclamation-triangle me-2"></i>Unmapped Columns</h6>
                            <div id="unmappedList" class="d-flex flex-wrap gap-2">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" onclick="resetImport()">
                                <i class="fas fa-redo me-2"></i>Start Over
                            </button>
                            <button class="btn btn-success btn-lg" onclick="confirmImport()">
                                <i class="fas fa-check me-2"></i>Confirm & Import <span id="rowCount"></span> Records
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Schedule Results (Hidden initially) -->
    <div id="pdfResultsSection" class="d-none">
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Extracted Maintenance Schedules</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-magic me-2"></i>
                            We found the following maintenance schedules in your PDF.
                            Select which ones to import as Work Order templates.
                        </div>

                        <div id="schedulesList">
                            <!-- Populated by JavaScript -->
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-outline-secondary" onclick="resetImport()">
                                <i class="fas fa-redo me-2"></i>Start Over
                            </button>
                            <button class="btn btn-success btn-lg" onclick="importSchedules()">
                                <i class="fas fa-check me-2"></i>Create PM Templates
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Templates Section -->
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Download Import Templates</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card bg-secondary h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-cogs fa-3x text-primary mb-3"></i>
                                    <h6>Asset Template</h6>
                                    <p class="text-muted small">Equipment, machines, vehicles</p>
                                    <button class="btn btn-outline-primary btn-sm" onclick="downloadTemplate('asset')">
                                        <i class="fas fa-download me-1"></i>Download CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-3x text-success mb-3"></i>
                                    <h6>Parts Template</h6>
                                    <p class="text-muted small">Inventory, spare parts, consumables</p>
                                    <button class="btn btn-outline-success btn-sm" onclick="downloadTemplate('part')">
                                        <i class="fas fa-download me-1"></i>Download CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h6>User Template</h6>
                                    <p class="text-muted small">Technicians, managers, admins</p>
                                    <button class="btn btn-outline-info btn-sm" onclick="downloadTemplate('user')">
                                        <i class="fas fa-download me-1"></i>Download CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.drop-zone {
    border: 3px dashed #6c757d;
    transition: all 0.3s ease;
    cursor: pointer;
    background: rgba(0, 212, 255, 0.02);
}

.drop-zone:hover, .drop-zone.drag-over {
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.1);
}

.drop-zone.drag-over {
    transform: scale(1.02);
}

.border-dashed {
    border-style: dashed !important;
}

.confidence-high { color: #28a745; }
.confidence-medium { color: #ffc107; }
.confidence-low { color: #dc3545; }

.schedule-card {
    border-left: 4px solid #00d4ff;
}

.schedule-card.selected {
    border-left-color: #28a745;
    background: rgba(40, 167, 69, 0.1);
}
</style>

<script>
// State
let currentJobId = null;
let currentMappings = [];
let targetFields = {};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initDropZone();
});

function initDropZone() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    // Click to browse
    dropZone.addEventListener('click', () => fileInput.click());

    // Drag events
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'));
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'));
    });

    dropZone.addEventListener('drop', handleDrop);
    fileInput.addEventListener('change', handleFileSelect);
}

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function handleDrop(e) {
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
}

function handleFileSelect(e) {
    if (e.target.files.length > 0) {
        uploadFile(e.target.files[0]);
    }
}

async function uploadFile(file) {
    const entityType = document.querySelector('input[name="entityType"]:checked').value;

    // Show progress
    document.getElementById('dropZoneContent').classList.add('d-none');
    document.getElementById('uploadProgress').classList.remove('d-none');
    document.getElementById('uploadStatus').textContent = 'Analyzing your file...';

    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch(`/api/v1/import/upload?entity_type=${entityType}`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.detail || 'Upload failed');
        }

        if (data.file_type === 'pdf') {
            showPdfResults(data);
        } else {
            showMappingResults(data);
        }

    } catch (error) {
        showError(error.message);
    }
}

function showMappingResults(data) {
    currentJobId = data.job_id;
    currentMappings = data.suggested_mapping.mappings;

    // Hide upload, show mapping
    document.getElementById('dropZone').closest('.card').classList.add('d-none');
    document.getElementById('mappingSection').classList.remove('d-none');
    document.getElementById('rowCount').textContent = `(${data.total_rows} rows)`;

    // Populate mapping table
    const tbody = document.getElementById('mappingTableBody');
    tbody.innerHTML = '';

    currentMappings.forEach((mapping, index) => {
        const confidenceClass = mapping.confidence >= 0.8 ? 'confidence-high' :
                               mapping.confidence >= 0.5 ? 'confidence-medium' : 'confidence-low';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${mapping.source_column}</strong></td>
            <td><small class="text-muted">${mapping.sample_values.slice(0, 2).join(', ') || 'N/A'}</small></td>
            <td>
                <select class="form-select form-select-sm bg-dark text-white" id="mapping-${index}" data-source="${mapping.source_column}">
                    <option value="${mapping.target_field}" selected>${mapping.target_field}</option>
                    <option value="">-- Skip this column --</option>
                </select>
            </td>
            <td><span class="${confidenceClass}">${Math.round(mapping.confidence * 100)}%</span></td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeMapping(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Show unmapped columns
    if (data.suggested_mapping.unmapped_columns.length > 0) {
        document.getElementById('unmappedColumns').classList.remove('d-none');
        const unmappedList = document.getElementById('unmappedList');
        unmappedList.innerHTML = data.suggested_mapping.unmapped_columns.map(col =>
            `<span class="badge bg-warning text-dark">${col}</span>`
        ).join('');
    }
}

function showPdfResults(data) {
    // Hide upload, show PDF results
    document.getElementById('dropZone').closest('.card').classList.add('d-none');
    document.getElementById('pdfResultsSection').classList.remove('d-none');

    const schedulesList = document.getElementById('schedulesList');

    if (data.extracted_schedules.length === 0) {
        schedulesList.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-circle me-2"></i>
                No maintenance schedules were found in this PDF.
                Try uploading an equipment manual with maintenance tables.
            </div>
        `;
        return;
    }

    schedulesList.innerHTML = data.extracted_schedules.map((schedule, index) => `
        <div class="card bg-secondary mb-2 schedule-card" data-index="${index}">
            <div class="card-body">
                <div class="form-check">
                    <input class="form-check-input schedule-checkbox" type="checkbox" id="schedule-${index}" checked>
                    <label class="form-check-label" for="schedule-${index}">
                        <strong>${schedule.task_name}</strong>
                    </label>
                </div>
                <div class="ms-4 mt-2">
                    <span class="badge bg-primary me-2">${schedule.frequency}</span>
                    ${schedule.asset_type ? `<span class="badge bg-info me-2">${schedule.asset_type}</span>` : ''}
                    ${schedule.estimated_duration ? `<span class="badge bg-secondary">${schedule.estimated_duration}</span>` : ''}
                </div>
                ${schedule.required_parts.length > 0 ? `
                    <div class="ms-4 mt-2">
                        <small class="text-muted">Parts: ${schedule.required_parts.join(', ')}</small>
                    </div>
                ` : ''}
            </div>
        </div>
    `).join('');
}

function showError(message) {
    document.getElementById('dropZoneContent').classList.remove('d-none');
    document.getElementById('uploadProgress').classList.add('d-none');

    // Show toast or alert
    alert('Error: ' + message);
}

function resetImport() {
    currentJobId = null;
    currentMappings = [];

    document.getElementById('dropZone').closest('.card').classList.remove('d-none');
    document.getElementById('mappingSection').classList.add('d-none');
    document.getElementById('pdfResultsSection').classList.add('d-none');
    document.getElementById('dropZoneContent').classList.remove('d-none');
    document.getElementById('uploadProgress').classList.add('d-none');
    document.getElementById('fileInput').value = '';
}

async function confirmImport() {
    if (!currentJobId) return;

    // Collect confirmed mappings
    const confirmedMappings = {};
    document.querySelectorAll('[id^="mapping-"]').forEach(select => {
        const source = select.dataset.source;
        const target = select.value;
        if (target) {
            confirmedMappings[source] = target;
        }
    });

    try {
        const response = await fetch(`/api/v1/import/confirm/${currentJobId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(confirmedMappings),
            credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
            alert('Import started! Your data is being processed in the background.');
            window.location.href = '/dashboard';
        } else {
            throw new Error(data.detail || 'Import failed');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function importSchedules() {
    const selectedSchedules = [];
    document.querySelectorAll('.schedule-checkbox:checked').forEach(checkbox => {
        const index = checkbox.id.split('-')[1];
        selectedSchedules.push(index);
    });

    if (selectedSchedules.length === 0) {
        alert('Please select at least one schedule to import.');
        return;
    }

    alert(`Creating ${selectedSchedules.length} PM templates... (Feature coming soon)`);
    // TODO: Implement schedule import
}

async function downloadTemplate(entityType) {
    try {
        const response = await fetch(`/api/v1/import/templates/${entityType}`);
        const data = await response.json();

        // Create CSV content
        const headers = data.template.columns.join(',');
        const sampleRow = data.template.columns.map(col =>
            JSON.stringify(data.template.sample_row[col] || '')
        ).join(',');

        const csvContent = `${headers}\n${sampleRow}`;

        // Download
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chatterfix_${entityType}_template.csv`;
        a.click();
        window.URL.revokeObjectURL(url);

    } catch (error) {
        alert('Error downloading template: ' + error.message);
    }
}

function removeMapping(index) {
    const select = document.getElementById(`mapping-${index}`);
    select.value = '';
}
</script>
{% endblock %}
