{% extends "base.html" %}

{% block title %}Bulk Import Parts - ChatterFix CMMS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1"><i class="fas fa-upload me-2"></i>Bulk Import Parts</h2>
                    <p class="text-muted mb-0">Upload CSV or Excel files to import multiple parts at once</p>
                </div>
                <a href="/inventory" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Inventory
                </a>
            </div>
        </div>
    </div>

    <!-- Download Templates Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-download me-2"></i>Step 1: Download Template</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Download a template file with the correct column headers, then fill in your data.</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-file-csv fa-2x text-success me-3"></i>
                                    <div>
                                        <h6 class="mb-0">CSV Template</h6>
                                        <small class="text-muted">Works with all spreadsheet software</small>
                                    </div>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="downloadTemplate('csv')">
                                    <i class="fas fa-download me-1"></i>Download CSV
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-file-excel fa-2x text-primary me-3"></i>
                                    <div>
                                        <h6 class="mb-0">Excel Template</h6>
                                        <small class="text-muted">Best for Microsoft Excel users</small>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="downloadTemplate('xlsx')" {% if not pandas_available %}disabled title="Excel support not available"{% endif %}>
                                    <i class="fas fa-download me-1"></i>Download Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Column Info -->
                    <div class="mt-3">
                        <h6><i class="fas fa-info-circle me-1"></i>Required Columns:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Column</th>
                                        <th>Required</th>
                                        <th>Description</th>
                                        <th>Example</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>name</code></td><td><span class="badge bg-danger">Required</span></td><td>Part name</td><td>Hydraulic Filter</td></tr>
                                    <tr><td><code>part_number</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Unique part number/SKU</td><td>HF-1234</td></tr>
                                    <tr><td><code>category</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Part category</td><td>Filters</td></tr>
                                    <tr><td><code>description</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Part description</td><td>Heavy duty filter</td></tr>
                                    <tr><td><code>current_stock</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Current quantity</td><td>25</td></tr>
                                    <tr><td><code>minimum_stock</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Reorder threshold</td><td>10</td></tr>
                                    <tr><td><code>location</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Storage location</td><td>Warehouse A-12</td></tr>
                                    <tr><td><code>unit_cost</code></td><td><span class="badge bg-secondary">Optional</span></td><td>Cost per unit</td><td>45.99</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Step 2: Upload Your File</h5>
                </div>
                <div class="card-body">
                    <div id="uploadArea" class="upload-area text-center p-5"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                         onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h5>Drag & Drop Your File Here</h5>
                        <p class="text-muted mb-3">Or click to browse and select a file</p>
                        <p class="small text-muted">Supported formats: CSV, XLSX, XLS (Max 100 rows per upload)</p>
                        <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                    </div>

                    <!-- Selected File Info -->
                    <div id="fileInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-info d-flex align-items-center">
                            <i class="fas fa-file me-3 fa-2x"></i>
                            <div class="flex-grow-1">
                                <strong id="selectedFileName"></strong>
                                <br><small id="selectedFileSize" class="text-muted"></small>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearFile()">
                                <i class="fas fa-times"></i> Remove
                            </button>
                        </div>
                        <button class="btn btn-success btn-lg w-100" onclick="startImport()">
                            <i class="fas fa-upload me-2"></i>Import Parts
                        </button>
                    </div>

                    <!-- Progress -->
                    <div id="progressSection" class="mt-3" style="display: none;">
                        <div class="progress" style="height: 25px;">
                            <div id="importProgress" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-center mt-2 text-muted">Processing...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="row mb-4" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Import Results</h5>
                </div>
                <div class="card-body">
                    <div id="resultsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .upload-area {
        border: 3px dashed var(--border-color);
        border-radius: 15px;
        background: var(--bg-secondary);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .upload-area:hover, .upload-area.dragover {
        border-color: var(--accent-color);
        background: rgba(52, 152, 219, 0.1);
        transform: scale(1.01);
    }
    .dark-mode .upload-area {
        background: var(--bg-secondary);
    }
</style>

<script>
    let selectedFile = null;

    function downloadTemplate(format) {
        window.location.href = `/inventory/api/parts/template?format=${format}`;
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('uploadArea').classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('uploadArea').classList.remove('dragover');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('uploadArea').classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    }

    function processFile(file) {
        const validTypes = ['.csv', '.xlsx', '.xls'];
        const fileName = file.name.toLowerCase();
        const isValid = validTypes.some(type => fileName.endsWith(type));

        if (!isValid) {
            alert('Please select a CSV or Excel file (.csv, .xlsx, .xls)');
            return;
        }

        selectedFile = file;
        document.getElementById('selectedFileName').textContent = file.name;
        document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
        document.getElementById('fileInfo').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' bytes';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function clearFile() {
        selectedFile = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('fileInfo').style.display = 'none';
    }

    async function startImport() {
        if (!selectedFile) {
            alert('Please select a file first');
            return;
        }

        // Show progress
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('importProgress').style.width = '30%';
        document.getElementById('progressText').textContent = 'Uploading file...';

        try {
            const formData = new FormData();
            formData.append('file', selectedFile);

            document.getElementById('importProgress').style.width = '60%';
            document.getElementById('progressText').textContent = 'Processing data...';

            const response = await fetch('/inventory/api/parts/bulk-import', {
                method: 'POST',
                body: formData
            });

            document.getElementById('importProgress').style.width = '100%';
            document.getElementById('progressText').textContent = 'Complete!';

            const result = await response.json();

            setTimeout(() => {
                document.getElementById('progressSection').style.display = 'none';
                showResults(result);
            }, 500);

        } catch (error) {
            document.getElementById('progressSection').style.display = 'none';
            showResults({
                success: false,
                error: 'Network error: ' + error.message
            });
        }
    }

    function showResults(result) {
        document.getElementById('resultsSection').style.display = 'block';
        const content = document.getElementById('resultsContent');

        if (result.success) {
            let html = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Import Successful!</h5>
                    <p class="mb-0">${result.message}</p>
                </div>
                <div class="row text-center mb-3">
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h3 class="text-primary">${result.total_rows}</h3>
                            <small class="text-muted">Total Rows</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h3 class="text-success">${result.imported}</h3>
                            <small class="text-muted">Imported</small>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-3">
                            <h3 class="text-danger">${result.error_count}</h3>
                            <small class="text-muted">Errors</small>
                        </div>
                    </div>
                </div>
            `;

            if (result.errors && result.errors.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Some rows had errors:</h6>
                        <ul class="mb-0" style="max-height: 200px; overflow-y: auto;">
                            ${result.errors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            html += `
                <div class="d-flex gap-2">
                    <a href="/inventory" class="btn btn-primary">
                        <i class="fas fa-box me-1"></i>View Inventory
                    </a>
                    <button class="btn btn-outline-secondary" onclick="resetImport()">
                        <i class="fas fa-redo me-1"></i>Import More
                    </button>
                </div>
            `;

            content.innerHTML = html;
        } else {
            content.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-times-circle me-2"></i>Import Failed</h5>
                    <p class="mb-0">${result.error}</p>
                </div>
                <button class="btn btn-outline-secondary" onclick="resetImport()">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            `;
        }
    }

    function resetImport() {
        clearFile();
        document.getElementById('resultsSection').style.display = 'none';
    }
</script>
{% endblock %}
