{% extends "base.html" %}

{% block title %}IoT Sensors Dashboard - ChatterFix{% endblock %}

{% block extra_head %}
<style>
    .sensor-card { transition: all 0.3s ease; }
    .sensor-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
    .alert-critical { animation: pulse 2s infinite; }
    .real-time-indicator { animation: blink 1s infinite; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }
    .premium-badge {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
    .iot-stat-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }
    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }
    .status-online { background: #22c55e; }
    .status-offline { background: #ef4444; }
    .status-warning { background: #f59e0b; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-microchip me-2 text-primary"></i>
                IoT Sensors <span class="premium-badge">Advanced</span>
            </h1>
            <p class="text-muted mb-0">Monitor and manage your IoT sensors in real-time</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" onclick="refreshSensors()">
                <i class="fas fa-sync-alt me-1"></i> Refresh
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSensorModal">
                <i class="fas fa-plus me-1"></i> Add Sensor
            </button>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="iot-stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle p-3 bg-primary bg-opacity-10 me-3">
                        <i class="fas fa-microchip text-primary fa-lg"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Total Sensors</div>
                        <div class="h4 mb-0" id="totalSensors">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="iot-stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle p-3 bg-success bg-opacity-10 me-3">
                        <i class="fas fa-wifi text-success fa-lg"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Online</div>
                        <div class="h4 mb-0 text-success" id="onlineSensors">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="iot-stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle p-3 bg-danger bg-opacity-10 me-3">
                        <i class="fas fa-exclamation-triangle text-danger fa-lg"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Offline</div>
                        <div class="h4 mb-0 text-danger" id="offlineSensors">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="iot-stat-card">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle p-3 bg-warning bg-opacity-10 me-3">
                        <i class="fas fa-bell text-warning fa-lg"></i>
                    </div>
                    <div>
                        <div class="text-muted small">Active Alerts</div>
                        <div class="h4 mb-0 text-warning" id="activeAlerts">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div id="alertsSection" class="mb-4" style="display: none;">
        <div class="card border-danger">
            <div class="card-header bg-danger bg-opacity-10 text-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>Critical Alerts</strong>
            </div>
            <div class="card-body">
                <div id="alertsList"></div>
            </div>
        </div>
    </div>

    <!-- Sensors Grid -->
    <div class="mb-4">
        <h5 class="mb-3"><i class="fas fa-th-large me-2"></i>Sensors</h5>
        <div class="sensor-grid" id="sensorsGrid">
            <!-- Sensors will be loaded here -->
            <div class="text-center py-5 text-muted" id="noSensorsMessage">
                <i class="fas fa-microchip fa-3x mb-3 opacity-50"></i>
                <p>No sensors configured yet.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSensorModal">
                    <i class="fas fa-plus me-1"></i> Add Your First Sensor
                </button>
            </div>
        </div>
    </div>

    <!-- Real-time Chart -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-chart-line me-2"></i>
            Real-time Sensor Readings
            <span class="badge bg-success ms-2">
                <span class="real-time-indicator d-inline-block rounded-circle me-1" style="width: 8px; height: 8px; background: white;"></span>
                Live
            </span>
        </div>
        <div class="card-body">
            <div style="height: 300px;">
                <canvas id="realTimeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Add Sensor Modal -->
<div class="modal fade" id="addSensorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2 text-primary"></i>
                    Add New IoT Sensor
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addSensorForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Sensor Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="sensorName" name="name" required
                                   placeholder="e.g., Pump 247 Temperature">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sensor Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="sensorType" name="sensor_type" required>
                                <option value="">Select type...</option>
                                <option value="temperature">Temperature</option>
                                <option value="pressure">Pressure</option>
                                <option value="vibration">Vibration</option>
                                <option value="flow">Flow Rate</option>
                                <option value="humidity">Humidity</option>
                                <option value="level">Level</option>
                                <option value="power">Power Consumption</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Protocol <span class="text-danger">*</span></label>
                            <select class="form-select" id="sensorProtocol" name="protocol" required>
                                <option value="">Select protocol...</option>
                                <option value="modbus_tcp">Modbus TCP</option>
                                <option value="mqtt">MQTT</option>
                                <option value="http">HTTP API</option>
                                <option value="opcua">OPC-UA</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="sensorLocation" name="location"
                                   placeholder="e.g., Building A, Floor 2">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sampling Interval (seconds)</label>
                            <input type="number" class="form-control" id="samplingInterval" name="sampling_interval"
                                   value="60" min="1" max="3600">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Link to Asset</label>
                            <select class="form-select" id="sensorAsset" name="asset_id">
                                <option value="">No asset linked</option>
                                <!-- Assets will be loaded dynamically -->
                            </select>
                        </div>

                        <div class="col-12">
                            <hr>
                            <h6><i class="fas fa-plug me-2"></i>Connection Parameters</h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Host/IP Address</label>
                            <input type="text" class="form-control" id="connectionHost" name="connection_host"
                                   placeholder="e.g., 192.168.1.100">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" id="connectionPort" name="connection_port"
                                   placeholder="e.g., 502">
                        </div>

                        <div class="col-12">
                            <hr>
                            <h6><i class="fas fa-bell me-2"></i>Alert Thresholds (Optional)</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Warning Low</label>
                            <input type="number" step="0.1" class="form-control" id="thresholdWarningLow" name="threshold_warning_low">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Warning High</label>
                            <input type="number" step="0.1" class="form-control" id="thresholdWarningHigh" name="threshold_warning_high">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Critical High</label>
                            <input type="number" step="0.1" class="form-control" id="thresholdCriticalHigh" name="threshold_critical_high">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitSensorBtn">
                        <i class="fas fa-plus me-1"></i> Add Sensor
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Dashboard State
let dashboardData = {
    overview: {},
    sensors: [],
    realTimeChart: null
};

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
});

async function initializeDashboard() {
    try {
        await loadDashboardData();
        await loadAssets();
        initializeChart();
        setupRealTimeUpdates();
        setupFormHandler();
    } catch (error) {
        console.error('Dashboard initialization error:', error);
    }
}

async function loadDashboardData() {
    try {
        const response = await fetch('/iot/dashboard/overview', {
            credentials: 'include'
        });
        const data = await response.json();

        if (data.overview?.upgrade_required) {
            // IoT module not available - show demo data
            showDemoMode();
            return;
        }

        dashboardData = data;
        updateOverviewStats();
        updateAlertsSection();
        renderSensorGrid();
    } catch (error) {
        console.error('Failed to load dashboard data:', error);
        showDemoMode();
    }
}

function showDemoMode() {
    // Show demo data when IoT module isn't available
    document.getElementById('totalSensors').textContent = '0';
    document.getElementById('onlineSensors').textContent = '0';
    document.getElementById('offlineSensors').textContent = '0';
    document.getElementById('activeAlerts').textContent = '0';
}

async function loadAssets() {
    try {
        const response = await fetch('/api/assets/list', {
            credentials: 'include'
        });
        const data = await response.json();

        const assetSelect = document.getElementById('sensorAsset');
        if (data.assets && Array.isArray(data.assets)) {
            data.assets.forEach(asset => {
                const option = document.createElement('option');
                option.value = asset.id;
                option.textContent = asset.name;
                assetSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.log('Could not load assets:', error);
    }
}

function updateOverviewStats() {
    const overview = dashboardData.overview || {};
    document.getElementById('totalSensors').textContent = overview.total_sensors || 0;
    document.getElementById('onlineSensors').textContent = overview.online_sensors || 0;
    document.getElementById('offlineSensors').textContent = overview.offline_sensors || 0;
    document.getElementById('activeAlerts').textContent = overview.active_alerts || 0;
}

function updateAlertsSection() {
    const alerts = dashboardData.alerts || [];
    const alertsSection = document.getElementById('alertsSection');
    const alertsList = document.getElementById('alertsList');

    if (alerts.length === 0) {
        alertsSection.style.display = 'none';
        return;
    }

    alertsSection.style.display = 'block';
    alertsList.innerHTML = alerts.map(alert => `
        <div class="alert ${alert.level === 'critical' ? 'alert-danger' : 'alert-warning'} d-flex align-items-center mb-2">
            <i class="fas ${alert.level === 'critical' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'} me-2"></i>
            <div class="flex-grow-1">
                <strong>${alert.name}</strong> - Value: ${alert.value}
            </div>
            <span class="badge ${alert.level === 'critical' ? 'bg-danger' : 'bg-warning'}">${alert.level.toUpperCase()}</span>
        </div>
    `).join('');
}

function renderSensorGrid() {
    const sensors = dashboardData.sensors || [];
    const grid = document.getElementById('sensorsGrid');
    const noSensorsMessage = document.getElementById('noSensorsMessage');

    if (sensors.length === 0) {
        if (noSensorsMessage) noSensorsMessage.style.display = 'block';
        return;
    }

    if (noSensorsMessage) noSensorsMessage.style.display = 'none';

    grid.innerHTML = sensors.map(sensor => `
        <div class="card sensor-card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h6 class="card-title mb-0">${sensor.name}</h6>
                    <span class="badge ${sensor.status === 'online' ? 'bg-success' : 'bg-danger'}">
                        ${sensor.status || 'Unknown'}
                    </span>
                </div>
                <div class="row g-2 text-sm">
                    <div class="col-6">
                        <div class="text-muted small">Type</div>
                        <div class="fw-medium">${sensor.type || '--'}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted small">Reading</div>
                        <div class="fw-medium">${sensor.last_reading || '--'}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted small">Location</div>
                        <div class="fw-medium">${sensor.location || 'Not set'}</div>
                    </div>
                    <div class="col-6">
                        <div class="text-muted small">Last Update</div>
                        <div class="fw-medium">${sensor.last_update || '--'}</div>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="viewSensorDetails('${sensor.id}')">
                        <i class="fas fa-chart-line me-1"></i> Details
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSensor('${sensor.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

function initializeChart() {
    const ctx = document.getElementById('realTimeChart');
    if (!ctx) return;

    dashboardData.realTimeChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Sensor Reading',
                data: [],
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
}

function setupRealTimeUpdates() {
    // Update every 30 seconds
    setInterval(async () => {
        await loadDashboardData();
    }, 30000);
}

function setupFormHandler() {
    const form = document.getElementById('addSensorForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitSensorBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Adding...';

        try {
            const formData = {
                name: document.getElementById('sensorName').value,
                sensor_type: document.getElementById('sensorType').value,
                protocol: document.getElementById('sensorProtocol').value,
                location: document.getElementById('sensorLocation').value || null,
                sampling_interval: parseInt(document.getElementById('samplingInterval').value) || 60,
                asset_id: document.getElementById('sensorAsset').value || null,
                connection_params: {
                    host: document.getElementById('connectionHost').value || null,
                    port: parseInt(document.getElementById('connectionPort').value) || null
                },
                data_mapping: {},
                alert_thresholds: {
                    warning_low: parseFloat(document.getElementById('thresholdWarningLow').value) || null,
                    warning_high: parseFloat(document.getElementById('thresholdWarningHigh').value) || null,
                    critical_high: parseFloat(document.getElementById('thresholdCriticalHigh').value) || null
                }
            };

            const response = await fetch('/iot/sensors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(formData)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // Close modal and refresh
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSensorModal'));
                modal.hide();
                form.reset();

                showToast('Sensor added successfully!', 'success');
                await loadDashboardData();
            } else {
                showToast(result.message || result.error || 'Failed to add sensor', 'error');
            }
        } catch (error) {
            console.error('Error adding sensor:', error);
            showToast('Failed to add sensor: ' + error.message, 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Sensor';
        }
    });
}

async function refreshSensors() {
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';

    await loadDashboardData();

    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh';
    showToast('Sensors refreshed', 'success');
}

function viewSensorDetails(sensorId) {
    showToast('Sensor details view coming soon', 'info');
}

async function deleteSensor(sensorId) {
    if (!confirm('Are you sure you want to delete this sensor?')) return;

    try {
        const response = await fetch(`/iot/sensors/${sensorId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (response.ok) {
            showToast('Sensor deleted', 'success');
            await loadDashboardData();
        } else {
            showToast('Failed to delete sensor', 'error');
        }
    } catch (error) {
        showToast('Error deleting sensor', 'error');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);

    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}
