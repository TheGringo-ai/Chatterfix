<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LineSmart Intelligence Dashboard - ChatterFix</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #2563eb;
            --secondary-blue: #1e40af;
            --accent-green: #059669;
            --warning-orange: #d97706;
            --danger-red: #dc2626;
            --bg-light: #f8fafc;
            --text-dark: #1f2937;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-light);
            color: var(--text-dark);
        }

        .dashboard-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .dashboard-title {
            color: var(--primary-blue);
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .dashboard-subtitle {
            color: #6b7280;
            margin: 0.5rem 0 0 0;
            font-size: 1rem;
        }

        .refresh-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background: var(--secondary-blue);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--primary-blue);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 0;
        }

        .metric-label {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            margin: 0.25rem 0 0 0;
        }

        .metric-change {
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .positive { color: var(--accent-green); }
        .negative { color: var(--danger-red); }

        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            margin: 0 0 1rem 0;
        }

        .technician-performance {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .technician-card {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
        }

        .technician-name {
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .performance-metric {
            display: flex;
            justify-content: space-between;
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .training-opportunities {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .opportunity-item {
            padding: 1rem;
            border-left: 4px solid var(--warning-orange);
            background: #fef3c7;
            border-radius: 0 8px 8px 0;
            margin: 0.75rem 0;
        }

        .opportunity-title {
            font-weight: 600;
            color: var(--text-dark);
        }

        .opportunity-details {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: var(--danger-red);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">üß† LineSmart Intelligence Dashboard</h1>
            <p class="dashboard-subtitle">AI-Powered Workforce Intelligence & Training Analytics</p>
        </div>
        <button class="refresh-btn" onclick="loadDashboardData()">üîÑ Refresh Data</button>
    </div>

    <div id="loading" class="loading">
        <h3>Loading LineSmart Intelligence Data...</h3>
        <p>Analyzing workforce patterns and training opportunities</p>
    </div>

    <div id="dashboard-content" style="display: none;">
        <!-- Key Metrics -->
        <div class="metrics-grid" id="key-metrics">
            <!-- Dynamic metrics will be populated here -->
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3 class="chart-title">Skill Gap Distribution</h3>
                <canvas id="skillGapChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-container">
                <h3 class="chart-title">Failure Type Analysis</h3>
                <canvas id="failureTypeChart" width="400" height="300"></canvas>
            </div>
        </div>

        <!-- Technician Performance -->
        <div class="technician-performance">
            <h3 class="chart-title">üë®‚Äçüîß Technician Performance Analytics</h3>
            <div class="performance-grid" id="technician-grid">
                <!-- Dynamic technician cards will be populated here -->
            </div>
        </div>

        <!-- Training Opportunities -->
        <div class="training-opportunities">
            <h3 class="chart-title">üéì AI-Generated Training Opportunities</h3>
            <div id="training-list">
                <!-- Dynamic training opportunities will be populated here -->
            </div>
        </div>
    </div>

    <script>
        let skillGapChart = null;
        let failureTypeChart = null;

        async function loadDashboardData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('dashboard-content').style.display = 'none';
                
                const response = await fetch('/api/linesmart/dashboard?timeframe_days=90');
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                populateKeyMetrics(data);
                populateSkillGapChart(data.skill_gap_analytics);
                populateFailureTypeChart(data.skill_gap_analytics);
                populateTechnicianPerformance(data.technician_performance);
                populateTrainingOpportunities(data.skill_gap_analytics);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="error">
                        <h3>‚ö†Ô∏è Error Loading Data</h3>
                        <p>${error.message}</p>
                        <button onclick="loadDashboardData()" class="refresh-btn">Try Again</button>
                    </div>
                `;
            }
        }

        function populateKeyMetrics(data) {
            const metricsContainer = document.getElementById('key-metrics');
            const metrics = [
                {
                    value: data.overview?.total_analyses || 0,
                    label: 'Intelligence Analyses',
                    change: 'Last 90 days'
                },
                {
                    value: data.overview?.training_modules_generated || 0,
                    label: 'AI-Generated Training Modules',
                    change: 'Auto-created from failures'
                },
                {
                    value: data.business_intelligence?.repeat_failure_reduction || '75%',
                    label: 'Repeat Failure Reduction',
                    change: 'Target achievement'
                },
                {
                    value: data.business_intelligence?.estimated_annual_savings || '$50,000+',
                    label: 'Estimated Annual Savings',
                    change: 'ROI from training'
                }
            ];

            metricsContainer.innerHTML = metrics.map(metric => `
                <div class="metric-card">
                    <div class="metric-value">${metric.value}</div>
                    <div class="metric-label">${metric.label}</div>
                    <div class="metric-change">${metric.change}</div>
                </div>
            `).join('');
        }

        function populateSkillGapChart(analytics) {
            const ctx = document.getElementById('skillGapChart').getContext('2d');
            
            if (skillGapChart) {
                skillGapChart.destroy();
            }
            
            const skillGaps = analytics.top_skill_gaps || {};
            const labels = Object.keys(skillGaps);
            const data = Object.values(skillGaps);
            
            if (labels.length === 0) {
                // Show placeholder for no data
                labels.push('No Data Available');
                data.push(1);
            }
            
            skillGapChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#2563eb', '#059669', '#d97706', '#dc2626', '#7c3aed'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function populateFailureTypeChart(analytics) {
            const ctx = document.getElementById('failureTypeChart').getContext('2d');
            
            if (failureTypeChart) {
                failureTypeChart.destroy();
            }
            
            const failureTypes = analytics.failure_type_distribution || {};
            const labels = Object.keys(failureTypes);
            const data = Object.values(failureTypes);
            
            if (labels.length === 0) {
                labels.push('No Data Available');
                data.push(1);
            }
            
            failureTypeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Failure Count',
                        data: data,
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function populateTechnicianPerformance(performance) {
            const container = document.getElementById('technician-grid');
            
            const technicians = [
                {
                    name: 'Jake Thompson (Senior Technician)',
                    id: '4',
                    data: performance.jake_thompson || {}
                },
                {
                    name: 'Anna Kowalski (Technician II)', 
                    id: '5',
                    data: performance.anna_kowalski || {}
                }
            ];
            
            container.innerHTML = technicians.map(tech => {
                const improvements = tech.data.improvements || {};
                return `
                    <div class="technician-card">
                        <div class="technician-name">${tech.name}</div>
                        <div class="performance-metric">
                            <span>Efficiency Improvement:</span>
                            <span class="${improvements.efficiency_improvement_percent > 0 ? 'positive' : ''}">${improvements.efficiency_improvement_percent || 0}%</span>
                        </div>
                        <div class="performance-metric">
                            <span>First-Time Fix Rate:</span>
                            <span class="${improvements.first_time_fix_improvement_percent > 0 ? 'positive' : ''}">${improvements.first_time_fix_improvement_percent || 0}%</span>
                        </div>
                        <div class="performance-metric">
                            <span>Performance Trend:</span>
                            <span>${tech.data.roi_indicators?.performance_trend || 'stable'}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateTrainingOpportunities(analytics) {
            const container = document.getElementById('training-list');
            const opportunities = analytics.training_focus_areas || {};
            
            if (Object.keys(opportunities).length === 0) {
                container.innerHTML = '<p>No training opportunities identified yet. Complete more work orders to generate AI recommendations.</p>';
                return;
            }
            
            container.innerHTML = Object.entries(opportunities).map(([topic, count]) => `
                <div class="opportunity-item">
                    <div class="opportunity-title">üéØ ${topic}</div>
                    <div class="opportunity-details">Identified ${count} time(s) - High impact training opportunity</div>
                </div>
            `).join('');
        }

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</body>
</html>