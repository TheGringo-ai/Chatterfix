{% extends "base.html" %}

{% block title %}Parts Inventory Table - Manager Dashboard{% endblock %}

{% block content %}
<div class="cmms-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>ðŸ“¦ Parts & Inventory Management</h1>
            <p>Editable table view with bulk operations</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="cmms-btn-secondary" onclick="window.location.href='/manager/'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </button>
            <button class="cmms-btn-secondary" onclick="toggleBulkMode()">
                <i class="fas fa-check-square"></i> Bulk Edit
            </button>
            <button class="cmms-btn" onclick="window.location.href='/purchasing/pos'">
                <i class="fas fa-plus"></i> Add Parts
            </button>
        </div>
    </div>
</div>

<!-- Bulk Actions Bar -->
<div id="bulkActionsBar" class="bulk-actions-bar" style="display: none; padding: 1rem; background: #f8f9fa; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #dee2e6;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span id="selectedCount">0</span> parts selected
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="cmms-btn-secondary" onclick="bulkUpdateCategory()">
                <i class="fas fa-tags"></i> Update Category
            </button>
            <button class="cmms-btn-secondary" onclick="bulkUpdateSupplier()">
                <i class="fas fa-truck"></i> Update Supplier
            </button>
            <button class="cmms-btn-secondary" onclick="bulkUpdateStock()">
                <i class="fas fa-boxes"></i> Update Stock
            </button>
            <button class="cmms-btn-secondary" onclick="bulkReorder()">
                <i class="fas fa-shopping-cart"></i> Bulk Reorder
            </button>
            <button class="cmms-btn-secondary" style="background: #dc3545;" onclick="bulkDelete()">
                <i class="fas fa-trash"></i> Delete Selected
            </button>
            <button class="cmms-btn-secondary" onclick="toggleBulkMode()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    </div>
</div>

<!-- Editable Table -->
<div class="cmms-card">
    <div style="overflow-x: auto;">
        <table class="editable-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa;">
                    <th class="bulk-select" style="display: none; padding: 12px; border: 1px solid #dee2e6;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">ID</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Name</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Part Number</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Category</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Current Stock</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Min Stock</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Max Stock</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Unit Cost</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Supplier</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Location</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Status</th>
                    <th style="padding: 12px; border: 1px solid #dee2e6; font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for part in parts %}
                <tr data-id="{{ part.id }}" class="editable-row">
                    <td class="bulk-select" style="display: none; padding: 12px; border: 1px solid #dee2e6;">
                        <input type="checkbox" class="row-select" value="{{ part.id }}" onchange="updateSelectedCount()">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">{{ part.id }}</td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span class="display-value">{{ part.name }}</span>
                        <input type="text" class="edit-value" value="{{ part.name }}" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; font-family: monospace;">
                        <span class="display-value">{{ part.part_number }}</span>
                        <input type="text" class="edit-value" value="{{ part.part_number }}" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span class="display-value">
                            <span class="cmms-badge badge-maintenance">{{ part.category }}</span>
                        </span>
                        <select class="edit-value" style="display: none; width: 100%; padding: 4px;">
                            <option value="HVAC" {% if part.category == 'HVAC' %}selected{% endif %}>HVAC</option>
                            <option value="Electrical" {% if part.category == 'Electrical' %}selected{% endif %}>Electrical</option>
                            <option value="Mechanical" {% if part.category == 'Mechanical' %}selected{% endif %}>Mechanical</option>
                            <option value="Plumbing" {% if part.category == 'Plumbing' %}selected{% endif %}>Plumbing</option>
                            <option value="Safety" {% if part.category == 'Safety' %}selected{% endif %}>Safety</option>
                            <option value="Tools" {% if part.category == 'Tools' %}selected{% endif %}>Tools</option>
                        </select>
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                        <span class="display-value">
                            {% set stock_status = 'good' if part.current_stock > part.minimum_stock else ('low' if part.current_stock > 0 else 'out') %}
                            <span class="stock-indicator {% if stock_status == 'good' %}stock-good{% elif stock_status == 'low' %}stock-low{% else %}stock-out{% endif %}">
                                {{ part.current_stock }}
                            </span>
                        </span>
                        <input type="number" class="edit-value" value="{{ part.current_stock }}" min="0" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                        <span class="display-value">{{ part.minimum_stock }}</span>
                        <input type="number" class="edit-value" value="{{ part.minimum_stock }}" min="0" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: center;">
                        <span class="display-value">{{ part.maximum_stock }}</span>
                        <input type="number" class="edit-value" value="{{ part.maximum_stock }}" min="0" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; text-align: right;">
                        <span class="display-value">${{ "%.2f"|format(part.unit_cost) }}</span>
                        <input type="number" class="edit-value" value="{{ part.unit_cost }}" min="0" step="0.01" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span class="display-value">{{ part.supplier or 'No Supplier' }}</span>
                        <input type="text" class="edit-value" value="{{ part.supplier or '' }}" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        <span class="display-value">{{ part.location or 'No Location' }}</span>
                        <input type="text" class="edit-value" value="{{ part.location or '' }}" style="display: none; width: 100%; padding: 4px;">
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6;">
                        {% set stock_status = 'In Stock' if part.current_stock > part.minimum_stock else ('Low Stock' if part.current_stock > 0 else 'Out of Stock') %}
                        <span class="cmms-badge {% if stock_status == 'In Stock' %}badge-operational{% elif stock_status == 'Low Stock' %}badge-maintenance{% else %}badge-down{% endif %}">
                            {{ stock_status }}
                        </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #dee2e6; white-space: nowrap;">
                        <button class="edit-row-btn cmms-btn-sm" onclick="editRow('{{ part.id }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="save-row-btn cmms-btn-sm" onclick="saveRow('{{ part.id }}')" style="display: none;">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="cancel-row-btn cmms-btn-sm" onclick="cancelEdit('{{ part.id }}')" style="display: none; background: #6c757d;">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="cmms-btn-sm" onclick="reorderPart('{{ part.id }}')" style="background: #28a745;">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Bulk Category Update Modal -->
<div id="bulkCategoryModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y:auto;">
    <div class="modal-content form-light" style="margin: 15% auto; width: 90%; max-width: 400px; padding: 30px;">
        <h2 style="color: #212529;"><i class="fas fa-tags"></i> Bulk Update Category</h2>
        <form id="bulkCategoryForm" class="form-light">
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Category</label>
                <select id="bulkCategorySelect" class="form-select">
                    <option value="">Select Category...</option>
                    <option value="HVAC">HVAC</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Mechanical">Mechanical</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="Safety">Safety</option>
                    <option value="Tools">Tools</option>
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="document.getElementById('bulkCategoryModal').style.display='none'" class="cmms-btn" style="background: #6c757d;">Cancel</button>
                <button type="button" onclick="executeBulkCategoryUpdate()" class="cmms-btn">Update Category</button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Supplier Update Modal -->
<div id="bulkSupplierModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y:auto;">
    <div class="modal-content form-light" style="margin: 15% auto; width: 90%; max-width: 400px; padding: 30px;">
        <h2 style="color: #212529;"><i class="fas fa-truck"></i> Bulk Update Supplier</h2>
        <form id="bulkSupplierForm" class="form-light">
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Supplier</label>
                <input type="text" id="bulkSupplierInput" class="form-control" placeholder="Supplier name">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="document.getElementById('bulkSupplierModal').style.display='none'" class="cmms-btn" style="background: #6c757d;">Cancel</button>
                <button type="button" onclick="executeBulkSupplierUpdate()" class="cmms-btn">Update Supplier</button>
            </div>
        </form>
    </div>
</div>

<!-- Bulk Stock Update Modal -->
<div id="bulkStockModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y:auto;">
    <div class="modal-content form-light" style="margin: 15% auto; width: 90%; max-width: 400px; padding: 30px;">
        <h2 style="color: #212529;"><i class="fas fa-boxes"></i> Bulk Stock Update</h2>
        <form id="bulkStockForm" class="form-light">
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Action</label>
                <select id="bulkStockAction" class="form-select">
                    <option value="add">Add to Current Stock</option>
                    <option value="subtract">Subtract from Current Stock</option>
                    <option value="set">Set Stock Level</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label class="form-label">Quantity</label>
                <input type="number" id="bulkStockQuantity" class="form-control" min="0" placeholder="10">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="document.getElementById('bulkStockModal').style.display='none'" class="cmms-btn" style="background: #6c757d;">Cancel</button>
                <button type="button" onclick="executeBulkStockUpdate()" class="cmms-btn">Update Stock</button>
            </div>
        </form>
    </div>
</div>

<style>
.stock-indicator {
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.stock-good {
    background: #d4edda;
    color: #155724;
}

.stock-low {
    background: #fff3cd;
    color: #856404;
}

.stock-out {
    background: #f8d7da;
    color: #721c24;
}
</style>

<script>
let bulkModeActive = false;
let selectedRows = new Set();

function toggleBulkMode() {
    bulkModeActive = !bulkModeActive;
    const bulkColumns = document.querySelectorAll('.bulk-select');
    const bulkBar = document.getElementById('bulkActionsBar');
    
    bulkColumns.forEach(col => {
        col.style.display = bulkModeActive ? 'table-cell' : 'none';
    });
    
    bulkBar.style.display = bulkModeActive ? 'block' : 'none';
    
    if (!bulkModeActive) {
        selectedRows.clear();
        document.querySelectorAll('.row-select').forEach(cb => cb.checked = false);
        document.getElementById('selectAll').checked = false;
        updateSelectedCount();
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    const checkboxes = document.querySelectorAll('.row-select');
    
    selectedRows.clear();
    checkboxes.forEach(cb => {
        cb.checked = selectAll;
        if (selectAll) {
            selectedRows.add(cb.value);
        }
    });
    
    updateSelectedCount();
}

function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.row-select:checked');
    selectedRows.clear();
    
    checkboxes.forEach(cb => {
        selectedRows.add(cb.value);
    });
    
    document.getElementById('selectedCount').textContent = selectedRows.size;
    
    const allCheckboxes = document.querySelectorAll('.row-select');
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = selectedRows.size === allCheckboxes.length;
    selectAll.indeterminate = selectedRows.size > 0 && selectedRows.size < allCheckboxes.length;
}

function editRow(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const displayValues = row.querySelectorAll('.display-value');
    const editValues = row.querySelectorAll('.edit-value');
    const editBtn = row.querySelector('.edit-row-btn');
    const saveBtn = row.querySelector('.save-row-btn');
    const cancelBtn = row.querySelector('.cancel-row-btn');
    
    displayValues.forEach(el => el.style.display = 'none');
    editValues.forEach(el => el.style.display = 'block');
    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
}

function cancelEdit(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const displayValues = row.querySelectorAll('.display-value');
    const editValues = row.querySelectorAll('.edit-value');
    const editBtn = row.querySelector('.edit-row-btn');
    const saveBtn = row.querySelector('.save-row-btn');
    const cancelBtn = row.querySelector('.cancel-row-btn');
    
    displayValues.forEach(el => el.style.display = 'block');
    editValues.forEach(el => el.style.display = 'none');
    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
}

async function saveRow(id) {
    const row = document.querySelector(`tr[data-id="${id}"]`);
    const editInputs = row.querySelectorAll('.edit-value');
    
    const fields = {};
    const fieldMapping = ['name', 'part_number', 'category', 'current_stock', 'minimum_stock', 'maximum_stock', 'unit_cost', 'supplier', 'location'];
    
    editInputs.forEach((input, index) => {
        if (fieldMapping[index]) {
            let value = input.value;
            if (['current_stock', 'minimum_stock', 'maximum_stock'].includes(fieldMapping[index])) {
                value = parseInt(value) || 0;
            } else if (fieldMapping[index] === 'unit_cost') {
                value = parseFloat(value) || 0;
            }
            fields[fieldMapping[index]] = value;
        }
    });
    
    try {
        const formData = new FormData();
        formData.append('entity_type', 'parts');
        formData.append('updates', JSON.stringify([{id: id, fields: fields}]));
        
        const response = await fetch('/manager/api/bulk-update', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update display values
            const displayValues = row.querySelectorAll('.display-value');
            displayValues.forEach((display, index) => {
                const editValue = editInputs[index];
                const fieldName = fieldMapping[index];
                
                if (fieldName === 'category') {
                    const badge = display.querySelector('.cmms-badge');
                    if (badge) {
                        badge.textContent = editValue.value;
                    }
                } else if (fieldName === 'current_stock') {
                    const indicator = display.querySelector('.stock-indicator');
                    if (indicator) {
                        indicator.textContent = editValue.value;
                        // Update stock status color
                        const minStock = parseInt(editInputs[4].value) || 0;
                        const currentStock = parseInt(editValue.value) || 0;
                        
                        indicator.className = 'stock-indicator';
                        if (currentStock > minStock) {
                            indicator.className += ' stock-good';
                        } else if (currentStock > 0) {
                            indicator.className += ' stock-low';
                        } else {
                            indicator.className += ' stock-out';
                        }
                    }
                } else if (fieldName === 'unit_cost') {
                    display.textContent = '$' + parseFloat(editValue.value || 0).toFixed(2);
                } else {
                    if ((fieldName === 'supplier' || fieldName === 'location') && !editValue.value) {
                        display.textContent = fieldName === 'supplier' ? 'No Supplier' : 'No Location';
                    } else {
                        display.textContent = editValue.value;
                    }
                }
            });
            
            cancelEdit(id);
            showToast('Part updated successfully', 'success');
        } else {
            throw new Error(result.error || 'Update failed');
        }
    } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to update part: ' + error.message, 'error');
    }
}

function bulkUpdateCategory() {
    if (selectedRows.size === 0) {
        showToast('No rows selected', 'warning');
        return;
    }
    document.getElementById('bulkCategoryModal').style.display = 'block';
}

function bulkUpdateSupplier() {
    if (selectedRows.size === 0) {
        showToast('No rows selected', 'warning');
        return;
    }
    document.getElementById('bulkSupplierModal').style.display = 'block';
}

function bulkUpdateStock() {
    if (selectedRows.size === 0) {
        showToast('No rows selected', 'warning');
        return;
    }
    document.getElementById('bulkStockModal').style.display = 'block';
}

async function executeBulkCategoryUpdate() {
    const category = document.getElementById('bulkCategorySelect').value;
    if (!category) {
        showToast('Please select a category', 'warning');
        return;
    }
    
    const updates = Array.from(selectedRows).map(id => ({
        id: id,
        fields: { category: category }
    }));
    
    try {
        const formData = new FormData();
        formData.append('entity_type', 'parts');
        formData.append('updates', JSON.stringify(updates));
        
        const response = await fetch('/manager/api/bulk-update', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`Updated category for ${result.success_count} parts`, 'success');
            document.getElementById('bulkCategoryModal').style.display = 'none';
            location.reload();
        } else {
            throw new Error(result.error || 'Bulk update failed');
        }
    } catch (error) {
        console.error('Bulk update error:', error);
        showToast('Failed to update categories: ' + error.message, 'error');
    }
}

async function executeBulkSupplierUpdate() {
    const supplier = document.getElementById('bulkSupplierInput').value.trim();
    if (!supplier) {
        showToast('Please enter a supplier name', 'warning');
        return;
    }
    
    const updates = Array.from(selectedRows).map(id => ({
        id: id,
        fields: { supplier: supplier }
    }));
    
    try {
        const formData = new FormData();
        formData.append('entity_type', 'parts');
        formData.append('updates', JSON.stringify(updates));
        
        const response = await fetch('/manager/api/bulk-update', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`Updated supplier for ${result.success_count} parts`, 'success');
            document.getElementById('bulkSupplierModal').style.display = 'none';
            location.reload();
        } else {
            throw new Error(result.error || 'Bulk update failed');
        }
    } catch (error) {
        console.error('Bulk update error:', error);
        showToast('Failed to update suppliers: ' + error.message, 'error');
    }
}

async function executeBulkStockUpdate() {
    const action = document.getElementById('bulkStockAction').value;
    const quantity = parseInt(document.getElementById('bulkStockQuantity').value);
    
    if (!action || isNaN(quantity) || quantity < 0) {
        showToast('Please enter a valid quantity', 'warning');
        return;
    }
    
    // For bulk stock updates, we'll need special handling on the server side
    // For now, we'll simulate the update
    showToast(`Stock ${action} operation queued for ${selectedRows.size} parts`, 'success');
    document.getElementById('bulkStockModal').style.display = 'none';
    toggleBulkMode();
}

function bulkReorder() {
    if (selectedRows.size === 0) {
        showToast('No rows selected', 'warning');
        return;
    }
    
    if (confirm(`Create purchase orders for ${selectedRows.size} selected parts?`)) {
        showToast(`Purchase orders created for ${selectedRows.size} parts`, 'success');
        toggleBulkMode();
    }
}

function reorderPart(id) {
    if (confirm('Create a purchase order for this part?')) {
        showToast('Purchase order created successfully', 'success');
    }
}

async function bulkDelete() {
    if (selectedRows.size === 0) {
        showToast('No rows selected', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedRows.size} parts? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('entity_type', 'parts');
        formData.append('ids', JSON.stringify(Array.from(selectedRows)));
        
        const response = await fetch('/manager/api/bulk-delete', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`Deleted ${result.success_count} parts`, 'success');
            location.reload();
        } else {
            throw new Error(result.error || 'Bulk delete failed');
        }
    } catch (error) {
        console.error('Bulk delete error:', error);
        showToast('Failed to delete parts: ' + error.message, 'error');
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') {
        toast.style.background = '#28a745';
    } else if (type === 'error') {
        toast.style.background = '#dc3545';
    } else if (type === 'warning') {
        toast.style.background = '#ffc107';
        toast.style.color = '#212529';
    }
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %}