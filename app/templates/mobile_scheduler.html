{% extends "base.html" %}

{% block title %}Mobile Scheduler - ChatterFix{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
    /* Mobile-first responsive design */
    .mobile-scheduler {
        padding: 0.5rem;
        max-width: 100%;
        overflow-x: hidden;
    }

    .mobile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        margin: -0.5rem -0.5rem 1rem -0.5rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .mobile-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .technician-info {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
        margin-top: 0.5rem;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-card {
        background: var(--card-bg);
        padding: 1rem 0.5rem;
        border-radius: 8px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--border-color);
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        margin-bottom: 0.25rem;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
    }

    .today-schedule {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: bold;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .task-item {
        background: var(--bg-secondary);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--primary-color);
        position: relative;
    }

    .task-item.emergency {
        border-left-color: #dc2626;
        background: linear-gradient(135deg, rgba(220, 38, 38, 0.1) 0%, rgba(220, 38, 38, 0.05) 100%);
    }

    .task-item.urgent {
        border-left-color: #ea580c;
    }

    .task-item.high {
        border-left-color: #d97706;
    }

    .task-item.medium {
        border-left-color: #059669;
    }

    .task-item.completed {
        opacity: 0.7;
        text-decoration: line-through;
    }

    .task-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .task-title {
        font-weight: bold;
        font-size: 0.95rem;
        line-height: 1.3;
        flex: 1;
        margin-right: 0.5rem;
    }

    .task-time {
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: bold;
        white-space: nowrap;
    }

    .task-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        font-size: 0.8rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
    }

    .task-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
    }

    .btn-mobile {
        flex: 1;
        padding: 0.75rem 0.5rem;
        border-radius: 6px;
        border: none;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-primary-mobile {
        background: var(--primary-color);
        color: white;
    }

    .btn-secondary-mobile {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
    }

    .btn-success-mobile {
        background: #059669;
        color: white;
    }

    .btn-mobile:active {
        transform: scale(0.98);
    }

    .upcoming-tasks {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .fab {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        width: 56px;
        height: 56px;
        background: var(--primary-color);
        color: white;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .fab:active {
        transform: scale(0.9);
    }

    .emergency-alert {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
        100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
    }

    .emergency-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
    }

    .modal-content {
        background: var(--card-bg);
        margin: 10% auto;
        padding: 1.5rem;
        width: 90%;
        max-width: 400px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .modal-title {
        font-size: 1.1rem;
        font-weight: bold;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .textarea {
        resize: vertical;
        min-height: 80px;
    }

    .offline-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #dc2626;
        color: white;
        text-align: center;
        padding: 0.5rem;
        font-size: 0.8rem;
        font-weight: bold;
        display: none;
        z-index: 1001;
    }

    .sync-status {
        position: fixed;
        bottom: 4.5rem;
        right: 1rem;
        background: var(--card-bg);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        border: 2px solid var(--border-color);
        font-size: 0.8rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 999;
    }

    .sync-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
    }

    .sync-indicator.online {
        background: #059669;
    }

    .sync-indicator.syncing {
        background: #d97706;
        animation: blink 1s infinite;
    }

    .sync-indicator.offline {
        background: #dc2626;
    }

    @keyframes blink {
        50% { opacity: 0.3; }
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--card-bg);
        border-top: 2px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        padding: 0.75rem 0;
        z-index: 998;
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: var(--text-secondary);
        font-size: 0.7rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .nav-item.active {
        color: var(--primary-color);
    }

    .nav-icon {
        font-size: 1.2rem;
        margin-bottom: 0.25rem;
    }

    /* Pull to refresh styles */
    .pull-refresh {
        transform: translateY(0);
        transition: transform 0.3s ease;
    }

    .pull-refresh.pulling {
        transform: translateY(60px);
    }

    .refresh-indicator {
        position: absolute;
        top: -60px;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-color);
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
    }

    /* Swipe actions */
    .task-item {
        position: relative;
        transform: translateX(0);
        transition: transform 0.3s ease;
    }

    .task-item.swiping-left {
        transform: translateX(-80px);
    }

    .task-item.swiping-right {
        transform: translateX(80px);
    }

    .swipe-action {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .swipe-action.left {
        right: 0;
        background: #059669;
    }

    .swipe-action.right {
        left: 0;
        background: #dc2626;
    }

    /* Hide on mobile browsers */
    @media screen and (max-width: 768px) {
        .mobile-scheduler {
            padding-bottom: 5rem; /* Account for bottom nav */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="offline-indicator" id="offlineIndicator">
    Offline Mode - Changes will sync when connected
</div>

<div class="mobile-scheduler pull-refresh" id="mainContent">
    <div class="refresh-indicator">
        Release to refresh...
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-title">Field Technician Dashboard</div>
        <div class="technician-info" id="technicianName">John Martinez</div>
        <div class="status-badge" id="technicianStatus">Available</div>
    </div>

    <!-- Emergency Alerts -->
    <div id="emergencyAlerts">
        <!-- Emergency alerts will be populated here -->
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
        <div class="stat-card">
            <div class="stat-value" id="todayTasks">0</div>
            <div class="stat-label">Today's Tasks</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completedTasks">0</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="hoursWorked">0.0</div>
            <div class="stat-label">Hours</div>
        </div>
    </div>

    <!-- Today's Schedule -->
    <div class="today-schedule">
        <div class="section-title">
            üìÖ Today's Schedule
            <button class="btn-secondary-mobile" onclick="refreshSchedule()" style="margin-left: auto; padding: 0.5rem;">
                üîÑ
            </button>
        </div>
        <div id="todayTasks">
            <!-- Today's tasks will be populated here -->
        </div>
    </div>

    <!-- Upcoming Tasks -->
    <div class="upcoming-tasks">
        <div class="section-title">
            ‚è∞ Upcoming Tasks
        </div>
        <div id="upcomingTasks">
            <!-- Upcoming tasks will be populated here -->
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab" onclick="openReportModal()">
    üìù
</button>

<!-- Sync Status -->
<div class="sync-status">
    <span class="sync-indicator online" id="syncIndicator"></span>
    <span id="syncStatus">Online</span>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <a href="#" class="nav-item active" onclick="switchTab('schedule')">
        <div class="nav-icon">üìã</div>
        <div>Schedule</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('map')">
        <div class="nav-icon">üó∫Ô∏è</div>
        <div>Map</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('tools')">
        <div class="nav-icon">üîß</div>
        <div>Tools</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('profile')">
        <div class="nav-icon">üë§</div>
        <div>Profile</div>
    </a>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Quick Report</div>
            <button class="close-btn" onclick="closeReportModal()">&times;</button>
        </div>
        
        <form id="reportForm" onsubmit="submitReport(event)">
            <div class="form-group">
                <label class="form-label">Report Type</label>
                <select class="form-input" id="reportType" required>
                    <option value="">Select type...</option>
                    <option value="completion">Task Completion</option>
                    <option value="issue">Issue Report</option>
                    <option value="parts_request">Parts Request</option>
                    <option value="safety_concern">Safety Concern</option>
                    <option value="delay">Delay Report</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Asset/Location</label>
                <input type="text" class="form-input" id="reportAsset" placeholder="Asset ID or location">
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-input textarea" id="reportDescription" placeholder="Describe the situation..." required></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Estimated Time (hours)</label>
                <input type="number" class="form-input" id="reportTime" step="0.5" min="0" placeholder="0.5">
            </div>
            
            <div class="task-actions">
                <button type="button" class="btn-secondary-mobile" onclick="closeReportModal()">Cancel</button>
                <button type="submit" class="btn-primary-mobile">Submit Report</button>
            </div>
        </form>
    </div>
</div>

<script>
let currentTechnician = null;
let todaysTasks = [];
let upcomingTasks = [];
let isOnline = navigator.onLine;
let lastSyncTime = new Date();

// Mock technician data
const mockTechnician = {
    id: 'tech_001',
    name: 'John Martinez',
    status: 'available',
    shift: { start: '07:00', end: '15:00' },
    location: 'Building A - Production Floor',
    skills: ['hydraulics', 'mechanical', 'safety_inspection']
};

// Mock task data
const mockTasks = [
    {
        id: 'wo_001',
        title: 'Hydraulic Press Daily Check',
        asset_id: 'hydraulic_press_001',
        location: 'Building A - Production Floor',
        priority: 'medium',
        scheduled_time: '08:00',
        estimated_duration: 0.5,
        status: 'pending',
        description: 'Daily inspection of hydraulic system',
        procedures: [
            'Check hydraulic fluid levels',
            'Inspect for leaks',
            'Check pressure readings',
            'Test emergency stops'
        ]
    },
    {
        id: 'wo_002',
        title: 'EMERGENCY: Motor Vibration Alert',
        asset_id: 'motor_drive_003',
        location: 'Building B - Assembly Line',
        priority: 'emergency',
        scheduled_time: 'ASAP',
        estimated_duration: 2.0,
        status: 'pending',
        description: 'High vibration detected on motor drive',
        procedures: [
            'Perform vibration analysis',
            'Check bearing condition',
            'Verify motor alignment'
        ]
    },
    {
        id: 'wo_003',
        title: 'Conveyor Belt Inspection',
        asset_id: 'conveyor_main_001',
        location: 'Warehouse North',
        priority: 'low',
        scheduled_time: '14:00',
        estimated_duration: 1.5,
        status: 'pending',
        description: 'Weekly inspection of conveyor system'
    }
];

document.addEventListener('DOMContentLoaded', () => {
    initializeMobileApp();
    loadTechnicianData();
    loadTodaysTasks();
    setupOfflineSupport();
    setupPullToRefresh();
    setupSwipeActions();
});

function initializeMobileApp() {
    // Update technician info
    document.getElementById('technicianName').textContent = mockTechnician.name;
    document.getElementById('technicianStatus').textContent = mockTechnician.status;
    
    // Update sync status
    updateSyncStatus();
    
    // Setup online/offline listeners
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    // Setup periodic sync
    setInterval(syncData, 30000); // Sync every 30 seconds when online
}

function loadTechnicianData() {
    // In a real app, this would load from localStorage or API
    currentTechnician = mockTechnician;
    updateTechnicianDisplay();
}

function loadTodaysTasks() {
    // Simulate loading today's tasks
    todaysTasks = mockTasks.filter(task => {
        // Filter for today's tasks
        return true; // For demo, show all tasks
    });
    
    updateTasksDisplay();
    updateStats();
}

function updateTasksDisplay() {
    const todayContainer = document.getElementById('todayTasks');
    const upcomingContainer = document.getElementById('upcomingTasks');
    
    // Clear existing content
    todayContainer.innerHTML = '';
    upcomingContainer.innerHTML = '';
    
    // Separate today's and upcoming tasks
    const today = new Date().toDateString();
    
    todaysTasks.forEach(task => {
        const taskElement = createTaskElement(task);
        todayContainer.appendChild(taskElement);
    });
    
    // Add emergency tasks at the top
    const emergencyTasks = todaysTasks.filter(task => task.priority === 'emergency');
    if (emergencyTasks.length > 0) {
        updateEmergencyAlerts(emergencyTasks);
    }
    
    // Show upcoming tasks (next 3 days)
    const upcomingTasksFiltered = mockTasks.slice(0, 3);
    upcomingTasksFiltered.forEach(task => {
        const taskElement = createTaskElement(task, false);
        upcomingContainer.appendChild(taskElement);
    });
}

function createTaskElement(task, isToday = true) {
    const taskDiv = document.createElement('div');
    taskDiv.className = `task-item ${task.priority} ${task.status}`;
    taskDiv.id = `task-${task.id}`;
    
    const priorityColors = {
        emergency: '#dc2626',
        urgent: '#ea580c',
        high: '#d97706',
        medium: '#059669',
        low: '#0284c7'
    };
    
    taskDiv.innerHTML = `
        <div class="swipe-action left">‚úì</div>
        <div class="swipe-action right">‚úï</div>
        
        <div class="task-header">
            <div class="task-title">${task.title}</div>
            <div class="task-time">${task.scheduled_time}</div>
        </div>
        
        <div class="task-details">
            <div>üìç ${task.location}</div>
            <div>‚è±Ô∏è ${task.estimated_duration}h</div>
        </div>
        
        <div style="font-size: 0.85rem; margin-bottom: 0.5rem; color: var(--text-secondary);">
            ${task.description}
        </div>
        
        ${isToday ? `
        <div class="task-actions">
            <button class="btn-secondary-mobile" onclick="viewTaskDetails('${task.id}')">
                View Details
            </button>
            <button class="btn-success-mobile" onclick="startTask('${task.id}')">
                Start Task
            </button>
        </div>
        ` : ''}
    `;
    
    return taskDiv;
}

function updateEmergencyAlerts(emergencyTasks) {
    const alertsContainer = document.getElementById('emergencyAlerts');
    alertsContainer.innerHTML = '';
    
    emergencyTasks.forEach(task => {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'emergency-alert';
        alertDiv.innerHTML = `
            <div class="emergency-title">
                üö® EMERGENCY ALERT
            </div>
            <div>${task.title}</div>
            <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                Location: ${task.location}
            </div>
            <button class="btn-mobile btn-primary-mobile" onclick="startTask('${task.id}')" style="margin-top: 0.5rem; width: 100%;">
                Respond Now
            </button>
        `;
        alertsContainer.appendChild(alertDiv);
    });
}

function updateStats() {
    const totalTasks = todaysTasks.length;
    const completedTasks = todaysTasks.filter(t => t.status === 'completed').length;
    const hoursWorked = todaysTasks
        .filter(t => t.status === 'completed')
        .reduce((sum, t) => sum + t.estimated_duration, 0);
    
    document.getElementById('todayTasks').textContent = totalTasks;
    document.getElementById('completedTasks').textContent = completedTasks;
    document.getElementById('hoursWorked').textContent = hoursWorked.toFixed(1);
}

function startTask(taskId) {
    const task = todaysTasks.find(t => t.id === taskId);
    if (!task) return;
    
    // Update task status
    task.status = 'in_progress';
    
    // Show confirmation
    if (confirm(`Start "${task.title}"?\n\nEstimated time: ${task.estimated_duration} hours`)) {
        // Update display
        updateTasksDisplay();
        updateStats();
        
        // Show task in progress indicator
        showTaskTimer(task);
        
        // Update sync
        queueSync('task_started', { taskId, timestamp: new Date().toISOString() });
    }
}

function completeTask(taskId) {
    const task = todaysTasks.find(t => t.id === taskId);
    if (!task) return;
    
    task.status = 'completed';
    task.completedAt = new Date().toISOString();
    
    // Update display
    updateTasksDisplay();
    updateStats();
    
    // Show success message
    showNotification('Task completed successfully!', 'success');
    
    // Update sync
    queueSync('task_completed', { taskId, timestamp: task.completedAt });
}

function viewTaskDetails(taskId) {
    const task = todaysTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const details = `
Task: ${task.title}
Asset: ${task.asset_id}
Location: ${task.location}
Priority: ${task.priority.toUpperCase()}
Duration: ${task.estimated_duration} hours

Description:
${task.description}

${task.procedures ? 'Procedures:\n‚Ä¢ ' + task.procedures.join('\n‚Ä¢ ') : ''}
    `;
    
    alert(details); // In production, use a proper modal
}

function showTaskTimer(task) {
    // Create a floating timer for the active task
    const timer = document.createElement('div');
    timer.id = 'activeTaskTimer';
    timer.style.cssText = `
        position: fixed;
        top: 4rem;
        right: 1rem;
        background: var(--primary-color);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: bold;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    `;
    
    let startTime = Date.now();
    let elapsedTime = 0;
    
    function updateTimer() {
        elapsedTime = (Date.now() - startTime) / 1000;
        const hours = Math.floor(elapsedTime / 3600);
        const minutes = Math.floor((elapsedTime % 3600) / 60);
        const seconds = Math.floor(elapsedTime % 60);
        
        timer.innerHTML = `
            ${task.title.substring(0, 15)}...<br>
            ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
            <br>
            <button onclick="completeTask('${task.id}')" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
                font-size: 0.7rem;
                cursor: pointer;
                margin-top: 0.25rem;
            ">Complete</button>
        `;
    }
    
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);
    
    // Store timer info for cleanup
    timer.dataset.interval = timerInterval;
    
    document.body.appendChild(timer);
}

function openReportModal() {
    document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
    document.getElementById('reportForm').reset();
}

function submitReport(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const report = {
        id: 'report_' + Date.now(),
        type: formData.get('reportType') || document.getElementById('reportType').value,
        asset: formData.get('reportAsset') || document.getElementById('reportAsset').value,
        description: formData.get('reportDescription') || document.getElementById('reportDescription').value,
        time: formData.get('reportTime') || document.getElementById('reportTime').value,
        technician: currentTechnician.id,
        timestamp: new Date().toISOString()
    };
    
    // Queue for sync
    queueSync('report_submitted', report);
    
    // Close modal
    closeReportModal();
    
    // Show confirmation
    showNotification('Report submitted successfully!', 'success');
}

function switchTab(tab) {
    // Update active tab
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    event.target.closest('.nav-item').classList.add('active');
    
    // Handle tab switching
    switch (tab) {
        case 'schedule':
            // Already showing schedule
            break;
        case 'map':
            showNotification('Map view coming soon!', 'info');
            break;
        case 'tools':
            showNotification('Tools inventory coming soon!', 'info');
            break;
        case 'profile':
            showNotification('Profile settings coming soon!', 'info');
            break;
    }
}

function refreshSchedule() {
    showNotification('Refreshing schedule...', 'info');
    
    // Simulate refresh
    setTimeout(() => {
        loadTodaysTasks();
        showNotification('Schedule updated!', 'success');
    }, 1000);
}

// Offline support
function setupOfflineSupport() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/mobile-sw.js')
            .then(registration => console.log('SW registered'))
            .catch(error => console.log('SW registration failed'));
    }
    
    // Initialize offline storage
    if (!localStorage.getItem('pendingSync')) {
        localStorage.setItem('pendingSync', JSON.stringify([]));
    }
}

function handleOnline() {
    isOnline = true;
    updateSyncStatus();
    document.getElementById('offlineIndicator').style.display = 'none';
    syncPendingData();
}

function handleOffline() {
    isOnline = false;
    updateSyncStatus();
    document.getElementById('offlineIndicator').style.display = 'block';
}

function updateSyncStatus() {
    const indicator = document.getElementById('syncIndicator');
    const status = document.getElementById('syncStatus');
    
    if (isOnline) {
        indicator.className = 'sync-indicator online';
        status.textContent = 'Online';
    } else {
        indicator.className = 'sync-indicator offline';
        status.textContent = 'Offline';
    }
}

function queueSync(action, data) {
    const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    pending.push({ action, data, timestamp: new Date().toISOString() });
    localStorage.setItem('pendingSync', JSON.stringify(pending));
    
    if (isOnline) {
        syncPendingData();
    }
}

function syncPendingData() {
    const pending = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    
    if (pending.length === 0) return;
    
    // Update sync indicator
    const indicator = document.getElementById('syncIndicator');
    indicator.className = 'sync-indicator syncing';
    document.getElementById('syncStatus').textContent = 'Syncing...';
    
    // Simulate sync
    setTimeout(() => {
        localStorage.setItem('pendingSync', JSON.stringify([]));
        lastSyncTime = new Date();
        updateSyncStatus();
        console.log('Synced', pending.length, 'items');
    }, 2000);
}

function syncData() {
    if (!isOnline) return;
    
    // Periodic sync of current data
    syncPendingData();
}

// Pull to refresh
function setupPullToRefresh() {
    let startY = 0;
    let currentY = 0;
    let isRefreshing = false;
    
    const mainContent = document.getElementById('mainContent');
    
    mainContent.addEventListener('touchstart', (e) => {
        if (window.scrollY === 0) {
            startY = e.touches[0].clientY;
        }
    });
    
    mainContent.addEventListener('touchmove', (e) => {
        if (window.scrollY === 0 && !isRefreshing) {
            currentY = e.touches[0].clientY;
            const diff = currentY - startY;
            
            if (diff > 0 && diff < 100) {
                mainContent.style.transform = `translateY(${diff}px)`;
            } else if (diff >= 100) {
                mainContent.classList.add('pulling');
            }
        }
    });
    
    mainContent.addEventListener('touchend', () => {
        if (mainContent.classList.contains('pulling') && !isRefreshing) {
            isRefreshing = true;
            refreshSchedule();
            
            setTimeout(() => {
                mainContent.style.transform = 'translateY(0)';
                mainContent.classList.remove('pulling');
                isRefreshing = false;
            }, 1000);
        } else {
            mainContent.style.transform = 'translateY(0)';
        }
    });
}

// Swipe actions
function setupSwipeActions() {
    let startX = 0;
    let currentX = 0;
    let swipingElement = null;
    
    document.addEventListener('touchstart', (e) => {
        if (e.target.closest('.task-item')) {
            startX = e.touches[0].clientX;
            swipingElement = e.target.closest('.task-item');
        }
    });
    
    document.addEventListener('touchmove', (e) => {
        if (swipingElement) {
            currentX = e.touches[0].clientX;
            const diff = currentX - startX;
            
            if (Math.abs(diff) > 20) {
                if (diff > 0) {
                    swipingElement.classList.add('swiping-right');
                } else {
                    swipingElement.classList.add('swiping-left');
                }
            }
        }
    });
    
    document.addEventListener('touchend', () => {
        if (swipingElement) {
            const diff = currentX - startX;
            
            if (diff > 100) {
                // Swipe right - mark as complete
                const taskId = swipingElement.id.replace('task-', '');
                completeTask(taskId);
            } else if (diff < -100) {
                // Swipe left - defer task
                const taskId = swipingElement.id.replace('task-', '');
                deferTask(taskId);
            }
            
            swipingElement.classList.remove('swiping-left', 'swiping-right');
            swipingElement = null;
        }
    });
}

function deferTask(taskId) {
    if (confirm('Defer this task to later today?')) {
        const task = todaysTasks.find(t => t.id === taskId);
        if (task) {
            task.deferred = true;
            updateTasksDisplay();
            showNotification('Task deferred', 'info');
            queueSync('task_deferred', { taskId, timestamp: new Date().toISOString() });
        }
    }
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 1rem;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#059669' : type === 'error' ? '#dc2626' : '#0284c7'};
        color: white;
        padding: 1rem 2rem;
        border-radius: 8px;
        font-weight: bold;
        z-index: 2001;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        document.body.removeChild(notification);
    }, 3000);
}

// Close modal when clicking outside
window.addEventListener('click', (e) => {
    const modal = document.getElementById('reportModal');
    if (e.target === modal) {
        closeReportModal();
    }
});
</script>
{% endblock %}