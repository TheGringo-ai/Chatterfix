{% extends "base.html" %}

{% block title %}Join {{ organization_name }} - ChatterFix{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full">
        <!-- Glass card -->
        <div class="glass-card p-8 rounded-2xl shadow-glass">
            <!-- Logo/Icon -->
            <div class="text-center mb-8">
                <div class="w-16 h-16 mx-auto bg-gradient-to-br from-accent to-accent-secondary rounded-full flex items-center justify-center mb-4">
                    <i class="fas fa-users text-white text-2xl"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white">You're Invited!</h2>
                <p class="mt-2 text-gray-600 dark:text-gray-300">
                    Join <strong>{{ organization_name }}</strong> on ChatterFix
                </p>
            </div>

            <!-- Invite Details -->
            <div class="bg-white/50 dark:bg-gray-800/50 rounded-xl p-4 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Organization</span>
                    <span class="font-semibold text-gray-800 dark:text-white">{{ organization_name }}</span>
                </div>
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Role</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent/20 text-accent">
                        {{ invite.role | capitalize if invite.role else 'Team Member' }}
                    </span>
                </div>
                {% if invite.invited_by_email %}
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Invited by</span>
                    <span class="text-gray-800 dark:text-white">{{ invite.invited_by_email }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3">
                <!-- Accept Invite (requires login) -->
                <form id="acceptInviteForm" action="/organization/invite/{{ invite_code }}/accept" method="POST">
                    <button type="submit"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-gradient-to-r from-accent to-accent-secondary hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent transition-all duration-200">
                        <i class="fas fa-check-circle mr-2"></i>
                        Accept Invitation
                    </button>
                </form>

                <!-- Already have an account? Login first -->
                <div class="text-center text-sm text-gray-600 dark:text-gray-400">
                    <p class="mb-2">You need to be logged in to accept this invite.</p>
                    <div class="flex justify-center space-x-4">
                        <a href="/login?next=/organization/invite/{{ invite_code }}"
                           class="text-accent hover:text-accent-secondary font-medium">
                            Sign In
                        </a>
                        <span class="text-gray-400">or</span>
                        <a href="/landing?next=/organization/invite/{{ invite_code }}"
                           class="text-accent hover:text-accent-secondary font-medium">
                            Create Account
                        </a>
                    </div>
                </div>
            </div>

            <!-- Note -->
            <div class="mt-6 p-3 bg-blue-50 dark:bg-blue-900/30 rounded-xl">
                <div class="flex">
                    <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-2"></i>
                    <p class="text-xs text-blue-700 dark:text-blue-300">
                        By accepting this invite, you'll join {{ organization_name }}'s workspace and gain access to their assets, work orders, and team collaboration features.
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <p class="mt-4 text-center text-xs text-gray-500 dark:text-gray-400">
            Powered by ChatterFix CMMS - Built for Technicians
        </p>
    </div>
</div>

<script>
document.getElementById('acceptInviteForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
    btn.disabled = true;

    try {
        const response = await fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
            // Show success and redirect
            btn.innerHTML = '<i class="fas fa-check mr-2"></i>Welcome to the team!';
            btn.classList.remove('from-accent', 'to-accent-secondary');
            btn.classList.add('bg-green-500');

            setTimeout(() => {
                window.location.href = '/dashboard?welcome=team';
            }, 1500);
        } else {
            // Show error
            btn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + (data.detail || 'Failed to accept invite');
            btn.classList.remove('from-accent', 'to-accent-secondary');
            btn.classList.add('bg-red-500');

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-red-500');
                btn.classList.add('from-accent', 'to-accent-secondary');
                btn.disabled = false;
            }, 3000);
        }
    } catch (error) {
        console.error('Error:', error);
        btn.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Please log in first';
        btn.classList.remove('from-accent', 'to-accent-secondary');
        btn.classList.add('bg-orange-500');

        setTimeout(() => {
            window.location.href = '/login?next=/organization/invite/{{ invite_code }}';
        }, 2000);
    }
});
</script>
{% endblock %}
