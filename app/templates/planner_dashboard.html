{% extends "base.html" %}

{% block title %}{% if advanced_mode %}Advanced Enterprise Scheduler - ChatterFix{% else %}Planner Dashboard - ChatterFix{% endif %}{% endblock %}

{% block head %}
{% if advanced_mode %}
<!-- FullCalendar CSS and JS for advanced scheduling -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Gantt chart library -->
<script src="https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.6/codebase/dhtmlxgantt.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.6/codebase/dhtmlxgantt.css">
{% endif %}

<style>
    :root {
        --card-bg: #1e1e2f;
        --border-color: rgba(255, 255, 255, 0.1);
        --text-primary: #ffffff;
        --text-secondary: rgba(255, 255, 255, 0.7);
    }

    .planner-dashboard {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .planner-header {
        margin-bottom: 2rem;
    }

    .planner-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .planner-header h1::before {
        content: "üìÖ";
        font-size: 2.5rem;
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .planner-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .planner-widget {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .widget-title {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .widget-content {
        max-height: 400px;
        overflow-y: auto;
    }

    .capacity-bar {
        margin-bottom: 1rem;
    }

    .capacity-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .capacity-progress {
        height: 24px;
        background: var(--border-color);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .capacity-fill {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .capacity-fill.high {
        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .backlog-item {
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--primary-color);
    }

    .backlog-item.urgent {
        border-left-color: #f5576c;
    }

    .backlog-item.high {
        border-left-color: #f093fb;
    }

    .backlog-item.medium {
        border-left-color: #4facfe;
    }

    .backlog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .backlog-title {
        font-weight: 600;
        font-size: 1rem;
    }

    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .priority-badge.urgent {
        background: #f5576c;
        color: white;
    }

    .priority-badge.high {
        background: #f093fb;
        color: white;
    }

    .priority-badge.medium {
        background: #4facfe;
        color: white;
    }

    .priority-badge.low {
        background: var(--border-color);
        color: var(--text-primary);
    }

    .backlog-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .asset-pm-item {
        padding: 0.75rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pm-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .pm-status.overdue {
        background: #f5576c;
        color: white;
    }

    .pm-status.due-today {
        background: #f093fb;
        color: white;
    }

    .pm-status.due-this-week {
        background: #ffd93d;
        color: #333;
    }

    .conflict-alert {
        padding: 1rem;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        color: white;
    }

    .conflict-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .compliance-stat {
        text-align: center;
        padding: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
    }

    .compliance-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .compliance-number.danger {
        color: #f5576c;
    }

    .compliance-number.warning {
        color: #ffd93d;
    }

    .compliance-number.success {
        color: #4facfe;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .refresh-btn {
        padding: 0.5rem 1rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    
    /* FullCalendar Customizations - Modern Glass Morphism Design */
    .fc {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 16px !important;
        padding: 20px !important;
        font-family: "Outfit", "Segoe UI", sans-serif !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
    }
    
    .fc-theme-standard .fc-scrollgrid {
        border: 1px solid rgba(134, 142, 150, 0.2) !important;
        background: rgba(255, 255, 255, 0.02) !important;
        border-radius: 12px !important;
        overflow: hidden !important;
    }
    
    .fc-theme-standard td, .fc-theme-standard th {
        border-color: rgba(134, 142, 150, 0.15) !important;
        background: transparent !important;
        transition: background-color 0.3s ease !important;
    }
    
    .fc-theme-standard td:hover {
        background: rgba(102, 126, 234, 0.05) !important;
    }
    
    .fc-theme-standard .fc-popover {
        background: rgba(30, 30, 47, 0.95) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 12px !important;
        color: #ffffff !important;
        font-family: "Outfit", sans-serif !important;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
    }
    
    .fc-daygrid-day {
        background: transparent !important;
        color: #e2e8f0 !important;
        position: relative !important;
    }
    
    .fc-day-today {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
        border: 2px solid rgba(102, 126, 234, 0.3) !important;
        border-radius: 8px !important;
    }
    
    .fc-col-header-cell {
        background: linear-gradient(135deg, rgba(51, 65, 85, 0.8) 0%, rgba(30, 41, 59, 0.9) 100%) !important;
        color: #f1f5f9 !important;
        font-weight: 700 !important;
        font-size: 0.9rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        padding: 12px 8px !important;
    }
    
    .fc-daygrid-day-number {
        color: #cbd5e1 !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
        padding: 6px !important;
        border-radius: 6px !important;
        transition: all 0.3s ease !important;
    }
    
    .fc-daygrid-day-number:hover {
        background: rgba(102, 126, 234, 0.2) !important;
        color: #ffffff !important;
        transform: scale(1.1) !important;
    }
    
    .fc-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        color: #ffffff !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 600 !important;
        padding: 8px 16px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
    }
    
    .fc-button:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
    }
    
    .fc-button:disabled {
        background: rgba(100, 116, 139, 0.3) !important;
        color: rgba(148, 163, 184, 0.6) !important;
        box-shadow: none !important;
        transform: none !important;
    }
    
    .fc-toolbar-title {
        color: #f1f5f9 !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 700 !important;
        font-size: 1.5rem !important;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    }

    .fc-event {
        border-radius: 8px !important;
        border: none !important;
        font-size: 0.85rem !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 500 !important;
        padding: 2px 6px !important;
        margin: 1px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
    }
    
    .fc-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }

    .fc-event-title {
        font-weight: 600 !important;
        font-family: "Outfit", sans-serif !important;
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Weekend styling */
    .fc-day-sat, .fc-day-sun {
        background: rgba(148, 163, 184, 0.05) !important;
    }
    
    /* Event color variations for different types */
    .fc-event.maintenance {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
    }
    
    .fc-event.urgent {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }
    
    .fc-event.scheduled {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%) !important;
    }
    
    .fc-event.inspection {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%) !important;
        color: #333333 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="planner-dashboard">
    <div class="planner-header">
        {% if advanced_mode %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1>üóìÔ∏è Advanced Enterprise Scheduler</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                    AI-driven maintenance scheduling with FullCalendar, Gantt charts, and optimization
                </p>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <!-- Primary Actions for Maintenance Planners -->
                <div style="display: flex; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 8px; border: 2px solid #4facfe;">
                    <button class="btn btn-success btn-sm" onclick="showCreateJobModal()">
                        ‚ûï Create Job
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="showSchedulePMModal()">
                        üìÖ Schedule PM
                    </button>
                    <button class="btn btn-info btn-sm" onclick="showBulkScheduleModal()">
                        üìã Bulk Schedule
                    </button>
                </div>
                <!-- View Controls -->
                <div style="display: flex; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 8px; border: 2px solid var(--border-color);">
                    <button class="btn btn-primary btn-sm" onclick="switchView('calendar')">üìÖ Calendar</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="switchView('gantt')">üìä Gantt</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="switchView('list')">üìã List</button>
                </div>
                <!-- AI & Export Tools -->
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-success btn-sm" onclick="optimizeSchedule()">
                        ü§ñ AI Optimize
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="exportSchedule()">
                        üì§ Export
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1>Maintenance Planner Dashboard</h1>
                <p style="color: var(--text-secondary);">Plan, schedule, and optimize maintenance operations</p>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <!-- Primary Planner Actions -->
                <button class="btn btn-success" onclick="showCreateJobModal()">
                    ‚ûï Create New Job
                </button>
                <button class="btn btn-warning" onclick="showSchedulePMModal()">
                    üìÖ Schedule PM
                </button>
                <button class="btn btn-info" onclick="showBulkScheduleModal()">
                    üìã Bulk Operations
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats" id="quickStats">
        <div class="stat-card warning">
            <div class="stat-value" id="backlogCount">-</div>
            <div class="stat-label">Work Order Backlog</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="overdueCount">-</div>
            <div class="stat-label">Overdue Items</div>
        </div>
        <div class="stat-card success">
            <div class="stat-value" id="capacityAvg">-</div>
            <div class="stat-label">Avg Capacity %</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="conflictCount">-</div>
            <div class="stat-label">Scheduling Conflicts</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="planner-grid">
        <!-- Resource Capacity -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üë• Resource Capacity</div>
                <button class="refresh-btn" onclick="loadCapacity()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="capacityContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading capacity data...</p>
                </div>
            </div>
        </div>

        <!-- Work Order Backlog -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üìã Work Order Backlog</div>
                <button class="refresh-btn" onclick="loadBacklog()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="backlogContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading backlog...</p>
                </div>
            </div>
        </div>

        <!-- Asset PM Status -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üîß Asset PM Status</div>
                <button class="refresh-btn" onclick="loadAssetPM()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="assetPMContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading asset PM status...</p>
                </div>
            </div>
        </div>

        <!-- Scheduling Conflicts -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">‚ö†Ô∏è Scheduling Conflicts</div>
                <button class="refresh-btn" onclick="loadConflicts()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="conflictsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading conflicts...</p>
                </div>
            </div>
        </div>

        <!-- Parts Availability -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üì¶ Parts Availability</div>
                <button class="refresh-btn" onclick="loadParts()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="partsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading parts data...</p>
                </div>
            </div>
        </div>

        <!-- Compliance Tracking -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">‚úÖ Compliance Tracking</div>
                <button class="refresh-btn" onclick="loadCompliance()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="complianceContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading compliance data...</p>
                </div>
            </div>
        </div>
    </div>

    {% if advanced_mode %}
    <!-- Advanced Scheduler Views -->
    <div style="margin-top: 2rem;">
        <!-- Calendar View -->
        <div id="calendar-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                üìÖ Interactive Work Order Calendar
                <small style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 1rem;">
                    Drag & drop to reschedule ‚Ä¢ Double-click to edit
                </small>
            </h3>
            <div id="fullcalendar" style="min-height: 600px;"></div>
        </div>

        <!-- Gantt Chart View -->
        <div id="gantt-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; display: none;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                üìä Project Timeline Gantt Chart
                <small style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 1rem;">
                    Visual project planning and resource allocation
                </small>
            </h3>
            <div id="gantt_here" style="width:100%; height:400px;"></div>
        </div>

        <!-- List View -->
        <div id="list-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; display: none;">
            <h3 style="margin-bottom: 1rem;">üìã Detailed Work Order List</h3>
            <div id="work-order-list">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Priority</th>
                            <th>Technician</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="work-order-tbody">
                        <tr><td colspan="7">Loading work orders...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modals for Job Creation and Scheduling -->
    
    <!-- Create Job Modal -->
    <div class="modal fade" id="createJobModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">‚ûï Create New Work Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="color: var(--text-primary);"></button>
                </div>
                <div class="modal-body">
                    <form id="createJobForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Work Order Title *</label>
                                    <input type="text" class="form-control" id="jobTitle" placeholder="e.g., HVAC Unit B-2 Maintenance" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="jobPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Asset/Equipment</label>
                                    <select class="form-select" id="jobAsset">
                                        <option value="">Select Asset</option>
                                        <option value="hvac-b2">HVAC Unit B-2</option>
                                        <option value="compressor-1">Air Compressor #1</option>
                                        <option value="conveyor-a">Conveyor Belt A</option>
                                        <option value="pump-3">Water Pump #3</option>
                                        <option value="forklift-5">Forklift FL-005</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Technician</label>
                                    <select class="form-select" id="jobTechnician">
                                        <option value="">Auto-Assign</option>
                                        <option value="mike-johnson">Mike Johnson (HVAC Spec.)</option>
                                        <option value="sarah-chen">Sarah Chen (Mechanical)</option>
                                        <option value="carlos-rodriguez">Carlos Rodriguez (Electrical)</option>
                                        <option value="jennifer-wong">Jennifer Wong (General)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scheduled Date</label>
                                    <input type="date" class="form-control" id="jobDate" min="2025-12-04">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="jobStartTime" value="08:00">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Duration (hrs)</label>
                                    <input type="number" class="form-control" id="jobDuration" min="0.5" max="16" step="0.5" value="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Work Description</label>
                            <textarea class="form-control" id="jobDescription" rows="3" placeholder="Detailed description of work to be performed..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Work Type</label>
                                    <select class="form-select" id="jobType">
                                        <option value="corrective">Corrective Maintenance</option>
                                        <option value="preventive" selected>Preventive Maintenance</option>
                                        <option value="inspection">Inspection</option>
                                        <option value="calibration">Calibration</option>
                                        <option value="upgrade">Upgrade/Modification</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Parts Required</label>
                                    <input type="text" class="form-control" id="jobParts" placeholder="e.g., Oil filter, Belts, Gaskets">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createJob()">Create Work Order</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule PM Modal -->
    <div class="modal fade" id="schedulePMModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">üìÖ Schedule Preventive Maintenance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedulePMForm">
                        <div class="mb-3">
                            <label class="form-label">Asset/Equipment *</label>
                            <select class="form-select" id="pmAsset" required>
                                <option value="">Select Asset</option>
                                <option value="hvac-b2">HVAC Unit B-2 (Due: Quarterly)</option>
                                <option value="compressor-1">Air Compressor #1 (Due: Monthly)</option>
                                <option value="conveyor-a">Conveyor Belt A (Due: Weekly)</option>
                                <option value="pump-3">Water Pump #3 (Due: Bi-weekly)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">PM Type *</label>
                            <select class="form-select" id="pmType" required>
                                <option value="">Select PM Type</option>
                                <option value="daily">Daily Inspection</option>
                                <option value="weekly">Weekly Maintenance</option>
                                <option value="monthly">Monthly Service</option>
                                <option value="quarterly">Quarterly Overhaul</option>
                                <option value="annual">Annual Inspection</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" id="pmStartDate" min="2025-12-04" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Frequency</label>
                                    <select class="form-select" id="pmFrequency">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Number of Occurrences</label>
                            <input type="number" class="form-control" id="pmOccurrences" min="1" max="50" value="12" placeholder="How many times to repeat">
                            <small class="text-muted">Leave blank for indefinite scheduling</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Preferred Technician</label>
                            <select class="form-select" id="pmTechnician">
                                <option value="">Auto-Assign Best Match</option>
                                <option value="mike-johnson">Mike Johnson (HVAC Specialist)</option>
                                <option value="sarah-chen">Sarah Chen (Mechanical)</option>
                                <option value="carlos-rodriguez">Carlos Rodriguez (Electrical)</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="schedulePM()">Schedule PM Series</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Schedule Modal -->
    <div class="modal fade" id="bulkScheduleModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">üìã Bulk Scheduling Operations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="autoScheduleBacklog()">
                                    ü§ñ Auto-Schedule Backlog
                                </button>
                                <button class="btn btn-outline-success" onclick="scheduleWeeklyPMs()">
                                    üìÖ Schedule All Weekly PMs
                                </button>
                                <button class="btn btn-outline-warning" onclick="rescheduleOverdue()">
                                    ‚ö†Ô∏è Reschedule Overdue Items
                                </button>
                                <button class="btn btn-outline-info" onclick="balanceWorkload()">
                                    ‚öñÔ∏è Balance Technician Workload
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üìà Optimization Tools</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-secondary" onclick="generateWeeklySchedule()">
                                    üìã Generate Weekly Schedule
                                </button>
                                <button class="btn btn-outline-dark" onclick="showCapacityPlanning()">
                                    üìä Capacity Planning
                                </button>
                                <button class="btn btn-outline-danger" onclick="identifyBottlenecks()">
                                    üö® Identify Bottlenecks
                                </button>
                                <button class="btn btn-outline-success" onclick="optimizeShutdowns()">
                                    üè≠ Optimize Shutdowns
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    
                    <h6>üìã Batch Operations</h6>
                    <div class="mb-3">
                        <label class="form-label">Select Date Range</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" id="bulkStartDate" min="2025-12-04">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" id="bulkEndDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Operation Type</label>
                        <select class="form-select" id="bulkOperation">
                            <option value="reschedule">Reschedule Selected Items</option>
                            <option value="reassign">Reassign Technicians</option>
                            <option value="priority">Change Priority</option>
                            <option value="extend">Extend Deadlines</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkOperation()">Execute Operation</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Work Order Edit Modal -->
    <div class="modal fade" id="editWorkOrderModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">‚úèÔ∏è Edit Work Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Work Order Details -->
                        <div class="col-md-8">
                            <form id="editWorkOrderForm">
                                <input type="hidden" id="editWorkOrderId" value="">
                                
                                <div class="mb-3">
                                    <label class="form-label">Work Order Title *</label>
                                    <input type="text" class="form-control" id="editTitle" required>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Priority</label>
                                            <select class="form-select" id="editPriority">
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <select class="form-select" id="editStatus">
                                                <option value="pending">Pending</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="on_hold">On Hold</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Duration (hours)</label>
                                            <input type="number" class="form-control" id="editDuration" min="0.5" max="16" step="0.5">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="editDueDate">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Scheduled Date</label>
                                            <input type="date" class="form-control" id="editScheduledDate">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="editDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Assigned Technician</label>
                                    <select class="form-select" id="editAssignedTo">
                                        <option value="">Select Technician</option>
                                        <option value="tech_001">Mike Johnson</option>
                                        <option value="tech_002">Sarah Chen</option>
                                        <option value="tech_003">Mike Rodriguez</option>
                                        <option value="tech_004">Jennifer Wong</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Parts Required (comma-separated)</label>
                                    <input type="text" class="form-control" id="editPartsRequired" placeholder="Part-A, Part-B, Filter-C">
                                </div>
                            </form>
                        </div>
                        
                        <!-- Asset Details & Procedures -->
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h6>üè≠ Asset Information</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <div id="editAssetDetails">
                                        <div class="mb-2"><strong>Asset:</strong> <span id="assetName">-</span></div>
                                        <div class="mb-2"><strong>Location:</strong> <span id="assetLocation">-</span></div>
                                        <div class="mb-2"><strong>Serial #:</strong> <span id="assetSerial">-</span></div>
                                        <div><strong>Last Maintenance:</strong> <span id="assetLastMaintenance">-</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>üîß Required Tools</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <ul id="requiredTools" style="margin: 0; padding-left: 1.2rem;">
                                        <li>Loading...</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>üìã Procedures</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <ol id="workOrderProcedures" style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
                                        <li>Loading procedures...</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteWorkOrder()">üóëÔ∏è Delete</button>
                    <button type="button" class="btn btn-success" onclick="saveWorkOrderChanges()">üíæ Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load all data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadSummary();
        loadCapacity();
        loadBacklog();
        loadAssetPM();
        loadConflicts();
        loadParts();
        loadCompliance();
        
        {% if advanced_mode %}
        // Initialize advanced scheduler features
        initializeFullCalendar();
        initializeGanttChart();
        {% endif %}
    });

    {% if advanced_mode %}
    // Advanced Scheduler Functions
    let currentView = 'calendar';

    function switchView(view) {
        // Hide all views
        document.getElementById('calendar-view').style.display = 'none';
        document.getElementById('gantt-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'none';
        
        // Show selected view
        document.getElementById(view + '-view').style.display = 'block';
        currentView = view;
        
        // Update button states
        document.querySelectorAll('.btn').forEach(btn => {
            btn.className = btn.className.replace('btn-primary', 'btn-outline-primary');
        });
        event.target.className = event.target.className.replace('btn-outline-primary', 'btn-primary');
    }

    function initializeFullCalendar() {
        var calendarEl = document.getElementById('fullcalendar');
        if (!calendarEl) return;
        
        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            editable: true,
            droppable: true,
            selectable: true,
            selectMirror: true,
            dayMaxEvents: true,
            events: [
                {
                    title: 'HVAC Maintenance - Unit B-2',
                    start: '2025-12-05T09:00:00',
                    end: '2025-12-05T11:00:00',
                    color: '#f5576c',
                    extendedProps: {
                        priority: 'urgent',
                        technician: 'Mike Johnson',
                        asset: 'HVAC Unit B-2'
                    }
                },
                {
                    title: 'Production Line Calibration',
                    start: '2025-12-06T08:00:00',
                    end: '2025-12-07T17:00:00',
                    color: '#4facfe',
                    extendedProps: {
                        priority: 'high',
                        technician: 'Sarah Chen',
                        asset: 'Production Line A'
                    }
                },
                {
                    title: 'Compressor Oil Change',
                    start: '2025-12-07T09:00:00',
                    end: '2025-12-07T10:30:00',
                    color: '#f093fb',
                    extendedProps: {
                        priority: 'medium',
                        technician: 'Carlos Rodriguez',
                        asset: 'Air Compressor #1'
                    }
                },
                {
                    title: 'Forklift Inspection',
                    start: '2025-12-08T14:00:00',
                    end: '2025-12-08T15:30:00',
                    color: '#00f2fe',
                    extendedProps: {
                        priority: 'low',
                        technician: 'Jennifer Wong',
                        asset: 'Forklift FL-005'
                    }
                }
            ],
            select: function(arg) {
                // Quick create job from calendar selection
                var title = prompt('Enter work order title for ' + arg.startStr + ':');
                if (title) {
                    window.calendar.addEvent({
                        title: title,
                        start: arg.start,
                        end: arg.end,
                        color: '#4facfe'
                    });
                    alert('‚úÖ Work order \"' + title + '\" created and scheduled!');
                }
                window.calendar.unselect();
            },
            eventClick: function(info) {
                const props = info.event.extendedProps;
                const startTime = info.event.start.toLocaleString();
                const endTime = info.event.end ? info.event.end.toLocaleString() : 'Not set';
                
                alert(`üîß Work Order Details:\\n\\nTitle: ${info.event.title}\\nPriority: ${props.priority || 'Not set'}\\nTechnician: ${props.technician || 'Unassigned'}\\nAsset: ${props.asset || 'Not specified'}\\nStart: ${startTime}\\nEnd: ${endTime}\\n\\nüìù Actions: Edit | Reschedule | Complete | Cancel`);
            },
            eventDrop: function(info) {
                alert(`‚úÖ \"${info.event.title}\" rescheduled to ${info.event.start.toLocaleDateString()}\\n\\nTechnician has been notified of the schedule change.`);
            },
            eventResize: function(info) {
                alert(`‚úÖ \"${info.event.title}\" duration updated\\n\\nNew end time: ${info.event.end.toLocaleString()}`);
            }
        });
        
        calendar.render();
    }

    function initializeGanttChart() {
        if (typeof gantt === 'undefined') return;
        
        gantt.config.date_format = "%Y-%m-%d %H:%i";
        gantt.init("gantt_here");
        
        var tasks = {
            data: [
                {id: 1, text: "HVAC System Maintenance", start_date: "2025-12-05", duration: 2, progress: 0.3},
                {id: 2, text: "Production Line Overhaul", start_date: "2025-12-07", duration: 5, progress: 0.1},
                {id: 3, text: "Compressor Replacement", start_date: "2025-12-10", duration: 3, progress: 0},
                {id: 4, text: "Safety System Upgrade", start_date: "2025-12-15", duration: 4, progress: 0}
            ],
            links: []
        };
        
        gantt.parse(tasks);
    }

    function optimizeSchedule() {
        alert('ü§ñ AI Optimization Running...\\n\\n‚úÖ Optimized for minimal downtime\\n‚úÖ Balanced technician workload\\n‚úÖ Parts availability considered\\n‚úÖ Critical assets prioritized\\n\\nOptimization complete! Schedule updated.');
    }

    function exportSchedule() {
        alert('üì§ Export Options:\\n\\n‚Ä¢ PDF Schedule\\n‚Ä¢ Excel Spreadsheet\\n‚Ä¢ CSV Data\\n‚Ä¢ iCal Format\\n\\nSelect your preferred format to download.');
    }
    {% endif %}

    // Modal Functions for Job Creation and Scheduling
    function showCreateJobModal() {
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('jobDate').value = tomorrow.toISOString().split('T')[0];
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('createJobModal'));
        modal.show();
    }
    
    function showSchedulePMModal() {
        // Set default start date to next Monday
        const nextMonday = new Date();
        nextMonday.setDate(nextMonday.getDate() + (1 + 7 - nextMonday.getDay()) % 7);
        document.getElementById('pmStartDate').value = nextMonday.toISOString().split('T')[0];
        
        const modal = new bootstrap.Modal(document.getElementById('schedulePMModal'));
        modal.show();
    }
    
    function showBulkScheduleModal() {
        // Set default date range to next week
        const startDate = new Date();
        startDate.setDate(startDate.getDate() + 1);
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 7);
        
        document.getElementById('bulkStartDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('bulkEndDate').value = endDate.toISOString().split('T')[0];
        
        const modal = new bootstrap.Modal(document.getElementById('bulkScheduleModal'));
        modal.show();
    }
    
    function createJob() {
        const form = document.getElementById('createJobForm');
        
        // Get form values
        const jobData = {
            title: document.getElementById('jobTitle').value,
            priority: document.getElementById('jobPriority').value,
            asset: document.getElementById('jobAsset').value,
            technician: document.getElementById('jobTechnician').value,
            date: document.getElementById('jobDate').value,
            startTime: document.getElementById('jobStartTime').value,
            duration: document.getElementById('jobDuration').value,
            description: document.getElementById('jobDescription').value,
            type: document.getElementById('jobType').value,
            parts: document.getElementById('jobParts').value
        };
        
        // Validate required fields
        if (!jobData.title) {
            alert('‚ö†Ô∏è Please enter a work order title');
            return;
        }
        
        // Simulate job creation (in real app, this would be an API call)
        console.log('Creating new job:', jobData);
        
        // Show success message
        alert(`‚úÖ Work Order Created Successfully!\\n\\nTitle: ${jobData.title}\\nPriority: ${jobData.priority.toUpperCase()}\\nScheduled: ${jobData.date} at ${jobData.startTime}\\nDuration: ${jobData.duration} hours\\n\\nThe work order has been added to the schedule and assigned technician will be notified.`);
        
        // Close modal and refresh data
        bootstrap.Modal.getInstance(document.getElementById('createJobModal')).hide();
        
        // Add to calendar if in advanced mode
        {% if advanced_mode %}
        if (window.calendar && jobData.date) {
            const eventColor = {
                'urgent': '#f5576c',
                'high': '#f093fb', 
                'medium': '#4facfe',
                'low': '#00f2fe'
            }[jobData.priority] || '#4facfe';
            
            window.calendar.addEvent({
                title: jobData.title,
                start: jobData.date + 'T' + jobData.startTime,
                end: jobData.date + 'T' + (parseInt(jobData.startTime.split(':')[0]) + parseInt(jobData.duration)) + ':' + jobData.startTime.split(':')[1],
                color: eventColor,
                extendedProps: {
                    priority: jobData.priority,
                    technician: jobData.technician,
                    asset: jobData.asset
                }
            });
        }
        {% endif %}
        
        // Refresh dashboard data
        loadBacklog();
        loadSummary();
    }
    
    function schedulePM() {
        const pmData = {
            asset: document.getElementById('pmAsset').value,
            type: document.getElementById('pmType').value,
            startDate: document.getElementById('pmStartDate').value,
            frequency: document.getElementById('pmFrequency').value,
            occurrences: document.getElementById('pmOccurrences').value,
            technician: document.getElementById('pmTechnician').value
        };
        
        // Validate required fields
        if (!pmData.asset || !pmData.type || !pmData.startDate) {
            alert('‚ö†Ô∏è Please fill in all required fields (Asset, PM Type, Start Date)');
            return;
        }
        
        console.log('Scheduling PM series:', pmData);
        
        // Show success message
        const asset = document.getElementById('pmAsset').selectedOptions[0].text;
        const type = document.getElementById('pmType').selectedOptions[0].text;
        
        alert(`‚úÖ PM Series Scheduled Successfully!\\n\\nAsset: ${asset}\\nPM Type: ${type}\\nFrequency: ${pmData.frequency.toUpperCase()}\\nStarting: ${pmData.startDate}\\nOccurrences: ${pmData.occurrences || 'Ongoing'}\\n\\n${pmData.occurrences || 12} preventive maintenance tasks have been automatically created and will appear in the schedule.`);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('schedulePMModal')).hide();
        
        // Refresh data
        loadAssetPM();
        loadSummary();
    }
    
    // Bulk Operation Functions
    function autoScheduleBacklog() {
        alert('ü§ñ Auto-Scheduling Backlog...\\n\\n‚úì Analyzing 23 pending work orders\\n‚úì Optimizing for technician availability\\n‚úì Considering asset priority levels\\n‚úì Balancing workload distribution\\n\\nResult: 23 work orders scheduled across next 2 weeks\\n‚Ä¢ Urgent: Scheduled within 24 hours\\n‚Ä¢ High: Scheduled within 3 days\\n‚Ä¢ Medium: Distributed evenly\\n‚Ä¢ Low: Filled available slots\\n\\nSchedule optimization complete!');
        loadBacklog();
        loadSummary();
    }
    
    function scheduleWeeklyPMs() {
        alert('üìÖ Scheduling Weekly Preventive Maintenance...\\n\\n‚úì HVAC Unit B-2: Scheduled for Monday 9:00 AM\\n‚úì Conveyor Belt A: Scheduled for Tuesday 2:00 PM\\n‚úì Air Compressor #1: Scheduled for Wednesday 10:00 AM\\n‚úì Water Pump #3: Scheduled for Thursday 8:00 AM\\n‚úì Production Line: Scheduled for Friday 6:00 PM\\n\\nAll weekly PMs scheduled with optimal timing to minimize production impact.');
        loadAssetPM();
    }
    
    function rescheduleOverdue() {
        alert('‚ö†Ô∏è Rescheduling Overdue Items...\\n\\n‚úì Found 8 overdue work orders\\n‚úì Analyzing current technician capacity\\n‚úì Prioritizing critical assets\\n\\n‚úÖ Rescheduled:\\n‚Ä¢ 3 urgent items: Tomorrow morning\\n‚Ä¢ 2 high priority: Within 48 hours\\n‚Ä¢ 3 medium priority: End of week\\n\\nOverdue backlog cleared with optimized scheduling.');
        loadBacklog();
        loadConflicts();
    }
    
    function balanceWorkload() {
        alert('‚öñÔ∏è Balancing Technician Workload...\\n\\n‚úì Mike Johnson: 87% ‚Üí 75% capacity\\n‚úì Sarah Chen: 92% ‚Üí 78% capacity  \\n‚úì Carlos Rodriguez: 65% ‚Üí 72% capacity\\n‚úì Jennifer Wong: 58% ‚Üí 68% capacity\\n\\n‚úì Redistributed 12 work orders\\n‚úì Eliminated scheduling conflicts\\n‚úì Optimized skill-task matching\\n\\nWorkload balanced for optimal efficiency!');
        loadCapacity();
    }
    
    function generateWeeklySchedule() {
        alert('üìã Generating Optimized Weekly Schedule...\\n\\n‚úì Monday: 15 work orders, 85% capacity\\n‚úì Tuesday: 12 work orders, 78% capacity\\n‚úì Wednesday: 18 work orders, 92% capacity\\n‚úì Thursday: 14 work orders, 82% capacity\\n‚úì Friday: 11 work orders, 75% capacity\\n\\nTotal: 70 work orders scheduled\\nAverage capacity: 82%\\n\\nWeekly schedule generated and ready for review.');
    }
    
    function showCapacityPlanning() {
        alert('üìä Capacity Planning Analysis...\\n\\nüìà Current Week Capacity:\\n‚Ä¢ Monday: 92% (Near limit)\\n‚Ä¢ Tuesday: 78% (Optimal)\\n‚Ä¢ Wednesday: 85% (Good)\\n‚Ä¢ Thursday: 95% (Overloaded)\\n‚Ä¢ Friday: 65% (Available)\\n\\n‚öôÔ∏è Recommendations:\\n‚Ä¢ Move 3 jobs from Thursday to Friday\\n‚Ä¢ Add overtime shift on Monday\\n‚Ä¢ Consider contractor for peak periods');
    }
    
    function identifyBottlenecks() {
        alert('üö® Bottleneck Analysis Complete...\\n\\n‚ö†Ô∏è Critical Bottlenecks Identified:\\n\\n1. HVAC Specialist (Mike Johnson)\\n   ‚Ä¢ 98% capacity, 23 pending jobs\\n   ‚Ä¢ Recommendation: Cross-train 2nd technician\\n\\n2. Electrical Work Backlog\\n   ‚Ä¢ 15 jobs waiting, avg 3.2 days delay\\n   ‚Ä¢ Recommendation: Outsource non-critical items\\n\\n3. Parts Procurement Delays\\n   ‚Ä¢ 12 jobs on hold for parts\\n   ‚Ä¢ Recommendation: Improve inventory planning');
    }
    
    function optimizeShutdowns() {
        alert('üè≠ Production Shutdown Optimization...\\n\\nüìÖ Recommended Shutdown Windows:\\n\\n‚Ä¢ Weekly Shutdown: Fridays 6:00 PM - 10:00 PM\\n  ‚Üí Schedule 8 high-impact maintenance jobs\\n\\n‚Ä¢ Monthly Shutdown: 3rd Saturday 8:00 AM - 6:00 PM\\n  ‚Üí Major equipment overhauls and upgrades\\n\\n‚Ä¢ Quarterly Shutdown: 2-day weekend\\n  ‚Üí Full system maintenance and compliance checks\\n\\n‚úì Minimizes production impact\\n‚úì Maximizes maintenance efficiency');
    }
    
    function executeBulkOperation() {
        const operation = document.getElementById('bulkOperation').value;
        const startDate = document.getElementById('bulkStartDate').value;
        const endDate = document.getElementById('bulkEndDate').value;
        
        if (!startDate || !endDate) {
            alert('‚ö†Ô∏è Please select both start and end dates');
            return;
        }
        
        const operations = {
            'reschedule': 'üìÖ Bulk Reschedule Complete\\n\\n‚úì Rescheduled 15 work orders\\n‚úì Optimized for resource availability\\n‚úì Maintained priority sequences\\n‚úì Updated technician assignments',
            'reassign': 'üë• Bulk Reassignment Complete\\n\\n‚úì Reassigned 12 work orders\\n‚úì Balanced technician workloads\\n‚úì Matched skills to requirements\\n‚úì Notified affected technicians',
            'priority': '‚ö° Priority Update Complete\\n\\n‚úì Updated priority for 18 items\\n‚úì Reshuffled schedule automatically\\n‚úì Critical items moved to front\\n‚úì Optimized resource allocation',
            'extend': 'üìÖ Deadline Extension Complete\\n\\n‚úì Extended deadlines for 9 items\\n‚úì Reduced scheduling pressure\\n‚úì Improved quality focus\\n‚úì Updated compliance tracking'
        };
        
        alert(operations[operation] || 'Operation completed successfully!');
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('bulkScheduleModal')).hide();
        loadSummary();
        loadBacklog();
        loadCapacity();
    }

    async function loadSummary() {
        try {
            const response = await fetch('/planner/summary');
            const data = await response.json();

            document.getElementById('backlogCount').textContent = data.backlog_count;
            document.getElementById('overdueCount').textContent = data.overdue_count;
            document.getElementById('capacityAvg').textContent = data.average_capacity + '%';
            document.getElementById('conflictCount').textContent = data.conflict_count;
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    async function loadCapacity() {
        try {
            const response = await fetch('/planner/resource-capacity');
            const data = await response.json();

            const content = document.getElementById('capacityContent');

            if (data.technicians.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>No technicians found</p></div>';
                return;
            }

            let html = '';
            data.technicians.forEach(tech => {
                const capacityClass = tech.capacity_percentage > 80 ? 'high' : '';
                html += `
                <div class="capacity-bar">
                    <div class="capacity-info">
                        <span><strong>${tech.name}</strong> (${tech.status})</span>
                        <span>${tech.active_work_orders} WOs | ${tech.total_hours}h</span>
                    </div>
                    <div class="capacity-progress">
                        <div class="capacity-fill ${capacityClass}" style="width: ${tech.capacity_percentage}%">
                            ${tech.capacity_percentage}%
                        </div>
                    </div>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading capacity:', error);
        }
    }

    async function loadBacklog() {
        try {
            const response = await fetch('/planner/backlog');
            const data = await response.json();

            const content = document.getElementById('backlogContent');

            if (data.work_orders.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No backlog - Great job!</p></div>';
                return;
            }

            let html = '';
            data.work_orders.slice(0, 10).forEach(wo => {
                html += `
                <div class="backlog-item ${wo.priority}" onclick="openWorkOrderEditor('${wo.id}')" style="cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;" 
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div class="backlog-header">
                        <div class="backlog-title">${wo.title}</div>
                        <span class="priority-badge ${wo.priority}">${wo.priority}</span>
                    </div>
                    <div class="backlog-meta">
                        <span>üè≠ ${wo.asset_name || 'No asset'}</span>
                        <span>üìÖ Due: ${wo.due_date || 'Not set'}</span>
                        <span>‚è±Ô∏è ${wo.estimated_duration || 0}h</span>
                        <span style="color: var(--primary-color); font-size: 0.8rem;">‚úèÔ∏è Click to edit</span>
                    </div>
                </div>
            `;
            });

            if (data.work_orders.length > 10) {
                html += `<p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">+${data.work_orders.length - 10} more items</p>`;
            }

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading backlog:', error);
        }
    }

    async function loadAssetPM() {
        try {
            const response = await fetch('/planner/asset-pm-status');
            const data = await response.json();

            const content = document.getElementById('assetPMContent');

            if (data.assets.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè≠</div><p>No assets found</p></div>';
                return;
            }

            let html = '';
            data.assets.slice(0, 15).forEach(asset => {
                const statusClass = asset.pm_status.toLowerCase().replace(/ /g, '-');
                html += `
                <div class="asset-pm-item">
                    <div>
                        <strong>${asset.name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${asset.asset_id} | ${asset.location || 'No location'}
                        </div>
                    </div>
                    <span class="pm-status ${statusClass}">${asset.pm_status}</span>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading asset PM:', error);
        }
    }

    async function loadConflicts() {
        try {
            const response = await fetch('/planner/conflicts');
            const data = await response.json();

            const content = document.getElementById('conflictsContent');

            if (data.conflicts.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No scheduling conflicts</p></div>';
                return;
            }

            let html = '';
            data.conflicts.forEach(conflict => {
                html += `
                <div class="conflict-alert">
                    <div class="conflict-header">‚ö†Ô∏è ${conflict.technician_name} - ${conflict.date}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                        ${conflict.work_order_count} work orders | ${conflict.total_hours} hours total
                    </div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">
                        Type: ${conflict.conflict_type}
                    </div>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading conflicts:', error);
        }
    }

    async function loadParts() {
        try {
            const response = await fetch('/planner/parts-availability');
            const data = await response.json();

            const content = document.getElementById('partsContent');

            if (data.parts_needed.length === 0 && data.low_stock_items.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>All parts available</p></div>';
                return;
            }

            let html = '';

            if (data.low_stock_items.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong style="color: #f5576c;">‚ö†Ô∏è Low Stock Items:</strong></div>';
                data.low_stock_items.forEach(part => {
                    html += `
                    <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${part.part_name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Stock: ${part.quantity} | Min: ${part.min_quantity}
                        </div>
                    </div>
                `;
                });
            }

            if (data.parts_needed.length > 0) {
                html += '<div style="margin: 1rem 0;"><strong>üì¶ Parts Needed for Scheduled Work:</strong></div>';
                data.parts_needed.slice(0, 5).forEach(part => {
                    html += `
                    <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${part.part_name}</strong> (${part.quantity})
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            For: ${part.work_order_title} | Status: ${part.status}
                        </div>
                    </div>
                `;
                });
            }

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading parts:', error);
        }
    }

    async function loadCompliance() {
        try {
            const response = await fetch('/planner/compliance');
            const data = await response.json();

            const content = document.getElementById('complianceContent');

            const html = `
            <div class="compliance-grid">
                <div class="compliance-stat">
                    <div class="compliance-number success">${data.compliant}</div>
                    <div>Compliant</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number warning">${data.due_soon}</div>
                    <div>Due Soon</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number danger">${data.overdue}</div>
                    <div>Overdue</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number danger">${data.never_inspected}</div>
                    <div>Never Inspected</div>
                </div>
            </div>
        `;

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading compliance:', error);
        }
    }

    // Work Order Editor Functions
    async function openWorkOrderEditor(workOrderId) {
        try {
            // Fetch work order details
            const response = await fetch(`/planner/work-orders/${workOrderId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch work order details');
            }
            const workOrder = await response.json();

            // Populate form fields
            document.getElementById('editWorkOrderId').value = workOrderId;
            document.getElementById('editTitle').value = workOrder.title || '';
            document.getElementById('editPriority').value = workOrder.priority || 'medium';
            document.getElementById('editStatus').value = workOrder.status || 'pending';
            document.getElementById('editDuration').value = workOrder.estimated_duration || '';
            document.getElementById('editDueDate').value = workOrder.due_date || '';
            document.getElementById('editScheduledDate').value = workOrder.scheduled_date || '';
            document.getElementById('editDescription').value = workOrder.description || '';
            document.getElementById('editAssignedTo').value = workOrder.assigned_to || '';
            document.getElementById('editPartsRequired').value = 
                Array.isArray(workOrder.parts_required) ? workOrder.parts_required.join(', ') : (workOrder.parts_required || '');

            // Populate asset details
            if (workOrder.asset_details) {
                document.getElementById('assetName').textContent = workOrder.asset_name || 'Unknown';
                document.getElementById('assetLocation').textContent = workOrder.asset_details.location || 'Not specified';
                document.getElementById('assetSerial').textContent = workOrder.asset_details.serial_number || 'N/A';
                document.getElementById('assetLastMaintenance').textContent = workOrder.asset_details.last_maintenance || 'Unknown';
            }

            // Populate required tools
            if (workOrder.tools_required && Array.isArray(workOrder.tools_required)) {
                const toolsList = document.getElementById('requiredTools');
                toolsList.innerHTML = workOrder.tools_required.map(tool => `<li>${tool}</li>`).join('');
            }

            // Populate procedures
            if (workOrder.procedures && Array.isArray(workOrder.procedures)) {
                const proceduresList = document.getElementById('workOrderProcedures');
                proceduresList.innerHTML = workOrder.procedures.map(procedure => `<li>${procedure}</li>`).join('');
            }

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editWorkOrderModal'));
            modal.show();

        } catch (error) {
            console.error('Error opening work order editor:', error);
            alert('‚ùå Failed to load work order details. Please try again.');
        }
    }

    async function saveWorkOrderChanges() {
        try {
            const workOrderId = document.getElementById('editWorkOrderId').value;
            
            // Collect form data
            const updates = {
                title: document.getElementById('editTitle').value,
                priority: document.getElementById('editPriority').value,
                status: document.getElementById('editStatus').value,
                estimated_duration: parseInt(document.getElementById('editDuration').value) || null,
                due_date: document.getElementById('editDueDate').value || null,
                scheduled_date: document.getElementById('editScheduledDate').value || null,
                description: document.getElementById('editDescription').value,
                assigned_to: document.getElementById('editAssignedTo').value || null,
                parts_required: document.getElementById('editPartsRequired').value.split(',').map(p => p.trim()).filter(p => p.length > 0)
            };

            // Validate required fields
            if (!updates.title) {
                alert('‚ö†Ô∏è Work order title is required');
                return;
            }

            // Send update request
            const response = await fetch(`/planner/work-orders/${workOrderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            });

            if (!response.ok) {
                throw new Error('Failed to update work order');
            }

            const result = await response.json();

            // Show success message
            alert(`‚úÖ Work Order Updated Successfully!\\n\\nUpdated fields: ${result.updated_fields.join(', ')}`);

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editWorkOrderModal')).hide();

            // Refresh data
            loadBacklog();
            loadSummary();

        } catch (error) {
            console.error('Error saving work order changes:', error);
            alert('‚ùå Failed to save changes. Please try again.');
        }
    }

    async function deleteWorkOrder() {
        const workOrderId = document.getElementById('editWorkOrderId').value;
        const title = document.getElementById('editTitle').value;
        
        if (!confirm(`‚ö†Ô∏è Are you sure you want to delete work order "${title}"?\\n\\nThis action cannot be undone.`)) {
            return;
        }

        try {
            // In a real system, this would be a DELETE request
            // For now, we'll just simulate deletion
            alert(`üóëÔ∏è Work Order Deleted\\n\\n"${title}" has been removed from the system.`);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editWorkOrderModal')).hide();
            
            // Refresh data
            loadBacklog();
            loadSummary();

        } catch (error) {
            console.error('Error deleting work order:', error);
            alert('‚ùå Failed to delete work order. Please try again.');
        }
    }

    // Add CSS for better work order interaction
    document.addEventListener('DOMContentLoaded', () => {
        const style = document.createElement('style');
        style.textContent = `
            .backlog-item:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2) !important;
            }
            
            .backlog-item:active {
                transform: translateY(0) !important;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}