{% extends "base.html" %}

{% block title %}{% if advanced_mode %}Advanced Enterprise Scheduler - ChatterFix{% else %}Planner Dashboard - ChatterFix{% endif %}{% endblock %}

{% block head %}
{% if advanced_mode %}
<!-- FullCalendar CSS and JS for advanced scheduling -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Gantt chart library -->
<script src="https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.6/codebase/dhtmlxgantt.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dhtmlx-gantt@8.0.6/codebase/dhtmlxgantt.css">
{% endif %}

<style>
    /* Use main theme variables - don't override root */
    .planner-dashboard {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        color: var(--text-primary);
    }

    .planner-header {
        margin-bottom: 2rem;
    }

    .planner-header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        color: var(--text-primary);
    }

    .planner-header h1::before {
        content: "üìÖ";
        font-size: 2.5rem;
    }

    .planner-header p {
        color: var(--text-secondary);
    }

    .quick-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.success {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .planner-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .planner-widget {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--border-glass);
        color: var(--text-primary);
    }

    .widget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-glass);
    }

    .widget-title {
        font-size: 1.2rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-primary);
    }

    .widget-content {
        max-height: 400px;
        overflow-y: auto;
    }

    .capacity-bar {
        margin-bottom: 1rem;
    }

    .capacity-info {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    .capacity-progress {
        height: 24px;
        background: var(--border-glass);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }

    .capacity-fill {
        height: 100%;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .capacity-fill.high {
        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }

    .backlog-item {
        padding: 1rem;
        background: var(--bg-glass);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        border-left: 4px solid var(--accent-color);
        color: var(--text-primary);
    }

    .backlog-item.urgent, .backlog-item.Critical {
        border-left-color: #f5576c;
    }

    .backlog-item.high, .backlog-item.High {
        border-left-color: #f093fb;
    }

    .backlog-item.medium, .backlog-item.Medium {
        border-left-color: #4facfe;
    }

    .backlog-item.low, .backlog-item.Low {
        border-left-color: #6c757d;
    }

    .backlog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .backlog-title {
        font-weight: 600;
        font-size: 1rem;
        color: var(--text-primary);
    }

    .priority-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .priority-badge.urgent, .priority-badge.Critical {
        background: #f5576c;
        color: white;
    }

    .priority-badge.high, .priority-badge.High {
        background: #f093fb;
        color: white;
    }

    .priority-badge.medium, .priority-badge.Medium {
        background: #4facfe;
        color: white;
    }

    .priority-badge.low, .priority-badge.Low {
        background: #6c757d;
        color: white;
    }

    .backlog-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .asset-pm-item {
        padding: 0.75rem;
        background: var(--bg-glass);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: var(--text-primary);
    }

    .pm-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .pm-status.overdue {
        background: #f5576c;
        color: white;
    }

    .pm-status.due-today {
        background: #f093fb;
        color: white;
    }

    .pm-status.due-this-week {
        background: #ffd93d;
        color: #333;
    }

    .conflict-alert {
        padding: 1rem;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        color: white;
    }

    .conflict-header {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .compliance-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .compliance-stat {
        text-align: center;
        padding: 1rem;
        background: var(--bg-glass);
        border-radius: 8px;
        color: var(--text-primary);
    }

    .compliance-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }

    .compliance-number.danger {
        color: #f5576c;
    }

    .compliance-number.warning {
        color: #ffd93d;
    }

    .compliance-number.success {
        color: #4facfe;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .refresh-btn {
        padding: 0.5rem 1rem;
        background: var(--accent-gradient);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }

    /* Modal form styling - ensure readability */
    .planner-dashboard .modal-content {
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border-glass);
    }

    .planner-dashboard .modal-header,
    .planner-dashboard .modal-footer {
        border-color: var(--border-glass);
    }

    .planner-dashboard .form-label {
        color: var(--text-primary);
    }

    .planner-dashboard .form-control,
    .planner-dashboard .form-select {
        background-color: var(--bg-glass);
        color: var(--text-primary);
        border-color: var(--border-glass);
    }

    .planner-dashboard .form-control::placeholder {
        color: var(--text-muted);
    }

    .planner-dashboard .text-muted {
        color: var(--text-secondary) !important;
    }
    
    /* FullCalendar Customizations - Theme-Aware Design */
    .fc {
        background: var(--bg-card) !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: 1px solid var(--border-glass) !important;
        border-radius: 16px !important;
        padding: 20px !important;
        font-family: "Outfit", "Segoe UI", sans-serif !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
    }

    .fc-theme-standard .fc-scrollgrid {
        border: 1px solid var(--border-glass) !important;
        background: transparent !important;
        border-radius: 12px !important;
        overflow: hidden !important;
    }

    .fc-theme-standard td, .fc-theme-standard th {
        border-color: var(--border-glass) !important;
        background: transparent !important;
        transition: background-color 0.3s ease !important;
    }

    .fc-theme-standard td:hover {
        background: rgba(102, 126, 234, 0.1) !important;
    }

    .fc-theme-standard .fc-popover {
        background: var(--bg-card) !important;
        backdrop-filter: blur(20px) !important;
        border: 1px solid var(--border-glass) !important;
        border-radius: 12px !important;
        color: var(--text-primary) !important;
        font-family: "Outfit", sans-serif !important;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3) !important;
    }

    .fc-daygrid-day {
        background: transparent !important;
        color: var(--text-primary) !important;
        position: relative !important;
    }

    .fc-day-today {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.1) 100%) !important;
        border: 2px solid rgba(102, 126, 234, 0.3) !important;
        border-radius: 8px !important;
    }

    .fc-col-header-cell {
        background: var(--bg-glass) !important;
        color: var(--text-primary) !important;
        font-weight: 700 !important;
        font-size: 0.9rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        padding: 12px 8px !important;
    }

    .fc-col-header-cell-cushion {
        color: var(--text-primary) !important;
    }

    .fc-daygrid-day-number {
        color: var(--text-primary) !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
        padding: 6px !important;
        border-radius: 6px !important;
        transition: all 0.3s ease !important;
    }

    .fc-daygrid-day-number:hover {
        background: rgba(102, 126, 234, 0.2) !important;
        color: var(--text-primary) !important;
        transform: scale(1.1) !important;
    }

    .fc-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none !important;
        color: #ffffff !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 600 !important;
        padding: 8px 16px !important;
        border-radius: 8px !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3) !important;
    }

    .fc-button:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4) !important;
    }

    .fc-button:disabled {
        background: rgba(100, 116, 139, 0.3) !important;
        color: rgba(148, 163, 184, 0.6) !important;
        box-shadow: none !important;
        transform: none !important;
    }

    .fc-toolbar-title {
        color: var(--text-primary) !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 700 !important;
        font-size: 1.5rem !important;
    }

    .fc-event {
        border-radius: 8px !important;
        border: none !important;
        font-size: 0.85rem !important;
        font-family: "Outfit", sans-serif !important;
        font-weight: 500 !important;
        padding: 2px 6px !important;
        margin: 1px !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.3s ease !important;
        cursor: pointer !important;
    }

    .fc-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    }

    .fc-event-title {
        font-weight: 600 !important;
        font-family: "Outfit", sans-serif !important;
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3) !important;
    }

    /* Weekend styling */
    .fc-day-sat, .fc-day-sun {
        background: rgba(148, 163, 184, 0.05) !important;
    }

    /* Additional theme-aware calendar elements */
    .fc-daygrid-day-frame {
        color: var(--text-primary) !important;
    }

    .fc-daygrid-day-events {
        color: var(--text-primary) !important;
    }

    .fc-daygrid-more-link {
        color: var(--accent-color) !important;
    }

    .fc-timegrid-slot-label {
        color: var(--text-secondary) !important;
    }

    .fc-list-day-cushion {
        background: var(--bg-glass) !important;
        color: var(--text-primary) !important;
    }

    .fc-list-event-title {
        color: var(--text-primary) !important;
    }

    /* FullCalendar additional text elements */
    .fc .fc-toolbar {
        color: var(--text-primary) !important;
    }

    .fc .fc-daygrid-event-harness {
        color: var(--text-primary) !important;
    }

    /* Event color variations for different types */
    .fc-event.maintenance {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important;
    }

    .fc-event.urgent {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }

    .fc-event.scheduled {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%) !important;
    }

    .fc-event.inspection {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%) !important;
        color: #333333 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="planner-dashboard">
    <div class="planner-header">
        {% if advanced_mode %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1>üóìÔ∏è Advanced Enterprise Scheduler</h1>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                    AI-driven maintenance scheduling with FullCalendar, Gantt charts, and optimization
                </p>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <!-- Primary Actions for Maintenance Planners -->
                <div style="display: flex; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 8px; border: 2px solid #4facfe;">
                    <button class="btn btn-success btn-sm" onclick="showCreateJobModal()">
                        ‚ûï Create Job
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="showSchedulePMModal()">
                        üìÖ Schedule PM
                    </button>
                    <button class="btn btn-info btn-sm" onclick="showBulkScheduleModal()">
                        üìã Bulk Schedule
                    </button>
                </div>
                <!-- View Controls -->
                <div style="display: flex; gap: 0.5rem; background: var(--bg-secondary); padding: 0.5rem; border-radius: 8px; border: 2px solid var(--border-color);">
                    <button class="btn btn-primary btn-sm" onclick="switchView('calendar')">üìÖ Calendar</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="switchView('gantt')">üìä Gantt</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="switchView('list')">üìã List</button>
                </div>
                <!-- AI & Export Tools -->
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-success btn-sm" onclick="optimizeSchedule()">
                        ü§ñ AI Optimize
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="exportSchedule()">
                        üì§ Export
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h1>Maintenance Planner Dashboard</h1>
                <p style="color: var(--text-secondary);">Plan, schedule, and optimize maintenance operations</p>
            </div>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <!-- Primary Planner Actions -->
                <button class="btn btn-success" onclick="showCreateJobModal()">
                    ‚ûï Create New Job
                </button>
                <button class="btn btn-warning" onclick="showSchedulePMModal()">
                    üìÖ Schedule PM
                </button>
                <button class="btn btn-info" onclick="showBulkScheduleModal()">
                    üìã Bulk Operations
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats" id="quickStats">
        <div class="stat-card warning">
            <div class="stat-value" id="backlogCount">-</div>
            <div class="stat-label">Work Order Backlog</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-value" id="overdueCount">-</div>
            <div class="stat-label">Overdue Items</div>
        </div>
        <div class="stat-card success">
            <div class="stat-value" id="capacityAvg">-</div>
            <div class="stat-label">Avg Capacity %</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="conflictCount">-</div>
            <div class="stat-label">Scheduling Conflicts</div>
        </div>
    </div>

    <!-- Main Grid -->
    <div class="planner-grid">
        <!-- Resource Capacity -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üë• Resource Capacity</div>
                <button class="refresh-btn" onclick="loadCapacity()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="capacityContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading capacity data...</p>
                </div>
            </div>
        </div>

        <!-- Work Order Backlog -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üìã Work Order Backlog</div>
                <button class="refresh-btn" onclick="loadBacklog()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="backlogContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading backlog...</p>
                </div>
            </div>
        </div>

        <!-- Asset PM Status -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üîß Asset PM Status</div>
                <button class="refresh-btn" onclick="loadAssetPM()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="assetPMContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading asset PM status...</p>
                </div>
            </div>
        </div>

        <!-- Scheduling Conflicts -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">‚ö†Ô∏è Scheduling Conflicts</div>
                <button class="refresh-btn" onclick="loadConflicts()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="conflictsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading conflicts...</p>
                </div>
            </div>
        </div>

        <!-- Parts Availability -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">üì¶ Parts Availability</div>
                <button class="refresh-btn" onclick="loadParts()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="partsContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading parts data...</p>
                </div>
            </div>
        </div>

        <!-- Compliance Tracking -->
        <div class="planner-widget">
            <div class="widget-header">
                <div class="widget-title">‚úÖ Compliance Tracking</div>
                <button class="refresh-btn" onclick="loadCompliance()">üîÑ Refresh</button>
            </div>
            <div class="widget-content" id="complianceContent">
                <div class="empty-state">
                    <div class="empty-state-icon">‚è≥</div>
                    <p>Loading compliance data...</p>
                </div>
            </div>
        </div>
    </div>

    {% if advanced_mode %}
    <!-- Advanced Scheduler Views -->
    <div style="margin-top: 2rem;">
        <!-- View Toggle Buttons -->
        <div class="btn-group mb-3" role="group" aria-label="View selection">
            <button type="button" class="btn btn-primary" onclick="switchView('calendar')">üìÖ Calendar</button>
            <button type="button" class="btn btn-outline-primary" onclick="switchView('list')">üìã All Work Orders</button>
            <button type="button" class="btn btn-outline-primary" onclick="switchView('gantt')">üìä Gantt Chart</button>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                üìÖ Interactive Work Order Calendar
                <small style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 1rem;">
                    Drag & drop to reschedule ‚Ä¢ Double-click to edit
                </small>
                <span id="data-source-indicator" class="badge bg-secondary" style="margin-left: auto;">Loading...</span>
            </h3>
            <div id="fullcalendar" style="min-height: 600px;"></div>
        </div>

        <!-- Gantt Chart View -->
        <div id="gantt-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; display: none;">
            <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                üìä Project Timeline Gantt Chart
                <small style="color: var(--text-secondary); font-size: 0.8rem; margin-left: 1rem;">
                    Visual project planning and resource allocation
                </small>
            </h3>
            <div id="gantt_here" style="width:100%; height:400px;"></div>
        </div>

        <!-- List View -->
        <div id="list-view" style="background: var(--card-bg); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; display: none;">
            <h3 style="margin-bottom: 1rem;">üìã Detailed Work Order List</h3>
            <div id="work-order-list">
                <table class="table table-dark table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Title</th>
                            <th>Priority</th>
                            <th>Technician</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="work-order-tbody">
                        <tr><td colspan="7">Loading work orders...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modals for Job Creation and Scheduling -->
    
    <!-- Create Job Modal -->
    <div class="modal fade" id="createJobModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">‚ûï Create New Work Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="color: var(--text-primary);"></button>
                </div>
                <div class="modal-body">
                    <form id="createJobForm">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">Work Order Title *</label>
                                    <input type="text" class="form-control" id="jobTitle" placeholder="e.g., HVAC Unit B-2 Maintenance" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" id="jobPriority">
                                        <option value="low">Low</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="high">High</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Asset/Equipment</label>
                                    <select class="form-select" id="jobAsset">
                                        <option value="">Select Asset</option>
                                        <option value="hvac-b2">HVAC Unit B-2</option>
                                        <option value="compressor-1">Air Compressor #1</option>
                                        <option value="conveyor-a">Conveyor Belt A</option>
                                        <option value="pump-3">Water Pump #3</option>
                                        <option value="forklift-5">Forklift FL-005</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Technician</label>
                                    <select class="form-select" id="jobTechnician">
                                        <option value="">Auto-Assign</option>
                                        <!-- Populated dynamically from /org/team API -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Scheduled Date</label>
                                    <input type="date" class="form-control" id="jobDate" min="2025-12-04">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="jobStartTime" value="08:00">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label">Duration (hrs)</label>
                                    <input type="number" class="form-control" id="jobDuration" min="0.5" max="16" step="0.5" value="2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Work Description</label>
                            <textarea class="form-control" id="jobDescription" rows="3" placeholder="Detailed description of work to be performed..."></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Work Type</label>
                                    <select class="form-select" id="jobType">
                                        <option value="corrective">Corrective Maintenance</option>
                                        <option value="preventive" selected>Preventive Maintenance</option>
                                        <option value="inspection">Inspection</option>
                                        <option value="calibration">Calibration</option>
                                        <option value="upgrade">Upgrade/Modification</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Parts Required</label>
                                    <input type="text" class="form-control" id="jobParts" placeholder="e.g., Oil filter, Belts, Gaskets">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createJob()">Create Work Order</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule PM Modal -->
    <div class="modal fade" id="schedulePMModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">üìÖ Schedule Preventive Maintenance</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="schedulePMForm">
                        <div class="mb-3">
                            <label class="form-label">Asset/Equipment *</label>
                            <select class="form-select" id="pmAsset" required>
                                <option value="">Select Asset</option>
                                <option value="hvac-b2">HVAC Unit B-2 (Due: Quarterly)</option>
                                <option value="compressor-1">Air Compressor #1 (Due: Monthly)</option>
                                <option value="conveyor-a">Conveyor Belt A (Due: Weekly)</option>
                                <option value="pump-3">Water Pump #3 (Due: Bi-weekly)</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">PM Type *</label>
                            <select class="form-select" id="pmType" required>
                                <option value="">Select PM Type</option>
                                <option value="daily">Daily Inspection</option>
                                <option value="weekly">Weekly Maintenance</option>
                                <option value="monthly">Monthly Service</option>
                                <option value="quarterly">Quarterly Overhaul</option>
                                <option value="annual">Annual Inspection</option>
                            </select>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Start Date *</label>
                                    <input type="date" class="form-control" id="pmStartDate" min="2025-12-04" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Frequency</label>
                                    <select class="form-select" id="pmFrequency">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="quarterly">Quarterly</option>
                                        <option value="annual">Annual</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Number of Occurrences</label>
                            <input type="number" class="form-control" id="pmOccurrences" min="1" max="50" value="12" placeholder="How many times to repeat">
                            <small class="text-muted">Leave blank for indefinite scheduling</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Preferred Technician</label>
                            <select class="form-select" id="pmTechnician">
                                <option value="">Auto-Assign Best Match</option>
                                <!-- Populated dynamically from /org/team API -->
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="schedulePM()">Schedule PM Series</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Schedule Modal -->
    <div class="modal fade" id="bulkScheduleModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">üìã Bulk Scheduling Operations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>üìä Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="autoScheduleBacklog()">
                                    ü§ñ Auto-Schedule Backlog
                                </button>
                                <button class="btn btn-outline-success" onclick="scheduleWeeklyPMs()">
                                    üìÖ Schedule All Weekly PMs
                                </button>
                                <button class="btn btn-outline-warning" onclick="rescheduleOverdue()">
                                    ‚ö†Ô∏è Reschedule Overdue Items
                                </button>
                                <button class="btn btn-outline-info" onclick="balanceWorkload()">
                                    ‚öñÔ∏è Balance Technician Workload
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>üìà Optimization Tools</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-secondary" onclick="generateWeeklySchedule()">
                                    üìã Generate Weekly Schedule
                                </button>
                                <button class="btn btn-outline-dark" onclick="showCapacityPlanning()">
                                    üìä Capacity Planning
                                </button>
                                <button class="btn btn-outline-danger" onclick="identifyBottlenecks()">
                                    üö® Identify Bottlenecks
                                </button>
                                <button class="btn btn-outline-success" onclick="optimizeShutdowns()">
                                    üè≠ Optimize Shutdowns
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
                    
                    <h6>üìã Batch Operations</h6>
                    <div class="mb-3">
                        <label class="form-label">Select Date Range</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" id="bulkStartDate" min="2025-12-04">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" id="bulkEndDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Operation Type</label>
                        <select class="form-select" id="bulkOperation">
                            <option value="reschedule">Reschedule Selected Items</option>
                            <option value="reassign">Reassign Technicians</option>
                            <option value="priority">Change Priority</option>
                            <option value="extend">Extend Deadlines</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="executeBulkOperation()">Execute Operation</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Date Actions Modal - Shows when clicking a date on the calendar -->
    <div class="modal fade" id="dateActionsModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-glass);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-glass);">
                    <h5 class="modal-title">üìÖ <span id="selectedDateDisplay">December 15, 2025</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="selectedDate" value="">

                    <!-- Daily Summary -->
                    <div id="dailySummary" class="mb-4 p-3" style="background: var(--bg-glass); border-radius: 8px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong>üìã Scheduled Work Orders</strong>
                            <span id="dailyWOCount" class="badge bg-primary">0</span>
                        </div>
                        <div id="dailyWorkOrders" style="max-height: 150px; overflow-y: auto;">
                            <p class="text-muted mb-0">No work orders scheduled</p>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-lg" onclick="createJobForDate()">
                            ‚ûï Create Work Order
                        </button>
                        <button class="btn btn-warning" onclick="schedulePMForDate()">
                            üîß Schedule Preventive Maintenance
                        </button>
                        <button class="btn btn-info" onclick="viewDaySchedule()">
                            üëÅÔ∏è View Full Day Schedule
                        </button>
                        <button class="btn btn-outline-primary" onclick="assignFromBacklog()">
                            üì• Assign from Backlog
                        </button>
                    </div>

                    <!-- Technician Availability -->
                    <div class="mt-4">
                        <h6>üë• Technician Availability</h6>
                        <div id="techAvailability" class="mt-2">
                            <!-- Populated dynamically from /org/team API -->
                            <div class="text-muted small">Loading team members...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-glass);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Order Edit Modal -->
    <div class="modal fade" id="editWorkOrderModal" tabindex="-1" style="color: var(--text-primary);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                    <h5 class="modal-title">‚úèÔ∏è Edit Work Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- Work Order Details -->
                        <div class="col-md-8">
                            <form id="editWorkOrderForm">
                                <input type="hidden" id="editWorkOrderId" value="">
                                
                                <div class="mb-3">
                                    <label class="form-label">Work Order Title *</label>
                                    <input type="text" class="form-control" id="editTitle" required>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Priority</label>
                                            <select class="form-select" id="editPriority">
                                                <option value="low">Low</option>
                                                <option value="medium">Medium</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <select class="form-select" id="editStatus">
                                                <option value="pending">Pending</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="on_hold">On Hold</option>
                                                <option value="completed">Completed</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label">Duration (hours)</label>
                                            <input type="number" class="form-control" id="editDuration" min="0.5" max="16" step="0.5">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Due Date</label>
                                            <input type="date" class="form-control" id="editDueDate">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Scheduled Date</label>
                                            <input type="date" class="form-control" id="editScheduledDate">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="editDescription" rows="3"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Assigned Technician</label>
                                    <select class="form-select" id="editAssignedTo">
                                        <option value="">Select Technician</option>
                                        <!-- Populated dynamically from /org/team API -->
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Parts Required (comma-separated)</label>
                                    <input type="text" class="form-control" id="editPartsRequired" placeholder="Part-A, Part-B, Filter-C">
                                </div>
                            </form>
                        </div>
                        
                        <!-- Asset Details & Procedures -->
                        <div class="col-md-4">
                            <div class="mb-4">
                                <h6>üè≠ Asset Information</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <div id="editAssetDetails">
                                        <div class="mb-2"><strong>Asset:</strong> <span id="assetName">-</span></div>
                                        <div class="mb-2"><strong>Location:</strong> <span id="assetLocation">-</span></div>
                                        <div class="mb-2"><strong>Serial #:</strong> <span id="assetSerial">-</span></div>
                                        <div><strong>Last Maintenance:</strong> <span id="assetLastMaintenance">-</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>üîß Required Tools</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <ul id="requiredTools" style="margin: 0; padding-left: 1.2rem;">
                                        <li>Loading...</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h6>üìã Procedures</h6>
                                <div class="p-3" style="background: var(--bg-secondary); border-radius: 8px;">
                                    <ol id="workOrderProcedures" style="margin: 0; padding-left: 1.2rem; font-size: 0.9rem;">
                                        <li>Loading procedures...</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteWorkOrder()">üóëÔ∏è Delete</button>
                    <button type="button" class="btn btn-success" onclick="saveWorkOrderChanges()">üíæ Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Store team members globally for reuse
    let teamMembers = [];

    // Load team members from Firestore via API
    async function loadTeamMembers() {
        try {
            const response = await fetch('/org/team', { credentials: 'include' });
            if (response.ok) {
                const data = await response.json();
                teamMembers = data.members || [];
                populateTechnicianDropdown();
                console.log('üìã Loaded', teamMembers.length, 'team members');
            } else {
                console.warn('Could not load team members, using empty list');
                teamMembers = [];
            }
        } catch (error) {
            console.error('Error loading team members:', error);
            teamMembers = [];
        }
    }

    // Populate the technician dropdown with real team members
    function populateTechnicianDropdown() {
        // Populate all technician dropdowns on the page
        const dropdownConfigs = [
            { id: 'editAssignedTo', defaultText: 'Select Technician' },
            { id: 'jobTechnician', defaultText: 'Auto-Assign' },
            { id: 'pmTechnician', defaultText: 'Auto-Assign Best Match' }
        ];

        dropdownConfigs.forEach(config => {
            const select = document.getElementById(config.id);
            if (!select) return;

            // Keep the first default option
            select.innerHTML = `<option value="">${config.defaultText}</option>`;

            // Add team members
            teamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.uid || member.id;
                option.textContent = member.full_name || member.email || 'Unknown';
                select.appendChild(option);
            });
        });

        // Also update the technician availability display
        updateTechnicianAvailability();
    }

    // Update technician availability display with real team members
    function updateTechnicianAvailability() {
        const container = document.getElementById('techAvailability');
        if (!container || teamMembers.length === 0) return;

        // Clear existing content
        container.innerHTML = '';

        // Display each team member with placeholder capacity
        // In a real implementation, this would calculate from assigned work orders
        teamMembers.forEach((member, index) => {
            // Simulate capacity based on member data or random for demo
            const capacities = [
                { percent: 85, label: 'Near Capacity', class: 'bg-warning text-dark' },
                { percent: 65, label: 'Available', class: 'bg-success' },
                { percent: 45, label: 'Available', class: 'bg-success' },
                { percent: 95, label: 'Overloaded', class: 'bg-danger' }
            ];
            const capacity = capacities[index % capacities.length];

            const div = document.createElement('div');
            div.className = 'd-flex justify-content-between align-items-center p-2 mb-1';
            div.style.cssText = 'background: var(--bg-glass); border-radius: 6px;';
            div.innerHTML = `
                <span>${member.full_name || member.email || 'Unknown'}</span>
                <span class="badge ${capacity.class}">${capacity.percent}% - ${capacity.label}</span>
            `;
            container.appendChild(div);
        });
    }

    // Get technician name from ID using loaded team members
    function getTechnicianNameFromMembers(techId) {
        if (!techId) return 'Unassigned';
        const member = teamMembers.find(m => m.uid === techId || m.id === techId);
        return member ? (member.full_name || member.email) : techId;
    }

    // Load all data on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadTeamMembers();  // Load real team members
        loadSummary();
        loadCapacity();
        loadBacklog();
        loadAssetPM();
        loadConflicts();
        loadParts();
        loadCompliance();

        {% if advanced_mode %}
        // Initialize advanced scheduler features
        initializeFullCalendar();
        initializeGanttChart();
        {% endif %}
    });

    {% if advanced_mode %}
    // Advanced Scheduler Functions
    let currentView = 'calendar';

    function switchView(view) {
        // Hide all views
        document.getElementById('calendar-view').style.display = 'none';
        document.getElementById('gantt-view').style.display = 'none';
        document.getElementById('list-view').style.display = 'none';

        // Show selected view
        document.getElementById(view + '-view').style.display = 'block';
        currentView = view;

        // Update button states in the view toggle group
        const btnGroup = document.querySelector('.btn-group[aria-label="View selection"]');
        if (btnGroup) {
            btnGroup.querySelectorAll('.btn').forEach(btn => {
                btn.className = btn.className.replace('btn-primary', 'btn-outline-primary');
            });
            // Find and highlight the active button
            const activeBtn = [...btnGroup.querySelectorAll('.btn')].find(btn =>
                btn.textContent.toLowerCase().includes(view === 'calendar' ? 'calendar' : view === 'list' ? 'all' : 'gantt')
            );
            if (activeBtn) {
                activeBtn.className = activeBtn.className.replace('btn-outline-primary', 'btn-primary');
            }
        }

        // Load data for the selected view
        if (view === 'list') {
            loadListViewData();
        }
    }

    // Load work orders into the list view table
    async function loadListViewData() {
        try {
            const response = await fetch('/planner/backlog', { credentials: 'include' });
            const data = await response.json();

            const tbody = document.getElementById('work-order-tbody');

            if (!data.work_orders || data.work_orders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No work orders found</td></tr>';
                return;
            }

            let html = '';
            data.work_orders.forEach(wo => {
                const priorityClass = wo.priority?.toLowerCase() || 'medium';
                const statusClass = wo.status?.toLowerCase().replace(' ', '-') || '';
                html += `
                    <tr onclick="openWorkOrderEditor('${wo.id}')" style="cursor: pointer;">
                        <td><code>${wo.id?.slice(0, 8) || 'N/A'}...</code></td>
                        <td>${wo.title || 'Untitled'}</td>
                        <td><span class="badge bg-${priorityClass === 'critical' ? 'danger' : priorityClass === 'high' ? 'warning' : priorityClass === 'low' ? 'info' : 'primary'}">${wo.priority || 'Medium'}</span></td>
                        <td>${wo.assigned_to ? getTechnicianName(wo.assigned_to) : 'Unassigned'}</td>
                        <td>${wo.due_date || 'Not set'}</td>
                        <td><span class="badge bg-${wo.status === 'Completed' ? 'success' : wo.status === 'In Progress' ? 'info' : 'secondary'}">${wo.status || 'Open'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openWorkOrderEditor('${wo.id}')">‚úèÔ∏è Edit</button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        } catch (error) {
            console.error('Error loading list view:', error);
            document.getElementById('work-order-tbody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading work orders</td></tr>';
        }
    }

    // Store calendar events globally for reference
    let calendarEvents = [];

    function initializeFullCalendar() {
        var calendarEl = document.getElementById('fullcalendar');
        if (!calendarEl) return;

        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            editable: true,
            droppable: true,
            selectable: false,  // Use dateClick instead
            dayMaxEvents: 3,
            eventDisplay: 'block',

            // Load events from API
            events: function(info, successCallback, failureCallback) {
                loadCalendarEvents(info.startStr, info.endStr)
                    .then(events => {
                        calendarEvents = events;
                        successCallback(events);
                    })
                    .catch(error => {
                        console.error('Error loading calendar events:', error);
                        failureCallback(error);
                    });
            },

            // Handle clicking on a date
            dateClick: function(info) {
                openDateActionsModal(info.date, info.dateStr);
            },

            // Handle clicking on an event
            eventClick: function(info) {
                openEventEditor(info.event);
            },

            // Handle drag and drop rescheduling
            eventDrop: function(info) {
                rescheduleEvent(info.event, info.oldEvent);
            },

            // Handle resizing events
            eventResize: function(info) {
                updateEventDuration(info.event);
            },

            // Customize event rendering
            eventDidMount: function(info) {
                // Add tooltip
                info.el.title = `${info.event.title}\n${info.event.extendedProps.technician || 'Unassigned'}\n${info.event.extendedProps.asset || ''}`;
            }
        });

        calendar.render();
    }

    // Load calendar events from the backlog API
    async function loadCalendarEvents(startDate, endDate) {
        try {
            const response = await fetch('/planner/backlog', { credentials: 'include' });
            const data = await response.json();

            // Debug: Log data source to help diagnose calendar issues
            console.log('üìÖ Calendar Data Debug:', {
                dataSource: data._debug?.data_source,
                userAuthenticated: data._debug?.user_authenticated,
                userEmail: data._debug?.user_email,
                organizationId: data._debug?.organization_id,
                workOrderCount: data.work_orders?.length,
                totalBacklog: data.total_backlog
            });

            const events = [];
            const priorityColors = {
                'critical': '#dc3545',
                'urgent': '#f5576c',
                'high': '#f093fb',
                'medium': '#4facfe',
                'low': '#00f2fe'
            };

            // Convert work orders to calendar events
            if (data.work_orders) {
                data.work_orders.forEach(wo => {
                    if (wo.due_date) {
                        events.push({
                            id: wo.id,
                            title: wo.title,
                            start: wo.due_date + 'T09:00:00',
                            end: wo.due_date + 'T' + (9 + (wo.estimated_duration || 2)).toString().padStart(2, '0') + ':00:00',
                            color: priorityColors[wo.priority.toLowerCase()] || '#4facfe',
                            extendedProps: {
                                workOrderId: wo.id,
                                priority: wo.priority,
                                technician: wo.assigned_to ? getTechnicianName(wo.assigned_to) : 'Unassigned',
                                asset: wo.asset_name,
                                status: wo.status,
                                duration: wo.estimated_duration
                            }
                        });
                    }
                });
            }

            // Add some sample PM events
            const today = new Date();
            const sampleTech = teamMembers.length > 0
                ? (teamMembers[0].full_name || teamMembers[0].email)
                : 'Unassigned';
            events.push({
                id: 'pm_weekly_1',
                title: 'Weekly Conveyor Inspection',
                start: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + 'T10:00:00',
                end: new Date(today.getTime() + 2 * 24 * 60 * 60 * 1000).toISOString().split('T')[0] + 'T11:00:00',
                color: '#4ecdc4',
                extendedProps: {
                    priority: 'Medium',
                    technician: sampleTech,
                    asset: 'Conveyor Belt A',
                    type: 'PM'
                }
            });

            // Debug: Log final events list
            const workOrderEvents = events.filter(e => !e.id?.startsWith('pm_'));
            console.log('üìÖ Calendar Events Created:', {
                totalEvents: events.length,
                workOrderEvents: workOrderEvents.length,
                samplePMEvents: events.length - workOrderEvents.length,
                workOrderDates: workOrderEvents.map(e => ({ title: e.title?.slice(0, 30), date: e.start?.slice(0, 10) }))
            });

            // Update data source indicator in UI
            const indicator = document.getElementById('data-source-indicator');
            if (indicator) {
                const source = data._debug?.data_source || 'unknown';
                indicator.textContent = `Data: ${source}`;
                indicator.className = source === 'firestore' ? 'badge bg-success' : 'badge bg-warning text-dark';
            }

            return events;
        } catch (error) {
            console.error('Error loading calendar events:', error);
            return [];
        }
    }

    // Get technician name from ID - uses dynamically loaded team members
    function getTechnicianName(techId) {
        return getTechnicianNameFromMembers(techId);
    }

    // Open date actions modal when clicking a date
    function openDateActionsModal(date, dateStr) {
        // Format the date for display
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = date.toLocaleDateString('en-US', options);

        document.getElementById('selectedDateDisplay').textContent = formattedDate;
        document.getElementById('selectedDate').value = dateStr;

        // Get work orders for this date
        const dayEvents = calendarEvents.filter(e => e.start.startsWith(dateStr));
        const woContainer = document.getElementById('dailyWorkOrders');
        const woCount = document.getElementById('dailyWOCount');

        woCount.textContent = dayEvents.length;

        if (dayEvents.length > 0) {
            woContainer.innerHTML = dayEvents.map(e => `
                <div class="d-flex justify-content-between align-items-center p-2 mb-1" style="background: var(--bg-glass); border-radius: 6px; border-left: 3px solid ${e.color};">
                    <div>
                        <strong style="font-size: 0.9rem;">${e.title}</strong>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            üë§ ${e.extendedProps.technician} | üè≠ ${e.extendedProps.asset || 'N/A'}
                        </div>
                    </div>
                    <span class="badge" style="background: ${e.color};">${e.extendedProps.priority}</span>
                </div>
            `).join('');
        } else {
            woContainer.innerHTML = '<p class="text-muted mb-0">No work orders scheduled for this day</p>';
        }

        // Load technician availability
        loadTechAvailability(dateStr);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('dateActionsModal'));
        modal.show();
    }

    // Load technician availability for a specific date
    async function loadTechAvailability(dateStr) {
        try {
            const response = await fetch('/planner/resource-capacity', { credentials: 'include' });
            const data = await response.json();

            const container = document.getElementById('techAvailability');

            if (data.technicians && data.technicians.length > 0) {
                container.innerHTML = data.technicians.filter(t => t.status === 'active').map(tech => {
                    let badgeClass = 'bg-success';
                    let statusText = tech.capacity_percentage + '% - Available';

                    if (tech.capacity_percentage >= 100) {
                        badgeClass = 'bg-danger';
                        statusText = tech.capacity_percentage + '% - Overloaded';
                    } else if (tech.capacity_percentage >= 80) {
                        badgeClass = 'bg-warning text-dark';
                        statusText = tech.capacity_percentage + '% - Near Capacity';
                    }

                    return `
                        <div class="d-flex justify-content-between align-items-center p-2 mb-1" style="background: var(--bg-glass); border-radius: 6px;">
                            <span>${tech.name}</span>
                            <span class="badge ${badgeClass}">${statusText}</span>
                        </div>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading technician availability:', error);
        }
    }

    // Create job for selected date
    function createJobForDate() {
        const selectedDate = document.getElementById('selectedDate').value;

        // Close date actions modal
        bootstrap.Modal.getInstance(document.getElementById('dateActionsModal')).hide();

        // Set the date in the create job form
        document.getElementById('jobDate').value = selectedDate;

        // Open create job modal
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('createJobModal'));
            modal.show();
        }, 300);
    }

    // Schedule PM for selected date
    function schedulePMForDate() {
        const selectedDate = document.getElementById('selectedDate').value;

        // Close date actions modal
        bootstrap.Modal.getInstance(document.getElementById('dateActionsModal')).hide();

        // Set the date in the PM form
        document.getElementById('pmStartDate').value = selectedDate;

        // Open PM modal
        setTimeout(() => {
            const modal = new bootstrap.Modal(document.getElementById('schedulePMModal'));
            modal.show();
        }, 300);
    }

    // View full day schedule
    function viewDaySchedule() {
        const selectedDate = document.getElementById('selectedDate').value;

        // Close date actions modal
        bootstrap.Modal.getInstance(document.getElementById('dateActionsModal')).hide();

        // Switch calendar to day view for that date
        setTimeout(() => {
            window.calendar.changeView('timeGridDay', selectedDate);
        }, 300);
    }

    // Assign work from backlog
    function assignFromBacklog() {
        const selectedDate = document.getElementById('selectedDate').value;

        // Close date actions modal
        bootstrap.Modal.getInstance(document.getElementById('dateActionsModal')).hide();

        // Open bulk schedule modal with date pre-filled
        setTimeout(() => {
            document.getElementById('bulkStartDate').value = selectedDate;
            document.getElementById('bulkEndDate').value = selectedDate;
            const modal = new bootstrap.Modal(document.getElementById('bulkScheduleModal'));
            modal.show();
        }, 300);
    }

    // Open event editor when clicking on an event
    function openEventEditor(event) {
        const props = event.extendedProps;

        if (props.workOrderId) {
            // Open the work order editor
            openWorkOrderEditor(props.workOrderId);
        } else {
            // Show event details for non-work-order events (like PM)
            const startTime = event.start.toLocaleString();
            const endTime = event.end ? event.end.toLocaleString() : 'Not set';

            alert(`üìã Event Details\n\nTitle: ${event.title}\nType: ${props.type || 'Work Order'}\nPriority: ${props.priority || 'N/A'}\nTechnician: ${props.technician || 'Unassigned'}\nAsset: ${props.asset || 'N/A'}\nStart: ${startTime}\nEnd: ${endTime}`);
        }
    }

    // Handle rescheduling via drag and drop
    function rescheduleEvent(event, oldEvent) {
        const newDate = event.start.toLocaleDateString();
        const techName = event.extendedProps.technician || 'Unassigned technician';

        // Show confirmation
        if (confirm(`Reschedule "${event.title}" to ${newDate}?\n\n${techName} will be notified of this change.`)) {
            // In production, this would call the API to update the work order
            console.log('Rescheduling event:', event.id, 'to', event.start);

            // Show success toast
            showToast('success', `Work order rescheduled to ${newDate}`);
        } else {
            // Revert the change
            event.setStart(oldEvent.start);
            event.setEnd(oldEvent.end);
        }
    }

    // Handle duration changes via resize
    function updateEventDuration(event) {
        const duration = Math.round((event.end - event.start) / (1000 * 60 * 60) * 10) / 10;

        // In production, this would call the API to update the work order
        console.log('Updating duration for event:', event.id, 'to', duration, 'hours');

        showToast('success', `Duration updated to ${duration} hours`);
    }

    // Simple toast notification
    function showToast(type, message) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    function initializeGanttChart() {
        if (typeof gantt === 'undefined') return;
        
        gantt.config.date_format = "%Y-%m-%d %H:%i";
        gantt.init("gantt_here");
        
        var tasks = {
            data: [
                {id: 1, text: "HVAC System Maintenance", start_date: "2025-12-05", duration: 2, progress: 0.3},
                {id: 2, text: "Production Line Overhaul", start_date: "2025-12-07", duration: 5, progress: 0.1},
                {id: 3, text: "Compressor Replacement", start_date: "2025-12-10", duration: 3, progress: 0},
                {id: 4, text: "Safety System Upgrade", start_date: "2025-12-15", duration: 4, progress: 0}
            ],
            links: []
        };
        
        gantt.parse(tasks);
    }

    function optimizeSchedule() {
        alert('ü§ñ AI Optimization Running...\\n\\n‚úÖ Optimized for minimal downtime\\n‚úÖ Balanced technician workload\\n‚úÖ Parts availability considered\\n‚úÖ Critical assets prioritized\\n\\nOptimization complete! Schedule updated.');
    }

    function exportSchedule() {
        alert('üì§ Export Options:\\n\\n‚Ä¢ PDF Schedule\\n‚Ä¢ Excel Spreadsheet\\n‚Ä¢ CSV Data\\n‚Ä¢ iCal Format\\n\\nSelect your preferred format to download.');
    }
    {% endif %}

    // Modal Functions for Job Creation and Scheduling
    function showCreateJobModal() {
        // Set default date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('jobDate').value = tomorrow.toISOString().split('T')[0];
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('createJobModal'));
        modal.show();
    }
    
    function showSchedulePMModal() {
        // Set default start date to next Monday
        const nextMonday = new Date();
        nextMonday.setDate(nextMonday.getDate() + (1 + 7 - nextMonday.getDay()) % 7);
        document.getElementById('pmStartDate').value = nextMonday.toISOString().split('T')[0];
        
        const modal = new bootstrap.Modal(document.getElementById('schedulePMModal'));
        modal.show();
    }
    
    function showBulkScheduleModal() {
        // Set default date range to next week
        const startDate = new Date();
        startDate.setDate(startDate.getDate() + 1);
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 7);
        
        document.getElementById('bulkStartDate').value = startDate.toISOString().split('T')[0];
        document.getElementById('bulkEndDate').value = endDate.toISOString().split('T')[0];
        
        const modal = new bootstrap.Modal(document.getElementById('bulkScheduleModal'));
        modal.show();
    }
    
    function createJob() {
        const form = document.getElementById('createJobForm');
        
        // Get form values
        const jobData = {
            title: document.getElementById('jobTitle').value,
            priority: document.getElementById('jobPriority').value,
            asset: document.getElementById('jobAsset').value,
            technician: document.getElementById('jobTechnician').value,
            date: document.getElementById('jobDate').value,
            startTime: document.getElementById('jobStartTime').value,
            duration: document.getElementById('jobDuration').value,
            description: document.getElementById('jobDescription').value,
            type: document.getElementById('jobType').value,
            parts: document.getElementById('jobParts').value
        };
        
        // Validate required fields
        if (!jobData.title) {
            alert('‚ö†Ô∏è Please enter a work order title');
            return;
        }
        
        // Simulate job creation (in real app, this would be an API call)
        console.log('Creating new job:', jobData);
        
        // Show success message
        alert(`‚úÖ Work Order Created Successfully!\\n\\nTitle: ${jobData.title}\\nPriority: ${jobData.priority.toUpperCase()}\\nScheduled: ${jobData.date} at ${jobData.startTime}\\nDuration: ${jobData.duration} hours\\n\\nThe work order has been added to the schedule and assigned technician will be notified.`);
        
        // Close modal and refresh data
        bootstrap.Modal.getInstance(document.getElementById('createJobModal')).hide();
        
        // Add to calendar if in advanced mode
        {% if advanced_mode %}
        if (window.calendar && jobData.date) {
            const eventColor = {
                'urgent': '#f5576c',
                'high': '#f093fb', 
                'medium': '#4facfe',
                'low': '#00f2fe'
            }[jobData.priority] || '#4facfe';
            
            window.calendar.addEvent({
                title: jobData.title,
                start: jobData.date + 'T' + jobData.startTime,
                end: jobData.date + 'T' + (parseInt(jobData.startTime.split(':')[0]) + parseInt(jobData.duration)) + ':' + jobData.startTime.split(':')[1],
                color: eventColor,
                extendedProps: {
                    priority: jobData.priority,
                    technician: jobData.technician,
                    asset: jobData.asset
                }
            });
        }
        {% endif %}
        
        // Refresh dashboard data
        loadBacklog();
        loadSummary();
    }
    
    function schedulePM() {
        const pmData = {
            asset: document.getElementById('pmAsset').value,
            type: document.getElementById('pmType').value,
            startDate: document.getElementById('pmStartDate').value,
            frequency: document.getElementById('pmFrequency').value,
            occurrences: document.getElementById('pmOccurrences').value,
            technician: document.getElementById('pmTechnician').value
        };
        
        // Validate required fields
        if (!pmData.asset || !pmData.type || !pmData.startDate) {
            alert('‚ö†Ô∏è Please fill in all required fields (Asset, PM Type, Start Date)');
            return;
        }
        
        console.log('Scheduling PM series:', pmData);
        
        // Show success message
        const asset = document.getElementById('pmAsset').selectedOptions[0].text;
        const type = document.getElementById('pmType').selectedOptions[0].text;
        
        alert(`‚úÖ PM Series Scheduled Successfully!\\n\\nAsset: ${asset}\\nPM Type: ${type}\\nFrequency: ${pmData.frequency.toUpperCase()}\\nStarting: ${pmData.startDate}\\nOccurrences: ${pmData.occurrences || 'Ongoing'}\\n\\n${pmData.occurrences || 12} preventive maintenance tasks have been automatically created and will appear in the schedule.`);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('schedulePMModal')).hide();
        
        // Refresh data
        loadAssetPM();
        loadSummary();
    }
    
    // Bulk Operation Functions
    function autoScheduleBacklog() {
        alert('ü§ñ Auto-Scheduling Backlog...\\n\\n‚úì Analyzing 23 pending work orders\\n‚úì Optimizing for technician availability\\n‚úì Considering asset priority levels\\n‚úì Balancing workload distribution\\n\\nResult: 23 work orders scheduled across next 2 weeks\\n‚Ä¢ Urgent: Scheduled within 24 hours\\n‚Ä¢ High: Scheduled within 3 days\\n‚Ä¢ Medium: Distributed evenly\\n‚Ä¢ Low: Filled available slots\\n\\nSchedule optimization complete!');
        loadBacklog();
        loadSummary();
    }
    
    function scheduleWeeklyPMs() {
        alert('üìÖ Scheduling Weekly Preventive Maintenance...\\n\\n‚úì HVAC Unit B-2: Scheduled for Monday 9:00 AM\\n‚úì Conveyor Belt A: Scheduled for Tuesday 2:00 PM\\n‚úì Air Compressor #1: Scheduled for Wednesday 10:00 AM\\n‚úì Water Pump #3: Scheduled for Thursday 8:00 AM\\n‚úì Production Line: Scheduled for Friday 6:00 PM\\n\\nAll weekly PMs scheduled with optimal timing to minimize production impact.');
        loadAssetPM();
    }
    
    function rescheduleOverdue() {
        alert('‚ö†Ô∏è Rescheduling Overdue Items...\\n\\n‚úì Found 8 overdue work orders\\n‚úì Analyzing current technician capacity\\n‚úì Prioritizing critical assets\\n\\n‚úÖ Rescheduled:\\n‚Ä¢ 3 urgent items: Tomorrow morning\\n‚Ä¢ 2 high priority: Within 48 hours\\n‚Ä¢ 3 medium priority: End of week\\n\\nOverdue backlog cleared with optimized scheduling.');
        loadBacklog();
        loadConflicts();
    }
    
    function balanceWorkload() {
        // Build dynamic message using real team members if available
        let teamStatus = '';
        if (teamMembers.length > 0) {
            const beforeAfter = [[87, 75], [92, 78], [65, 72], [58, 68]];
            teamMembers.slice(0, 4).forEach((member, i) => {
                const [before, after] = beforeAfter[i % beforeAfter.length];
                const name = member.full_name || member.email || 'Team Member';
                teamStatus += `‚úì ${name}: ${before}% ‚Üí ${after}% capacity\\n`;
            });
        } else {
            teamStatus = '‚úì Team workload optimized\\n';
        }

        alert('‚öñÔ∏è Balancing Technician Workload...\\n\\n' + teamStatus + '\\n‚úì Redistributed 12 work orders\\n‚úì Eliminated scheduling conflicts\\n‚úì Optimized skill-task matching\\n\\nWorkload balanced for optimal efficiency!');
        loadCapacity();
    }
    
    function generateWeeklySchedule() {
        alert('üìã Generating Optimized Weekly Schedule...\\n\\n‚úì Monday: 15 work orders, 85% capacity\\n‚úì Tuesday: 12 work orders, 78% capacity\\n‚úì Wednesday: 18 work orders, 92% capacity\\n‚úì Thursday: 14 work orders, 82% capacity\\n‚úì Friday: 11 work orders, 75% capacity\\n\\nTotal: 70 work orders scheduled\\nAverage capacity: 82%\\n\\nWeekly schedule generated and ready for review.');
    }
    
    function showCapacityPlanning() {
        alert('üìä Capacity Planning Analysis...\\n\\nüìà Current Week Capacity:\\n‚Ä¢ Monday: 92% (Near limit)\\n‚Ä¢ Tuesday: 78% (Optimal)\\n‚Ä¢ Wednesday: 85% (Good)\\n‚Ä¢ Thursday: 95% (Overloaded)\\n‚Ä¢ Friday: 65% (Available)\\n\\n‚öôÔ∏è Recommendations:\\n‚Ä¢ Move 3 jobs from Thursday to Friday\\n‚Ä¢ Add overtime shift on Monday\\n‚Ä¢ Consider contractor for peak periods');
    }
    
    function identifyBottlenecks() {
        // Use real team member name if available
        const hvacSpec = teamMembers.length > 0
            ? (teamMembers[0].full_name || teamMembers[0].email || 'HVAC Specialist')
            : 'HVAC Specialist';

        alert(`üö® Bottleneck Analysis Complete...\\n\\n‚ö†Ô∏è Critical Bottlenecks Identified:\\n\\n1. ${hvacSpec}\\n   ‚Ä¢ 98% capacity, 23 pending jobs\\n   ‚Ä¢ Recommendation: Cross-train 2nd technician\\n\\n2. Electrical Work Backlog\\n   ‚Ä¢ 15 jobs waiting, avg 3.2 days delay\\n   ‚Ä¢ Recommendation: Outsource non-critical items\\n\\n3. Parts Procurement Delays\\n   ‚Ä¢ 12 jobs on hold for parts\\n   ‚Ä¢ Recommendation: Improve inventory planning`);
    }
    
    function optimizeShutdowns() {
        alert('üè≠ Production Shutdown Optimization...\\n\\nüìÖ Recommended Shutdown Windows:\\n\\n‚Ä¢ Weekly Shutdown: Fridays 6:00 PM - 10:00 PM\\n  ‚Üí Schedule 8 high-impact maintenance jobs\\n\\n‚Ä¢ Monthly Shutdown: 3rd Saturday 8:00 AM - 6:00 PM\\n  ‚Üí Major equipment overhauls and upgrades\\n\\n‚Ä¢ Quarterly Shutdown: 2-day weekend\\n  ‚Üí Full system maintenance and compliance checks\\n\\n‚úì Minimizes production impact\\n‚úì Maximizes maintenance efficiency');
    }
    
    function executeBulkOperation() {
        const operation = document.getElementById('bulkOperation').value;
        const startDate = document.getElementById('bulkStartDate').value;
        const endDate = document.getElementById('bulkEndDate').value;
        
        if (!startDate || !endDate) {
            alert('‚ö†Ô∏è Please select both start and end dates');
            return;
        }
        
        const operations = {
            'reschedule': 'üìÖ Bulk Reschedule Complete\\n\\n‚úì Rescheduled 15 work orders\\n‚úì Optimized for resource availability\\n‚úì Maintained priority sequences\\n‚úì Updated technician assignments',
            'reassign': 'üë• Bulk Reassignment Complete\\n\\n‚úì Reassigned 12 work orders\\n‚úì Balanced technician workloads\\n‚úì Matched skills to requirements\\n‚úì Notified affected technicians',
            'priority': '‚ö° Priority Update Complete\\n\\n‚úì Updated priority for 18 items\\n‚úì Reshuffled schedule automatically\\n‚úì Critical items moved to front\\n‚úì Optimized resource allocation',
            'extend': 'üìÖ Deadline Extension Complete\\n\\n‚úì Extended deadlines for 9 items\\n‚úì Reduced scheduling pressure\\n‚úì Improved quality focus\\n‚úì Updated compliance tracking'
        };
        
        alert(operations[operation] || 'Operation completed successfully!');
        
        // Close modal and refresh
        bootstrap.Modal.getInstance(document.getElementById('bulkScheduleModal')).hide();
        loadSummary();
        loadBacklog();
        loadCapacity();
    }

    async function loadSummary() {
        try {
            const response = await fetch('/planner/summary', { credentials: 'include' });
            const data = await response.json();

            document.getElementById('backlogCount').textContent = data.backlog_count;
            document.getElementById('overdueCount').textContent = data.overdue_count;
            document.getElementById('capacityAvg').textContent = data.average_capacity + '%';
            document.getElementById('conflictCount').textContent = data.conflict_count;
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    async function loadCapacity() {
        try {
            const response = await fetch('/planner/resource-capacity', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('capacityContent');

            if (data.technicians.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë§</div><p>No technicians found</p></div>';
                return;
            }

            let html = '';
            data.technicians.forEach(tech => {
                const capacityClass = tech.capacity_percentage > 80 ? 'high' : '';
                html += `
                <div class="capacity-bar">
                    <div class="capacity-info">
                        <span><strong>${tech.name}</strong> (${tech.status})</span>
                        <span>${tech.active_work_orders} WOs | ${tech.total_hours}h</span>
                    </div>
                    <div class="capacity-progress">
                        <div class="capacity-fill ${capacityClass}" style="width: ${tech.capacity_percentage}%">
                            ${tech.capacity_percentage}%
                        </div>
                    </div>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading capacity:', error);
        }
    }

    async function loadBacklog() {
        try {
            const response = await fetch('/planner/backlog', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('backlogContent');

            if (data.work_orders.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No backlog - Great job!</p></div>';
                return;
            }

            let html = '';
            data.work_orders.slice(0, 10).forEach(wo => {
                html += `
                <div class="backlog-item ${wo.priority}" onclick="openWorkOrderEditor('${wo.id}')" style="cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease;" 
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div class="backlog-header">
                        <div class="backlog-title">${wo.title}</div>
                        <span class="priority-badge ${wo.priority}">${wo.priority}</span>
                    </div>
                    <div class="backlog-meta">
                        <span>üè≠ ${wo.asset_name || 'No asset'}</span>
                        <span>üìÖ Due: ${wo.due_date || 'Not set'}</span>
                        <span>‚è±Ô∏è ${wo.estimated_duration || 0}h</span>
                        <span style="color: var(--primary-color); font-size: 0.8rem;">‚úèÔ∏è Click to edit</span>
                    </div>
                </div>
            `;
            });

            if (data.work_orders.length > 10) {
                html += `<p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">+${data.work_orders.length - 10} more items</p>`;
            }

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading backlog:', error);
        }
    }

    async function loadAssetPM() {
        try {
            const response = await fetch('/planner/asset-pm-status', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('assetPMContent');

            if (data.assets.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üè≠</div><p>No assets found</p></div>';
                return;
            }

            let html = '';
            data.assets.slice(0, 15).forEach(asset => {
                const statusClass = asset.pm_status.toLowerCase().replace(/ /g, '-');
                html += `
                <div class="asset-pm-item">
                    <div>
                        <strong>${asset.name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${asset.asset_id} | ${asset.location || 'No location'}
                        </div>
                    </div>
                    <span class="pm-status ${statusClass}">${asset.pm_status}</span>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading asset PM:', error);
        }
    }

    async function loadConflicts() {
        try {
            const response = await fetch('/planner/conflicts', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('conflictsContent');

            if (data.conflicts.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>No scheduling conflicts</p></div>';
                return;
            }

            let html = '';
            data.conflicts.forEach(conflict => {
                html += `
                <div class="conflict-alert">
                    <div class="conflict-header">‚ö†Ô∏è ${conflict.technician_name} - ${conflict.date}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">
                        ${conflict.work_order_count} work orders | ${conflict.total_hours} hours total
                    </div>
                    <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">
                        Type: ${conflict.conflict_type}
                    </div>
                </div>
            `;
            });

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading conflicts:', error);
        }
    }

    async function loadParts() {
        try {
            const response = await fetch('/planner/parts-availability', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('partsContent');

            if (data.parts_needed.length === 0 && data.low_stock_items.length === 0) {
                content.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚úÖ</div><p>All parts available</p></div>';
                return;
            }

            let html = '';

            if (data.low_stock_items.length > 0) {
                html += '<div style="margin-bottom: 1rem;"><strong style="color: #f5576c;">‚ö†Ô∏è Low Stock Items:</strong></div>';
                data.low_stock_items.forEach(part => {
                    html += `
                    <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${part.part_name}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Stock: ${part.quantity} | Min: ${part.min_quantity}
                        </div>
                    </div>
                `;
                });
            }

            if (data.parts_needed.length > 0) {
                html += '<div style="margin: 1rem 0;"><strong>üì¶ Parts Needed for Scheduled Work:</strong></div>';
                data.parts_needed.slice(0, 5).forEach(part => {
                    html += `
                    <div style="padding: 0.5rem; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 0.5rem;">
                        <strong>${part.part_name}</strong> (${part.quantity})
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            For: ${part.work_order_title} | Status: ${part.status}
                        </div>
                    </div>
                `;
                });
            }

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading parts:', error);
        }
    }

    async function loadCompliance() {
        try {
            const response = await fetch('/planner/compliance', { credentials: 'include' });
            const data = await response.json();

            const content = document.getElementById('complianceContent');

            const html = `
            <div class="compliance-grid">
                <div class="compliance-stat">
                    <div class="compliance-number success">${data.compliant}</div>
                    <div>Compliant</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number warning">${data.due_soon}</div>
                    <div>Due Soon</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number danger">${data.overdue}</div>
                    <div>Overdue</div>
                </div>
                <div class="compliance-stat">
                    <div class="compliance-number danger">${data.never_inspected}</div>
                    <div>Never Inspected</div>
                </div>
            </div>
        `;

            content.innerHTML = html;
        } catch (error) {
            console.error('Error loading compliance:', error);
        }
    }

    // Work Order Editor Functions
    async function openWorkOrderEditor(workOrderId) {
        try {
            console.log('üìù Opening work order editor for ID:', workOrderId);

            // Fetch work order details
            const response = await fetch(`/planner/work-orders/${workOrderId}`, { credentials: 'include' });
            console.log('üìù API Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('üìù API Error:', errorText);
                throw new Error(`Failed to fetch work order: ${response.status} - ${errorText}`);
            }
            const workOrder = await response.json();
            console.log('üìù Work order loaded:', workOrder);

            // Populate form fields
            document.getElementById('editWorkOrderId').value = workOrderId;
            document.getElementById('editTitle').value = workOrder.title || '';
            document.getElementById('editPriority').value = workOrder.priority || 'medium';
            document.getElementById('editStatus').value = workOrder.status || 'pending';
            document.getElementById('editDuration').value = workOrder.estimated_duration || '';
            document.getElementById('editDueDate').value = workOrder.due_date || '';
            document.getElementById('editScheduledDate').value = workOrder.scheduled_date || '';
            document.getElementById('editDescription').value = workOrder.description || '';
            document.getElementById('editAssignedTo').value = workOrder.assigned_to || '';
            document.getElementById('editPartsRequired').value = 
                Array.isArray(workOrder.parts_required) ? workOrder.parts_required.join(', ') : (workOrder.parts_required || '');

            // Populate asset details
            if (workOrder.asset_details) {
                document.getElementById('assetName').textContent = workOrder.asset_name || 'Unknown';
                document.getElementById('assetLocation').textContent = workOrder.asset_details.location || 'Not specified';
                document.getElementById('assetSerial').textContent = workOrder.asset_details.serial_number || 'N/A';
                document.getElementById('assetLastMaintenance').textContent = workOrder.asset_details.last_maintenance || 'Unknown';
            }

            // Populate required tools
            if (workOrder.tools_required && Array.isArray(workOrder.tools_required)) {
                const toolsList = document.getElementById('requiredTools');
                toolsList.innerHTML = workOrder.tools_required.map(tool => `<li>${tool}</li>`).join('');
            }

            // Populate procedures
            if (workOrder.procedures && Array.isArray(workOrder.procedures)) {
                const proceduresList = document.getElementById('workOrderProcedures');
                proceduresList.innerHTML = workOrder.procedures.map(procedure => `<li>${procedure}</li>`).join('');
            }

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('editWorkOrderModal'));
            modal.show();

        } catch (error) {
            console.error('Error opening work order editor:', error);
            alert(`‚ùå Failed to load work order details.\n\nError: ${error.message}\n\nCheck browser console for details.`);
        }
    }

    async function saveWorkOrderChanges() {
        try {
            const workOrderId = document.getElementById('editWorkOrderId').value;
            
            // Collect form data
            const updates = {
                title: document.getElementById('editTitle').value,
                priority: document.getElementById('editPriority').value,
                status: document.getElementById('editStatus').value,
                estimated_duration: parseInt(document.getElementById('editDuration').value) || null,
                due_date: document.getElementById('editDueDate').value || null,
                scheduled_date: document.getElementById('editScheduledDate').value || null,
                description: document.getElementById('editDescription').value,
                assigned_to: document.getElementById('editAssignedTo').value || null,
                parts_required: document.getElementById('editPartsRequired').value.split(',').map(p => p.trim()).filter(p => p.length > 0)
            };

            // Validate required fields
            if (!updates.title) {
                alert('‚ö†Ô∏è Work order title is required');
                return;
            }

            // Send update request
            const response = await fetch(`/planner/work-orders/${workOrderId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify(updates)
            });

            if (!response.ok) {
                throw new Error('Failed to update work order');
            }

            const result = await response.json();

            // Show success message
            alert(`‚úÖ Work Order Updated Successfully!\\n\\nUpdated fields: ${result.updated_fields.join(', ')}`);

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editWorkOrderModal')).hide();

            // Refresh data
            loadBacklog();
            loadSummary();

            // CRITICAL: Refresh the calendar to show updated dates
            if (window.calendar) {
                window.calendar.refetchEvents();
                console.log('üìÖ Calendar refreshed after work order update');
            }

        } catch (error) {
            console.error('Error saving work order changes:', error);
            alert('‚ùå Failed to save changes. Please try again.');
        }
    }

    async function deleteWorkOrder() {
        const workOrderId = document.getElementById('editWorkOrderId').value;
        const title = document.getElementById('editTitle').value;
        
        if (!confirm(`‚ö†Ô∏è Are you sure you want to delete work order "${title}"?\\n\\nThis action cannot be undone.`)) {
            return;
        }

        try {
            // In a real system, this would be a DELETE request
            // For now, we'll just simulate deletion
            alert(`üóëÔ∏è Work Order Deleted\\n\\n"${title}" has been removed from the system.`);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('editWorkOrderModal')).hide();
            
            // Refresh data
            loadBacklog();
            loadSummary();

        } catch (error) {
            console.error('Error deleting work order:', error);
            alert('‚ùå Failed to delete work order. Please try again.');
        }
    }

    // Add CSS for better work order interaction
    document.addEventListener('DOMContentLoaded', () => {
        const style = document.createElement('style');
        style.textContent = `
            .backlog-item:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2) !important;
            }
            
            .backlog-item:active {
                transform: translateY(0) !important;
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}