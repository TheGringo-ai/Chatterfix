{% extends "base.html" %}

{% block title %}POS System - ChatterFix CMMS{% endblock %}

{% block content %}
<div class="cmms-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üè™ Point of Sale & Purchasing</h1>
            <p>Complete purchasing and parts management system</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <button class="cmms-btn" onclick="showBarcodeScan()">
                <i class="fas fa-qrcode"></i> Barcode Scan
            </button>
            <button class="cmms-btn" onclick="showQuickAdd()">
                <i class="fas fa-plus"></i> Quick Add Part
            </button>
        </div>
    </div>
</div>

<!-- Main POS Interface -->
<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;">
    
    <!-- Left Panel: Search & Cart -->
    <div>
        <!-- Search Bar -->
        <div class="cmms-card">
            <h3>üîç Part Search</h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="part-search" placeholder="Search parts by name or part number..." 
                    style="flex: 1; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                <button onclick="searchParts()" class="cmms-btn">Search</button>
            </div>
            <div id="search-results" style="max-height: 300px; overflow-y: auto;">
                <!-- Search results will be populated here -->
            </div>
        </div>

        <!-- Shopping Cart -->
        <div class="cmms-card">
            <h3>üõí Current Purchase Order</h3>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <select id="vendor-select" style="flex: 1; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <option value="">Select Vendor...</option>
                    {% for vendor in vendors %}
                    <option value="{{ vendor.id }}" style="color: black;">{{ vendor.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" id="po-number" placeholder="PO Number" 
                    style="padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
            </div>
            
            <div id="cart-items" style="min-height: 200px;">
                <div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">
                    Cart is empty. Search for parts to add them.
                </div>
            </div>
            
            <div style="border-top: 1px solid #dee2e6; padding-top: 1rem; margin-top: 1rem;">
                <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold;">
                    <span>Total: $</span>
                    <span id="cart-total">0.00</span>
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                    <button onclick="savePO()" class="cmms-btn" style="flex: 1;">üíæ Save as Draft</button>
                    <button onclick="submitPO()" class="cmms-btn cmms-btn-success" style="flex: 1;">‚úÖ Submit PO</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Right Panel: Quick Actions -->
    <div>
        <!-- Quick Stats -->
        <div class="cmms-card">
            <h3>üìä Quick Stats</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="text-align: center; padding: 1rem; background: var(--bg-glass); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #e74c3c;" id="low-stock-count">0</div>
                    <div style="font-size: 0.9rem;">Low Stock</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: var(--bg-glass); border-radius: 8px;">
                    <div style="font-size: 1.5rem; font-weight: bold; color: #3498db;" id="pending-pos">0</div>
                    <div style="font-size: 0.9rem;">Pending POs</div>
                </div>
            </div>
        </div>

        <!-- Recent Parts -->
        <div class="cmms-card">
            <h3>üïí Recently Added</h3>
            <div id="recent-parts">
                {% for part in parts[:5] %}
                <div class="item-card" style="margin-bottom: 0.5rem; padding: 0.8rem;" onclick="addToCart('{{ part.id }}', '{{ part.name }}', {{ part.cost or 0 }})">
                    <strong>{{ part.name }}</strong><br>
                    <small>{{ part.part_number }} - ${{ "%.2f"|format(part.cost or 0) }}</small>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="cmms-card">
            <h3>‚ö° Quick Actions</h3>
            <button onclick="showAddPart()" class="cmms-btn" style="width: 100%; margin-bottom: 0.5rem;">
                <i class="fas fa-plus"></i> Add New Part
            </button>
            <button onclick="showAddVendor()" class="cmms-btn" style="width: 100%; margin-bottom: 0.5rem;">
                <i class="fas fa-building"></i> Add New Vendor
            </button>
            <button onclick="showLowStock()" class="cmms-btn" style="width: 100%; margin-bottom: 0.5rem;">
                <i class="fas fa-exclamation-triangle"></i> View Low Stock
            </button>
            <button onclick="showInvoices()" class="cmms-btn" style="width: 100%;">
                <i class="fas fa-file-invoice"></i> Upload Invoice
            </button>
        </div>
    </div>
</div>

<!-- Add Part Modal -->
<div id="addPartModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 5% auto; width: 600px; padding: 30px; max-height: 90vh; overflow-y: auto;">
        <h2>üì¶ Add New Part</h2>
        <form id="add-part-form" enctype="multipart/form-data">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label>Part Name</label>
                    <input type="text" name="name" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label>Part Number</label>
                    <input type="text" name="part_number" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>Description</label>
                    <textarea name="description" rows="2" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;"></textarea>
                </div>
                <div>
                    <label>Category</label>
                    <input type="text" name="category" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label>Vendor</label>
                    <select name="vendor_id" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="" style="color: black;">No Vendor</option>
                        {% for vendor in vendors %}
                        <option value="{{ vendor.id }}" style="color: black;">{{ vendor.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label>Unit Cost</label>
                    <input type="number" step="0.01" name="unit_cost" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label>Current Stock</label>
                    <input type="number" name="current_stock" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label>Minimum Stock</label>
                    <input type="number" name="minimum_stock" value="5" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label>Location</label>
                    <input type="text" name="location" placeholder="e.g., A1-B2" style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label>üì∏ Photos & Documents</label>
                    <input type="file" name="files" multiple accept="image/*,.pdf,.doc,.docx" style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="document.getElementById('addPartModal').style.display='none'" class="cmms-btn" style="background: #e74c3c;">Cancel</button>
                <button type="submit" class="cmms-btn">Add Part</button>
            </div>
        </form>
    </div>
</div>

<!-- Barcode Scanner Modal -->
<div id="barcodeModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 10% auto; width: 400px; padding: 30px;">
        <h2>üì± Barcode Scanner</h2>
        <div style="margin-bottom: 1rem;">
            <input type="text" id="barcode-input" placeholder="Scan or enter barcode/part number"
                style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
        </div>
        <div style="display: flex; gap: 1rem;">
            <button onclick="lookupBarcode()" class="cmms-btn" style="flex: 1;">Lookup</button>
            <button onclick="document.getElementById('barcodeModal').style.display='none'" class="cmms-btn" style="background: #e74c3c;">Close</button>
        </div>
        <div id="barcode-result" style="margin-top: 1rem;"></div>
    </div>
</div>

<!-- Add Vendor Modal -->
<div id="addVendorModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 5% auto; width: 90%; max-width: 600px; padding: 30px;">
        <h2 style="color: #212529; margin-bottom: 1.5rem;"><i class="fas fa-building"></i> Add New Vendor</h2>
        <form id="add-vendor-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div style="grid-column: 1 / -1;">
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Vendor Name *</label>
                    <input type="text" name="name" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Contact Name</label>
                    <input type="text" name="contact_name" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Email</label>
                    <input type="email" name="email" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Phone</label>
                    <input type="tel" name="phone" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Payment Terms</label>
                    <select name="payment_terms" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="Net 30">Net 30</option>
                        <option value="Net 15">Net 15</option>
                        <option value="Net 60">Net 60</option>
                        <option value="Due on Receipt">Due on Receipt</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Address</label>
                    <textarea name="address" rows="2" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;"></textarea>
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Tax ID</label>
                    <input type="text" name="tax_id" style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Documents</label>
                    <input type="file" name="files" multiple accept=".pdf,.doc,.docx" style="width: 100%; padding: 0.5rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeVendorModal()" class="cmms-btn" style="background: #6c757d;">Cancel</button>
                <button type="submit" class="cmms-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Add Vendor</button>
            </div>
        </form>
    </div>
</div>

<!-- Low Stock Modal -->
<div id="lowStockModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 5% auto; width: 90%; max-width: 800px; padding: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="color: #212529; margin: 0;"><i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Low Stock Items</h2>
            <button onclick="closeLowStockModal()" class="cmms-btn" style="background: #6c757d; padding: 0.5rem 1rem;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <div id="low-stock-list" style="max-height: 60vh; overflow-y: auto;">
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Loading low stock items...</p>
            </div>
        </div>
    </div>
</div>

<!-- Upload Invoice Modal -->
<div id="uploadInvoiceModal" class="modal modal-light" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 5% auto; width: 90%; max-width: 600px; padding: 30px;">
        <h2 style="color: #212529; margin-bottom: 1.5rem;"><i class="fas fa-file-invoice"></i> Upload Invoice</h2>
        <form id="upload-invoice-form" enctype="multipart/form-data">
            <div style="display: grid; gap: 1rem;">
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Related Purchase Order *</label>
                    <select name="po_id" id="invoice-po-select" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="">Select PO...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Invoice Number *</label>
                        <input type="text" name="invoice_number" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    </div>
                    <div>
                        <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Invoice Amount *</label>
                        <input type="number" step="0.01" name="invoice_amount" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    </div>
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Invoice Date *</label>
                    <input type="date" name="invoice_date" required style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="color: #495057; font-weight: 600; display: block; margin-bottom: 0.5rem;">Invoice Document(s) *</label>
                    <div style="border: 2px dashed #dee2e6; border-radius: 8px; padding: 2rem; text-align: center; background: #f8f9fa;">
                        <i class="fas fa-cloud-upload-alt fa-2x" style="color: #6c757d; margin-bottom: 0.5rem;"></i>
                        <p style="color: #6c757d; margin-bottom: 0.5rem;">Drag & drop invoice files here or click to browse</p>
                        <input type="file" name="files" multiple required accept=".pdf,.jpg,.jpeg,.png" style="width: 100%;">
                    </div>
                </div>
            </div>
            <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="closeInvoiceModal()" class="cmms-btn" style="background: #6c757d;">Cancel</button>
                <button type="submit" class="cmms-btn" style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);">Upload Invoice</button>
            </div>
        </form>
    </div>
</div>

<script>
let cart = [];
let cartTotal = 0;

// Search functionality
async function searchParts() {
    const query = document.getElementById('part-search').value;
    try {
        const response = await fetch(`/purchasing/parts/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        const resultsDiv = document.getElementById('search-results');
        if (data.parts.length > 0) {
            resultsDiv.innerHTML = data.parts.map(part => `
                <div class="item-card" style="margin-bottom: 0.5rem; cursor: pointer;" onclick="addToCart(${part.id}, '${part.name}', ${part.unit_cost}, '${part.part_number}')">
                    <strong>${part.name}</strong><br>
                    <small>${part.part_number} - $${part.unit_cost.toFixed(2)} | Stock: ${part.current_stock}</small>
                </div>
            `).join('');
        } else {
            resultsDiv.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 1rem;">No parts found</div>';
        }
    } catch (error) {
        console.error('Search error:', error);
    }
}

// Cart functionality
function addToCart(partId, name, price, partNumber = '') {
    const existingItem = cart.find(item => item.id === partId);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({
            id: partId,
            name: name,
            partNumber: partNumber,
            price: price,
            quantity: 1
        });
    }
    
    updateCartDisplay();
}

function updateCartDisplay() {
    const cartDiv = document.getElementById('cart-items');
    const totalDiv = document.getElementById('cart-total');
    
    if (cart.length === 0) {
        cartDiv.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 2rem;">Cart is empty. Search for parts to add them.</div>';
        totalDiv.textContent = '0.00';
        return;
    }
    
    cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    cartDiv.innerHTML = cart.map(item => `
        <div class="item-card" style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>${item.name}</strong><br>
                <small>${item.partNumber} - $${item.price.toFixed(2)} each</small>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" class="cmms-btn cmms-btn-sm">-</button>
                <span style="padding: 0 0.5rem;">${item.quantity}</span>
                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" class="cmms-btn cmms-btn-sm">+</button>
                <button onclick="removeFromCart(${item.id})" class="cmms-btn cmms-btn-sm" style="background: #e74c3c; margin-left: 0.5rem;">√ó</button>
            </div>
        </div>
    `).join('');
    
    totalDiv.textContent = cartTotal.toFixed(2);
}

function updateQuantity(partId, newQuantity) {
    if (newQuantity <= 0) {
        removeFromCart(partId);
        return;
    }
    
    const item = cart.find(item => item.id === partId);
    if (item) {
        item.quantity = newQuantity;
        updateCartDisplay();
    }
}

function removeFromCart(partId) {
    cart = cart.filter(item => item.id !== partId);
    updateCartDisplay();
}

// Purchase Order submission
async function submitPO() {
    const vendorId = document.getElementById('vendor-select').value;
    const poNumber = document.getElementById('po-number').value;
    
    if (!vendorId) {
        alert('Please select a vendor');
        return;
    }
    
    if (!poNumber) {
        alert('Please enter a PO number');
        return;
    }
    
    if (cart.length === 0) {
        alert('Cart is empty');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('vendor_id', vendorId);
        formData.append('po_number', poNumber);
        formData.append('description', `PO with ${cart.length} items`);
        formData.append('total_amount', cartTotal.toFixed(2));
        
        const response = await fetch('/purchasing/purchase-orders/create', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Purchase Order created successfully!');
            cart = [];
            updateCartDisplay();
            document.getElementById('po-number').value = '';
            document.getElementById('vendor-select').value = '';
        } else {
            alert('Error creating purchase order');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating purchase order');
    }
}

// Modals
function showAddPart() {
    document.getElementById('addPartModal').style.display = 'block';
}

function showBarcodeScan() {
    document.getElementById('barcodeModal').style.display = 'block';
    document.getElementById('barcode-input').focus();
}

// Barcode lookup
async function lookupBarcode() {
    const barcode = document.getElementById('barcode-input').value;
    if (!barcode) return;
    
    try {
        const response = await fetch(`/purchasing/barcode/${encodeURIComponent(barcode)}`);
        const data = await response.json();
        
        const resultDiv = document.getElementById('barcode-result');
        if (data.success) {
            const part = data.part;
            resultDiv.innerHTML = `
                <div class="item-card">
                    <strong>${part.name}</strong><br>
                    <small>${part.part_number} - $${part.unit_cost.toFixed(2)}</small><br>
                    <button onclick="addToCart(${part.id}, '${part.name}', ${part.unit_cost}, '${part.part_number}'); document.getElementById('barcodeModal').style.display='none'" 
                        class="cmms-btn cmms-btn-sm" style="margin-top: 0.5rem;">Add to Cart</button>
                </div>
            `;
        } else {
            resultDiv.innerHTML = '<div style="color: #e74c3c;">Part not found</div>';
        }
    } catch (error) {
        console.error('Barcode lookup error:', error);
    }
}

// Form submissions
document.getElementById('add-part-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/purchasing/parts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Part added successfully!');
            document.getElementById('addPartModal').style.display = 'none';
            this.reset();
            location.reload(); // Refresh to show new part
        } else {
            alert('Error adding part');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error adding part');
    }
});

// Enter key for search
document.getElementById('part-search').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchParts();
    }
});

// Enter key for barcode
document.getElementById('barcode-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        lookupBarcode();
    }
});

// Load initial data
document.addEventListener('DOMContentLoaded', function() {
    searchParts(); // Load all parts initially
    loadLowStockCount(); // Load low stock count for stats
});

// ============================================
// QUICK ACTION FUNCTIONS
// ============================================

// Show Add Vendor Modal
function showAddVendor() {
    document.getElementById('addVendorModal').style.display = 'block';
}

function closeVendorModal() {
    document.getElementById('addVendorModal').style.display = 'none';
}

// Add Vendor Form Submit
document.getElementById('add-vendor-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
        const response = await fetch('/purchasing/vendors/create', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ Vendor added successfully!');
            closeVendorModal();
            this.reset();
            location.reload(); // Refresh to show new vendor in dropdown
        } else {
            alert('‚ùå Error adding vendor: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error adding vendor');
    }
});

// Show Low Stock Modal
async function showLowStock() {
    document.getElementById('lowStockModal').style.display = 'block';
    await loadLowStockItems();
}

function closeLowStockModal() {
    document.getElementById('lowStockModal').style.display = 'none';
}

async function loadLowStockItems() {
    const listDiv = document.getElementById('low-stock-list');

    try {
        const response = await fetch('/purchasing/inventory/low-stock');
        const data = await response.json();

        if (data.low_stock_items && data.low_stock_items.length > 0) {
            listDiv.innerHTML = data.low_stock_items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 0.75rem; background: #fff;">
                    <div>
                        <strong style="color: #212529;">${item.name}</strong>
                        <div style="font-size: 0.85rem; color: #6c757d;">
                            Part #: ${item.part_number || 'N/A'} | Location: ${item.location || 'N/A'}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="color: #e74c3c; font-weight: bold;">
                            Stock: ${item.current_stock || 0} / Min: ${item.minimum_stock || 0}
                        </div>
                        <div style="font-size: 0.85rem; color: #6c757d;">
                            Vendor: ${item.vendor_name || 'N/A'}
                        </div>
                    </div>
                    <button onclick="addToCart('${item.id}', '${item.name}', ${item.unit_cost || 0}, '${item.part_number || ''}')"
                        class="cmms-btn" style="margin-left: 1rem; padding: 0.5rem 1rem;">
                        <i class="fas fa-cart-plus"></i> Add to PO
                    </button>
                </div>
            `).join('');
        } else {
            listDiv.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #28a745;">
                    <i class="fas fa-check-circle fa-3x" style="margin-bottom: 1rem;"></i>
                    <h4>All Stock Levels Good!</h4>
                    <p>No items are currently below minimum stock levels.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading low stock:', error);
        listDiv.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #dc3545;">
                <i class="fas fa-exclamation-circle fa-2x"></i>
                <p>Error loading low stock items</p>
            </div>
        `;
    }
}

async function loadLowStockCount() {
    try {
        const response = await fetch('/purchasing/inventory/low-stock');
        const data = await response.json();
        const count = data.low_stock_items ? data.low_stock_items.length : 0;
        document.getElementById('low-stock-count').textContent = count;
    } catch (error) {
        console.error('Error loading low stock count:', error);
    }
}

// Show Upload Invoice Modal
async function showInvoices() {
    document.getElementById('uploadInvoiceModal').style.display = 'block';
    await loadPurchaseOrdersForInvoice();
}

function closeInvoiceModal() {
    document.getElementById('uploadInvoiceModal').style.display = 'none';
}

async function loadPurchaseOrdersForInvoice() {
    const select = document.getElementById('invoice-po-select');

    try {
        const response = await fetch('/purchasing/purchase-orders');
        const data = await response.json();

        select.innerHTML = '<option value="">Select PO...</option>';

        if (data.purchase_orders && data.purchase_orders.length > 0) {
            data.purchase_orders.forEach(po => {
                const option = document.createElement('option');
                option.value = po.id;
                option.textContent = `${po.po_number} - $${(po.total_amount || 0).toFixed(2)} (${po.status || 'Unknown'})`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading POs:', error);
    }
}

// Upload Invoice Form Submit
document.getElementById('upload-invoice-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
        const response = await fetch('/purchasing/invoices/upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert('‚úÖ Invoice uploaded successfully!');
            closeInvoiceModal();
            this.reset();
        } else {
            alert('‚ùå Error uploading invoice: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error uploading invoice');
    }
});

// Quick Add Part modal (already exists as showAddPart)
function showQuickAdd() {
    showAddPart();
}
</script>
{% endblock %}