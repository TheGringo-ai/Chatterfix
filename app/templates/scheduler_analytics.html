{% extends "base.html" %}

{% block title %}Scheduler Analytics - ChatterFix{% endblock %}

{% block head %}
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>

<style>
    .analytics-dashboard {
        padding: 1.5rem;
        max-width: 1400px;
        margin: 0 auto;
    }

    .analytics-header {
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .analytics-title {
        font-size: 2.5rem;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .analytics-controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .date-filter {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        background: var(--card-bg);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }

    .date-input {
        border: none;
        background: transparent;
        color: var(--text-primary);
        padding: 0.25rem;
    }

    .export-btn {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .kpi-card {
        background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg-secondary) 100%);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--border-color);
        position: relative;
        overflow: hidden;
    }

    .kpi-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .kpi-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .kpi-icon {
        font-size: 1.5rem;
        opacity: 0.7;
    }

    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .kpi-change {
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .kpi-change.positive {
        color: #059669;
    }

    .kpi-change.negative {
        color: #dc2626;
    }

    .kpi-change.neutral {
        color: var(--text-secondary);
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .chart-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--border-color);
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .chart-filter {
        display: flex;
        gap: 0.5rem;
    }

    .filter-btn {
        padding: 0.25rem 0.75rem;
        border: 2px solid var(--border-color);
        background: var(--bg-secondary);
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    .chart-container.large {
        height: 400px;
    }

    .insights-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--border-color);
    }

    .insights-title {
        font-size: 1.3rem;
        font-weight: bold;
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .insight-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
        background: var(--bg-secondary);
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
    }

    .insight-icon {
        font-size: 1.5rem;
        opacity: 0.8;
    }

    .insight-content {
        flex: 1;
    }

    .insight-text {
        font-size: 0.95rem;
        line-height: 1.4;
        margin-bottom: 0.25rem;
    }

    .insight-metric {
        font-size: 0.85rem;
        color: var(--text-secondary);
        font-weight: 600;
    }

    .trends-table {
        background: var(--card-bg);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 2px solid var(--border-color);
    }

    .table-header {
        background: var(--bg-secondary);
        padding: 1rem 1.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .table-title {
        font-size: 1.2rem;
        font-weight: 600;
    }

    .table-container {
        overflow-x: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }

    th {
        background: var(--bg-secondary);
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        color: var(--text-primary);
    }

    .trend-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .trend-up {
        color: #059669;
    }

    .trend-down {
        color: #dc2626;
    }

    .trend-stable {
        color: var(--text-secondary);
    }

    .performance-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
    }

    .performance-excellent {
        background: #dcfce7;
        color: #166534;
    }

    .performance-good {
        background: #dbeafe;
        color: #1e40af;
    }

    .performance-average {
        background: #fef3c7;
        color: #92400e;
    }

    .performance-poor {
        background: #fee2e2;
        color: #991b1b;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .analytics-dashboard {
            padding: 1rem;
        }
        
        .analytics-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        }
        
        .chart-container {
            height: 250px;
        }
        
        .insight-item {
            flex-direction: column;
            text-align: center;
        }
    }

    /* Dark mode chart adjustments */
    @media (prefers-color-scheme: dark) {
        .chart-card {
            background: #1a1a1a;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <div class="analytics-header">
        <div>
            <h1 class="analytics-title">Scheduler Analytics</h1>
            <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                Comprehensive insights into maintenance scheduling performance
            </p>
        </div>
        
        <div class="analytics-controls">
            <div class="date-filter">
                <label>From:</label>
                <input type="date" id="startDate" class="date-input">
                <label>To:</label>
                <input type="date" id="endDate" class="date-input">
            </div>
            <button class="export-btn" onclick="exportReport()">
                üìä Export Report
            </button>
        </div>
    </div>

    <!-- KPI Overview -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Schedule Efficiency</div>
                <div class="kpi-icon">‚ö°</div>
            </div>
            <div class="kpi-value" id="scheduleEfficiency">94.2%</div>
            <div class="kpi-change positive">
                <span>‚Üó</span> +2.3% from last month
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Resource Utilization</div>
                <div class="kpi-icon">üë•</div>
            </div>
            <div class="kpi-value" id="resourceUtilization">87.5%</div>
            <div class="kpi-change positive">
                <span>‚Üó</span> +5.1% from last month
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Conflict Resolution</div>
                <div class="kpi-icon">üîß</div>
            </div>
            <div class="kpi-value" id="conflictResolution">98.7%</div>
            <div class="kpi-change positive">
                <span>‚Üó</span> +1.2% from last month
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Cost Optimization</div>
                <div class="kpi-icon">üí∞</div>
            </div>
            <div class="kpi-value" id="costSavings">$45,230</div>
            <div class="kpi-change positive">
                <span>‚Üó</span> +12.8% from last month
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">PM Compliance</div>
                <div class="kpi-icon">üìã</div>
            </div>
            <div class="kpi-value" id="pmCompliance">96.3%</div>
            <div class="kpi-change neutral">
                <span>‚Üí</span> -0.2% from last month
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Emergency Response</div>
                <div class="kpi-icon">üö®</div>
            </div>
            <div class="kpi-value" id="emergencyResponse">12 min</div>
            <div class="kpi-change positive">
                <span>‚Üò</span> -3.2 min from last month
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid">
        <!-- Schedule Performance Over Time -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Schedule Performance Trends</div>
                <div class="chart-filter">
                    <button class="filter-btn active" onclick="updatePerformanceChart('7d')">7D</button>
                    <button class="filter-btn" onclick="updatePerformanceChart('30d')">30D</button>
                    <button class="filter-btn" onclick="updatePerformanceChart('90d')">90D</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Technician Workload Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Technician Workload Distribution</div>
                <div class="chart-filter">
                    <button class="filter-btn active" onclick="updateWorkloadChart('current')">Current</button>
                    <button class="filter-btn" onclick="updateWorkloadChart('projected')">Projected</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="workloadChart"></canvas>
            </div>
        </div>

        <!-- Priority Distribution -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Work Order Priority Distribution</div>
            </div>
            <div class="chart-container">
                <canvas id="priorityChart"></canvas>
            </div>
        </div>

        <!-- Asset Type Breakdown -->
        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Maintenance by Asset Type</div>
            </div>
            <div class="chart-container">
                <canvas id="assetChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Comprehensive Performance Chart -->
    <div class="chart-card">
        <div class="chart-header">
            <div class="chart-title">Comprehensive Performance Metrics</div>
            <div class="chart-filter">
                <button class="filter-btn active" onclick="updateComprehensiveChart('efficiency')">Efficiency</button>
                <button class="filter-btn" onclick="updateComprehensiveChart('cost')">Cost</button>
                <button class="filter-btn" onclick="updateComprehensiveChart('compliance')">Compliance</button>
            </div>
        </div>
        <div class="chart-container large">
            <canvas id="comprehensiveChart"></canvas>
        </div>
    </div>

    <!-- AI Insights -->
    <div class="insights-section">
        <div class="insights-title">
            ü§ñ AI-Generated Insights & Recommendations
        </div>
        
        <div class="insight-item">
            <div class="insight-icon">üìä</div>
            <div class="insight-content">
                <div class="insight-text">
                    Scheduling efficiency has improved by 12% since implementing AI-driven optimization. 
                    The system successfully reduced conflicts by 85% and improved resource utilization.
                </div>
                <div class="insight-metric">Impact: High | Confidence: 94%</div>
            </div>
        </div>

        <div class="insight-item">
            <div class="insight-icon">üë•</div>
            <div class="insight-content">
                <div class="insight-text">
                    Technicians with hydraulics certification are overutilized (110% capacity). 
                    Consider cross-training 2-3 technicians to balance workload.
                </div>
                <div class="insight-metric">Recommended Action: Training Program | ROI: $23,000/year</div>
            </div>
        </div>

        <div class="insight-item">
            <div class="insight-icon">üîß</div>
            <div class="insight-content">
                <div class="insight-text">
                    PM automation has prevented an estimated 18 emergency breakdowns this month, 
                    saving approximately $156,000 in unplanned downtime costs.
                </div>
                <div class="insight-metric">Cost Avoidance: $156,000 | Emergency Reduction: 67%</div>
            </div>
        </div>

        <div class="insight-item">
            <div class="insight-icon">‚è∞</div>
            <div class="insight-content">
                <div class="insight-text">
                    Peak scheduling conflicts occur between 10 AM - 12 PM. Consider staggering 
                    non-critical maintenance to off-peak hours for 15% efficiency gain.
                </div>
                <div class="insight-metric">Optimization Opportunity: 15% efficiency gain | Implementation: 2 weeks</div>
            </div>
        </div>

        <div class="insight-item">
            <div class="insight-icon">üåü</div>
            <div class="insight-content">
                <div class="insight-text">
                    Building A shows 23% faster task completion compared to other facilities. 
                    Best practices include improved tool accessibility and pre-positioned parts.
                </div>
                <div class="insight-metric">Best Practice Candidate: Building A Layout | Rollout Potential: All Facilities</div>
            </div>
        </div>
    </div>

    <!-- Performance Trends Table -->
    <div class="trends-table">
        <div class="table-header">
            <div class="table-title">Technician Performance Trends</div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Technician</th>
                        <th>Efficiency</th>
                        <th>Tasks Completed</th>
                        <th>Avg. Duration</th>
                        <th>Quality Score</th>
                        <th>Trend</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody id="performanceTable">
                    <!-- Table rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
let charts = {};
let analyticsData = {};

document.addEventListener('DOMContentLoaded', async () => {
    // Set default date range (last 30 days)
    const endDate = new Date();
    const startDate = new Date(endDate.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('startDate').valueAsDate = startDate;
    document.getElementById('endDate').valueAsDate = endDate;

    // Load analytics data
    await loadAnalyticsData();
    
    // Initialize all charts
    initializeCharts();
    
    // Update performance table
    updatePerformanceTable();
    
    // Setup event listeners
    document.getElementById('startDate').addEventListener('change', refreshAnalytics);
    document.getElementById('endDate').addEventListener('change', refreshAnalytics);
});

async function loadAnalyticsData() {
    try {
        // In a real implementation, this would fetch from multiple endpoints
        analyticsData = {
            performance: generatePerformanceData(),
            workload: generateWorkloadData(),
            priorities: generatePriorityData(),
            assets: generateAssetData(),
            technicians: generateTechnicianData(),
            trends: generateTrendData()
        };
    } catch (error) {
        console.error('Error loading analytics data:', error);
        // Use mock data as fallback
        analyticsData = generateMockAnalyticsData();
    }
}

function generateMockAnalyticsData() {
    return {
        performance: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            efficiency: [92, 94, 93, 96],
            completion: [88, 91, 89, 93],
            quality: [95, 96, 94, 97]
        },
        workload: {
            labels: ['John M.', 'Sarah C.', 'Mike J.', 'Lisa R.', 'David K.', 'Emma W.'],
            current: [85, 92, 78, 88, 95, 82],
            capacity: [100, 100, 100, 100, 100, 100]
        },
        priorities: {
            labels: ['Emergency', 'Urgent', 'High', 'Medium', 'Low'],
            counts: [12, 34, 67, 145, 89],
            colors: ['#dc2626', '#ea580c', '#d97706', '#059669', '#0284c7']
        },
        assets: {
            labels: ['Hydraulic Press', 'CNC Machine', 'Conveyor', 'Motor Drive', 'HVAC', 'Other'],
            maintenance: [45, 38, 32, 28, 22, 18],
            colors: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#6b7280']
        },
        technicians: [
            { name: 'John Martinez', efficiency: 96, tasks: 142, avgDuration: 3.2, quality: 4.8, trend: 'up', performance: 'excellent' },
            { name: 'Sarah Chen', efficiency: 94, tasks: 138, avgDuration: 3.4, quality: 4.7, trend: 'up', performance: 'excellent' },
            { name: 'Mike Johnson', efficiency: 92, tasks: 134, avgDuration: 3.6, quality: 4.6, trend: 'stable', performance: 'good' },
            { name: 'Lisa Rodriguez', efficiency: 89, tasks: 128, avgDuration: 3.8, quality: 4.5, trend: 'up', performance: 'good' },
            { name: 'David Kim', efficiency: 87, tasks: 125, avgDuration: 4.1, quality: 4.4, trend: 'down', performance: 'average' },
            { name: 'Emma Wilson', efficiency: 85, tasks: 121, avgDuration: 4.3, quality: 4.3, trend: 'stable', performance: 'average' }
        ]
    };
}

function generatePerformanceData() {
    const labels = [];
    const efficiency = [];
    const completion = [];
    const quality = [];
    
    // Generate 30 days of data
    for (let i = 29; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        
        // Simulate realistic performance data with some variation
        efficiency.push(85 + Math.random() * 15 + Math.sin(i / 7) * 5); // Weekly cycles
        completion.push(80 + Math.random() * 20 + Math.cos(i / 7) * 3);
        quality.push(90 + Math.random() * 10);
    }
    
    return { labels, efficiency, completion, quality };
}

function generateWorkloadData() {
    const technicians = [
        'John M.', 'Sarah C.', 'Mike J.', 'Lisa R.', 'David K.', 
        'Emma W.', 'Carlos L.', 'Jennifer B.', 'Robert D.', 'Angela T.'
    ];
    
    return {
        labels: technicians,
        current: technicians.map(() => 60 + Math.random() * 40),
        capacity: technicians.map(() => 100)
    };
}

function generatePriorityData() {
    return {
        labels: ['Emergency', 'Urgent', 'High', 'Medium', 'Low'],
        counts: [
            Math.floor(Math.random() * 20) + 5,    // Emergency: 5-25
            Math.floor(Math.random() * 50) + 20,   // Urgent: 20-70
            Math.floor(Math.random() * 80) + 40,   // High: 40-120
            Math.floor(Math.random() * 120) + 80,  // Medium: 80-200
            Math.floor(Math.random() * 100) + 50   // Low: 50-150
        ],
        colors: ['#dc2626', '#ea580c', '#d97706', '#059669', '#0284c7']
    };
}

function generateAssetData() {
    return {
        labels: ['Hydraulic Equipment', 'CNC Machines', 'Conveyor Systems', 'Motor Drives', 'HVAC Systems', 'Other Equipment'],
        maintenance: [
            Math.floor(Math.random() * 30) + 30,   // 30-60
            Math.floor(Math.random() * 25) + 25,   // 25-50
            Math.floor(Math.random() * 20) + 20,   // 20-40
            Math.floor(Math.random() * 15) + 15,   // 15-30
            Math.floor(Math.random() * 10) + 10,   // 10-20
            Math.floor(Math.random() * 15) + 5     // 5-20
        ],
        colors: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444', '#6b7280']
    };
}

function generateTechnicianData() {
    const names = [
        'John Martinez', 'Sarah Chen', 'Mike Johnson', 'Lisa Rodriguez', 
        'David Kim', 'Emma Wilson', 'Carlos Lopez', 'Jennifer Brown',
        'Robert Davis', 'Angela Thompson'
    ];
    
    return names.map(name => ({
        name,
        efficiency: Math.floor(Math.random() * 20) + 80,    // 80-100%
        tasks: Math.floor(Math.random() * 50) + 100,        // 100-150 tasks
        avgDuration: 2.5 + Math.random() * 3,               // 2.5-5.5 hours
        quality: 4.0 + Math.random() * 1,                   // 4.0-5.0 stars
        trend: ['up', 'down', 'stable'][Math.floor(Math.random() * 3)],
        performance: ['excellent', 'good', 'average', 'poor'][Math.floor(Math.random() * 4)]
    }));
}

function generateTrendData() {
    // Generate weekly trend data for the last 12 weeks
    const weeks = [];
    const efficiency = [];
    const cost = [];
    const compliance = [];
    
    for (let i = 11; i >= 0; i--) {
        weeks.push(`Week ${12 - i}`);
        efficiency.push(85 + Math.random() * 15);
        cost.push(15000 + Math.random() * 10000);
        compliance.push(90 + Math.random() * 10);
    }
    
    return { weeks, efficiency, cost, compliance };
}

function initializeCharts() {
    // Performance Trends Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    charts.performance = new Chart(performanceCtx, {
        type: 'line',
        data: {
            labels: analyticsData.performance.labels,
            datasets: [{
                label: 'Efficiency %',
                data: analyticsData.performance.efficiency,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
            }, {
                label: 'Completion %',
                data: analyticsData.performance.completion,
                borderColor: '#f093fb',
                backgroundColor: 'rgba(240, 147, 251, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });

    // Workload Distribution Chart
    const workloadCtx = document.getElementById('workloadChart').getContext('2d');
    charts.workload = new Chart(workloadCtx, {
        type: 'bar',
        data: {
            labels: analyticsData.workload.labels,
            datasets: [{
                label: 'Current Workload %',
                data: analyticsData.workload.current,
                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                borderColor: '#667eea',
                borderWidth: 2
            }, {
                label: 'Capacity %',
                data: analyticsData.workload.capacity,
                backgroundColor: 'rgba(156, 163, 175, 0.3)',
                borderColor: '#9ca3af',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 120
                }
            }
        }
    });

    // Priority Distribution Chart
    const priorityCtx = document.getElementById('priorityChart').getContext('2d');
    charts.priority = new Chart(priorityCtx, {
        type: 'doughnut',
        data: {
            labels: analyticsData.priorities.labels,
            datasets: [{
                data: analyticsData.priorities.counts,
                backgroundColor: analyticsData.priorities.colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Asset Type Chart
    const assetCtx = document.getElementById('assetChart').getContext('2d');
    charts.asset = new Chart(assetCtx, {
        type: 'bar',
        data: {
            labels: analyticsData.assets.labels,
            datasets: [{
                label: 'Maintenance Tasks',
                data: analyticsData.assets.maintenance,
                backgroundColor: analyticsData.assets.colors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Comprehensive Performance Chart
    const comprehensiveCtx = document.getElementById('comprehensiveChart').getContext('2d');
    const trendData = generateTrendData();
    charts.comprehensive = new Chart(comprehensiveCtx, {
        type: 'line',
        data: {
            labels: trendData.weeks,
            datasets: [{
                label: 'Efficiency %',
                data: trendData.efficiency,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'Cost ($)',
                data: trendData.cost,
                borderColor: '#f59e0b',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }, {
                label: 'Compliance %',
                data: trendData.compliance,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Time Period'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Percentage (%)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Cost ($)'
                    },
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });
}

function updatePerformanceTable() {
    const tableBody = document.getElementById('performanceTable');
    tableBody.innerHTML = '';
    
    analyticsData.technicians.forEach(tech => {
        const row = document.createElement('tr');
        
        const trendIcon = tech.trend === 'up' ? '‚Üó' : tech.trend === 'down' ? '‚Üò' : '‚Üí';
        const trendClass = tech.trend === 'up' ? 'trend-up' : tech.trend === 'down' ? 'trend-down' : 'trend-stable';
        
        row.innerHTML = `
            <td>${tech.name}</td>
            <td>${tech.efficiency}%</td>
            <td>${tech.tasks}</td>
            <td>${tech.avgDuration.toFixed(1)}h</td>
            <td>${tech.quality.toFixed(1)}/5.0</td>
            <td><span class="trend-indicator ${trendClass}">${trendIcon} ${tech.trend}</span></td>
            <td><span class="performance-badge performance-${tech.performance}">${tech.performance}</span></td>
        `;
        
        tableBody.appendChild(row);
    });
}

function updatePerformanceChart(period) {
    // Update active filter button
    document.querySelectorAll('.chart-filter .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Generate new data based on period
    let newData;
    switch (period) {
        case '7d':
            newData = generatePerformanceData();
            newData.labels = newData.labels.slice(-7);
            newData.efficiency = newData.efficiency.slice(-7);
            newData.completion = newData.completion.slice(-7);
            break;
        case '30d':
            newData = generatePerformanceData();
            break;
        case '90d':
            newData = generatePerformanceData();
            // Extend to 90 days
            for (let i = 30; i < 90; i++) {
                newData.labels.push(`Day ${i + 1}`);
                newData.efficiency.push(85 + Math.random() * 15);
                newData.completion.push(80 + Math.random() * 20);
            }
            break;
    }
    
    charts.performance.data.labels = newData.labels;
    charts.performance.data.datasets[0].data = newData.efficiency;
    charts.performance.data.datasets[1].data = newData.completion;
    charts.performance.update();
}

function updateWorkloadChart(view) {
    // Update active filter button
    document.querySelectorAll('.chart-filter .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    if (view === 'projected') {
        // Show projected workload for next week
        const projectedData = analyticsData.workload.current.map(current => 
            Math.min(current + (Math.random() - 0.5) * 20, 100)
        );
        charts.workload.data.datasets[0].data = projectedData;
        charts.workload.data.datasets[0].label = 'Projected Workload %';
    } else {
        // Show current workload
        charts.workload.data.datasets[0].data = analyticsData.workload.current;
        charts.workload.data.datasets[0].label = 'Current Workload %';
    }
    
    charts.workload.update();
}

function updateComprehensiveChart(metric) {
    // Update active filter button
    document.querySelectorAll('.chart-filter .filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Update chart data based on selected metric
    const trendData = generateTrendData();
    
    switch (metric) {
        case 'efficiency':
            charts.comprehensive.data.datasets[0].hidden = false;
            charts.comprehensive.data.datasets[1].hidden = true;
            charts.comprehensive.data.datasets[2].hidden = false;
            break;
        case 'cost':
            charts.comprehensive.data.datasets[0].hidden = true;
            charts.comprehensive.data.datasets[1].hidden = false;
            charts.comprehensive.data.datasets[2].hidden = true;
            break;
        case 'compliance':
            charts.comprehensive.data.datasets[0].hidden = false;
            charts.comprehensive.data.datasets[1].hidden = true;
            charts.comprehensive.data.datasets[2].hidden = false;
            break;
    }
    
    charts.comprehensive.update();
}

async function refreshAnalytics() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) return;
    
    // Show loading state
    document.querySelectorAll('.kpi-value').forEach(el => el.textContent = '...');
    
    // Reload data with new date range
    await loadAnalyticsData();
    
    // Update all charts
    Object.values(charts).forEach(chart => {
        chart.update();
    });
    
    // Update performance table
    updatePerformanceTable();
    
    // Update KPIs
    updateKPIs();
}

function updateKPIs() {
    // Simulate dynamic KPI updates
    document.getElementById('scheduleEfficiency').textContent = (90 + Math.random() * 10).toFixed(1) + '%';
    document.getElementById('resourceUtilization').textContent = (80 + Math.random() * 15).toFixed(1) + '%';
    document.getElementById('conflictResolution').textContent = (95 + Math.random() * 5).toFixed(1) + '%';
    document.getElementById('costSavings').textContent = '$' + (30000 + Math.random() * 20000).toFixed(0);
    document.getElementById('pmCompliance').textContent = (92 + Math.random() * 8).toFixed(1) + '%';
    document.getElementById('emergencyResponse').textContent = (8 + Math.random() * 8).toFixed(0) + ' min';
}

function exportReport() {
    // Simulate report generation
    const reportData = {
        dateRange: {
            start: document.getElementById('startDate').value,
            end: document.getElementById('endDate').value
        },
        kpis: {
            scheduleEfficiency: document.getElementById('scheduleEfficiency').textContent,
            resourceUtilization: document.getElementById('resourceUtilization').textContent,
            conflictResolution: document.getElementById('conflictResolution').textContent,
            costSavings: document.getElementById('costSavings').textContent,
            pmCompliance: document.getElementById('pmCompliance').textContent,
            emergencyResponse: document.getElementById('emergencyResponse').textContent
        },
        analyticsData: analyticsData,
        generatedAt: new Date().toISOString()
    };
    
    // Create and download JSON report
    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scheduler_analytics_report_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    // Show confirmation
    alert('Analytics report exported successfully!');
}

// Initialize with mock data on load
document.addEventListener('DOMContentLoaded', () => {
    // Generate and display initial analytics data
    analyticsData = generateMockAnalyticsData();
});
</script>
{% endblock %}