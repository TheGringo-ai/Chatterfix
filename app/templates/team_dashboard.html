{% extends "base.html" %}

{% block title %}Team Dashboard - ChatterFix{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">ü§ù Team Dashboard</h1>
            <p class="text-muted">Real-time collaboration and communication</p>
        </div>
    </div>

    <div class="row">
        <!-- Team Members -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 cmms-card p-0 overflow-hidden">
                <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üë• Team Members</h5>
                    <button class="btn btn-sm btn-success" onclick="openAddUserModal()">
                        <i class="fas fa-user-plus"></i> Add
                    </button>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% for user in users %}
                    {% if user %}
                    <div class="d-flex align-items-center mb-3 p-2 border-bottom">
                        <div class="position-relative">
                            {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" class="rounded-circle" width="40" height="40">
                            {% else %}
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                {{ (user.full_name[0] if user.full_name else user.username[0]) if user else 'U' }}
                            </div>
                            {% endif %}
                            <span class="position-absolute bottom-0 end-0 status-indicator 
                                         {% if user and user.id in online_users %}bg-success{% else %}bg-secondary{% endif %}"
                                style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;">
                            </span>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <a href="/team/users/{{ user.id if user else '#' }}" class="text-decoration-none">
                                <strong>{{ (user.full_name or user.username) if user else 'Unknown User' }}</strong>
                            </a>
                            <br>
                            <small class="text-muted">{{ user.role if user else 'No Role' }}</small>
                            {% if user and user.active_work_orders > 0 %}
                            <span class="badge bg-warning ms-2">{{ user.active_work_orders }} WO</span>
                            {% endif %}
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" title="Edit"
                                onclick="openEditUserModal('{{ user.id if user else 0 }}', '{{ (user.full_name or user.username) if user else 'Unknown' }}', '{{ user.role if user else '' }}', '{{ user.username if user else '' }}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-primary" title="Message"
                                onclick="openChat({{ user.id if user else 0 }}, '{{ (user.full_name or user.username) if user else 'Unknown' }}')">
                                üí¨
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Message Feed -->
        <div class="col-md-8 mb-4">
            <div class="card h-100 cmms-card p-0 overflow-hidden">
                <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üí¨ Team Messages</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleChatView()">
                        <span id="chat-view-icon">üìã</span> <span id="chat-view-text">List View</span>
                    </button>
                </div>
                <div class="card-body" id="message-container" style="max-height: 500px; overflow-y: auto;">
                    <div id="message-list">
                        {% for msg in messages %}
                        <div class="message-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between">
                                <strong>{{ msg.sender_name }}</strong>
                                {% if msg.recipient_name %}
                                <small class="text-muted">‚Üí {{ msg.recipient_name }}</small>
                                {% else %}
                                <small class="text-muted">‚Üí Everyone</small>
                                {% endif %}
                            </div>
                            <p class="mb-1">{{ msg.message }}</p>
                            <small class="text-muted">{{ msg.created_date }}</small>
                            {% if msg.priority == 'urgent' %}
                            <span class="badge bg-danger ms-2">URGENT</span>
                            {% elif msg.priority == 'high' %}
                            <span class="badge bg-warning">HIGH</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <form id="send-message-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control" placeholder="Type a message..."
                            required>
                        <select id="recipient-select" class="form-select" style="max-width: 200px;">
                            <option value="">Everyone</option>
                            {% for user in users %}
                            {% if user %}
                            <option value="{{ user.id }}">{{ user.full_name or user.username or 'Unknown User' }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card cmms-card p-0 overflow-hidden bg-transparent">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">üîß Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="requestParts()">
                            üì¶ Request Parts
                        </button>
                        <button class="btn btn-outline-success" onclick="reportIssue()">
                            ‚ö†Ô∏è Report Immediate Failure
                        </button>
                        <a href="/training" class="btn btn-outline-info">
                            üéì View Training
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card cmms-card p-0 overflow-hidden bg-transparent">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">üîî Recent Notifications</h5>
                </div>
                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                    <div id="notifications-list">
                        <p class="text-muted">Loading notifications...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firestore-based Messaging -->
<script>
    const currentUserId = "{{ user.id if user else 'demo_user_1' }}";
    let pollInterval = null;

    // Load messages on page load
    async function loadMessages() {
        try {
            const response = await fetch('/team/messages/recent?limit=50', {
                credentials: 'include'
            });
            const data = await response.json();

            if (data.success && data.messages) {
                renderMessages(data.messages);
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function renderMessages(messages) {
        const messageList = document.getElementById('message-list');
        if (!messages || messages.length === 0) {
            messageList.innerHTML = '<p class="text-muted text-center">No messages yet. Start the conversation!</p>';
            return;
        }

        messageList.innerHTML = messages.map(msg => `
            <div class="message-item mb-3 p-3 border rounded" data-id="${msg.id || ''}">
                <div class="d-flex justify-content-between">
                    <strong>${msg.sender_name || 'Unknown'}</strong>
                    ${msg.recipient_name
                        ? `<small class="text-muted">‚Üí ${msg.recipient_name}</small>`
                        : '<small class="text-muted">‚Üí Everyone</small>'
                    }
                </div>
                <p class="mb-1">${msg.message || ''}</p>
                <small class="text-muted">${formatDate(msg.created_at)}</small>
                ${msg.priority === 'urgent' ? '<span class="badge bg-danger ms-2">URGENT</span>' : ''}
                ${msg.priority === 'high' ? '<span class="badge bg-warning ms-2">HIGH</span>' : ''}
            </div>
        `).join('');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        return date.toLocaleString();
    }

    function addMessageToFeed(msg) {
        const messageList = document.getElementById('message-list');
        // Remove "no messages" placeholder if present
        const placeholder = messageList.querySelector('.text-muted.text-center');
        if (placeholder) placeholder.remove();

        const msgDiv = document.createElement('div');
        msgDiv.className = 'message-item mb-3 p-3 border rounded';
        msgDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>${msg.sender_name || 'You'}</strong>
                <small class="text-muted">${new Date().toLocaleTimeString()}</small>
            </div>
            <p class="mb-0">${msg.message}</p>
        `;
        messageList.insertBefore(msgDiv, messageList.firstChild);
    }

    // Send message via API
    document.getElementById('send-message-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const messageInput = document.getElementById('message-input');
        const message = messageInput.value.trim();
        const recipientId = document.getElementById('recipient-select').value;

        if (!message) return;

        try {
            const response = await fetch('/team/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    message: message,
                    recipient_id: recipientId || null,
                    priority: 'normal'
                })
            });

            const data = await response.json();

            if (data.success) {
                // Add message to feed immediately
                addMessageToFeed({
                    message: message,
                    sender_name: 'You',
                    recipient_id: recipientId
                });
                messageInput.value = '';
            } else {
                alert('Failed to send message: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        }
    });

    // Load notifications
    async function loadNotifications() {
        const notifList = document.getElementById('notifications-list');
        notifList.innerHTML = '<p class="text-muted">No new notifications</p>';
    }

    // Request browser notification permission
    if (Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Initialize on page load
    loadMessages();
    loadNotifications();

    // Poll for new messages every 10 seconds
    pollInterval = setInterval(loadMessages, 10000);

    // Helper functions
    function openChat(userId, userName) {
        document.getElementById('recipient-select').value = userId;
        document.getElementById('message-input').focus();
    }

    function requestParts() {
        window.location.href = '/inventory';
    }

    function reportIssue() {
        window.location.href = '/work-orders';
    }

    function toggleChatView() {
        // Toggle between list and chat view
        const container = document.getElementById('message-container');
        container.classList.toggle('chat-view');
    }
</script>

<style>
    .status-indicator {
        display: inline-block;
    }

    .message-item {
        transition: background-color 0.3s;
        background: var(--bg-glass);
        color: var(--text-primary);
    }

    .message-item:hover {
        background-color: var(--bg-glass-hover);
    }
    
    /* Ensure cards inherit glass styles */
    .card-header h5 {
        color: var(--text-primary);
    }
</style>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="addUserModalLabel"><i class="fas fa-user-plus"></i> Add Team Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm" onsubmit="submitAddUser(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newUserEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control bg-secondary text-light border-secondary" id="newUserEmail" required placeholder="team.member@company.com">
                    </div>
                    <div class="mb-3">
                        <label for="newUserName" class="form-label">Full Name</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserName" required placeholder="John Smith">
                    </div>
                    <div class="mb-3">
                        <label for="newUserRole" class="form-label">Role</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="newUserRole" required>
                            <option value="">Select Role...</option>
                            <option value="technician">Technician</option>
                            <option value="senior_technician">Senior Technician</option>
                            <option value="manager">Manager</option>
                            <option value="planner">Planner</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="newUserDepartment" class="form-label">Department</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserDepartment" placeholder="Maintenance">
                    </div>
                    {% if is_demo %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Demo Mode:</strong> In the full version, an invitation email will be sent to the new team member.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-paper-plane"></i> Send Invite</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="editUserModalLabel"><i class="fas fa-user-edit"></i> Edit Team Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" onsubmit="submitEditUser(event)">
                <input type="hidden" id="editUserId">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editUserEmail" class="form-label">Email Address</label>
                        <input type="email" class="form-control bg-secondary text-light border-secondary" id="editUserEmail" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editUserName" class="form-label">Full Name</label>
                        <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editUserRole" class="form-label">Role</label>
                        <select class="form-select bg-secondary text-light border-secondary" id="editUserRole" required>
                            <option value="technician">Technician</option>
                            <option value="senior_technician">Senior Technician</option>
                            <option value="manager">Manager</option>
                            <option value="planner">Planner</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    {% if is_demo %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Demo Mode:</strong> Changes will not be saved. Sign up for a free account to manage your team.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-danger me-auto" onclick="confirmDeleteUser()">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // User Management Functions
    function openAddUserModal() {
        document.getElementById('addUserForm').reset();
        const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }

    function openEditUserModal(userId, fullName, role, email) {
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUserEmail').value = email;
        document.getElementById('editUserName').value = fullName;
        document.getElementById('editUserRole').value = role.toLowerCase().replace(' ', '_');
        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
    }

    async function submitAddUser(event) {
        event.preventDefault();

        const userData = {
            email: document.getElementById('newUserEmail').value,
            full_name: document.getElementById('newUserName').value,
            role: document.getElementById('newUserRole').value,
            department: document.getElementById('newUserDepartment').value
        };

        {% if is_demo %}
        // Demo mode - show success message
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        showNotification('success', 'Invitation Sent!', `Demo: ${userData.full_name} would receive an invitation email at ${userData.email}`);
        return;
        {% endif %}

        try {
            const response = await fetch('/org/invite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
                showNotification('success', 'Invitation Sent!', `${userData.full_name} will receive an email invitation.`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', 'Error', data.message || 'Failed to send invitation');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Failed to send invitation. Please try again.');
        }
    }

    async function submitEditUser(event) {
        event.preventDefault();

        const userId = document.getElementById('editUserId').value;
        const userData = {
            full_name: document.getElementById('editUserName').value,
            role: document.getElementById('editUserRole').value
        };

        {% if is_demo %}
        // Demo mode - show success message
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        showNotification('success', 'Changes Saved!', `Demo: ${userData.full_name}'s profile would be updated.`);
        return;
        {% endif %}

        try {
            const response = await fetch(`/org/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(userData)
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                showNotification('success', 'User Updated!', 'Changes have been saved.');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', 'Error', data.message || 'Failed to update user');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Failed to update user. Please try again.');
        }
    }

    function confirmDeleteUser() {
        const userId = document.getElementById('editUserId').value;
        const userName = document.getElementById('editUserName').value;

        {% if is_demo %}
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        showNotification('info', 'Demo Mode', `${userName} would be removed from the team.`);
        return;
        {% endif %}

        if (confirm(`Are you sure you want to remove ${userName} from the team?`)) {
            deleteUser(userId);
        }
    }

    async function deleteUser(userId) {
        try {
            const response = await fetch(`/org/users/${userId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await response.json();

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                showNotification('success', 'User Removed', 'Team member has been removed.');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', 'Error', data.message || 'Failed to remove user');
            }
        } catch (error) {
            showNotification('error', 'Error', 'Failed to remove user. Please try again.');
        }
    }

    // Notification helper
    function showNotification(type, title, message) {
        const colors = {
            success: 'rgba(39, 174, 96, 0.95)',
            error: 'rgba(231, 76, 60, 0.95)',
            info: 'rgba(52, 152, 219, 0.95)'
        };
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            info: 'info-circle'
        };

        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; padding: 20px 25px;
            border-radius: 10px; background: ${colors[type]}; color: white;
            z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease; max-width: 350px;
        `;
        notification.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 5px;">
                <i class="fas fa-${icons[type]}"></i> ${title}
            </div>
            <div style="font-size: 14px; opacity: 0.9;">${message}</div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}