{% extends "base.html" %}

{% block title %}Team Dashboard - ChatterFix{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">ü§ù Team Dashboard</h1>
            <p class="text-muted">Real-time collaboration and communication</p>
        </div>
    </div>

    <div class="row">
        <!-- Team Members -->
        <div class="col-md-4 mb-4">
            <div class="card h-100 cmms-card p-0 overflow-hidden">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">üë• Team Members</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    {% for user in users %}
                    <div class="d-flex align-items-center mb-3 p-2 border-bottom">
                        <div class="position-relative">
                            {% if user.avatar_url %}
                            <img src="{{ user.avatar_url }}" class="rounded-circle" width="40" height="40">
                            {% else %}
                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                style="width: 40px; height: 40px;">
                                {{ user.full_name[0] if user.full_name else user.username[0] }}
                            </div>
                            {% endif %}
                            <span class="position-absolute bottom-0 end-0 status-indicator 
                                         {% if user.id in online_users %}bg-success{% else %}bg-secondary{% endif %}"
                                style="width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;">
                            </span>
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <a href="/team/users/{{ user.id }}" class="text-decoration-none">
                                <strong>{{ user.full_name or user.username }}</strong>
                            </a>
                            <br>
                            <small class="text-muted">{{ user.role }}</small>
                            {% if user.active_work_orders > 0 %}
                            <span class="badge bg-warning ms-2">{{ user.active_work_orders }} WO</span>
                            {% endif %}
                        </div>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="openChat({{ user.id }}, '{{ user.full_name or user.username }}')">
                            üí¨
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Message Feed -->
        <div class="col-md-8 mb-4">
            <div class="card h-100 cmms-card p-0 overflow-hidden">
                <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üí¨ Team Messages</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="toggleChatView()">
                        <span id="chat-view-icon">üìã</span> <span id="chat-view-text">List View</span>
                    </button>
                </div>
                <div class="card-body" id="message-container" style="max-height: 500px; overflow-y: auto;">
                    <div id="message-list">
                        {% for msg in messages %}
                        <div class="message-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between">
                                <strong>{{ msg.sender_name }}</strong>
                                {% if msg.recipient_name %}
                                <small class="text-muted">‚Üí {{ msg.recipient_name }}</small>
                                {% else %}
                                <small class="text-muted">‚Üí Everyone</small>
                                {% endif %}
                            </div>
                            <p class="mb-1">{{ msg.message }}</p>
                            <small class="text-muted">{{ msg.created_date }}</small>
                            {% if msg.priority == 'urgent' %}
                            <span class="badge bg-danger ms-2">URGENT</span>
                            {% elif msg.priority == 'high' %}
                            <span class="badge bg-warning">HIGH</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer">
                    <form id="send-message-form" class="d-flex gap-2">
                        <input type="text" id="message-input" class="form-control" placeholder="Type a message..."
                            required>
                        <select id="recipient-select" class="form-select" style="max-width: 200px;">
                            <option value="">Everyone</option>
                            {% for user in users %}
                            <option value="{{ user.id }}">{{ user.full_name or user.username }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card cmms-card p-0 overflow-hidden bg-transparent">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">üîß Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" onclick="requestParts()">
                            üì¶ Request Parts
                        </button>
                        <button class="btn btn-outline-success" onclick="reportIssue()">
                            ‚ö†Ô∏è Report Immediate Failure
                        </button>
                        <a href="/training" class="btn btn-outline-info">
                            üéì View Training
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card cmms-card p-0 overflow-hidden bg-transparent">
                <div class="card-header bg-transparent border-bottom border-secondary">
                    <h5 class="mb-0">üîî Recent Notifications</h5>
                </div>
                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                    <div id="notifications-list">
                        <p class="text-muted">Loading notifications...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- WebSocket Connection -->
<script>
    const currentUserId = "{{ user.id }}";
    let ws = null;

    function connectWebSocket() {
        // Dynamic protocol (ws or wss)
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        // Connect to dynamic host
        ws = new WebSocket(`${protocol}//${window.location.host}/team/ws/${currentUserId}`);

        ws.onopen = () => {
            console.log('WebSocket connected');
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
        };

        ws.onclose = () => {
            console.log('WebSocket disconnected, reconnecting...');
            setTimeout(connectWebSocket, 3000);
        };
    }

    function handleWebSocketMessage(data) {
        if (data.type === 'chat_message') {
            addMessageToFeed(data);
        } else if (data.type === 'notification') {
            showNotification(data);
        } else if (data.type === 'user_status') {
            updateUserStatus(data.user_id, data.status);
        }
    }

    function addMessageToFeed(msg) {
        const messageList = document.getElementById('message-list');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message-item mb-3 p-3 border rounded';
        msgDiv.innerHTML = `
            <div class="d-flex justify-content-between">
                <strong>User ${msg.sender_id}</strong>
                <small class="text-muted">${new Date(msg.timestamp).toLocaleTimeString()}</small>
            </div>
            <p class="mb-0">${msg.message}</p>
        `;
        messageList.insertBefore(msgDiv, messageList.firstChild);
    }

    function showNotification(notif) {
        // Show browser notification if permitted
        if (Notification.permission === 'granted') {
            new Notification(notif.title, {
                body: notif.message,
                icon: '/static/img/logo.png'
            });
        }

        // Add to notifications list
        const notifList = document.getElementById('notifications-list');
        const notifDiv = document.createElement('div');
        notifDiv.className = 'alert alert-info alert-dismissible fade show mb-2';
        notifDiv.innerHTML = `
            <strong>${notif.title}</strong><br>
            ${notif.message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        notifList.insertBefore(notifDiv, notifList.firstChild);
    }

    function updateUserStatus(userId, status) {
        // Update status indicator
        const indicators = document.querySelectorAll('.status-indicator');
        // Implementation depends on DOM structure
    }

    // Send message
    document.getElementById('send-message-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const message = document.getElementById('message-input').value;
        const recipientId = document.getElementById('recipient-select').value;

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: 'chat_message',
                message: message,
                recipient_id: recipientId || null,
                priority: 'normal'
            }));

            document.getElementById('message-input').value = '';
        }
    });

    // Request browser notification permission
    if (Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Connect on page load
    connectWebSocket();

    // Helper functions
    function openChat(userId, userName) {
        document.getElementById('recipient-select').value = userId;
        document.getElementById('message-input').focus();
    }

    function requestParts() {
        window.location.href = '/inventory';
    }

    function reportIssue() {
        window.location.href = '/work-orders';
    }

    function toggleChatView() {
        // Toggle between list and chat view
        alert('Chat view toggle - to be implemented');
    }
</script>

<style>
    .status-indicator {
        display: inline-block;
    }

    .message-item {
        transition: background-color 0.3s;
        background: var(--bg-glass);
        color: var(--text-primary);
    }

    .message-item:hover {
        background-color: var(--bg-glass-hover);
    }
    
    /* Ensure cards inherit glass styles */
    .card-header h5 {
        color: var(--text-primary);
    }
</style>
{% endblock %}