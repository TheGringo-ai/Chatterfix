{% extends "base.html" %}

{% block title %}Team Management - ChatterFix{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1"><i class="fas fa-users"></i> Team Management</h1>
                <p class="text-muted mb-0">Manage your maintenance team members</p>
            </div>
            <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-user-plus"></i> Add Team Member
            </button>
        </div>
    </div>

    <!-- Team Stats -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card cmms-card text-center p-3">
                <div class="display-4 text-primary">{{ users|length if users else 0 }}</div>
                <div class="text-muted">Total Members</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card cmms-card text-center p-3">
                <div class="display-4 text-success" id="stat-available">0</div>
                <div class="text-muted">Available</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card cmms-card text-center p-3">
                <div class="display-4 text-warning" id="stat-busy">0</div>
                <div class="text-muted">Busy</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card cmms-card text-center p-3">
                <div class="display-4 text-info" id="stat-oncall">0</div>
                <div class="text-muted">On Call</div>
            </div>
        </div>
    </div>

    <!-- Employee Cards Grid -->
    <div class="row" id="employeeCardsContainer">
        {% for user in users %}
        {% if user %}
        <div class="col-xl-4 col-lg-6 mb-4" id="employee-card-{{ user.id }}">
            <div class="card cmms-card h-100 employee-card">
                <!-- Card Header with Actions -->
                <div class="card-header bg-transparent border-bottom border-secondary d-flex justify-content-between align-items-start">
                    <div class="d-flex align-items-center">
                        <div class="position-relative me-3">
                            <div class="rounded-circle bg-gradient text-white d-flex align-items-center justify-content-center employee-avatar"
                                style="width: 60px; height: 60px; font-size: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                {{ user.full_name[0] if user.full_name else 'U' }}
                            </div>
                            <span class="position-absolute bottom-0 end-0 status-dot
                                {% if user.status == 'Available' %}bg-success
                                {% elif user.status == 'Busy' %}bg-warning
                                {% elif user.status == 'On Call' %}bg-info
                                {% else %}bg-secondary{% endif %}"
                                title="{{ user.status }}">
                            </span>
                        </div>
                        <div>
                            <h5 class="mb-0">{{ user.full_name }}</h5>
                            <span class="badge bg-primary">{{ user.role }}</span>
                            <span class="badge bg-secondary ms-1">{{ user.employee_id if user.employee_id else 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-primary btn-sm edit-user-btn"
                                data-bs-toggle="modal" data-bs-target="#editUserModal"
                                data-user-id="{{ user.id }}">
                            <i class="fas fa-pencil-alt"></i> Edit
                        </button>
                        <button type="button" class="btn btn-danger btn-sm delete-user-btn"
                                data-bs-toggle="modal" data-bs-target="#deleteUserModal"
                                data-user-id="{{ user.id }}"
                                data-user-name="{{ user.full_name }}">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                </div>

                <!-- Card Body -->
                <div class="card-body">
                    <!-- Contact Info -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-address-card"></i> Contact Information</h6>
                        <div class="row small">
                            <div class="col-6">
                                <i class="fas fa-envelope text-muted"></i> {{ user.username or user.contact or 'N/A' }}
                            </div>
                            <div class="col-6">
                                <i class="fas fa-phone text-muted"></i> {{ user.phone if user.phone else 'N/A' }}
                            </div>
                        </div>
                    </div>

                    <!-- Employment Details -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-briefcase"></i> Employment Details</h6>
                        <div class="row small">
                            <div class="col-6 mb-1">
                                <strong>Department:</strong> {{ user.department if user.department else 'N/A' }}
                            </div>
                            <div class="col-6 mb-1">
                                <strong>Shift:</strong> {{ user.shift if user.shift else 'N/A' }}
                            </div>
                            <div class="col-6 mb-1">
                                <strong>Start Date:</strong> {{ user.start_date if user.start_date else 'N/A' }}
                            </div>
                            <div class="col-6 mb-1">
                                <strong>Supervisor:</strong> {{ user.supervisor if user.supervisor else 'N/A' }}
                            </div>
                        </div>
                    </div>

                    <!-- Skills -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-tools"></i> Skills</h6>
                        <div class="skills-container">
                            {% if user.skills %}
                                {% for skill in user.skills %}
                                <span class="badge bg-info text-dark me-1 mb-1">{{ skill }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted small">No skills listed</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Certifications -->
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-certificate"></i> Certifications</h6>
                        <div class="certifications-container">
                            {% if user.certifications %}
                                {% for cert in user.certifications %}
                                <span class="badge bg-success me-1 mb-1">{{ cert }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-muted small">No certifications listed</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Work Stats -->
                    <div class="mb-2">
                        <h6 class="text-muted mb-2"><i class="fas fa-chart-bar"></i> Performance</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="stat-box p-2 rounded">
                                    <div class="h4 mb-0 text-warning">{{ user.active_work_orders if user.active_work_orders else 0 }}</div>
                                    <small class="text-muted">Active WOs</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-box p-2 rounded">
                                    <div class="h4 mb-0 text-success">{{ user.completed_orders if user.completed_orders else 0 }}</div>
                                    <small class="text-muted">Completed</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="stat-box p-2 rounded">
                                    <div class="h4 mb-0 text-primary">
                                        {% if user.status == 'Available' %}
                                        <i class="fas fa-check-circle"></i>
                                        {% elif user.status == 'Busy' %}
                                        <i class="fas fa-clock"></i>
                                        {% else %}
                                        <i class="fas fa-phone"></i>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">{{ user.status }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    {% if user.notes %}
                    <div class="mt-3 pt-3 border-top border-secondary">
                        <small class="text-muted"><i class="fas fa-sticky-note"></i> <strong>Notes:</strong> {{ user.notes }}</small>
                    </div>
                    {% endif %}
                </div>

                <!-- Card Footer Actions -->
                <div class="card-footer bg-transparent border-top border-secondary">
                    <div class="row g-2">
                        <div class="col-4">
                            <button class="btn btn-outline-light btn-sm w-100" onclick="openChat('{{ user.id }}', '{{ user.full_name }}')">
                                <i class="fas fa-comment"></i> Message
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-light btn-sm w-100" onclick="viewWorkOrders('{{ user.id }}')">
                                <i class="fas fa-wrench"></i> WOs
                            </button>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-outline-light btn-sm w-100" onclick="viewTraining('{{ user.id }}')">
                                <i class="fas fa-graduation-cap"></i> Train
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>

    {% if not users or users|length == 0 %}
    <div class="row">
        <div class="col-12 text-center py-5">
            <i class="fas fa-users fa-4x text-muted mb-3"></i>
            <h3 class="text-muted">No Team Members Yet</h3>
            <p class="text-muted">Add your first team member to get started</p>
            <button class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-user-plus"></i> Add Team Member
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add Team Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="addUserForm" onsubmit="submitAddUser(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserName" required placeholder="John Smith">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control bg-secondary text-light border-secondary" id="newUserEmail" required placeholder="john.smith@company.com">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control bg-secondary text-light border-secondary" id="newUserPhone" placeholder="(555) 123-4567">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserEmployeeId" placeholder="EMP-006">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select bg-secondary text-light border-secondary" id="newUserRole" required>
                                <option value="">Select Role...</option>
                                <option value="Maintenance Technician">Maintenance Technician</option>
                                <option value="Senior Technician">Senior Technician</option>
                                <option value="Maintenance Manager">Maintenance Manager</option>
                                <option value="Maintenance Planner">Maintenance Planner</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserDepartment" placeholder="Maintenance">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Shift</label>
                            <select class="form-select bg-secondary text-light border-secondary" id="newUserShift">
                                <option value="">Select Shift...</option>
                                <option value="Day Shift (7am-3pm)">Day Shift (7am-3pm)</option>
                                <option value="Swing Shift (3pm-11pm)">Swing Shift (3pm-11pm)</option>
                                <option value="Night Shift (11pm-7am)">Night Shift (11pm-7am)</option>
                                <option value="Rotating">Rotating</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control bg-secondary text-light border-secondary" id="newUserStartDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supervisor</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserSupervisor" placeholder="Manager Name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hourly Rate</label>
                            <input type="number" step="0.01" class="form-control bg-secondary text-light border-secondary" id="newUserHourlyRate" placeholder="25.00">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Skills (comma-separated)</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserSkills" placeholder="HVAC, Electrical, Plumbing">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Certifications (comma-separated)</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="newUserCertifications" placeholder="OSHA 30, EPA 608, First Aid">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control bg-secondary text-light border-secondary" id="newUserNotes" rows="2" placeholder="Additional notes about this employee..."></textarea>
                        </div>
                    </div>
                    {% if is_demo %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Demo Mode:</strong> In the full version, this will create a real employee record and send an invitation email.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-save"></i> Add Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit Team Member</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm" onsubmit="submitEditUser(event)">
                <input type="hidden" id="editUserId">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Full Name *</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email Address *</label>
                            <input type="email" class="form-control bg-secondary text-light border-secondary" id="editUserEmail" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control bg-secondary text-light border-secondary" id="editUserPhone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Employee ID</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserEmployeeId">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role *</label>
                            <select class="form-select bg-secondary text-light border-secondary" id="editUserRole" required>
                                <option value="Maintenance Technician">Maintenance Technician</option>
                                <option value="Senior Technician">Senior Technician</option>
                                <option value="Maintenance Manager">Maintenance Manager</option>
                                <option value="Maintenance Planner">Maintenance Planner</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserDepartment">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Shift</label>
                            <select class="form-select bg-secondary text-light border-secondary" id="editUserShift">
                                <option value="">Select Shift...</option>
                                <option value="Day Shift (7am-3pm)">Day Shift (7am-3pm)</option>
                                <option value="Swing Shift (3pm-11pm)">Swing Shift (3pm-11pm)</option>
                                <option value="Night Shift (11pm-7am)">Night Shift (11pm-7am)</option>
                                <option value="Rotating">Rotating</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control bg-secondary text-light border-secondary" id="editUserStartDate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Supervisor</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserSupervisor">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hourly Rate</label>
                            <input type="number" step="0.01" class="form-control bg-secondary text-light border-secondary" id="editUserHourlyRate">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select bg-secondary text-light border-secondary" id="editUserStatus">
                                <option value="Available">Available</option>
                                <option value="Busy">Busy</option>
                                <option value="On Call">On Call</option>
                                <option value="Off Duty">Off Duty</option>
                                <option value="Vacation">Vacation</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Skills (comma-separated)</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserSkills">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Certifications (comma-separated)</label>
                            <input type="text" class="form-control bg-secondary text-light border-secondary" id="editUserCertifications">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control bg-secondary text-light border-secondary" id="editUserNotes" rows="2"></textarea>
                        </div>
                    </div>
                    {% if is_demo %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Demo Mode:</strong> Changes will be simulated. Sign up for a free account to manage your real team.
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-danger me-auto" onclick="deleteUserFromModal()">
                        <i class="fas fa-trash"></i> Delete Employee
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary bg-danger">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deleteUserName"></strong>?</p>
                <p class="text-warning"><i class="fas fa-warning"></i> This action cannot be undone. All associated data including work order history will be preserved but the user will be removed from the team.</p>
                <input type="hidden" id="deleteUserId">
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="executeDeleteUser()">
                    <i class="fas fa-trash"></i> Yes, Delete Employee
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Modal instances
    let addModal, editModal, deleteModal;

    // Store user data for editing - use tojson for proper JS escaping (handles newlines, quotes, etc)
    const usersData = {
        {% for user in users %}
        {% if user %}
        {{ user.id|tojson }}: {
            id: {{ user.id|tojson }},
            full_name: {{ user.full_name|default("", true)|tojson }},
            username: {{ user.username|default("", true)|tojson }},
            contact: {{ user.contact|default("", true)|tojson }},
            phone: {{ user.phone|default("", true)|tojson }},
            employee_id: {{ user.employee_id|default("", true)|tojson }},
            role: {{ user.role|default("", true)|tojson }},
            department: {{ user.department|default("", true)|tojson }},
            shift: {{ user.shift|default("", true)|tojson }},
            start_date: {{ user.start_date|default("", true)|tojson }},
            supervisor: {{ user.supervisor|default("", true)|tojson }},
            hourly_rate: {{ user.hourly_rate|default(0, true)|tojson }},
            status: {{ user.status|default("Available", true)|tojson }},
            skills: {{ user.skills|default([], true)|tojson }},
            certifications: {{ user.certifications|default([], true)|tojson }},
            notes: {{ user.notes|default("", true)|tojson }}
        },
        {% endif %}
        {% endfor %}
    };

    document.addEventListener('DOMContentLoaded', function() {
        // Calculate stats
        let available = 0, busy = 0, oncall = 0;
        Object.values(usersData).forEach(user => {
            if (user.status === 'Available') available++;
            else if (user.status === 'Busy') busy++;
            else if (user.status === 'On Call') oncall++;
        });
        document.getElementById('stat-available').textContent = available;
        document.getElementById('stat-busy').textContent = busy;
        document.getElementById('stat-oncall').textContent = oncall;

        // Handle Edit Modal - populate form when modal opens via data-bs-toggle
        const editModal = document.getElementById('editUserModal');
        editModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            if (!button) {
                console.warn('Edit modal opened without relatedTarget');
                return;
            }

            const userId = button.getAttribute('data-user-id');
            console.log('Edit modal: userId=', userId, 'usersData keys=', Object.keys(usersData));

            const user = usersData[userId];

            if (!user) {
                console.error('User not found in usersData:', userId);
                showNotification('error', 'Error', 'User not found. Please refresh the page.');
                return;
            }

            console.log('Populating edit form with user:', user);

            document.getElementById('editUserId').value = user.id || userId;
            document.getElementById('editUserName').value = user.full_name || '';
            document.getElementById('editUserEmail').value = user.username || user.contact || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserEmployeeId').value = user.employee_id || '';
            document.getElementById('editUserRole').value = user.role || '';
            document.getElementById('editUserDepartment').value = user.department || '';
            document.getElementById('editUserShift').value = user.shift || '';
            document.getElementById('editUserStartDate').value = user.start_date || '';
            document.getElementById('editUserSupervisor').value = user.supervisor || '';
            document.getElementById('editUserHourlyRate').value = user.hourly_rate || '';
            document.getElementById('editUserStatus').value = user.status || 'Available';
            document.getElementById('editUserSkills').value = (user.skills || []).join(', ');
            document.getElementById('editUserCertifications').value = (user.certifications || []).join(', ');
            document.getElementById('editUserNotes').value = user.notes || '';
        });

        // Handle Delete Modal - populate name when modal opens via data-bs-toggle
        const deleteModal = document.getElementById('deleteUserModal');
        deleteModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            if (!button) {
                console.warn('Delete modal opened without relatedTarget');
                return;
            }

            const userId = button.getAttribute('data-user-id');
            const userName = button.getAttribute('data-user-name') || 'this user';

            console.log('Delete modal: userId=', userId, 'userName=', userName);

            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserName').textContent = userName;
        });

        // Handle Add Modal - reset form when opened
        const addModal = document.getElementById('addUserModal');
        addModal.addEventListener('show.bs.modal', function() {
            document.getElementById('addUserForm').reset();
        });
    });

    // Explicit modal openers (onclick handlers)
    function openEditModal(userId) {
        console.log('Opening edit modal for user:', userId);
        const user = usersData[userId];
        if (!user) {
            console.error('User not found in usersData:', userId, 'Available:', Object.keys(usersData));
            showNotification('error', 'Error', 'User data not found. Please refresh the page.');
            return;
        }

        // Populate form
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editUserName').value = user.full_name || '';
        document.getElementById('editUserEmail').value = user.username || user.contact || '';
        document.getElementById('editUserPhone').value = user.phone || '';
        document.getElementById('editUserEmployeeId').value = user.employee_id || '';
        document.getElementById('editUserRole').value = user.role || '';
        document.getElementById('editUserDepartment').value = user.department || '';
        document.getElementById('editUserShift').value = user.shift || '';
        document.getElementById('editUserStartDate').value = user.start_date || '';
        document.getElementById('editUserSupervisor').value = user.supervisor || '';
        document.getElementById('editUserHourlyRate').value = user.hourly_rate || '';
        document.getElementById('editUserStatus').value = user.status || 'Available';
        document.getElementById('editUserSkills').value = (user.skills || []).join(', ');
        document.getElementById('editUserCertifications').value = (user.certifications || []).join(', ');
        document.getElementById('editUserNotes').value = user.notes || '';

        // Show modal
        const editModalEl = document.getElementById('editUserModal');
        const editModal = new bootstrap.Modal(editModalEl);
        editModal.show();
    }

    function openDeleteModal(userId, userName) {
        console.log('Opening delete modal for user:', userId, userName);
        document.getElementById('deleteUserId').value = userId;
        document.getElementById('deleteUserName').textContent = userName;

        // Show modal
        const deleteModalEl = document.getElementById('deleteUserModal');
        const deleteModal = new bootstrap.Modal(deleteModalEl);
        deleteModal.show();
    }

    // Delete from Edit Modal
    function deleteUserFromModal() {
        const userId = document.getElementById('editUserId').value;
        const userName = document.getElementById('editUserName').value;

        // Close edit modal and open delete modal
        const editModalEl = document.getElementById('editUserModal');
        const editModalInstance = bootstrap.Modal.getInstance(editModalEl);
        editModalInstance.hide();

        // Wait for edit modal to close, then open delete modal
        setTimeout(() => {
            document.getElementById('deleteUserId').value = userId;
            document.getElementById('deleteUserName').textContent = userName;
            const deleteModalEl = document.getElementById('deleteUserModal');
            const deleteModalInstance = new bootstrap.Modal(deleteModalEl);
            deleteModalInstance.show();
        }, 300);
    }

    // Execute Delete
    function executeDeleteUser() {
        const userId = document.getElementById('deleteUserId').value;
        const userName = document.getElementById('deleteUserName').textContent;
        const deleteModalEl = document.getElementById('deleteUserModal');
        const deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);

        {% if is_demo %}
        deleteModalInstance.hide();
        // Simulate deletion in demo mode
        const card = document.getElementById('employee-card-' + userId);
        if (card) {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '0';
            card.style.transform = 'scale(0.8)';
            setTimeout(() => card.remove(), 500);
        }
        showNotification('success', 'Employee Deleted', `${userName} has been removed from the team.`);
        return;
        {% endif %}

        fetch(`/organization/team/${userId}`, {
            method: 'DELETE',
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            deleteModalInstance.hide();
            if (data.success) {
                const card = document.getElementById('employee-card-' + userId);
                if (card) {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '0';
                    setTimeout(() => card.remove(), 500);
                }
                showNotification('success', 'Team Member Removed', `${userName} has been removed from the team.`);
            } else {
                showNotification('error', 'Error', data.detail || data.message || 'Failed to remove team member');
            }
        })
        .catch(error => {
            deleteModalInstance.hide();
            showNotification('error', 'Error', 'Failed to remove team member. Please try again.');
        });
    }

    // Submit Add User
    async function submitAddUser(event) {
        event.preventDefault();
        const addModalEl = document.getElementById('addUserModal');
        const addModalInstance = bootstrap.Modal.getInstance(addModalEl);

        const userData = {
            full_name: document.getElementById('newUserName').value,
            email: document.getElementById('newUserEmail').value,
            phone: document.getElementById('newUserPhone').value,
            employee_id: document.getElementById('newUserEmployeeId').value,
            role: document.getElementById('newUserRole').value,
            department: document.getElementById('newUserDepartment').value,
            shift: document.getElementById('newUserShift').value,
            start_date: document.getElementById('newUserStartDate').value,
            supervisor: document.getElementById('newUserSupervisor').value,
            hourly_rate: parseFloat(document.getElementById('newUserHourlyRate').value) || null,
            skills: document.getElementById('newUserSkills').value.split(',').map(s => s.trim()).filter(s => s),
            certifications: document.getElementById('newUserCertifications').value.split(',').map(s => s.trim()).filter(s => s),
            notes: document.getElementById('newUserNotes').value
        };

        {% if is_demo %}
        addModalInstance.hide();
        showNotification('success', 'Employee Added!', `${userData.full_name} has been added to the team. (Demo Mode)`);
        setTimeout(() => location.reload(), 1500);
        return;
        {% endif %}

        try {
            const response = await fetch('/organization/team/invite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    email: userData.email,
                    role: userData.role.toLowerCase().replace(' ', '_')
                })
            });
            const data = await response.json();
            addModalInstance.hide();
            if (data.success) {
                showNotification('success', 'Invitation Sent!', `${userData.email} will receive an invitation email.`);
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', 'Error', data.detail || data.message || 'Failed to send invitation');
            }
        } catch (error) {
            addModalInstance.hide();
            showNotification('error', 'Error', 'Failed to send invitation. Please try again.');
        }
    }

    // Submit Edit User
    async function submitEditUser(event) {
        event.preventDefault();
        const editModalEl = document.getElementById('editUserModal');
        const editModalInstance = bootstrap.Modal.getInstance(editModalEl);

        const userId = document.getElementById('editUserId').value;
        const userData = {
            full_name: document.getElementById('editUserName').value,
            email: document.getElementById('editUserEmail').value,
            phone: document.getElementById('editUserPhone').value,
            employee_id: document.getElementById('editUserEmployeeId').value,
            role: document.getElementById('editUserRole').value,
            department: document.getElementById('editUserDepartment').value,
            shift: document.getElementById('editUserShift').value,
            start_date: document.getElementById('editUserStartDate').value,
            supervisor: document.getElementById('editUserSupervisor').value,
            hourly_rate: parseFloat(document.getElementById('editUserHourlyRate').value) || null,
            status: document.getElementById('editUserStatus').value,
            skills: document.getElementById('editUserSkills').value.split(',').map(s => s.trim()).filter(s => s),
            certifications: document.getElementById('editUserCertifications').value.split(',').map(s => s.trim()).filter(s => s),
            notes: document.getElementById('editUserNotes').value
        };

        {% if is_demo %}
        editModalInstance.hide();
        showNotification('success', 'Changes Saved!', `${userData.full_name}'s profile has been updated. (Demo Mode)`);
        setTimeout(() => location.reload(), 1500);
        return;
        {% endif %}

        try {
            const response = await fetch(`/organization/team/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    full_name: userData.full_name,
                    role: userData.role,
                    phone: userData.phone,
                    department: userData.department,
                    skills: userData.skills,
                    certifications: userData.certifications,
                    status: userData.status,
                    notes: userData.notes
                })
            });
            const data = await response.json();
            editModalInstance.hide();
            if (data.success) {
                showNotification('success', 'Changes Saved!', 'Team member profile has been updated.');
                setTimeout(() => location.reload(), 1500);
            } else {
                showNotification('error', 'Error', data.detail || data.message || 'Failed to update team member');
            }
        } catch (error) {
            editModalInstance.hide();
            showNotification('error', 'Error', 'Failed to update team member. Please try again.');
        }
    }

    // Helper functions
    function openChat(userId, userName) {
        showNotification('info', 'Message', `Opening chat with ${userName}...`);
        // Could redirect to messaging or open chat modal
    }

    function viewWorkOrders(userId) {
        window.location.href = {% if is_demo %}'/demo/work-orders'{% else %}`/work-orders?assigned_to=${userId}`{% endif %};
    }

    function viewTraining(userId) {
        window.location.href = {% if is_demo %}'/demo/training'{% else %}`/training?user=${userId}`{% endif %};
    }

    // Notification helper
    function showNotification(type, title, message) {
        const colors = {
            success: 'rgba(39, 174, 96, 0.95)',
            error: 'rgba(231, 76, 60, 0.95)',
            info: 'rgba(52, 152, 219, 0.95)',
            warning: 'rgba(241, 196, 15, 0.95)'
        };
        const icons = {
            success: 'check-circle',
            error: 'exclamation-circle',
            info: 'info-circle',
            warning: 'exclamation-triangle'
        };

        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed; top: 20px; right: 20px; padding: 20px 25px;
            border-radius: 10px; background: ${colors[type]}; color: white;
            z-index: 10000; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease; max-width: 400px;
        `;
        notification.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 5px;">
                <i class="fas fa-${icons[type]}"></i> ${title}
            </div>
            <div style="font-size: 14px; opacity: 0.9;">${message}</div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 4000);
    }
</script>

<style>
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    .employee-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .employee-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        border-color: rgba(255,255,255,0.2);
    }

    .employee-avatar {
        font-weight: bold;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .status-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 3px solid var(--bg-dark, #1a1a2e);
    }

    .stat-box {
        background: rgba(255,255,255,0.05);
    }

    .skills-container .badge,
    .certifications-container .badge {
        font-size: 0.75rem;
    }

    .card-footer .btn {
        font-size: 0.75rem;
    }

    /* Make header action buttons very visible */
    .card-header .btn-primary {
        background: #0d6efd;
        border-color: #0d6efd;
        font-weight: 600;
    }

    .card-header .btn-danger {
        background: #dc3545;
        border-color: #dc3545;
        font-weight: 600;
    }

    .card-header .btn-primary:hover {
        background: #0b5ed7;
        transform: scale(1.05);
    }

    .card-header .btn-danger:hover {
        background: #bb2d3b;
        transform: scale(1.05);
    }
</style>
{% endblock %}
