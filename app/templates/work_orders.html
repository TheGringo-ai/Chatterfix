{% extends "base.html" %}

{% block title %}Work Orders - ChatterFix CMMS{% endblock %}

{% block content %}
<div class="cmms-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üìã Work Orders</h1>
            <p>Manage and track maintenance tasks</p>
        </div>
        <button class="cmms-btn" onclick="openAIAssistant()">
            <i class="fas fa-robot"></i> Ask AI Assistant
        </button>
    </div>
</div>

<div class="cmms-card">
    <h2>Create New Work Order</h2>
    <form id="create-wo-form" action="/work-orders" method="post" enctype="multipart/form-data">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Title</label>
                <input type="text" name="title" required
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Priority</label>
                <select name="priority"
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                    <option value="Low" style="color: black;">Low</option>
                    <option value="Medium" selected style="color: black;">Medium</option>
                    <option value="High" style="color: black;">High</option>
                    <option value="Critical" style="color: black;">Critical</option>
                </select>
            </div>
            <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 0.5rem;">Description</label>
                <textarea name="description" rows="3"
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;"></textarea>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Assigned To</label>
                <input type="text" name="assigned_to"
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem;">Due Date</label>
                <input type="date" name="due_date"
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
            </div>
            <div style="grid-column: 1 / -1;">
                <label style="display: block; margin-bottom: 0.5rem;">üìé Attachments</label>
                <input type="file" name="files" multiple accept="image/*,.pdf,.doc,.docx,.txt"
                    style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                <small style="color: rgba(255,255,255,0.7); display: block; margin-top: 0.3rem;">
                    Upload photos, documents, or files related to this work order. Multiple files supported.
                </small>
            </div>
        </div>
        <button type="submit" class="cmms-btn" style="margin-top: 1rem;">üìã Create Work Order</button>
    </form>
</div>

<div class="filter-bar" id="wo-filters">
    <div style="flex: 1;">
        <label>Search</label>
        <input type="text" id="wo-search" placeholder="Search work orders..." style="width: 100%;">
    </div>
    <div>
        <label>Status</label>
        <select id="wo-status-filter">
            <option value="">All Statuses</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
        </select>
    </div>
    <div>
        <label>Priority</label>
        <select id="wo-priority-filter">
            <option value="">All Priorities</option>
            <option value="Critical">Critical</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
    </div>
</div>

<div id="wo-list">
    {% for wo in work_orders %}
    <div class="item-card {{ wo.priority|lower }}" data-status="{{ wo.status }}" data-priority="{{ wo.priority }}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="display: flex; gap: 1rem; flex: 1;">
                {% if wo.asset_image_url %}
                <div
                    style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.1);">
                    <img src="{{ wo.asset_image_url }}" alt="Asset"
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                {% endif %}
                <div>
                    <h3 style="margin: 0 0 0.5rem 0;">#{{ wo.id }} {{ wo.title }}</h3>
                    <p style="opacity: 0.8; margin: 0 0 1rem 0;">{{ wo.description }}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.9rem; opacity: 0.7;">
                        <span>üë§ {{ wo.assigned_to or 'Unassigned' }}</span>
                        <span>üìÖ Due: {{ wo.due_date or 'No date' }}</span>
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                <span
                    class="cmms-badge {% if wo.status == 'Open' %}badge-maintenance{% elif wo.status == 'Completed' %}badge-operational{% else %}badge-down{% endif %}">
                    {{ wo.status }}
                </span>
                <div
                    style="margin-top: 0.5rem; font-size: 0.8rem; font-weight: bold; color: {% if wo.priority == 'Critical' %}#ff4757{% elif wo.priority == 'High' %}#ffa726{% else %}#38ef7d{% endif %};">
                    {{ wo.priority }} Priority
                </div>
            </div>
        </div>
        <div
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="cmms-btn cmms-btn-sm"
                onclick="openEditModal('{{ wo.id }}', '{{ wo.title }}', '{{ wo.description }}', '{{ wo.priority }}', '{{ wo.assigned_to }}', '{{ wo.due_date }}')">Edit</button>
            {% if wo.status != 'Completed' %}
            <form action="/work-orders/{{ wo.id }}/complete" method="post" style="display: inline;">
                <button type="submit" class="cmms-btn cmms-btn-success cmms-btn-sm">Complete</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- AI Assistant Modal -->
<div id="aiAssistantModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 5% auto; width: 500px; padding: 30px;">
        <h2><i class="fas fa-robot"></i> AI Assistant</h2>
        <div id="chatHistory"
            style="height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 10px; border-radius: 4px;">
            <div class="message ai">Hello! I'm your maintenance assistant. How can I help you today?</div>
        </div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="userMessage" class="form-control" placeholder="Describe issue or ask for manual..."
                onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" class="btn btn-primary">Send</button>
        </div>
        <button onclick="document.getElementById('aiAssistantModal').style.display='none'"
            class="btn btn-sm btn-secondary" style="margin-top:10px;">Close</button>
    </div>
</div>

<!-- Edit Work Order Modal -->
<div id="editWOModal" class="modal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000;">
    <div class="modal-content glass-panel" style="margin: 5% auto; width: 600px; padding: 30px;">
        <h2>‚úèÔ∏è Edit Work Order</h2>
        <form id="edit-wo-form" method="post">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Title</label>
                    <input type="text" name="title" id="edit-title" required
                        style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Priority</label>
                    <select name="priority" id="edit-priority"
                        style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                        <option value="Low" style="color: black;">Low</option>
                        <option value="Medium" style="color: black;">Medium</option>
                        <option value="High" style="color: black;">High</option>
                        <option value="Critical" style="color: black;">Critical</option>
                    </select>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 0.5rem;">Description</label>
                    <textarea name="description" id="edit-description" rows="3"
                        style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;"></textarea>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Assigned To</label>
                    <input type="text" name="assigned_to" id="edit-assigned-to"
                        style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Due Date</label>
                    <input type="date" name="due_date" id="edit-due-date"
                        style="width: 100%; padding: 0.8rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; color: white;">
                </div>
            </div>
            <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="document.getElementById('editWOModal').style.display='none'"
                    class="cmms-btn" style="background: #e74c3c;">Cancel</button>
                <button type="submit" class="cmms-btn">Update Work Order</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        setupUnifiedFiltering('wo-list', {
            itemSelector: '.item-card',
            searchId: 'wo-search',
            filters: {
                status: 'wo-status-filter',
                priority: 'wo-priority-filter'
            }
        });
    });

    function openEditModal(id, title, description, priority, assignedTo, dueDate) {
        const modal = document.getElementById('editWOModal');
        const form = document.getElementById('edit-wo-form');

        form.action = `/work-orders/${id}/update`;
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-description').value = description;
        document.getElementById('edit-priority').value = priority;
        document.getElementById('edit-assigned-to').value = assignedTo;
        document.getElementById('edit-due-date').value = dueDate;

        modal.style.display = 'block';
    }
</script>
{% endblock %}