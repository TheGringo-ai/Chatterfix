{% extends "base.html" %}

{% block title %}Work Orders - ChatterFix CMMS{% endblock %}

{% block content %}
<div class="cmms-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üìã Work Orders</h1>
            <p>Manage and track maintenance tasks</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="cmms-btn-secondary" onclick="document.getElementById('workOrderBarcodeScanModal').style.display='block'">
                <i class="fas fa-qrcode"></i> Scan Asset
            </button>
            <button class="cmms-btn" onclick="openAIAssistant()">
                <i class="fas fa-magic"></i> Create with AI
            </button>
        </div>
    </div>
</div>

<div class="cmms-card">
    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleCreateWOForm()">
        <h2 style="margin: 0;">Create New Work Order</h2>
        <button type="button" class="cmms-btn" id="toggleCreateWOBtn">
            <i class="fas fa-plus" id="toggleCreateWOIcon"></i> <span id="toggleCreateWOText">Show Form</span>
        </button>
    </div>
    <form id="create-wo-form" class="form-light" action="/work-orders" method="post" enctype="multipart/form-data" style="display: none; margin-top: 1rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
                <label for="wo-title" class="form-label">Title</label>
                <input type="text" name="title" id="wo-title" class="form-control" required>
            </div>
            <div>
                <label for="wo-priority" class="form-label">Priority</label>
                <select name="priority" id="wo-priority" class="form-control">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>

            <!-- Asset Selection -->
            <div>
                <label for="assetSelect" class="form-label"><i class="fas fa-cogs"></i> Asset</label>
                <select name="asset_id" id="assetSelect" class="form-control">
                    <option value="">Select Asset...</option>
                </select>
                <small class="form-text">Choose the asset this work order relates to</small>
            </div>

            <!-- Work Order Type -->
            <div>
                <label for="wo-type" class="form-label">Work Order Type</label>
                <select name="work_order_type" id="wo-type" class="form-control">
                    <option value="Corrective">Corrective Maintenance</option>
                    <option value="Preventive">Preventive Maintenance</option>
                    <option value="Emergency">Emergency Repair</option>
                    <option value="Inspection">Inspection</option>
                    <option value="Installation">Installation</option>
                </select>
            </div>

            <div style="grid-column: 1 / -1;">
                <label for="wo-description" class="form-label">Description</label>
                <textarea name="description" id="wo-description" rows="3" class="form-control"></textarea>
            </div>

            <!-- Scheduling Section -->
            <div>
                <label for="wo-due-date" class="form-label"><i class="fas fa-calendar"></i> Due Date</label>
                <input type="date" name="due_date" id="wo-due-date" class="form-control">
            </div>

            <div>
                <label for="wo-scheduled-time" class="form-label"><i class="fas fa-clock"></i> Scheduled Time</label>
                <input type="datetime-local" name="scheduled_time" id="wo-scheduled-time" class="form-control">
            </div>

            <div>
                <label for="technicianSelect" class="form-label"><i class="fas fa-user"></i> Assigned To</label>
                <select name="assigned_to" id="technicianSelect" class="form-control">
                    <option value="">Select Technician...</option>
                </select>
            </div>

            <div>
                <label for="wo-estimated-hours" class="form-label">Estimated Hours</label>
                <input type="number" name="estimated_hours" id="wo-estimated-hours" min="0" step="0.5" placeholder="2.5" class="form-control">
            </div>
            <div style="grid-column: 1 / -1;">
                <label for="wo-files" class="form-label">üìé Attachments</label>
                <input type="file" name="files" id="wo-files" multiple accept="image/*,.pdf,.doc,.docx,.txt" class="form-control">
                <small class="form-text">Upload photos, documents, or files related to this work order. Multiple files supported.</small>
            </div>
        </div>

        <!-- Parts Checkout Section -->
        <div class="parts-section">
            <h3><i class="fas fa-tools"></i> Parts & Materials Checkout</h3>
            <div id="partsContainer">
                <div class="parts-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                    <div>
                        <label for="part-select-0" class="form-label">Part/Material</label>
                        <select name="parts[0][part_id]" id="part-select-0" class="part-select form-control">
                            <option value="">Select Part...</option>
                        </select>
                    </div>
                    <div>
                        <label for="part-qty-0" class="form-label">Quantity</label>
                        <input type="number" name="parts[0][quantity]" id="part-qty-0" min="1" placeholder="1" class="form-control">
                    </div>
                    <div>
                        <label class="form-label">Available Stock</label>
                        <span class="stock-display">-</span>
                    </div>
                    <div>
                        <button type="button" class="cmms-btn-danger" onclick="removePart(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                <button type="button" onclick="addPart()" class="cmms-btn-secondary">
                    <i class="fas fa-plus"></i> Add Another Part
                </button>
                <small class="form-text">
                    <i class="fas fa-info-circle"></i> Parts will be automatically deducted from inventory when work order is created
                </small>
            </div>
        </div>

        <!-- Work Instructions Section -->
        <div class="instructions-section">
            <h3><i class="fas fa-clipboard-list"></i> Work Instructions & Safety Notes</h3>
            <div>
                <label for="wo-instructions" class="form-label">Detailed Instructions for Technician</label>
                <textarea name="work_instructions" id="wo-instructions" rows="4" placeholder="Enter step-by-step instructions, safety requirements, special tools needed, etc." class="form-control"></textarea>
                <small class="form-text text-warning">
                    <i class="fas fa-exclamation-triangle"></i> Include safety precautions, required PPE, and any special procedures
                </small>
            </div>
        </div>

        <button type="submit" class="cmms-btn" style="margin-top: 1rem;">üìã Create Work Order</button>
    </form>
</div>

<div class="filter-bar" id="wo-filters">
    <div style="flex: 1;">
        <label>Search</label>
        <input type="text" id="wo-search" placeholder="Search work orders..." style="width: 100%;">
    </div>
    <div>
        <label>Status</label>
        <select id="wo-status-filter">
            <option value="">All Statuses</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Completed">Completed</option>
        </select>
    </div>
    <div>
        <label>Priority</label>
        <select id="wo-priority-filter">
            <option value="">All Priorities</option>
            <option value="Critical">Critical</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
    </div>
</div>

<div id="wo-list">
    {% for wo in work_orders %}
    <div class="item-card {{ wo.priority|lower }}" data-status="{{ wo.status }}" data-priority="{{ wo.priority }}">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="display: flex; gap: 1rem; flex: 1;">
                {% if wo.asset_image_url %}
                <div
                    style="width: 80px; height: 80px; border-radius: 8px; overflow: hidden; flex-shrink: 0; border: 1px solid #dee2e6;">
                    <img src="{{ wo.asset_image_url }}" alt="Asset"
                        style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                {% endif %}
                <div>
                    <h3 style="margin: 0 0 0.5rem 0;">{{ wo.title }}</h3>
                    <p style="opacity: 0.8; margin: 0 0 1rem 0;">{{ wo.description }}</p>
                    <div style="display: flex; gap: 1rem; font-size: 0.9rem; opacity: 0.7;">
                        <span>üë§ {{ wo.assigned_to or 'Unassigned' }}</span>
                        <span>üìÖ Due: {{ wo.due_date or 'No date' }}</span>
                    </div>
                </div>
            </div>
            <div style="text-align: right;">
                <span
                    class="cmms-badge {% if wo.status == 'Open' %}badge-maintenance{% elif wo.status == 'Completed' %}badge-operational{% else %}badge-down{% endif %}">
                    {{ wo.status }}
                </span>
                <div
                    style="margin-top: 0.5rem; font-size: 0.8rem; font-weight: bold; color: {% if wo.priority == 'Critical' %}#ff4757{% elif wo.priority == 'High' %}#ffa726{% else %}#38ef7d{% endif %};">
                    {{ wo.priority }} Priority
                </div>
            </div>
        </div>
        <div
            style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6; display: flex; justify-content: flex-end; gap: 0.5rem;">
            <button class="cmms-btn cmms-btn-sm"
                onclick="openEditModal('{{ wo.id }}', '{{ wo.title }}', '{{ wo.description }}', '{{ wo.priority }}', '{{ wo.status }}', '{{ wo.assigned_to }}', '{{ wo.due_date }}', '{{ wo.scheduled_time }}')">Edit</button>
            {% if wo.status != 'Completed' %}
            <button onclick="openCompletionModal('{{ wo.id }}', '{{ wo.title }}')" 
                class="cmms-btn cmms-btn-success cmms-btn-sm">Complete</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- AI Assistant Modal - Enhanced for Work Order Creation -->
<div id="aiAssistantModal" class="modal modal-light"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 3% auto; width: 90%; max-width: 700px; padding: 0; border-radius: 16px; overflow: hidden;">
        <!-- Header -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: white;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-robot" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.3rem;">AI Work Order Assistant</h2>
                        <p style="margin: 0; opacity: 0.9; font-size: 0.85rem;">I'll help you create a work order step by step</p>
                    </div>
                </div>
                <button onclick="closeAIAssistant()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; opacity: 0.8;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Chat History -->
        <div id="chatHistory" style="height: 350px; overflow-y: auto; padding: 20px; background: #f8f9fa;">
            <!-- Messages will be added here -->
        </div>

        <!-- Quick Actions (shown when AI suggests creating work order) -->
        <div id="aiQuickActions" style="display: none; padding: 15px 20px; background: #e8f5e9; border-top: 1px solid #c8e6c9;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="confirmCreateWorkOrder()" class="cmms-btn" style="background: #28a745;">
                    <i class="fas fa-check"></i> Create Work Order
                </button>
                <button onclick="editWorkOrderDetails()" class="cmms-btn-secondary">
                    <i class="fas fa-edit"></i> Edit Details
                </button>
                <button onclick="resetAIConversation()" class="cmms-btn-secondary" style="background: #6c757d; color: white;">
                    <i class="fas fa-redo"></i> Start Over
                </button>
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding: 20px; background: white; border-top: 1px solid #dee2e6;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <button onclick="startVoiceInput()" id="voiceInputBtn" class="cmms-btn-secondary" style="padding: 12px 15px;" title="Voice Input">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" id="userMessage" class="form-control"
                    placeholder="Describe the issue or answer my questions..."
                    style="flex: 1; padding: 12px 15px; border-radius: 25px; border: 2px solid #dee2e6;"
                    onkeypress="if(event.key==='Enter') sendAIMessage()">
                <button onclick="sendAIMessage()" class="cmms-btn" style="padding: 12px 20px; border-radius: 25px;">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
            <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                <span style="font-size: 0.8rem; color: #6c757d;">Quick prompts:</span>
                <button onclick="setQuickPrompt('Machine is making unusual noise')" class="quick-prompt-btn">Machine noise</button>
                <button onclick="setQuickPrompt('Equipment not starting')" class="quick-prompt-btn">Won't start</button>
                <button onclick="setQuickPrompt('Preventive maintenance needed')" class="quick-prompt-btn">PM needed</button>
                <button onclick="setQuickPrompt('Safety hazard identified')" class="quick-prompt-btn">Safety issue</button>
            </div>
        </div>
    </div>
</div>

<style>
.quick-prompt-btn {
    background: #e9ecef;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    padding: 5px 12px;
    font-size: 0.75rem;
    color: #495057;
    cursor: pointer;
    transition: all 0.2s;
}
.quick-prompt-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
}
.ai-message {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    animation: fadeIn 0.3s ease;
}
.ai-message.user {
    flex-direction: row-reverse;
}
.ai-message .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}
.ai-message.assistant .avatar {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}
.ai-message.user .avatar {
    background: #28a745;
    color: white;
}
.ai-message .bubble {
    max-width: 80%;
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.5;
}
.ai-message.assistant .bubble {
    background: white;
    color: #212529;
    border: 1px solid #dee2e6;
    border-top-left-radius: 4px;
}
.ai-message.user .bubble {
    background: #667eea;
    color: white;
    border-top-right-radius: 4px;
}
.ai-typing {
    display: flex;
    gap: 4px;
    padding: 8px 0;
}
.ai-typing span {
    width: 8px;
    height: 8px;
    background: #667eea;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out;
}
.ai-typing span:nth-child(1) { animation-delay: -0.32s; }
.ai-typing span:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.wo-preview-card {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border: 2px solid #667eea;
    border-radius: 12px;
    padding: 15px;
    margin-top: 10px;
}
.wo-preview-card h4 {
    color: #667eea;
    margin: 0 0 10px 0;
    font-size: 1rem;
}
.wo-preview-field {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px dashed #dee2e6;
    font-size: 0.9rem;
}
.wo-preview-field:last-child {
    border-bottom: none;
}
.wo-preview-field .label {
    color: #6c757d;
}
.wo-preview-field .value {
    color: #212529;
    font-weight: 500;
}
</style>

<!-- Edit Work Order Modal -->
<div id="editWOModal" class="modal modal-light"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 2% auto; width: 90%; max-width: 800px; padding: 30px;">
        <h2 style="color: #212529;">‚úèÔ∏è Edit Work Order</h2>
        <form id="edit-wo-form" class="form-light" method="post">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Title</label>
                    <input type="text" name="title" id="edit-title" required
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Priority</label>
                    <select name="priority" id="edit-priority"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="Low" style="color: black;">Low</option>
                        <option value="Medium" style="color: black;">Medium</option>
                        <option value="High" style="color: black;">High</option>
                        <option value="Critical" style="color: black;">Critical</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Status</label>
                    <select name="status" id="edit-status"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="Open" style="color: black;">Open</option>
                        <option value="In Progress" style="color: black;">In Progress</option>
                        <option value="On Hold" style="color: black;">On Hold</option>
                        <option value="Completed" style="color: black;">Completed</option>
                        <option value="Cancelled" style="color: black;">Cancelled</option>
                    </select>
                </div>

                <!-- Enhanced Edit Fields -->
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-cogs"></i> Asset</label>
                    <select name="asset_id" id="edit-asset-select"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="">Select Asset...</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Work Order Type</label>
                    <select name="work_order_type" id="edit-work-order-type"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="Corrective">Corrective Maintenance</option>
                        <option value="Preventive">Preventive Maintenance</option>
                        <option value="Emergency">Emergency Repair</option>
                        <option value="Inspection">Inspection</option>
                        <option value="Installation">Installation</option>
                    </select>
                </div>

                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Description</label>
                    <textarea name="description" id="edit-description" rows="3"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;"></textarea>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-calendar"></i> Due Date</label>
                    <input type="date" name="due_date" id="edit-due-date"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-clock"></i> Scheduled Time</label>
                    <input type="datetime-local" name="scheduled_time" id="edit-scheduled-time"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-user"></i> Assigned To</label>
                    <select name="assigned_to" id="edit-assigned-to"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="">Select Technician...</option>
                    </select>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Estimated Hours</label>
                    <input type="number" name="estimated_hours" id="edit-estimated-hours" min="0" step="0.5"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
            </div>

            <!-- Edit Parts Checkout Section -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-bottom: 1rem; color: #495057;"><i class="fas fa-tools"></i> Additional Parts Checkout</h3>
                <div id="editPartsContainer">
                    <div class="parts-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material</label>
                            <select name="edit_parts[0][part_id]" class="edit-part-select" onchange="updateEditPartStock(this)"
                                style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                                <option value="">Select Part...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity</label>
                            <input type="number" name="edit_parts[0][quantity]" min="1" placeholder="1" onchange="validateEditQuantity(this)"
                                style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                            <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
                        </div>
                        <div>
                            <button type="button" onclick="removeEditPart(this)" style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addEditPart()" class="cmms-btn-secondary">
                    <i class="fas fa-plus"></i> Add Part
                </button>
            </div>

            <!-- Work Instructions Section -->
            <div style="margin-top: 2rem; padding: 1.5rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                <h3 style="margin-bottom: 1rem; color: #856404;"><i class="fas fa-clipboard-list"></i> Work Instructions & Safety Notes</h3>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Updated Instructions</label>
                    <textarea name="work_instructions" id="edit-work-instructions" rows="4"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;"></textarea>
                </div>
            </div>

            <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 1rem;">
                <button type="button" onclick="document.getElementById('editWOModal').style.display='none'"
                    class="cmms-btn" style="background: #e74c3c;">Cancel</button>
                <button type="submit" class="cmms-btn">Update Work Order</button>
            </div>
        </form>
    </div>
</div>

<!-- Work Order Completion Modal -->
<div id="completionModal" class="modal modal-light"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 2% auto; width: 90%; max-width: 700px; padding: 30px;">
        <h2 style="color: #28a745;"><i class="fas fa-check-circle"></i> Complete Work Order</h2>
        <div id="completion-wo-title" style="margin-bottom: 2rem; padding: 1rem; background: rgba(40, 167, 69, 0.1); border-radius: 8px; border-left: 4px solid #28a745;">
            <h3 style="margin: 0; color: #155724;">Work Order Title</h3>
        </div>

        <form id="completion-form" class="form-light" method="post">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-clock"></i> Actual Hours Worked</label>
                    <input type="number" name="actual_hours" id="completion-actual-hours" min="0" step="0.25" placeholder="2.5" required
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <small style="color: #6c757d;">Enter the actual time spent on this work order</small>
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;"><i class="fas fa-calendar-check"></i> Completion Date & Time</label>
                    <input type="datetime-local" name="completion_time" id="completion-time" required
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
            </div>

            <!-- Work Summary Section -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: #e8f5e8; border-radius: 8px; border: 1px solid #c3e6cb;">
                <h3 style="margin-bottom: 1rem; color: #155724;"><i class="fas fa-clipboard-check"></i> Work Performed Summary</h3>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Detailed Description of Work Completed *
                    </label>
                    <textarea name="work_summary" id="completion-work-summary" rows="6" required
                        placeholder="Please provide a detailed description of the work performed, including:&#10;- What specific tasks were completed&#10;- Any problems encountered and how they were resolved&#10;- Parts used and why&#10;- Testing performed&#10;- Current status of the asset"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529; min-height: 120px;"></textarea>
                    <small style="color: #856404; display: block; margin-top: 0.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> This field is required. Please provide comprehensive details about the work performed.
                    </small>
                </div>
            </div>

            <!-- Parts Used Section -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                <h3 style="margin-bottom: 1rem; color: #495057;"><i class="fas fa-tools"></i> Parts Used During Work</h3>
                <div id="completionPartsContainer">
                    <div class="completion-parts-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material Used</label>
                            <select name="completion_parts[0][part_id]" class="completion-part-select" onchange="updateCompletionPartStock(this)"
                                style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                                <option value="">Select Part...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity Used</label>
                            <input type="number" name="completion_parts[0][quantity_used]" min="1" placeholder="1" onchange="validateCompletionQuantity(this)"
                                style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                            <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
                        </div>
                        <div>
                            <button type="button" onclick="removeCompletionPart(this)" style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <button type="button" onclick="addCompletionPart()" class="cmms-btn-secondary">
                    <i class="fas fa-plus"></i> Add Used Part
                </button>
                <div style="font-size: 0.9em; color: #6c757d; margin-top: 0.5rem;">
                    <i class="fas fa-info-circle"></i> Parts used will be deducted from inventory
                </div>
            </div>

            <!-- Follow-up Actions Section -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: #fff3cd; border-radius: 8px; border: 1px solid #ffeaa7;">
                <h3 style="margin-bottom: 1rem; color: #856404;"><i class="fas fa-exclamation-triangle"></i> Follow-up Actions & Recommendations</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Asset Status After Completion</label>
                        <select name="asset_status" id="completion-asset-status"
                            style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                            <option value="Operational">Fully Operational</option>
                            <option value="Operational-Monitor">Operational - Monitor</option>
                            <option value="Limited">Limited Function</option>
                            <option value="Down">Out of Service</option>
                        </select>
                    </div>

                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Next Service Due (Optional)</label>
                        <input type="date" name="next_service_date" id="completion-next-service"
                            style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Additional Recommendations or Follow-up Required</label>
                    <textarea name="follow_up_notes" id="completion-follow-up" rows="3"
                        placeholder="Describe any additional maintenance needed, parts to order, or follow-up work orders required..."
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;"></textarea>
                </div>
            </div>

            <!-- Completion Photos/Documents -->
            <div style="margin-bottom: 2rem; padding: 1.5rem; background: #e3f2fd; border-radius: 8px; border: 1px solid #bbdefb;">
                <h3 style="margin-bottom: 1rem; color: #0d47a1;"><i class="fas fa-camera"></i> Completion Documentation</h3>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Upload Photos/Documents (Optional)</label>
                    <input type="file" name="completion_files" id="completion-files" multiple accept="image/*,.pdf,.doc,.docx"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <small style="color: #1565c0; display: block; margin-top: 0.3rem;">
                        Upload photos of completed work, before/after pictures, or supporting documents
                    </small>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem; border-top: 1px solid #dee2e6; padding-top: 1rem;">
                <button type="button" onclick="closeCompletionModal()" class="cmms-btn" style="background: #6c757d;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="cmms-btn" style="background: #28a745;">
                    <i class="fas fa-check-circle"></i> Complete Work Order
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Work Order Barcode Scanner Modal -->
<div id="workOrderBarcodeScanModal" class="modal modal-light"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; overflow-y: auto;">
    <div class="modal-content form-light" style="margin: 2% auto; width: 90%; max-width: 600px; padding: 30px;">
        <h2 style="color: #212529;"><i class="fas fa-qrcode"></i> Scan Asset for Work Orders</h2>
        <p style="color: #495057;">Scan an asset's barcode to quickly view its work orders and create new ones.</p>

        <!-- Camera Interface -->
        <div id="woCameraSection" style="text-align: center; margin: 20px 0;">
            <video id="woBarcodeVideo" width="400" height="300" style="border: 2px solid #667eea; border-radius: 8px; display: none;"></video>
            <div id="woCameraPlaceholder" style="width: 400px; height: 300px; border: 2px dashed #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                <div style="text-align: center; color: #999;">
                    <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 10px;"></i>
                    <div>Click "Start Camera" to begin scanning</div>
                </div>
            </div>
            <div style="margin: 10px 0;">
                <button id="woStartCameraBtn" class="cmms-btn" onclick="startWOBarcodeCamera()">
                    <i class="fas fa-camera"></i> Start Camera
                </button>
                <button id="woStopCameraBtn" class="cmms-btn" style="display: none; background: #e74c3c;" onclick="stopWOBarcodeCamera()">
                    <i class="fas fa-stop"></i> Stop Camera
                </button>
            </div>
        </div>

        <!-- File Upload Option -->
        <div style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-top: 20px;">
            <h4>Or Upload Barcode Image</h4>
            <form id="woBarcodeUploadForm" class="form-light" enctype="multipart/form-data">
                <input type="file" id="woBarcodeFile" name="file" accept="image/*" class="form-control" onchange="uploadWOBarcode()">
            </form>
        </div>

        <!-- Manual Entry Option -->
        <div class="form-light" style="border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; margin-top: 20px;">
            <h4>Or Enter Asset Tag Manually</h4>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="woManualAssetTag" class="form-control" placeholder="Enter asset tag or barcode...">
                <button class="cmms-btn" onclick="lookupWOByTag()">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="woScanResults" style="margin-top: 20px; display: none;"></div>

        <div style="display: flex; gap: 1rem; margin-top: 20px; justify-content: center;">
            <button type="button" class="cmms-btn" style="background: #555;" onclick="closeWOBarcodeModal()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<script>
    // Toggle Create Work Order Form
    function toggleCreateWOForm() {
        const form = document.getElementById('create-wo-form');
        const icon = document.getElementById('toggleCreateWOIcon');
        const text = document.getElementById('toggleCreateWOText');

        if (form.style.display === 'none') {
            form.style.display = 'block';
            icon.classList.remove('fa-plus');
            icon.classList.add('fa-minus');
            text.textContent = 'Hide Form';
        } else {
            form.style.display = 'none';
            icon.classList.remove('fa-minus');
            icon.classList.add('fa-plus');
            text.textContent = 'Show Form';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        setupUnifiedFiltering('wo-list', {
            itemSelector: '.item-card',
            searchId: 'wo-search',
            filters: {
                status: 'wo-status-filter',
                priority: 'wo-priority-filter'
            }
        });
    });

    function openEditModal(id, title, description, priority, status, assignedTo, dueDate, scheduledTime) {
        const modal = document.getElementById('editWOModal');
        const form = document.getElementById('edit-wo-form');

        form.action = `/work-orders/${id}/update`;
        document.getElementById('edit-title').value = title;
        document.getElementById('edit-description').value = description;
        document.getElementById('edit-priority').value = priority;
        document.getElementById('edit-status').value = status || 'Open';
        document.getElementById('edit-due-date').value = dueDate;
        document.getElementById('edit-scheduled-time').value = scheduledTime || '';

        // Populate dropdowns if available parts are loaded
        if (availableParts && availableParts.length > 0) {
            // Populate asset dropdown
            const assetSelect = document.getElementById('edit-asset-select');
            // This will be populated when loadInitialData runs

            // Populate technician dropdown
            const techSelect = document.getElementById('edit-assigned-to');
            // Set the assigned value if it's a select dropdown
            if (techSelect.tagName === 'SELECT') {
                techSelect.value = assignedTo;
            }

            // Populate edit parts selects
            const editPartSelects = document.querySelectorAll('.edit-part-select');
            editPartSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Part...</option>';
                availableParts.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.id;
                    option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
                    option.dataset.stock = part.current_stock || 0;
                    select.appendChild(option);
                });
            });
        }

        modal.style.display = 'block';
    }

    // Work Order Barcode Scanner Functions
    let woBarcodeStream = null;

    function startWOBarcodeCamera() {
        if (!navigator.mediaDevices) {
            alert('Camera access not supported in this browser');
            return;
        }

        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                woBarcodeStream = stream;
                const video = document.getElementById('woBarcodeVideo');
                const placeholder = document.getElementById('woCameraPlaceholder');
                
                video.srcObject = stream;
                video.style.display = 'block';
                placeholder.style.display = 'none';
                
                document.getElementById('woStartCameraBtn').style.display = 'none';
                document.getElementById('woStopCameraBtn').style.display = 'inline-block';
                
                video.play();
                console.log('Work Order barcode camera started');
            })
            .catch(err => {
                console.error('Error accessing camera:', err);
                alert('Could not access camera. Please check permissions.');
            });
    }

    function stopWOBarcodeCamera() {
        if (woBarcodeStream) {
            woBarcodeStream.getTracks().forEach(track => track.stop());
            woBarcodeStream = null;
        }
        
        const video = document.getElementById('woBarcodeVideo');
        const placeholder = document.getElementById('woCameraPlaceholder');
        
        video.style.display = 'none';
        placeholder.style.display = 'flex';
        
        document.getElementById('woStartCameraBtn').style.display = 'inline-block';
        document.getElementById('woStopCameraBtn').style.display = 'none';
    }

    function uploadWOBarcode() {
        const fileInput = document.getElementById('woBarcodeFile');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        fetch('/assets/scan-barcode', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayWOScanResults(data);
        })
        .catch(error => {
            console.error('Error scanning barcode:', error);
            alert('Error scanning barcode: ' + error.message);
        });
    }

    function lookupWOByTag() {
        const assetTag = document.getElementById('woManualAssetTag').value.trim();
        
        if (!assetTag) {
            alert('Please enter an asset tag');
            return;
        }
        
        const formData = new FormData();
        formData.append('asset_tag', assetTag);
        
        fetch('/assets/lookup-by-tag', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayWOScanResults(data);
        })
        .catch(error => {
            console.error('Error looking up asset:', error);
            alert('Error looking up asset: ' + error.message);
        });
    }

    function displayWOScanResults(data) {
        const resultsDiv = document.getElementById('woScanResults');
        
        if (data.success && data.asset) {
            const asset = data.asset;
            const workOrders = data.work_orders || [];
            const parts = data.parts || [];
            
            resultsDiv.innerHTML = `
                <div class="scan-result-card" style="background: linear-gradient(135deg, rgba(39, 174, 96, 0.2), rgba(46, 204, 113, 0.2)); border: 1px solid rgba(39, 174, 96, 0.5); border-radius: 8px; padding: 20px;">
                    <h3 style="color: #27ae60; margin-bottom: 15px;">
                        <i class="fas fa-check-circle"></i> Asset Found: ${asset.name}
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div><strong>Tag:</strong> ${asset.asset_tag || 'N/A'}</div>
                        <div><strong>Location:</strong> ${asset.location || 'N/A'}</div>
                        <div><strong>Status:</strong> ${asset.status || 'N/A'}</div>
                        <div><strong>Model:</strong> ${asset.model || 'N/A'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #3498db; margin-bottom: 10px;">
                            <i class="fas fa-clipboard-list"></i> Active Work Orders (${workOrders.length})
                        </h4>
                        ${workOrders.length > 0 ? `
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${workOrders.map(wo => `
                                    <div style="background: rgba(52, 152, 219, 0.1); border-left: 3px solid #3498db; padding: 10px; margin-bottom: 5px;">
                                        <div style="font-weight: bold;">${wo.title}</div>
                                        <div style="font-size: 0.9em; color: #bdc3c7;">
                                            Status: ${wo.status} | Priority: ${wo.priority} | Due: ${wo.due_date || 'N/A'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div style="font-style: italic; color: #95a5a6;">No active work orders</div>'}
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: #f39c12; margin-bottom: 10px;">
                            <i class="fas fa-cogs"></i> Required Parts (${parts.length})
                        </h4>
                        ${parts.length > 0 ? `
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${parts.slice(0, 5).map(part => `
                                    <div style="background: rgba(243, 156, 18, 0.1); border-left: 3px solid #f39c12; padding: 8px; margin-bottom: 3px; font-size: 0.9em;">
                                        ${part.name} - ${part.quantity_used || 'N/A'} units
                                    </div>
                                `).join('')}
                                ${parts.length > 5 ? '<div style="font-style: italic; color: #95a5a6; text-align: center;">... and more</div>' : ''}
                            </div>
                        ` : '<div style="font-style: italic; color: #95a5a6;">No parts information available</div>'}
                    </div>
                    
                    <div style="text-align: center; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                        <button class="cmms-btn" onclick="createWorkOrderForAsset('${asset.id}', '${asset.name}')">
                            <i class="fas fa-plus"></i> Create New Work Order
                        </button>
                        <a href="/assets/${asset.id}" class="cmms-btn-secondary" style="display: inline-block; margin-left: 10px;">
                            <i class="fas fa-eye"></i> View Asset Details
                        </a>
                    </div>
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="scan-result-card" style="background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.2)); border: 1px solid rgba(231, 76, 60, 0.5); border-radius: 8px; padding: 20px; text-align: center;">
                    <h3 style="color: #e74c3c; margin-bottom: 15px;">
                        <i class="fas fa-times-circle"></i> No Asset Found
                    </h3>
                    <p>${data.message || data.error || 'No asset found with this identifier'}</p>
                    ${data.barcode_data ? `<p><strong>Scanned Data:</strong> ${data.barcode_data}</p>` : ''}
                </div>
            `;
        }
        
        resultsDiv.style.display = 'block';
    }

    function createWorkOrderForAsset(assetId, assetName) {
        // Pre-fill the create work order form with asset information
        closeWOBarcodeModal();
        
        // Scroll to the create form
        document.querySelector('.cmms-card').scrollIntoView({ behavior: 'smooth' });
        
        // Pre-fill the title with asset name
        const titleField = document.querySelector('input[name="title"]');
        if (titleField) {
            titleField.value = `Maintenance for ${assetName}`;
            titleField.focus();
        }
        
        // You could also add a hidden field for asset_id if your form supports it
        // const assetIdField = document.createElement('input');
        // assetIdField.type = 'hidden';
        // assetIdField.name = 'asset_id';
        // assetIdField.value = assetId;
        // document.getElementById('create-wo-form').appendChild(assetIdField);
    }

    function closeWOBarcodeModal() {
        stopWOBarcodeCamera();
        document.getElementById('workOrderBarcodeScanModal').style.display = 'none';
        document.getElementById('woScanResults').style.display = 'none';
        document.getElementById('woManualAssetTag').value = '';
        document.getElementById('woBarcodeFile').value = '';
    }

    // Load initial data
    async function loadInitialData() {
        try {
            // Load assets for dropdown (credentials needed for org filtering)
            const assetResponse = await fetch('/api/assets', { credentials: 'include' });
            if (assetResponse.ok) {
                const assets = await assetResponse.json();
                populateAssetDropdown(assets);
                // Store for AI context
                availableAssets = assets;
            }

            // Load technicians for dropdown (credentials needed for org filtering)
            const techResponse = await fetch('/api/users', { credentials: 'include' });
            if (techResponse.ok) {
                const technicians = await techResponse.json();
                populateTechnicianDropdown(technicians);
            }

            // Load parts for parts checkout
            const partsResponse = await fetch('/purchasing/parts/search', { credentials: 'include' });
            if (partsResponse.ok) {
                const partsData = await partsResponse.json();
                populatePartSelects(partsData.parts);
            }
        } catch (error) {
            console.error('Error loading initial data:', error);
        }
    }

    function populateAssetDropdown(assets) {
        const select = document.getElementById('assetSelect');
        select.innerHTML = '<option value="">Select Asset...</option>';
        
        assets.forEach(asset => {
            const option = document.createElement('option');
            option.value = asset.id;
            option.textContent = `${asset.name} (${asset.asset_tag || 'No Tag'})`;
            select.appendChild(option);
        });
    }

    // Store technicians for later use in edit modal
    let availableTechnicians = [];

    function populateTechnicianDropdown(technicians) {
        // Store for later use
        availableTechnicians = technicians;

        // Populate create form dropdown
        const createSelect = document.getElementById('technicianSelect');
        if (createSelect) {
            createSelect.innerHTML = '<option value="">Select Technician...</option>';
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.full_name || tech.name;
                createSelect.appendChild(option);
            });
        }

        // Also populate edit modal dropdown
        const editSelect = document.getElementById('edit-assigned-to');
        if (editSelect) {
            editSelect.innerHTML = '<option value="">Select Technician...</option>';
            technicians.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id;
                option.textContent = tech.full_name || tech.name;
                editSelect.appendChild(option);
            });
        }
    }

    let availableParts = [];

    function populatePartSelects(parts) {
        availableParts = parts;
        updateAllPartSelects();
    }

    function updateAllPartSelects() {
        const partSelects = document.querySelectorAll('.part-select');
        partSelects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Part...</option>';
            
            availableParts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
                option.dataset.stock = part.current_stock || 0;
                option.dataset.cost = part.unit_cost || 0;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        });
    }

    // Parts management functions
    let partCounter = 0;

    function addPart() {
        partCounter++;
        const container = document.getElementById('partsContainer');
        
        const partRow = document.createElement('div');
        partRow.className = 'parts-row';
        partRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;';
        
        partRow.innerHTML = `
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material</label>
                <select name="parts[${partCounter}][part_id]" class="part-select" onchange="updatePartStock(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <option value="">Select Part...</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity</label>
                <input type="number" name="parts[${partCounter}][quantity]" min="1" placeholder="1" onchange="validateQuantity(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
            </div>
            <div>
                <button type="button" class="remove-part-btn" onclick="removePart(this)" 
                    style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(partRow);
        
        // Populate the new select with available parts
        const newSelect = partRow.querySelector('.part-select');
        availableParts.forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
            option.dataset.stock = part.current_stock || 0;
            option.dataset.cost = part.unit_cost || 0;
            newSelect.appendChild(option);
        });
    }

    function removePart(button) {
        const partRow = button.closest('.parts-row');
        partRow.remove();
    }

    // Helper function to set stock display styling using CSS classes
    function setStockDisplayClass(stockDisplay, stock) {
        // Remove all stock classes first
        stockDisplay.classList.remove('stock-ok', 'stock-low', 'stock-out');

        if (stock === 0) {
            stockDisplay.classList.add('stock-out');
        } else if (stock <= 5) {
            stockDisplay.classList.add('stock-low');
        } else {
            stockDisplay.classList.add('stock-ok');
        }
    }

    function updatePartStock(select) {
        const selectedOption = select.options[select.selectedIndex];
        const stockDisplay = select.closest('.parts-row').querySelector('.stock-display');

        if (selectedOption && selectedOption.dataset.stock !== undefined) {
            const stock = parseInt(selectedOption.dataset.stock);
            stockDisplay.textContent = stock;

            // Update quantity validation
            const quantityInput = select.closest('.parts-row').querySelector('input[type="number"]');
            quantityInput.max = stock;

            // Use CSS classes instead of inline styles
            setStockDisplayClass(stockDisplay, stock);
        } else {
            stockDisplay.textContent = '-';
            stockDisplay.classList.remove('stock-ok', 'stock-low', 'stock-out');
        }
    }

    function validateQuantity(input) {
        const partRow = input.closest('.parts-row');
        const stockDisplay = partRow.querySelector('.stock-display');
        const availableStock = parseInt(stockDisplay.textContent) || 0;
        const requestedQty = parseInt(input.value) || 0;
        
        if (requestedQty > availableStock) {
            input.style.borderColor = '#dc3545';
            input.title = `Only ${availableStock} available in stock`;
            
            // Show warning message
            let warning = partRow.querySelector('.qty-warning');
            if (!warning) {
                warning = document.createElement('small');
                warning.className = 'qty-warning';
                warning.style.cssText = 'color: #dc3545; display: block; margin-top: 0.25rem;';
                input.parentNode.appendChild(warning);
            }
            warning.textContent = `Only ${availableStock} available`;
        } else {
            input.style.borderColor = '#dee2e6';
            input.title = '';
            
            const warning = partRow.querySelector('.qty-warning');
            if (warning) {
                warning.remove();
            }
        }
    }

    // Edit modal functions
    let editPartCounter = 0;

    function addEditPart() {
        editPartCounter++;
        const container = document.getElementById('editPartsContainer');
        
        const partRow = document.createElement('div');
        partRow.className = 'parts-row';
        partRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;';
        
        partRow.innerHTML = `
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material</label>
                <select name="edit_parts[${editPartCounter}][part_id]" class="edit-part-select" onchange="updateEditPartStock(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <option value="">Select Part...</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity</label>
                <input type="number" name="edit_parts[${editPartCounter}][quantity]" min="1" placeholder="1" onchange="validateEditQuantity(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
            </div>
            <div>
                <button type="button" onclick="removeEditPart(this)" 
                    style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(partRow);
        
        // Populate the new select with available parts
        const newSelect = partRow.querySelector('.edit-part-select');
        availableParts.forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
            option.dataset.stock = part.current_stock || 0;
            newSelect.appendChild(option);
        });
    }

    function removeEditPart(button) {
        button.closest('.parts-row').remove();
    }

    function updateEditPartStock(select) {
        const selectedOption = select.options[select.selectedIndex];
        const stockDisplay = select.closest('.parts-row').querySelector('.stock-display');

        if (selectedOption && selectedOption.dataset.stock !== undefined) {
            const stock = parseInt(selectedOption.dataset.stock);
            stockDisplay.textContent = stock;

            const quantityInput = select.closest('.parts-row').querySelector('input[type="number"]');
            quantityInput.max = stock;

            // Use CSS classes instead of inline styles
            setStockDisplayClass(stockDisplay, stock);
        } else {
            stockDisplay.textContent = '-';
            stockDisplay.classList.remove('stock-ok', 'stock-low', 'stock-out');
        }
    }

    function validateEditQuantity(input) {
        const partRow = input.closest('.parts-row');
        const stockDisplay = partRow.querySelector('.stock-display');
        const availableStock = parseInt(stockDisplay.textContent) || 0;
        const requestedQty = parseInt(input.value) || 0;
        
        if (requestedQty > availableStock) {
            input.style.borderColor = '#dc3545';
            input.title = `Only ${availableStock} available in stock`;
        } else {
            input.style.borderColor = '#dee2e6';
            input.title = '';
        }
    }

    // Completion modal functions
    let completionPartCounter = 0;

    function openCompletionModal(woId, woTitle) {
        const modal = document.getElementById('completionModal');
        const form = document.getElementById('completion-form');
        const titleDiv = document.getElementById('completion-wo-title');
        
        form.action = `/work-orders/${woId}/complete-enhanced`;
        titleDiv.querySelector('h3').textContent = woTitle;
        
        // Set current date/time
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        document.getElementById('completion-time').value = localDateTime;
        
        // Populate parts selects
        updateCompletionPartSelects();
        
        modal.style.display = 'block';
    }

    function closeCompletionModal() {
        document.getElementById('completionModal').style.display = 'none';
        
        // Reset form
        document.getElementById('completion-form').reset();
        
        // Reset parts container to single row
        const container = document.getElementById('completionPartsContainer');
        container.innerHTML = `
            <div class="completion-parts-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material Used</label>
                    <select name="completion_parts[0][part_id]" class="completion-part-select" onchange="updateCompletionPartStock(this)"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                        <option value="">Select Part...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity Used</label>
                    <input type="number" name="completion_parts[0][quantity_used]" min="1" placeholder="1" onchange="validateCompletionQuantity(this)"
                        style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                    <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
                </div>
                <div>
                    <button type="button" onclick="removeCompletionPart(this)" style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        updateCompletionPartSelects();
        completionPartCounter = 0;
    }

    function addCompletionPart() {
        completionPartCounter++;
        const container = document.getElementById('completionPartsContainer');
        
        const partRow = document.createElement('div');
        partRow.className = 'completion-parts-row';
        partRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: 1rem;';
        
        partRow.innerHTML = `
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Part/Material Used</label>
                <select name="completion_parts[${completionPartCounter}][part_id]" class="completion-part-select" onchange="updateCompletionPartStock(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
                    <option value="">Select Part...</option>
                </select>
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Quantity Used</label>
                <input type="number" name="completion_parts[${completionPartCounter}][quantity_used]" min="1" placeholder="1" onchange="validateCompletionQuantity(this)"
                    style="width: 100%; padding: 0.8rem; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; color: #212529;">
            </div>
            <div>
                <label style="display: block; margin-bottom: 0.5rem; color: #212529;">Available Stock</label>
                <span class="stock-display" style="display: block; padding: 0.8rem; background: #e9ecef; border-radius: 8px; color: #495057;">-</span>
            </div>
            <div>
                <button type="button" onclick="removeCompletionPart(this)" 
                    style="padding: 0.8rem 1rem; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        container.appendChild(partRow);
        
        // Populate the new select with available parts
        const newSelect = partRow.querySelector('.completion-part-select');
        availableParts.forEach(part => {
            const option = document.createElement('option');
            option.value = part.id;
            option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
            option.dataset.stock = part.current_stock || 0;
            newSelect.appendChild(option);
        });
    }

    function removeCompletionPart(button) {
        button.closest('.completion-parts-row').remove();
    }

    function updateCompletionPartStock(select) {
        const selectedOption = select.options[select.selectedIndex];
        const stockDisplay = select.closest('.completion-parts-row').querySelector('.stock-display');

        if (selectedOption && selectedOption.dataset.stock !== undefined) {
            const stock = parseInt(selectedOption.dataset.stock);
            stockDisplay.textContent = stock;

            const quantityInput = select.closest('.completion-parts-row').querySelector('input[type="number"]');
            quantityInput.max = stock;

            // Use CSS classes instead of inline styles
            setStockDisplayClass(stockDisplay, stock);
        } else {
            stockDisplay.textContent = '-';
            stockDisplay.classList.remove('stock-ok', 'stock-low', 'stock-out');
        }
    }

    function validateCompletionQuantity(input) {
        const partRow = input.closest('.completion-parts-row');
        const stockDisplay = partRow.querySelector('.stock-display');
        const availableStock = parseInt(stockDisplay.textContent) || 0;
        const requestedQty = parseInt(input.value) || 0;
        
        if (requestedQty > availableStock) {
            input.style.borderColor = '#dc3545';
            input.title = `Only ${availableStock} available in stock`;
        } else {
            input.style.borderColor = '#dee2e6';
            input.title = '';
        }
    }

    function updateCompletionPartSelects() {
        const partSelects = document.querySelectorAll('.completion-part-select');
        partSelects.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Part...</option>';
            
            availableParts.forEach(part => {
                const option = document.createElement('option');
                option.value = part.id;
                option.textContent = `${part.name} (${part.part_number || 'No PN'})`;
                option.dataset.stock = part.current_stock || 0;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        });
    }

    // ==========================================
    // AI ASSISTANT FOR WORK ORDER CREATION
    // ==========================================

    // Conversation state for AI-guided work order creation
    let aiConversationState = {
        step: 0,
        workOrderData: {
            title: '',
            description: '',
            priority: 'Medium',
            asset_id: '',
            asset_name: '',
            work_order_type: 'Corrective',
            due_date: '',
            assigned_to: '',
            work_instructions: ''
        },
        conversationHistory: []
    };

    function openAIAssistant() {
        const modal = document.getElementById('aiAssistantModal');
        modal.style.display = 'block';
        resetAIConversation();

        // Focus on input
        setTimeout(() => {
            document.getElementById('userMessage').focus();
        }, 300);
    }

    function closeAIAssistant() {
        document.getElementById('aiAssistantModal').style.display = 'none';
    }

    function resetAIConversation() {
        aiConversationState = {
            step: 0,
            workOrderData: {
                title: '',
                description: '',
                priority: 'Medium',
                asset_id: '',
                asset_name: '',
                work_order_type: 'Corrective',
                due_date: '',
                assigned_to: '',
                work_instructions: ''
            },
            conversationHistory: []
        };

        document.getElementById('chatHistory').innerHTML = '';
        document.getElementById('aiQuickActions').style.display = 'none';

        // Start conversation
        addAIMessage("Hello! I'm your AI assistant for creating work orders. Tell me about the maintenance issue you need to report, and I'll help you create a work order.\n\nYou can describe the problem in your own words - for example:\n‚Ä¢ \"The conveyor belt is making a grinding noise\"\n‚Ä¢ \"HVAC unit in Building B needs filter replacement\"\n‚Ä¢ \"Forklift #3 won't start\"");
    }

    function addAIMessage(message, isUser = false) {
        const chatHistory = document.getElementById('chatHistory');
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${isUser ? 'user' : 'assistant'}`;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.innerHTML = isUser ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = message.replace(/\n/g, '<br>');

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);

        // Scroll to bottom
        chatHistory.scrollTop = chatHistory.scrollHeight;

        // Store in history
        aiConversationState.conversationHistory.push({
            role: isUser ? 'user' : 'assistant',
            content: message
        });
    }

    function showTypingIndicator() {
        const chatHistory = document.getElementById('chatHistory');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="avatar"><i class="fas fa-robot"></i></div>
            <div class="bubble">
                <div class="ai-typing">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatHistory.appendChild(typingDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    async function sendAIMessage() {
        const input = document.getElementById('userMessage');
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        addAIMessage(message, true);
        input.value = '';

        // Show typing indicator
        showTypingIndicator();

        try {
            // Call AI endpoint with context about work order creation
            const response = await fetch('/ai/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    context: {
                        task: 'work_order_creation',
                        current_data: aiConversationState.workOrderData,
                        conversation_history: aiConversationState.conversationHistory.slice(-6),
                        available_assets: availableAssets || [],
                        instructions: `You are helping a technician create a work order. Based on their input, extract relevant information and ask follow-up questions if needed.

                        Extract these fields from their description:
                        - title: A short descriptive title for the work order
                        - description: Detailed description of the issue
                        - priority: Critical, High, Medium, or Low
                        - work_order_type: Corrective, Preventive, Emergency, Inspection, or Installation
                        - asset_name: The equipment/asset mentioned

                        After gathering enough information, summarize what you'll create and ask for confirmation.

                        IMPORTANT: Include a JSON block at the end of your response with extracted data in this format:
                        \`\`\`json
                        {"title": "...", "description": "...", "priority": "...", "work_order_type": "...", "asset_name": "...", "ready_to_create": true/false}
                        \`\`\`

                        Set ready_to_create to true only when you have enough information for a complete work order.`
                    }
                })
            });

            removeTypingIndicator();

            if (response.ok) {
                const data = await response.json();
                let aiResponse = data.response || data.message || "I'm sorry, I couldn't process that. Could you try again?";

                // Try to extract JSON data from response
                const jsonMatch = aiResponse.match(/```json\s*([\s\S]*?)\s*```/);
                if (jsonMatch) {
                    try {
                        const extractedData = JSON.parse(jsonMatch[1]);

                        // Update work order data
                        if (extractedData.title) aiConversationState.workOrderData.title = extractedData.title;
                        if (extractedData.description) aiConversationState.workOrderData.description = extractedData.description;
                        if (extractedData.priority) aiConversationState.workOrderData.priority = extractedData.priority;
                        if (extractedData.work_order_type) aiConversationState.workOrderData.work_order_type = extractedData.work_order_type;
                        if (extractedData.asset_name) aiConversationState.workOrderData.asset_name = extractedData.asset_name;

                        // Remove JSON from displayed message
                        aiResponse = aiResponse.replace(/```json[\s\S]*?```/g, '').trim();

                        // Show quick actions if ready to create
                        if (extractedData.ready_to_create) {
                            document.getElementById('aiQuickActions').style.display = 'block';

                            // Add work order preview card
                            aiResponse += generateWorkOrderPreview();
                        }
                    } catch (e) {
                        console.log('Could not parse JSON from AI response');
                    }
                }

                addAIMessage(aiResponse);
            } else {
                // Fallback to local processing
                processMessageLocally(message);
            }
        } catch (error) {
            console.error('AI Error:', error);
            removeTypingIndicator();
            processMessageLocally(message);
        }
    }

    function processMessageLocally(message) {
        // Local fallback processing
        const lowerMessage = message.toLowerCase();
        const data = aiConversationState.workOrderData;

        // Extract information from message
        if (!data.title && message.length > 5) {
            // Create title from first sentence
            const firstSentence = message.split(/[.!?]/)[0].trim();
            data.title = firstSentence.length > 50 ? firstSentence.substring(0, 50) + '...' : firstSentence;
            data.description = message;
        }

        // Detect priority keywords
        if (lowerMessage.includes('urgent') || lowerMessage.includes('emergency') || lowerMessage.includes('critical') || lowerMessage.includes('dangerous')) {
            data.priority = 'Critical';
        } else if (lowerMessage.includes('important') || lowerMessage.includes('asap') || lowerMessage.includes('high')) {
            data.priority = 'High';
        } else if (lowerMessage.includes('low') || lowerMessage.includes('when possible') || lowerMessage.includes('minor')) {
            data.priority = 'Low';
        }

        // Detect work order type
        if (lowerMessage.includes('emergency') || lowerMessage.includes('urgent')) {
            data.work_order_type = 'Emergency';
        } else if (lowerMessage.includes('inspect') || lowerMessage.includes('check')) {
            data.work_order_type = 'Inspection';
        } else if (lowerMessage.includes('install') || lowerMessage.includes('setup')) {
            data.work_order_type = 'Installation';
        } else if (lowerMessage.includes('preventive') || lowerMessage.includes('pm') || lowerMessage.includes('scheduled')) {
            data.work_order_type = 'Preventive';
        }

        // Generate response
        let response = '';

        if (aiConversationState.step === 0) {
            response = `Got it! I understand you're reporting: "${data.title}"\n\n`;
            response += `I've set this as a **${data.priority} priority ${data.work_order_type} Maintenance** work order.\n\n`;
            response += `Is there any specific equipment or asset this relates to? (You can also say "no specific asset" to skip)`;
            aiConversationState.step = 1;
        } else if (aiConversationState.step === 1) {
            if (!lowerMessage.includes('no') && !lowerMessage.includes('skip')) {
                data.asset_name = message;
                response = `Great, I'll associate this with "${data.asset_name}".\n\n`;
            } else {
                response = `Okay, no specific asset selected.\n\n`;
            }
            response += `Any additional instructions or safety notes for the technician?`;
            aiConversationState.step = 2;
        } else {
            if (!lowerMessage.includes('no') && !lowerMessage.includes('skip') && message.length > 3) {
                data.work_instructions = message;
            }

            response = `Perfect! Here's the work order I'll create:`;
            response += generateWorkOrderPreview();
            response += `\n\nClick "Create Work Order" to submit, or "Edit Details" to make changes.`;

            document.getElementById('aiQuickActions').style.display = 'block';
            aiConversationState.step = 3;
        }

        addAIMessage(response);
    }

    function generateWorkOrderPreview() {
        const data = aiConversationState.workOrderData;
        return `
            <div class="wo-preview-card">
                <h4><i class="fas fa-clipboard-list"></i> Work Order Preview</h4>
                <div class="wo-preview-field">
                    <span class="label">Title:</span>
                    <span class="value">${data.title || 'Not set'}</span>
                </div>
                <div class="wo-preview-field">
                    <span class="label">Type:</span>
                    <span class="value">${data.work_order_type}</span>
                </div>
                <div class="wo-preview-field">
                    <span class="label">Priority:</span>
                    <span class="value">${data.priority}</span>
                </div>
                <div class="wo-preview-field">
                    <span class="label">Asset:</span>
                    <span class="value">${data.asset_name || 'Not specified'}</span>
                </div>
                ${data.work_instructions ? `
                <div class="wo-preview-field">
                    <span class="label">Instructions:</span>
                    <span class="value">${data.work_instructions.substring(0, 50)}${data.work_instructions.length > 50 ? '...' : ''}</span>
                </div>
                ` : ''}
            </div>
        `;
    }

    async function confirmCreateWorkOrder() {
        const data = aiConversationState.workOrderData;

        if (!data.title) {
            addAIMessage("I need at least a title to create the work order. Could you describe the issue?");
            return;
        }

        showTypingIndicator();

        try {
            // Create the work order
            const formData = new FormData();
            formData.append('title', data.title);
            formData.append('description', data.description || data.title);
            formData.append('priority', data.priority);
            formData.append('work_order_type', data.work_order_type);
            formData.append('status', 'Open');

            if (data.work_instructions) {
                formData.append('work_instructions', data.work_instructions);
            }

            // Determine correct endpoint based on current URL
            const isDemo = window.location.pathname.includes('/demo/');
            const endpoint = isDemo ? '/demo/work-orders/create' : '/work-orders';

            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData
            });

            removeTypingIndicator();

            if (response.ok || response.redirected) {
                addAIMessage(`<div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                    <strong><i class="fas fa-check-circle" style="color: #28a745;"></i> Work Order Created Successfully!</strong><br><br>
                    Your work order "${data.title}" has been submitted. A technician will be notified shortly.
                </div>`);

                document.getElementById('aiQuickActions').style.display = 'none';

                // Refresh the page after a delay to show the new work order
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                throw new Error('Failed to create work order');
            }
        } catch (error) {
            removeTypingIndicator();
            addAIMessage(`<div style="background: #f8d7da; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545;">
                <strong><i class="fas fa-exclamation-circle" style="color: #dc3545;"></i> Error</strong><br>
                There was a problem creating the work order. Would you like me to try again?
            </div>`);
        }
    }

    function editWorkOrderDetails() {
        closeAIAssistant();

        // Open the manual form and pre-fill with AI-gathered data
        const form = document.getElementById('create-wo-form');
        form.style.display = 'block';

        const data = aiConversationState.workOrderData;

        // Pre-fill form fields
        const titleField = document.getElementById('wo-title');
        const descField = document.getElementById('wo-description');
        const priorityField = document.getElementById('wo-priority');
        const typeField = document.getElementById('wo-type');
        const instructionsField = document.getElementById('wo-instructions');

        if (titleField && data.title) titleField.value = data.title;
        if (descField && data.description) descField.value = data.description;
        if (priorityField && data.priority) priorityField.value = data.priority;
        if (typeField && data.work_order_type) typeField.value = data.work_order_type;
        if (instructionsField && data.work_instructions) instructionsField.value = data.work_instructions;

        // Update toggle button state
        document.getElementById('toggleCreateWOIcon').classList.remove('fa-plus');
        document.getElementById('toggleCreateWOIcon').classList.add('fa-minus');
        document.getElementById('toggleCreateWOText').textContent = 'Hide Form';

        // Scroll to form
        form.scrollIntoView({ behavior: 'smooth' });
    }

    function setQuickPrompt(prompt) {
        document.getElementById('userMessage').value = prompt;
        document.getElementById('userMessage').focus();
    }

    function startVoiceInput() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Voice input is not supported in your browser. Please use Chrome or Edge.');
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = 'en-US';

        const voiceBtn = document.getElementById('voiceInputBtn');
        voiceBtn.innerHTML = '<i class="fas fa-microphone-slash" style="color: #dc3545;"></i>';
        voiceBtn.style.background = '#ffe6e6';

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('userMessage').value = transcript;
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.style.background = '';
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.style.background = '';
        };

        recognition.onend = () => {
            voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceBtn.style.background = '';
        };

        recognition.start();
    }

    // Store available assets for AI context
    let availableAssets = [];

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadInitialData();
        
        // Set up form validation
        const form = document.getElementById('create-wo-form');
        form.addEventListener('submit', function(e) {
            // Validate parts quantities before submission
            const partRows = document.querySelectorAll('.parts-row');
            let hasErrors = false;
            
            partRows.forEach(row => {
                const select = row.querySelector('.part-select');
                const input = row.querySelector('input[type="number"]');
                
                if (select.value && input.value) {
                    const stockDisplay = row.querySelector('.stock-display');
                    const availableStock = parseInt(stockDisplay.textContent) || 0;
                    const requestedQty = parseInt(input.value) || 0;
                    
                    if (requestedQty > availableStock) {
                        hasErrors = true;
                        input.style.borderColor = '#dc3545';
                    }
                }
            });
            
            if (hasErrors) {
                e.preventDefault();
                alert('Please check part quantities. Some requested quantities exceed available stock.');
            }
        });
        
        // Set up completion form submission
        const completionForm = document.getElementById('completion-form');
        completionForm.addEventListener('submit', function(e) {
            // Collect parts data
            const partRows = document.querySelectorAll('.completion-parts-row');
            const partsData = [];
            
            partRows.forEach(row => {
                const partId = row.querySelector('.completion-part-select').value;
                const quantity = row.querySelector('input[type="number"]').value;
                
                if (partId && quantity && parseInt(quantity) > 0) {
                    partsData.push({
                        part_id: partId,
                        quantity_used: parseInt(quantity)
                    });
                }
            });
            
            // Add parts data as hidden input
            let partsInput = document.querySelector('input[name="completion_parts_data"]');
            if (!partsInput) {
                partsInput = document.createElement('input');
                partsInput.type = 'hidden';
                partsInput.name = 'completion_parts_data';
                completionForm.appendChild(partsInput);
            }
            partsInput.value = JSON.stringify(partsData);
            
            // Validate required fields
            const workSummary = document.getElementById('completion-work-summary').value.trim();
            if (workSummary.length < 20) {
                e.preventDefault();
                alert('Please provide a detailed work summary (at least 20 characters).');
                return;
            }
            
            const actualHours = document.getElementById('completion-actual-hours').value;
            if (!actualHours || parseFloat(actualHours) <= 0) {
                e.preventDefault();
                alert('Please enter the actual hours worked.');
                return;
            }
        });
    });
</script>
{% endblock %}