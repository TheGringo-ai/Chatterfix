# Optimized Cloud Build Configuration for ChatterFix
# Fast, parallel, and automated CI/CD pipeline
# Target: <3 minutes build+deploy time

steps:
  # Pre-build setup and validation
  - name: 'gcr.io/cloud-builders/git'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸš€ Starting ChatterFix optimized build pipeline"
      echo "Commit: $COMMIT_SHA"
      echo "Branch: $BRANCH_NAME"
      git log --oneline -1
    id: 'setup'

  # Parallel security and code quality checks
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸ” Running security and quality checks..."
      # Basic security scan
      if command -v trivy >/dev/null 2>&1; then
        trivy fs --exit-code 1 --severity HIGH,CRITICAL . || echo "âš ï¸ Security issues detected"
      fi
      # Check for secrets
      if grep -r --include="*.py" --include="*.js" -i "api[_-]key\|password\|secret" . | grep -v "example\|test\|placeholder"; then
        echo "âš ï¸ Potential secrets detected in code"
      fi
    id: 'security-check'
    waitFor: ['setup']

  # Build main application image with optimizations
  - name: 'gcr.io/cloud-builders/docker'
    args: 
    - 'build'
    - '--platform=linux/amd64'
    - '-t'
    - 'gcr.io/$PROJECT_ID/gringo-core:$COMMIT_SHA'
    - '-t'
    - 'gcr.io/$PROJECT_ID/gringo-core:latest'
    - '-f'
    - 'Dockerfile.optimized'
    - '--cache-from'
    - 'gcr.io/$PROJECT_ID/gringo-core:latest'
    - '--build-arg'
    - 'BUILDKIT_INLINE_CACHE=1'
    - '.'
    id: 'build-main'
    waitFor: ['security-check']

  # Build AI team service (if exists and changed)
  - name: 'bash'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      if [[ -d "ai-team-service" ]] && [[ -n "$(find ai-team-service -name '*.py' -newer ai-team-service/.last-deploy 2>/dev/null || echo 'build')" ]]; then
        echo "ðŸ¤– Building AI Team service..."
        cd ai-team-service
        docker build --platform linux/amd64 \
          -t gcr.io/$PROJECT_ID/ai-team-service:$COMMIT_SHA \
          -t gcr.io/$PROJECT_ID/ai-team-service:latest \
          --cache-from gcr.io/$PROJECT_ID/ai-team-service:latest \
          .
        echo "âœ… AI Team service build completed"
        touch .last-deploy
      else
        echo "â„¹ï¸  AI Team service unchanged - skipping build"
      fi
    env:
    - 'PROJECT_ID=$PROJECT_ID'
    - 'COMMIT_SHA=$COMMIT_SHA'
    id: 'build-ai-service'
    waitFor: ['security-check']

  # Run tests on built images
  - name: 'gcr.io/$PROJECT_ID/gringo-core:$COMMIT_SHA'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸ§ª Running application tests..."
      # Health check test
      python -c "
      import requests
      import sys
      from main import app
      from fastapi.testclient import TestClient
      
      client = TestClient(app)
      try:
          response = client.get('/health')
          assert response.status_code == 200
          print('âœ… Health check test passed')
      except Exception as e:
          print(f'âŒ Health check test failed: {e}')
          sys.exit(1)
      "
    id: 'test-main'
    waitFor: ['build-main']

  # Push images in parallel
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '--all-tags', 'gcr.io/$PROJECT_ID/gringo-core']
    id: 'push-main'
    waitFor: ['test-main']

  - name: 'bash'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      if docker images gcr.io/$PROJECT_ID/ai-team-service:$COMMIT_SHA --format="table" | grep -q $COMMIT_SHA; then
        echo "ðŸš€ Pushing AI Team service..."
        docker push --all-tags gcr.io/$PROJECT_ID/ai-team-service
        echo "âœ… AI Team service pushed"
      else
        echo "â„¹ï¸  No AI Team service to push"
      fi
    env:
    - 'PROJECT_ID=$PROJECT_ID'
    - 'COMMIT_SHA=$COMMIT_SHA'
    id: 'push-ai-service'
    waitFor: ['build-ai-service']

  # Deploy AI service first (if updated)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      if docker images gcr.io/$PROJECT_ID/ai-team-service:$COMMIT_SHA --format="table" | grep -q $COMMIT_SHA; then
        echo "ðŸš¢ Deploying AI Team service..."
        gcloud run deploy ai-team-service \
          --image gcr.io/$PROJECT_ID/ai-team-service:$COMMIT_SHA \
          --platform managed \
          --region $_DEPLOY_REGION \
          --allow-unauthenticated \
          --memory 2Gi \
          --cpu 2 \
          --timeout 300 \
          --concurrency 80 \
          --min-instances 0 \
          --max-instances 10 \
          --quiet
        echo "âœ… AI Team service deployed"
      else
        echo "â„¹ï¸  AI Team service not updated - skipping deployment"
      fi
    env:
    - '_DEPLOY_REGION=$_DEPLOY_REGION'
    id: 'deploy-ai-service'
    waitFor: ['push-ai-service']

  # Deploy main application with blue-green deployment
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸš¢ Deploying ChatterFix main service with blue-green strategy..."
      
      # Get AI Team service URL if it exists
      AI_TEAM_URL=$(gcloud run services describe ai-team-service --region $_DEPLOY_REGION --format="value(status.url)" 2>/dev/null || echo "")
      
      # Deploy with traffic initially set to 0%
      gcloud run deploy gringo-core \
        --image gcr.io/$PROJECT_ID/gringo-core:$COMMIT_SHA \
        --platform managed \
        --region $_DEPLOY_REGION \
        --allow-unauthenticated \
        --memory 1.5Gi \
        --cpu 1 \
        --timeout 300 \
        --concurrency 100 \
        --min-instances 1 \
        --max-instances 10 \
        --set-env-vars "AI_TEAM_SERVICE_URL=$AI_TEAM_URL,DISABLE_AI_TEAM_GRPC=true,INTERNAL_API_KEY=ai-team-service-key-change-me,ENVIRONMENT=production" \
        --port 8080 \
        --no-traffic \
        --tag blue \
        --quiet
      
      echo "âœ… Blue deployment completed"
    env:
    - '_DEPLOY_REGION=$_DEPLOY_REGION'
    id: 'deploy-main-blue'
    waitFor: ['push-main', 'deploy-ai-service']

  # Health check and smoke tests
  - name: 'gcr.io/cloud-builders/curl'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸ©º Running health checks on blue deployment..."
      
      # Get blue service URL
      BLUE_URL=$(gcloud run services describe gringo-core --region $_DEPLOY_REGION --format="value(status.traffic[0].url)" 2>/dev/null)
      
      if [[ -z "$BLUE_URL" ]]; then
        echo "âŒ Could not get blue deployment URL"
        exit 1
      fi
      
      echo "Testing: $BLUE_URL"
      
      # Wait for service to be ready
      for i in {1..30}; do
        if curl -f -s --connect-timeout 5 --max-time 10 "$BLUE_URL/health" > /dev/null; then
          echo "âœ… Health check passed"
          break
        fi
        echo "â³ Waiting for service to be ready... (attempt $i/30)"
        sleep 5
      done
      
      # Additional smoke tests
      echo "ðŸ§ª Running smoke tests..."
      
      # Test main page
      if curl -f -s --connect-timeout 5 --max-time 10 "$BLUE_URL/" > /dev/null; then
        echo "âœ… Main page accessible"
      else
        echo "âŒ Main page test failed"
        exit 1
      fi
      
      # Test API endpoints
      if curl -f -s --connect-timeout 5 --max-time 10 "$BLUE_URL/demo" > /dev/null; then
        echo "âœ… Demo endpoint accessible"
      else
        echo "âš ï¸  Demo endpoint test failed"
      fi
      
      echo "âœ… All health checks passed"
    env:
    - '_DEPLOY_REGION=$_DEPLOY_REGION'
    id: 'health-check'
    waitFor: ['deploy-main-blue']

  # Switch traffic to blue deployment (green->blue)
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸ”„ Switching traffic to blue deployment..."
      
      # Switch 100% traffic to blue
      gcloud run services update-traffic gringo-core \
        --region $_DEPLOY_REGION \
        --to-tags blue=100 \
        --quiet
      
      echo "âœ… Traffic switched to blue deployment"
      
      # Get final service URL
      SERVICE_URL=$(gcloud run services describe gringo-core --region $_DEPLOY_REGION --format="value(status.url)")
      echo "ðŸŒ Service available at: $SERVICE_URL"
    env:
    - '_DEPLOY_REGION=$_DEPLOY_REGION'
    id: 'switch-traffic'
    waitFor: ['health-check']

  # Final validation and cleanup
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
    - '-c'
    - |
      echo "ðŸ” Final deployment validation..."
      
      SERVICE_URL=$(gcloud run services describe gringo-core --region $_DEPLOY_REGION --format="value(status.url)")
      AI_SERVICE_URL=$(gcloud run services describe ai-team-service --region $_DEPLOY_REGION --format="value(status.url)" 2>/dev/null || echo "")
      
      # Final health checks
      if curl -f -s "$SERVICE_URL/health" > /dev/null; then
        echo "âœ… Production health check passed"
      else
        echo "âŒ Production health check failed"
        exit 1
      fi
      
      # Integration test
      if [[ -n "$AI_SERVICE_URL" ]] && curl -f -s "$SERVICE_URL/ai-team" > /dev/null; then
        echo "âœ… Service integration validated"
      fi
      
      echo ""
      echo "ðŸŽ‰ Deployment completed successfully!"
      echo "=================================="
      echo "Main Service: $SERVICE_URL"
      if [[ -n "$AI_SERVICE_URL" ]]; then
        echo "AI Service: $AI_SERVICE_URL"
      fi
      echo "Environment: Production"
      echo "Version: $COMMIT_SHA"
      echo ""
      
      # Performance metrics
      BUILD_DURATION=$(expr $(date +%s) - $BUILD_START_TIME)
      echo "ðŸ“Š Build Duration: ${BUILD_DURATION}s"
    env:
    - '_DEPLOY_REGION=$_DEPLOY_REGION'
    - 'BUILD_START_TIME=$BUILD_START_TIME'
    id: 'final-validation'
    waitFor: ['switch-traffic']

# Build optimizations
options:
  # Use high-performance machine type
  machineType: 'E2_HIGHCPU_8'
  
  # Optimize disk performance
  diskSizeGb: 100
  
  # Parallel execution
  substitutionOption: 'ALLOW_LOOSE'
  
  # Logging optimization
  logging: 'CLOUD_LOGGING_ONLY'
  
  # Environment variables
  env:
  - 'BUILD_START_TIME=$(date +%s)'

# Advanced settings
timeout: '1800s'  # 30 minutes max

# Substitutions for flexibility
substitutions:
  _DEPLOY_REGION: 'us-central1'
  _SERVICE_NAME: 'gringo-core'
  _AI_SERVICE_NAME: 'ai-team-service'

# Trigger settings for automatic builds
trigger:
  github:
    owner: 'your-github-username'  # Update with actual GitHub username
    name: 'ChatterFix'
    push:
      branch: '^main$'
  includedFiles:
  - '**/*.py'
  - 'requirements.txt'
  - 'Dockerfile*'
  - 'static/**'
  - 'templates/**'
  - 'app/**'
  ignoredFiles:
  - 'README.md'
  - 'docs/**'
  - '**/*.md'
  - '.gitignore'
  - 'logs/**'
  - '__pycache__/**'