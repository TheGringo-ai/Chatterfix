<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix It Fred & Grok Mobile Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .header {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .budget-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            font-size: 12px;
            text-align: center;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .user-message {
            background: #007AFF;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .bot-message {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .fred-message {
            background: #34C759;
            color: white;
        }

        .grok-message {
            background: #FF9500;
            color: white;
        }

        .input-container {
            padding: 15px;
            background: white;
            border-radius: 0 0 20px 20px;
            border-top: 1px solid #e0e0e0;
        }

        .chat-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .ai-selector {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        .send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            margin-bottom: 10px;
            text-align: center;
        }

        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .status.budget-warning { background: #fff3cd; color: #856404; }
        .status.budget-critical { background: #f8d7da; color: #721c24; }

        .quick-actions {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .quick-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            padding: 5px 10px;
            font-size: 11px;
            cursor: pointer;
            flex: 1;
            min-width: 60px;
        }

        .quick-btn:active {
            background: #e0e0e0;
        }

        .loading {
            display: none;
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 10px;
        }

        @media (max-width: 480px) {
            .container {
                height: 100vh;
                border-radius: 0;
            }
            .header {
                border-radius: 0;
            }
            .input-container {
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>ü§ñ Fix It Fred & Grok</h2>
            <div id="budget-display">Budget Tracking Active</div>
        </div>
        
        <div class="budget-info" id="budget-info">
            üí∞ Token Limit: 1000/day | Used: <span id="tokens-used">0</span> | Remaining: <span id="tokens-remaining">1000</span>
        </div>

        <div class="chat-container" id="chat-container">
            <div class="status online" id="connection-status">
                üü¢ Connected to Fix It Fred & Grok
            </div>
            
            <div class="message bot-message">
                üëã Hey! I'm your budget-friendly AI assistant. Choose Fix It Fred for CMMS help or Grok for infrastructure advice. I'll track your usage to keep costs low! üí∏
            </div>
        </div>

        <div class="input-container">
            <div class="quick-actions">
                <button class="quick-btn" onclick="quickMessage('Check VM status')">üìä Status</button>
                <button class="quick-btn" onclick="quickMessage('Any issues?')">üö® Issues</button>
                <button class="quick-btn" onclick="quickMessage('Help me')">‚ùì Help</button>
                <button class="quick-btn" onclick="quickMessage('Budget status')">üí∞ Budget</button>
            </div>
            
            <div class="chat-controls">
                <select class="ai-selector" id="ai-selector">
                    <option value="fred">üîß Fix It Fred (CMMS)</option>
                    <option value="grok">üß† Grok (Infrastructure)</option>
                    <option value="auto">ü§ñ Auto-Select</option>
                </select>
            </div>
            
            <div class="input-row">
                <input type="text" class="message-input" id="message-input" 
                       placeholder="Ask Fred or Grok anything..." 
                       onkeypress="handleKeyPress(event)">
                <button class="send-btn" id="send-btn" onclick="sendMessage()">
                    <span>üì§</span>
                </button>
            </div>
            
            <div class="loading" id="loading">
                ü§ñ AI is thinking...
            </div>
        </div>
    </div>

    <script>
        // Configuration - Update these with your server details
        const CONFIG = {
            fredUrl: 'http://localhost:8080',  // Fix It Fred
            grokUrl: 'http://localhost:8006',  // Grok
            budgetUrl: 'http://localhost:8009', // Budget tracker (we'll create this)
            maxTokensPerDay: 1000,
            maxTokensPerRequest: 150
        };

        // Budget tracking
        let budgetData = {
            tokensUsed: 0,
            tokensRemaining: 1000,
            dailyLimit: 1000,
            requestCount: 0
        };

        // Load budget from localStorage
        function loadBudget() {
            const saved = localStorage.getItem('grok_budget_' + new Date().toDateString());
            if (saved) {
                budgetData = JSON.parse(saved);
            }
            updateBudgetDisplay();
        }

        // Save budget to localStorage
        function saveBudget() {
            localStorage.setItem('grok_budget_' + new Date().toDateString(), JSON.stringify(budgetData));
            updateBudgetDisplay();
        }

        // Update budget display
        function updateBudgetDisplay() {
            document.getElementById('tokens-used').textContent = budgetData.tokensUsed;
            document.getElementById('tokens-remaining').textContent = budgetData.tokensRemaining;
            
            const budgetInfo = document.getElementById('budget-info');
            const percentage = (budgetData.tokensUsed / budgetData.dailyLimit) * 100;
            
            if (percentage > 90) {
                budgetInfo.className = 'budget-info budget-critical';
                budgetInfo.innerHTML = `üö® BUDGET CRITICAL: ${budgetData.tokensUsed}/${budgetData.dailyLimit} tokens used!`;
            } else if (percentage > 70) {
                budgetInfo.className = 'budget-info budget-warning';
                budgetInfo.innerHTML = `‚ö†Ô∏è Budget Warning: ${budgetData.tokensUsed}/${budgetData.dailyLimit} tokens used`;
            } else {
                budgetInfo.innerHTML = `üí∞ Token Limit: ${budgetData.dailyLimit}/day | Used: ${budgetData.tokensUsed} | Remaining: ${budgetData.tokensRemaining}`;
            }
        }

        // Check if we can make a request
        function canMakeRequest(estimatedTokens = 50) {
            if (budgetData.tokensUsed + estimatedTokens > budgetData.dailyLimit) {
                addMessage('system', 'üö® Daily token limit reached! Try again tomorrow or increase your budget.', 'budget-critical');
                return false;
            }
            return true;
        }

        // Add message to chat
        function addMessage(sender, message, className = '') {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            
            if (sender === 'user') {
                messageDiv.className = 'message user-message';
            } else if (sender === 'fred') {
                messageDiv.className = 'message fred-message';
            } else if (sender === 'grok') {
                messageDiv.className = 'message grok-message';
            } else {
                messageDiv.className = `message bot-message ${className}`;
            }
            
            messageDiv.innerHTML = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Estimate tokens (rough approximation)
        function estimateTokens(text) {
            return Math.ceil(text.length / 4); // Rough estimate: 4 chars = 1 token
        }

        // Send message to AI
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');
            const aiSelector = document.getElementById('ai-selector');
            
            const message = input.value.trim();
            if (!message) return;

            const estimatedTokens = estimateTokens(message);
            if (!canMakeRequest(estimatedTokens)) return;

            // Disable input
            input.disabled = true;
            sendBtn.disabled = true;
            loading.style.display = 'block';

            // Add user message
            addMessage('user', message);
            input.value = '';

            try {
                const selectedAI = aiSelector.value;
                let response;

                if (selectedAI === 'fred' || (selectedAI === 'auto' && message.toLowerCase().includes('work order'))) {
                    response = await sendToFred(message);
                    addMessage('fred', response.response || response.message || 'Fred is thinking...');
                } else if (selectedAI === 'grok' || (selectedAI === 'auto' && message.toLowerCase().includes('infrastructure'))) {
                    response = await sendToGrok(message);
                    addMessage('grok', response.response || response.grok_response || 'Grok is analyzing...');
                } else {
                    // Auto-select based on content
                    response = await sendToFred(message);
                    addMessage('fred', response.response || response.message || 'AI is responding...');
                }

                // Update budget
                const tokensUsed = estimateTokens(message + (response.response || ''));
                budgetData.tokensUsed += tokensUsed;
                budgetData.tokensRemaining = budgetData.dailyLimit - budgetData.tokensUsed;
                budgetData.requestCount += 1;
                saveBudget();

            } catch (error) {
                console.error('Error:', error);
                addMessage('system', '‚ùå Connection error. Check if your services are running!', 'offline');
            }

            // Re-enable input
            input.disabled = false;
            sendBtn.disabled = false;
            loading.style.display = 'none';
            input.focus();
        }

        // Send to Fix It Fred
        async function sendToFred(message) {
            const response = await fetch(`${CONFIG.fredUrl}/api/ai-assist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    context: 'mobile_chat',
                    budget_mode: true
                })
            });
            
            if (!response.ok) {
                throw new Error(`Fred error: ${response.status}`);
            }
            
            return await response.json();
        }

        // Send to Grok
        async function sendToGrok(message) {
            const response = await fetch(`${CONFIG.grokUrl}/mobile/grok-bridge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    context: 'mobile_budget_chat'
                })
            });
            
            if (!response.ok) {
                throw new Error(`Grok error: ${response.status}`);
            }
            
            return await response.json();
        }

        // Quick message buttons
        function quickMessage(message) {
            document.getElementById('message-input').value = message;
            sendMessage();
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Check connection status
        async function checkStatus() {
            try {
                const fredResponse = await fetch(`${CONFIG.fredUrl}/health`);
                const grokResponse = await fetch(`${CONFIG.grokUrl}/mobile/fred-status`);
                
                const fredOnline = fredResponse.ok;
                const grokOnline = grokResponse.ok;
                
                const statusElement = document.getElementById('connection-status');
                if (fredOnline && grokOnline) {
                    statusElement.className = 'status online';
                    statusElement.textContent = 'üü¢ Fred & Grok Online';
                } else if (fredOnline) {
                    statusElement.className = 'status online';
                    statusElement.textContent = 'üü° Fred Online, Grok Offline';
                } else if (grokOnline) {
                    statusElement.className = 'status online';
                    statusElement.textContent = 'üü° Grok Online, Fred Offline';
                } else {
                    statusElement.className = 'status offline';
                    statusElement.textContent = 'üî¥ Both Offline';
                }
            } catch (error) {
                const statusElement = document.getElementById('connection-status');
                statusElement.className = 'status offline';
                statusElement.textContent = 'üî¥ Connection Error';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadBudget();
            checkStatus();
            setInterval(checkStatus, 30000); // Check every 30 seconds
            
            // Focus on input
            document.getElementById('message-input').focus();
            
            // Welcome message based on budget
            if (budgetData.tokensUsed === 0) {
                addMessage('system', 'üí∏ Budget Mode Active! You have 1000 tokens per day. Each message uses ~50 tokens. Ask smart, specific questions to save money!');
            }
        });
    </script>
</body>
</html>