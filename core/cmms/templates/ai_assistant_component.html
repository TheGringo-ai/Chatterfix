<!-- ChatterFix AI Assistant Component -->
<!-- This component can be included in any CMMS page for universal AI assistance -->

<style>
/* AI Assistant Styles */
.ai-assistant-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.ai-assistant-fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    position: relative;
}

.ai-assistant-fab:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
}

.ai-assistant-fab.has-notification::after {
    content: '';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 12px;
    height: 12px;
    background: #ff4757;
    border-radius: 50%;
    border: 2px solid white;
}

.ai-chat-window {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 380px;
    height: 500px;
    background: rgba(16, 33, 62, 0.95);
    backdrop-filter: blur(20px);
    border-radius: 16px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    display: none;
    flex-direction: column;
    z-index: 999;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ai-chat-header {
    display: flex;
    align-items: center;
    justify-content: between;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(102, 126, 234, 0.2);
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    border-radius: 16px 16px 0 0;
}

.ai-chat-title {
    flex: 1;
    font-weight: 600;
    color: #ffffff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.ai-status-indicator {
    width: 8px;
    height: 8px;
    background: #00d4aa;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.ai-chat-close {
    background: none;
    border: none;
    color: #b0b0b0;
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
    border-radius: 4px;
    transition: color 0.2s ease;
}

.ai-chat-close:hover {
    color: #ffffff;
}

.ai-chat-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ai-chat-messages {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ai-message {
    max-width: 85%;
    padding: 12px 16px;
    border-radius: 16px;
    word-wrap: break-word;
    animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ai-message.user {
    align-self: flex-end;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
}

.ai-message.assistant {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.08);
    color: #ffffff;
    border-bottom-left-radius: 4px;
}

.ai-suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
}

.ai-suggestion-btn {
    background: rgba(102, 126, 234, 0.2);
    border: 1px solid rgba(102, 126, 234, 0.3);
    color: #667eea;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.ai-suggestion-btn:hover {
    background: rgba(102, 126, 234, 0.3);
    color: #ffffff;
}

.ai-chat-input {
    padding: 16px;
    border-top: 1px solid rgba(102, 126, 234, 0.2);
}

.ai-input-container {
    display: flex;
    gap: 8px;
    align-items: center;
}

.ai-input-field {
    flex: 1;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 20px;
    padding: 10px 16px;
    color: #ffffff;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s ease;
}

.ai-input-field:focus {
    border-color: #667eea;
}

.ai-input-field::placeholder {
    color: #808080;
}

.ai-send-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s ease;
}

.ai-send-btn:hover {
    transform: scale(1.05);
}

.ai-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.ai-voice-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.2);
    color: #667eea;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.ai-voice-btn:hover {
    background: rgba(102, 126, 234, 0.2);
    color: #ffffff;
}

.ai-voice-btn.recording {
    background: #ff4757;
    color: white;
    animation: pulse 1s infinite;
}

.ai-typing-indicator {
    display: none;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    color: #b0b0b0;
    font-style: italic;
}

.ai-typing-dots {
    display: flex;
    gap: 4px;
}

.ai-typing-dots span {
    width: 4px;
    height: 4px;
    background: #667eea;
    border-radius: 50%;
    animation: typingDots 1.4s infinite;
}

.ai-typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.ai-typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingDots {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.ai-quick-actions {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid rgba(102, 126, 234, 0.1);
    flex-wrap: wrap;
}

.ai-quick-action {
    background: rgba(102, 126, 234, 0.1);
    border: 1px solid rgba(102, 126, 234, 0.2);
    color: #667eea;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 4px;
}

.ai-quick-action:hover {
    background: rgba(102, 126, 234, 0.2);
    color: #ffffff;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .ai-chat-window {
        width: calc(100vw - 40px);
        right: 20px;
        left: 20px;
        height: 70vh;
        bottom: 90px;
    }
    
    .ai-assistant-fab {
        bottom: 20px;
        right: 20px;
    }
}

/* Context awareness indicator */
.ai-context-indicator {
    font-size: 10px;
    color: #00d4aa;
    margin-left: 8px;
    padding: 2px 6px;
    background: rgba(0, 212, 170, 0.1);
    border-radius: 8px;
}
</style>

<!-- AI Assistant HTML Structure -->
<div class="ai-assistant-container">
    <!-- Floating Action Button -->
    <button class="ai-assistant-fab" id="aiAssistantFab" title="ChatterFix AI Assistant">
        ü§ñ
    </button>
    
    <!-- Chat Window -->
    <div class="ai-chat-window" id="aiChatWindow">
        <!-- Header -->
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <div class="ai-status-indicator"></div>
                ChatterFix AI
                <div class="ai-context-indicator" id="aiContextIndicator">Dashboard</div>
            </div>
            <button class="ai-chat-close" id="aiChatClose">√ó</button>
        </div>
        
        <!-- Chat Body -->
        <div class="ai-chat-body">
            <!-- Messages -->
            <div class="ai-chat-messages" id="aiChatMessages">
                <div class="ai-message assistant">
                    <div>üëã Hi! I'm your ChatterFix CMMS assistant. I can help you with work orders, assets, parts, maintenance scheduling, and more. What would you like to do?</div>
                    <div class="ai-suggestions">
                        <button class="ai-suggestion-btn" onclick="sendQuickMessage('Create a work order')">Create Work Order</button>
                        <button class="ai-suggestion-btn" onclick="sendQuickMessage('Check asset status')">Asset Status</button>
                        <button class="ai-suggestion-btn" onclick="sendQuickMessage('Show inventory')">Inventory</button>
                    </div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div class="ai-typing-indicator" id="aiTypingIndicator">
                <span>AI is thinking</span>
                <div class="ai-typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="ai-quick-actions" id="aiQuickActions">
            <button class="ai-quick-action" onclick="executeQuickAction('create_work_order')">
                üìù New Work Order
            </button>
            <button class="ai-quick-action" onclick="executeQuickAction('asset_status')">
                üè≠ Asset Status
            </button>
            <button class="ai-quick-action" onclick="executeQuickAction('check_inventory')">
                üì¶ Inventory
            </button>
        </div>
        
        <!-- Input Area -->
        <div class="ai-chat-input">
            <div class="ai-input-container">
                <button class="ai-voice-btn" id="aiVoiceBtn" title="Voice Input">üé§</button>
                <input type="text" class="ai-input-field" id="aiInputField" placeholder="Ask me anything about your CMMS..." maxlength="500">
                <button class="ai-send-btn" id="aiSendBtn" title="Send Message">‚û§</button>
            </div>
        </div>
    </div>
</div>

<script>
// ChatterFix AI Assistant JavaScript
class ChatterFixAIAssistant {
    constructor() {
        this.isOpen = false;
        this.currentPage = this.detectCurrentPage();
        this.sessionId = this.generateSessionId();
        this.isRecording = false;
        this.mediaRecorder = null;
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.updateContextIndicator();
        this.getPageSuggestions();
    }
    
    bindEvents() {
        // FAB click
        document.getElementById('aiAssistantFab').addEventListener('click', () => {
            this.toggleChat();
        });
        
        // Close button
        document.getElementById('aiChatClose').addEventListener('click', () => {
            this.closeChat();
        });
        
        // Send button
        document.getElementById('aiSendBtn').addEventListener('click', () => {
            this.sendMessage();
        });
        
        // Input field enter key
        document.getElementById('aiInputField').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                this.sendMessage();
            }
        });
        
        // Voice button
        document.getElementById('aiVoiceBtn').addEventListener('click', () => {
            this.toggleVoiceInput();
        });
        
        // Page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                this.currentPage = this.detectCurrentPage();
                this.updateContextIndicator();
            }
        });
        
        // Close chat when clicking outside
        document.addEventListener('click', (e) => {
            const chatWindow = document.getElementById('aiChatWindow');
            const fab = document.getElementById('aiAssistantFab');
            
            if (this.isOpen && !chatWindow.contains(e.target) && !fab.contains(e.target)) {
                this.closeChat();
            }
        });
    }
    
    detectCurrentPage() {
        const path = window.location.pathname;
        if (path.includes('/work-orders')) return 'work_orders';
        if (path.includes('/assets')) return 'assets';
        if (path.includes('/parts')) return 'parts';
        if (path.includes('/pm-scheduling')) return 'pm_scheduling';
        if (path.includes('/reports')) return 'reports';
        return 'dashboard';
    }
    
    updateContextIndicator() {
        const indicator = document.getElementById('aiContextIndicator');
        const pageNames = {
            'dashboard': 'Dashboard',
            'work_orders': 'Work Orders',
            'assets': 'Assets',
            'parts': 'Parts',
            'pm_scheduling': 'PM Scheduling',
            'reports': 'Reports'
        };
        indicator.textContent = pageNames[this.currentPage] || 'Dashboard';
    }
    
    generateSessionId() {
        return 'session_' + Math.random().toString(36).substr(2, 9);
    }
    
    toggleChat() {
        if (this.isOpen) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }
    
    openChat() {
        const chatWindow = document.getElementById('aiChatWindow');
        chatWindow.style.display = 'flex';
        this.isOpen = true;
        
        // Focus input field
        setTimeout(() => {
            document.getElementById('aiInputField').focus();
        }, 100);
        
        // Get fresh context
        this.getPageContext();
    }
    
    closeChat() {
        const chatWindow = document.getElementById('aiChatWindow');
        chatWindow.style.display = 'none';
        this.isOpen = false;
    }
    
    async sendMessage() {
        const inputField = document.getElementById('aiInputField');
        const message = inputField.value.trim();
        
        if (!message) return;
        
        // Clear input
        inputField.value = '';
        
        // Add user message to chat
        this.addMessage(message, 'user');
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            // Send to AI service
            const response = await this.callAIService('/api/ai/chat', {
                message: message,
                current_page: this.currentPage,
                session_id: this.sessionId,
                context: await this.getCurrentPageContext()
            });
            
            // Hide typing indicator
            this.hideTypingIndicator();
            
            // Add AI response
            this.addMessage(response.response, 'assistant', {
                suggestions: response.quick_replies,
                actions: response.suggested_actions
            });
            
        } catch (error) {
            console.error('AI chat error:', error);
            this.hideTypingIndicator();
            this.addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
        }
    }
    
    addMessage(text, sender, extras = {}) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${sender}`;
        
        const textDiv = document.createElement('div');
        textDiv.textContent = text;
        messageDiv.appendChild(textDiv);
        
        // Add suggestions if provided
        if (extras.suggestions && extras.suggestions.length > 0) {
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'ai-suggestions';
            
            extras.suggestions.forEach(suggestion => {
                const btn = document.createElement('button');
                btn.className = 'ai-suggestion-btn';
                btn.textContent = suggestion;
                btn.onclick = () => this.sendQuickMessage(suggestion);
                suggestionsDiv.appendChild(btn);
            });
            
            messageDiv.appendChild(suggestionsDiv);
        }
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    sendQuickMessage(message) {
        const inputField = document.getElementById('aiInputField');
        inputField.value = message;
        this.sendMessage();
    }
    
    showTypingIndicator() {
        document.getElementById('aiTypingIndicator').style.display = 'flex';
        const messagesContainer = document.getElementById('aiChatMessages');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    hideTypingIndicator() {
        document.getElementById('aiTypingIndicator').style.display = 'none';
    }
    
    async executeQuickAction(action) {
        try {
            const response = await this.callAIService('/api/ai/quick-action', {
                action: action,
                parameters: { page: this.currentPage }
            });
            
            this.addMessage(`Quick Action: ${response.message}`, 'assistant');
            
            // Handle specific actions
            if (action === 'create_work_order') {
                // Could open work order creation modal
                this.addMessage('Opening work order creation wizard...', 'assistant');
            }
            
        } catch (error) {
            console.error('Quick action error:', error);
            this.addMessage('Sorry, that action failed. Please try again.', 'assistant');
        }
    }
    
    async toggleVoiceInput() {
        const voiceBtn = document.getElementById('aiVoiceBtn');
        
        if (!this.isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                this.mediaRecorder = new MediaRecorder(stream);
                
                voiceBtn.classList.add('recording');
                voiceBtn.textContent = 'üî¥';
                this.isRecording = true;
                
                const audioChunks = [];
                this.mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                this.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await this.processVoiceInput(audioBlob);
                };
                
                this.mediaRecorder.start();
                
                // Auto-stop after 10 seconds
                setTimeout(() => {
                    if (this.isRecording) {
                        this.stopRecording();
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Voice input error:', error);
                this.addMessage('Voice input not available. Please type your message.', 'assistant');
            }
        } else {
            this.stopRecording();
        }
    }
    
    stopRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            
            const voiceBtn = document.getElementById('aiVoiceBtn');
            voiceBtn.classList.remove('recording');
            voiceBtn.textContent = 'üé§';
            this.isRecording = false;
        }
    }
    
    async processVoiceInput(audioBlob) {
        // In a real implementation, you would send the audio to a speech-to-text service
        // For now, we'll simulate it
        this.addMessage('Processing voice input...', 'assistant');
        
        try {
            // Simulate speech-to-text processing
            setTimeout(() => {
                const sampleTranscripts = [
                    "Create a work order for pump maintenance",
                    "Show me the asset status",
                    "Check inventory levels",
                    "Schedule preventive maintenance"
                ];
                
                const transcript = sampleTranscripts[Math.floor(Math.random() * sampleTranscripts.length)];
                const inputField = document.getElementById('aiInputField');
                inputField.value = transcript;
                
                this.addMessage(`I heard: "${transcript}"`, 'assistant');
                // Auto-send the transcribed message
                setTimeout(() => this.sendMessage(), 1000);
            }, 2000);
            
        } catch (error) {
            console.error('Voice processing error:', error);
            this.addMessage('Sorry, I couldn\'t process your voice input. Please try again.', 'assistant');
        }
    }
    
    async getPageContext() {
        try {
            const response = await this.callAIService('/api/ai/context', {
                page: this.currentPage,
                filters: {},
                selected_items: []
            });
            
            // Update quick actions based on context
            this.updateQuickActions(response.available_actions);
            
        } catch (error) {
            console.error('Context retrieval error:', error);
        }
    }
    
    async getCurrentPageContext() {
        // In a real implementation, this would gather current page data
        return {
            page: this.currentPage,
            timestamp: new Date().toISOString(),
            user_id: 'current_user'
        };
    }
    
    async getPageSuggestions() {
        try {
            const response = await this.callAIService(`/api/ai/suggestions/${this.currentPage}`);
            
            // Could show priority actions as notifications
            if (response.priority_actions && response.priority_actions.length > 0) {
                const fab = document.getElementById('aiAssistantFab');
                fab.classList.add('has-notification');
            }
            
        } catch (error) {
            console.error('Suggestions error:', error);
        }
    }
    
    updateQuickActions(actions) {
        const quickActionsContainer = document.getElementById('aiQuickActions');
        quickActionsContainer.innerHTML = '';
        
        const actionConfig = {
            'create_work_order': { icon: 'üìù', text: 'New Work Order' },
            'asset_status': { icon: 'üè≠', text: 'Asset Status' },
            'check_inventory': { icon: 'üì¶', text: 'Inventory' },
            'schedule_maintenance': { icon: 'üìÖ', text: 'Schedule PM' },
            'generate_report': { icon: 'üìä', text: 'Report' },
            'help': { icon: '‚ùì', text: 'Help' }
        };
        
        actions.forEach(action => {
            const config = actionConfig[action];
            if (config) {
                const btn = document.createElement('button');
                btn.className = 'ai-quick-action';
                btn.innerHTML = `${config.icon} ${config.text}`;
                btn.onclick = () => this.executeQuickAction(action);
                quickActionsContainer.appendChild(btn);
            }
        });
    }
    
    async callAIService(endpoint, data) {
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
    }
}

// Initialize AI Assistant when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    window.chatterFixAI = new ChatterFixAIAssistant();
});

// Global functions for easy access
function sendQuickMessage(message) {
    if (window.chatterFixAI) {
        window.chatterFixAI.sendQuickMessage(message);
    }
}

function executeQuickAction(action) {
    if (window.chatterFixAI) {
        window.chatterFixAI.executeQuickAction(action);
    }
}
</script>