<!-- Universal AI Assistant Widget for ChatterFix CMMS -->
<!-- This widget adapts to user roles and provides contextual assistance -->

<style>
/* Universal AI Assistant Styles */
.ai-assistant-universal {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.ai-assistant-fab {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.ai-assistant-fab:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
}

.ai-assistant-fab::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
    border-radius: 50%;
}

.ai-assistant-icon {
    color: white;
    font-size: 24px;
    z-index: 1;
}

.ai-notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #ff4444;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.ai-assistant-panel {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 380px;
    height: 600px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    transform: translateY(100%) scale(0.8);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    z-index: 9999;
}

.ai-assistant-panel.active {
    transform: translateY(0) scale(1);
    opacity: 1;
}

.ai-assistant-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.ai-assistant-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
}

.ai-assistant-role {
    font-size: 12px;
    opacity: 0.9;
    margin-top: 2px;
}

.ai-assistant-close {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s;
}

.ai-assistant-close:hover {
    background: rgba(255, 255, 255, 0.1);
}

.ai-assistant-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.ai-status-indicator {
    width: 8px;
    height: 8px;
    background: #4ade80;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

.ai-assistant-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ai-assistant-suggestions {
    padding: 16px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.ai-suggestion-title {
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
}

.ai-suggestions-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.ai-suggestion-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.ai-suggestion-card:hover {
    border-color: #667eea;
    background: #f0f4ff;
    transform: translateY(-2px);
}

.ai-suggestion-icon {
    font-size: 20px;
    margin-bottom: 4px;
    color: #667eea;
}

.ai-suggestion-text {
    font-size: 12px;
    color: #374151;
    font-weight: 500;
}

.ai-chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.ai-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ai-message {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    max-width: 85%;
}

.ai-message.user {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.ai-message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.ai-message.assistant .ai-message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.ai-message.user .ai-message-avatar {
    background: #e2e8f0;
    color: #374151;
}

.ai-message-content {
    background: #f8fafc;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.4;
    color: #374151;
}

.ai-message.assistant .ai-message-content {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.ai-message.user .ai-message-content {
    background: #e2e8f0;
    color: #374151;
}

.ai-typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    color: #6b7280;
    font-size: 14px;
}

.ai-typing-dots {
    display: flex;
    gap: 4px;
}

.ai-typing-dot {
    width: 6px;
    height: 6px;
    background: #6b7280;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
.ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}

.ai-chat-input-container {
    padding: 16px;
    border-top: 1px solid #e2e8f0;
    background: white;
}

.ai-chat-input-wrapper {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.ai-chat-input {
    flex: 1;
    border: 1px solid #e2e8f0;
    border-radius: 20px;
    padding: 12px 16px;
    font-size: 14px;
    resize: none;
    min-height: 20px;
    max-height: 80px;
    outline: none;
    transition: border-color 0.2s;
}

.ai-chat-input:focus {
    border-color: #667eea;
}

.ai-chat-send {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.2s;
    flex-shrink: 0;
}

.ai-chat-send:hover {
    transform: scale(1.05);
}

.ai-chat-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .ai-assistant-panel {
        width: calc(100vw - 40px);
        height: calc(100vh - 140px);
        right: 20px;
        left: 20px;
        bottom: 90px;
    }
    
    .ai-assistant-fab {
        width: 50px;
        height: 50px;
    }
    
    .ai-assistant-icon {
        font-size: 20px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .ai-assistant-panel {
        background: #1f2937;
    }
    
    .ai-assistant-suggestions {
        background: #374151;
    }
    
    .ai-suggestion-card {
        background: #1f2937;
        border-color: #4b5563;
        color: #e5e7eb;
    }
    
    .ai-suggestion-card:hover {
        background: #374151;
    }
    
    .ai-chat-input-container {
        background: #1f2937;
        border-color: #4b5563;
    }
    
    .ai-chat-input {
        background: #374151;
        border-color: #4b5563;
        color: #e5e7eb;
    }
    
    .ai-message-content {
        background: #374151;
        color: #e5e7eb;
    }
}
</style>

<!-- AI Assistant HTML Structure -->
<div class="ai-assistant-universal" id="aiAssistantUniversal">
    <!-- FAB Button -->
    <button class="ai-assistant-fab" id="aiAssistantFab" title="ChatterFix AI Assistant">
        <i class="fas fa-robot ai-assistant-icon"></i>
        <div class="ai-notification-badge" id="aiNotificationBadge" style="display: none;">3</div>
    </button>
    
    <!-- AI Assistant Panel -->
    <div class="ai-assistant-panel" id="aiAssistantPanel">
        <!-- Header -->
        <div class="ai-assistant-header">
            <div>
                <h3 class="ai-assistant-title" id="aiAssistantTitle">Executive Assistant</h3>
                <div class="ai-assistant-role" id="aiAssistantRole">Manager Dashboard</div>
                <div class="ai-assistant-status">
                    <div class="ai-status-indicator"></div>
                    <span>Claude + Grok Active</span>
                </div>
            </div>
            <button class="ai-assistant-close" id="aiAssistantClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Body -->
        <div class="ai-assistant-body">
            <!-- Quick Suggestions -->
            <div class="ai-assistant-suggestions">
                <div class="ai-suggestion-title">Quick Actions</div>
                <div class="ai-suggestions-grid" id="aiSuggestionsGrid">
                    <!-- Dynamic suggestions based on role and context -->
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="ai-chat-container">
                <div class="ai-chat-messages" id="aiChatMessages">
                    <!-- Chat messages will be populated here -->
                </div>
                
                <!-- Input Container -->
                <div class="ai-chat-input-container">
                    <div class="ai-chat-input-wrapper">
                        <textarea 
                            class="ai-chat-input" 
                            id="aiChatInput" 
                            placeholder="Ask me anything about ChatterFix..."
                            rows="1"
                        ></textarea>
                        <button class="ai-chat-send" id="aiChatSend">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
class UniversalAIAssistant {
    constructor() {
        this.isOpen = false;
        this.currentUser = null;
        this.currentRole = 'technician';
        this.currentPage = this.detectCurrentPage();
        this.sessionId = this.generateSessionId();
        this.messages = [];
        
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.loadUserContext();
        this.setupRoleSuggestions();
        this.addWelcomeMessage();
        this.setupAutoResize();
        this.loadPersistentChat();
    }
    
    setupEventListeners() {
        const fab = document.getElementById('aiAssistantFab');
        const close = document.getElementById('aiAssistantClose');
        const send = document.getElementById('aiChatSend');
        const input = document.getElementById('aiChatInput');
        
        fab?.addEventListener('click', () => this.togglePanel());
        close?.addEventListener('click', () => this.closePanel());
        send?.addEventListener('click', () => this.sendMessage());
        
        input?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });
        
        // Add suggestion click handlers
        document.addEventListener('click', (e) => {
            if (e.target.closest('.ai-suggestion-card')) {
                const suggestion = e.target.closest('.ai-suggestion-card');
                const action = suggestion.dataset.action;
                this.handleSuggestionClick(action);
            }
        });
    }
    
    detectCurrentPage() {
        const path = window.location.pathname;
        if (path.includes('dashboard')) return 'dashboard';
        if (path.includes('work-orders')) return 'work-orders';
        if (path.includes('assets')) return 'assets';
        if (path.includes('parts')) return 'parts';
        if (path.includes('reports')) return 'reports';
        if (path.includes('schedule')) return 'schedule';
        return 'dashboard';
    }
    
    loadUserContext() {
        // Try to get user context from various sources
        const userRole = localStorage.getItem('userRole') || 
                        document.querySelector('[data-user-role]')?.dataset.userRole ||
                        'technician';
        
        const userId = localStorage.getItem('userId') || 
                      document.querySelector('[data-user-id]')?.dataset.userId ||
                      'anonymous';
        
        this.currentRole = userRole;
        this.currentUser = userId;
        this.updateHeaderForRole();
    }
    
    updateHeaderForRole() {
        const roleConfigs = {
            manager: { name: 'Executive Assistant', icon: 'fas fa-chart-line' },
            supervisor: { name: 'Operations Coordinator', icon: 'fas fa-tasks' },
            technician: { name: 'Technical Expert', icon: 'fas fa-tools' },
            buyer: { name: 'Procurement Specialist', icon: 'fas fa-shopping-cart' },
            operator: { name: 'Operations Guide', icon: 'fas fa-cogs' },
            admin: { name: 'System Administrator', icon: 'fas fa-user-shield' }
        };
        
        const config = roleConfigs[this.currentRole] || roleConfigs.technician;
        
        document.getElementById('aiAssistantTitle').textContent = config.name;
        document.getElementById('aiAssistantRole').textContent = 
            `${this.currentRole.charAt(0).toUpperCase() + this.currentRole.slice(1)} • ${this.currentPage.charAt(0).toUpperCase() + this.currentPage.slice(1)}`;
    }
    
    setupRoleSuggestions() {
        const suggestions = this.getRoleSuggestions();
        const grid = document.getElementById('aiSuggestionsGrid');
        
        grid.innerHTML = suggestions.map(suggestion => `
            <div class="ai-suggestion-card" data-action="${suggestion.action}">
                <div class="ai-suggestion-icon">
                    <i class="${suggestion.icon}"></i>
                </div>
                <div class="ai-suggestion-text">${suggestion.text}</div>
            </div>
        `).join('');
    }
    
    getRoleSuggestions() {
        const roleSuggestions = {
            manager: [
                { icon: 'fas fa-chart-bar', text: 'KPI Report', action: 'kpi_report' },
                { icon: 'fas fa-users', text: 'Team Status', action: 'team_status' },
                { icon: 'fas fa-dollar-sign', text: 'Cost Analysis', action: 'cost_analysis' },
                { icon: 'fas fa-calendar', text: 'Schedule Overview', action: 'schedule_overview' }
            ],
            supervisor: [
                { icon: 'fas fa-list-check', text: 'Work Orders', action: 'work_orders_summary' },
                { icon: 'fas fa-clock', text: 'Schedule Tasks', action: 'schedule_tasks' },
                { icon: 'fas fa-quality-check', text: 'Quality Check', action: 'quality_check' },
                { icon: 'fas fa-users-cog', text: 'Team Coordination', action: 'team_coordination' }
            ],
            technician: [
                { icon: 'fas fa-wrench', text: 'Diagnostics', action: 'diagnostics_help' },
                { icon: 'fas fa-book', text: 'Procedures', action: 'procedure_lookup' },
                { icon: 'fas fa-shield-alt', text: 'Safety Check', action: 'safety_check' },
                { icon: 'fas fa-search', text: 'Part ID', action: 'part_identification' }
            ],
            buyer: [
                { icon: 'fas fa-compare', text: 'Vendor Compare', action: 'vendor_compare' },
                { icon: 'fas fa-chart-line', text: 'Cost Trends', action: 'cost_trends' },
                { icon: 'fas fa-boxes', text: 'Inventory Plan', action: 'inventory_planning' },
                { icon: 'fas fa-truck', text: 'Order Status', action: 'order_status' }
            ],
            operator: [
                { icon: 'fas fa-play', text: 'Start Procedure', action: 'start_procedure' },
                { icon: 'fas fa-exclamation-triangle', text: 'Safety Alert', action: 'safety_alert' },
                { icon: 'fas fa-tachometer-alt', text: 'Performance', action: 'performance_check' },
                { icon: 'fas fa-clipboard-check', text: 'Checklist', action: 'operational_checklist' }
            ],
            admin: [
                { icon: 'fas fa-server', text: 'System Health', action: 'system_health' },
                { icon: 'fas fa-users', text: 'User Support', action: 'user_support' },
                { icon: 'fas fa-shield-alt', text: 'Security', action: 'security_check' },
                { icon: 'fas fa-chart-pie', text: 'Analytics', action: 'system_analytics' }
            ]
        };
        
        return roleSuggestions[this.currentRole] || roleSuggestions.technician;
    }
    
    addWelcomeMessage() {
        const welcomeMessages = {
            manager: "Hello! I'm your Executive Assistant. I can help with KPIs, team management, budget analysis, and strategic planning. What would you like to review?",
            supervisor: "Hi! I'm your Operations Coordinator. I can assist with workflow management, task coordination, and team scheduling. How can I help optimize your operations?",
            technician: "Hey! I'm your Technical Expert. I can help with diagnostics, procedures, safety protocols, and technical documentation. What equipment are you working on?",
            buyer: "Hello! I'm your Procurement Specialist. I can assist with vendor management, cost optimization, and inventory planning. What purchasing decisions can I help with?",
            operator: "Hi! I'm your Operations Guide. I can help with procedures, safety protocols, and operational excellence. What process are you working on?",
            admin: "Hello! I'm your System Administrator. I can help with system health, user management, and security protocols. What system aspects would you like to review?"
        };
        
        const message = welcomeMessages[this.currentRole] || welcomeMessages.technician;
        this.addMessage(message, 'assistant');
    }
    
    async sendMessage() {
        const input = document.getElementById('aiChatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        this.addMessage(message, 'user');
        input.value = '';
        
        // Show typing indicator
        this.showTypingIndicator();
        
        try {
            // Call AI assistant API
            const response = await fetch('/api/ai-assistant/ask', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    user_id: this.currentUser,
                    user_role: this.currentRole,
                    context: {
                        page: this.currentPage,
                        timestamp: new Date().toISOString()
                    },
                    session_id: this.sessionId,
                    current_page: this.currentPage
                })
            });
            
            const data = await response.json();
            
            // Remove typing indicator
            this.hideTypingIndicator();
            
            // Add AI response
            this.addMessage(data.response, 'assistant', data);
            
            // Store conversation
            this.savePersistentChat();
            
        } catch (error) {
            console.error('AI Assistant Error:', error);
            this.hideTypingIndicator();
            this.addMessage('I\'m experiencing some technical difficulties. Please try again.', 'assistant');
        }
    }
    
    addMessage(content, sender, metadata = {}) {
        const messagesContainer = document.getElementById('aiChatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `ai-message ${sender}`;
        
        const avatar = sender === 'assistant' ? 
            '<i class="fas fa-robot"></i>' : 
            '<i class="fas fa-user"></i>';
        
        messageDiv.innerHTML = `
            <div class="ai-message-avatar">${avatar}</div>
            <div class="ai-message-content">${content}</div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Store message
        this.messages.push({ content, sender, timestamp: new Date().toISOString(), metadata });
    }
    
    showTypingIndicator() {
        const messagesContainer = document.getElementById('aiChatMessages');
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-typing-indicator';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="ai-message-avatar"><i class="fas fa-robot"></i></div>
            <div class="ai-typing-dots">
                <div class="ai-typing-dot"></div>
                <div class="ai-typing-dot"></div>
                <div class="ai-typing-dot"></div>
            </div>
        `;
        
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    hideTypingIndicator() {
        const typing = document.getElementById('typingIndicator');
        if (typing) typing.remove();
    }
    
    handleSuggestionClick(action) {
        const actionMessages = {
            kpi_report: "Show me the current KPI dashboard and performance metrics.",
            team_status: "What's the current status of my team and their work assignments?",
            cost_analysis: "Provide a cost analysis for this month's maintenance activities.",
            diagnostics_help: "Help me diagnose equipment issues and provide troubleshooting steps.",
            procedure_lookup: "Find the maintenance procedure for the equipment I'm working on.",
            vendor_compare: "Compare vendors for the parts I need to purchase.",
            system_health: "Check the current system health and performance metrics."
        };
        
        const message = actionMessages[action] || `Help me with ${action.replace('_', ' ')}`;
        document.getElementById('aiChatInput').value = message;
        this.sendMessage();
    }
    
    togglePanel() {
        const panel = document.getElementById('aiAssistantPanel');
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            panel.classList.add('active');
            document.getElementById('aiChatInput').focus();
        } else {
            panel.classList.remove('active');
        }
    }
    
    closePanel() {
        this.isOpen = false;
        document.getElementById('aiAssistantPanel').classList.remove('active');
    }
    
    setupAutoResize() {
        const input = document.getElementById('aiChatInput');
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        });
    }
    
    generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }
    
    savePersistentChat() {
        try {
            localStorage.setItem('aiChatHistory_' + this.currentUser, JSON.stringify(this.messages.slice(-20)));
        } catch (e) {
            console.warn('Could not save chat history:', e);
        }
    }
    
    loadPersistentChat() {
        try {
            const history = localStorage.getItem('aiChatHistory_' + this.currentUser);
            if (history) {
                const messages = JSON.parse(history);
                messages.forEach(msg => {
                    if (msg.content !== this.messages[0]?.content) { // Don't duplicate welcome message
                        this.addMessage(msg.content, msg.sender, msg.metadata || {});
                    }
                });
            }
        } catch (e) {
            console.warn('Could not load chat history:', e);
        }
    }
}

// Initialize the Universal AI Assistant when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    window.universalAI = new UniversalAIAssistant();
});

// Export for external access
if (typeof module !== 'undefined' && module.exports) {
    module.exports = UniversalAIAssistant;
}
</script>