apiVersion: v1
kind: ConfigMap
metadata:
  name: chatterfix-monitoring-dashboard
  namespace: default
data:
  dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "ChatterFix CMMS Monitoring Dashboard",
        "tags": ["chatterfix", "cmms", "production"],
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "Service Health Overview",
            "type": "stat",
            "targets": [
              {
                "expr": "up{job='chatterfix-backend'}",
                "legendFormat": "Backend Status"
              },
              {
                "expr": "up{job='chatterfix-frontend'}",
                "legendFormat": "Frontend Status"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "mappings": [
                  {
                    "options": {
                      "0": {
                        "text": "DOWN",
                        "color": "red"
                      },
                      "1": {
                        "text": "UP",
                        "color": "green"
                      }
                    },
                    "type": "value"
                  }
                ]
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 0
            }
          },
          {
            "id": 2,
            "title": "Request Rate by Endpoint",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/work_orders'}[5m])",
                "legendFormat": "Work Orders"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/assets'}[5m])",
                "legendFormat": "Assets"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/parts'}[5m])",
                "legendFormat": "Parts"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/health'}[5m])",
                "legendFormat": "Health"
              }
            ],
            "yAxes": [
              {
                "label": "Requests per second",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 0
            }
          },
          {
            "id": 3,
            "title": "Response Time (95th percentile)",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job='chatterfix-backend',endpoint='/work_orders'}[5m]))",
                "legendFormat": "Work Orders P95"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job='chatterfix-backend',endpoint='/assets'}[5m]))",
                "legendFormat": "Assets P95"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job='chatterfix-backend',endpoint='/parts'}[5m]))",
                "legendFormat": "Parts P95"
              },
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job='chatterfix-backend',endpoint='/health'}[5m]))",
                "legendFormat": "Health P95"
              }
            ],
            "yAxes": [
              {
                "label": "Response time (seconds)",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 8
            }
          },
          {
            "id": 4,
            "title": "Error Rate by Endpoint",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/work_orders',status=~'4..|5..'}[5m]) / rate(http_requests_total{job='chatterfix-backend',endpoint='/work_orders'}[5m])",
                "legendFormat": "Work Orders Error Rate"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/assets',status=~'4..|5..'}[5m]) / rate(http_requests_total{job='chatterfix-backend',endpoint='/assets'}[5m])",
                "legendFormat": "Assets Error Rate"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/parts',status=~'4..|5..'}[5m]) / rate(http_requests_total{job='chatterfix-backend',endpoint='/parts'}[5m])",
                "legendFormat": "Parts Error Rate"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',endpoint='/health',status=~'4..|5..'}[5m]) / rate(http_requests_total{job='chatterfix-backend',endpoint='/health'}[5m])",
                "legendFormat": "Health Error Rate"
              }
            ],
            "yAxes": [
              {
                "label": "Error rate (%)",
                "min": 0,
                "max": 1
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 8
            }
          },
          {
            "id": 5,
            "title": "API Authentication Status",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',status='401'}[5m])",
                "legendFormat": "Unauthorized Requests"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',status='422'}[5m])",
                "legendFormat": "Missing API Key"
              },
              {
                "expr": "rate(http_requests_total{job='chatterfix-backend',status='429'}[5m])",
                "legendFormat": "Rate Limited"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "unit": "reqps"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 0,
              "y": 16
            }
          },
          {
            "id": 6,
            "title": "Data Operations",
            "type": "stat",
            "targets": [
              {
                "expr": "chatterfix_work_orders_total",
                "legendFormat": "Total Work Orders"
              },
              {
                "expr": "chatterfix_assets_total",
                "legendFormat": "Total Assets"
              },
              {
                "expr": "chatterfix_parts_total",
                "legendFormat": "Total Parts"
              },
              {
                "expr": "chatterfix_work_orders_completed_total",
                "legendFormat": "Completed Work Orders"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "unit": "short"
              }
            },
            "gridPos": {
              "h": 8,
              "w": 12,
              "x": 12,
              "y": 16
            }
          },
          {
            "id": 7,
            "title": "System Resources",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{container_name='chatterfix-backend'}[5m])",
                "legendFormat": "Backend CPU Usage"
              },
              {
                "expr": "rate(container_cpu_usage_seconds_total{container_name='chatterfix-frontend'}[5m])",
                "legendFormat": "Frontend CPU Usage"
              },
              {
                "expr": "container_memory_usage_bytes{container_name='chatterfix-backend'} / 1024 / 1024",
                "legendFormat": "Backend Memory (MB)"
              },
              {
                "expr": "container_memory_usage_bytes{container_name='chatterfix-frontend'} / 1024 / 1024",
                "legendFormat": "Frontend Memory (MB)"
              }
            ],
            "yAxes": [
              {
                "label": "Usage",
                "min": 0
              }
            ],
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 24
            }
          },
          {
            "id": 8,
            "title": "Uptime and Availability",
            "type": "stat",
            "targets": [
              {
                "expr": "avg_over_time(up{job='chatterfix-backend'}[24h])",
                "legendFormat": "Backend 24h Uptime"
              },
              {
                "expr": "avg_over_time(up{job='chatterfix-frontend'}[24h])",
                "legendFormat": "Frontend 24h Uptime"
              },
              {
                "expr": "time() - process_start_time_seconds{job='chatterfix-backend'}",
                "legendFormat": "Backend Uptime (seconds)"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "palette-classic"
                },
                "mappings": [
                  {
                    "options": {
                      "from": 0.99,
                      "to": 1
                    },
                    "type": "range",
                    "result": {
                      "color": "green"
                    }
                  },
                  {
                    "options": {
                      "from": 0.95,
                      "to": 0.99
                    },
                    "type": "range",
                    "result": {
                      "color": "yellow"
                    }
                  },
                  {
                    "options": {
                      "from": 0,
                      "to": 0.95
                    },
                    "type": "range",
                    "result": {
                      "color": "red"
                    }
                  }
                ]
              }
            },
            "gridPos": {
              "h": 8,
              "w": 24,
              "x": 0,
              "y": 32
            }
          }
        ]
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: chatterfix-alerting-rules
  namespace: default
data:
  alerts.yaml: |
    groups:
    - name: chatterfix-cmms-alerts
      rules:
      - alert: ChatterFixBackendDown
        expr: up{job="chatterfix-backend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ChatterFix Backend is down"
          description: "ChatterFix CMMS backend has been down for more than 1 minute"
          
      - alert: ChatterFixFrontendDown
        expr: up{job="chatterfix-frontend"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "ChatterFix Frontend is down"
          description: "ChatterFix CMMS frontend has been down for more than 1 minute"
          
      - alert: HighErrorRate
        expr: rate(http_requests_total{job="chatterfix-backend",status=~"4..|5.."}[5m]) / rate(http_requests_total{job="chatterfix-backend"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 10% for 5 minutes"
          
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="chatterfix-backend"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is above 2 seconds"
          
      - alert: RateLimitingTriggered
        expr: rate(http_requests_total{job="chatterfix-backend",status="429"}[5m]) > 0.5
        for: 2m
        labels:
          severity: info
        annotations:
          summary: "Rate limiting active"
          description: "Rate limiting is being triggered frequently"
          
      - alert: AuthenticationFailures
        expr: rate(http_requests_total{job="chatterfix-backend",status="401"}[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failures"
          description: "Unusual number of authentication failures detected"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: chatterfix-health-check
  namespace: default
data:
  health-check.sh: |
    #!/bin/bash
    
    # ChatterFix CMMS Health Check Script
    # Runs comprehensive health checks on all services
    
    set -e
    
    BACKEND_URL="https://chatterfix-consolidated-cmms-650169261019.us-central1.run.app"
    FRONTEND_URL="https://chatterfix-unified-gateway-updated-650169261019.us-central1.run.app"
    API_KEY="${CHATTERFIX_API_KEY}"
    
    echo "üîç ChatterFix CMMS Health Check Starting..."
    echo "=========================================="
    
    # Function to check endpoint
    check_endpoint() {
        local url=$1
        local name=$2
        local headers=$3
        
        echo -n "Checking $name... "
        
        if [ -n "$headers" ]; then
            response=$(curl -s -w "%{http_code}" -H "$headers" "$url" || echo "000")
        else
            response=$(curl -s -w "%{http_code}" "$url" || echo "000")
        fi
        
        status_code="${response: -3}"
        
        if [ "$status_code" = "200" ]; then
            echo "‚úÖ OK ($status_code)"
            return 0
        else
            echo "‚ùå FAILED ($status_code)"
            return 1
        fi
    }
    
    # Backend health checks
    echo "üîß Backend Services:"
    check_endpoint "$BACKEND_URL/health" "Health endpoint" "x-api-key: $API_KEY"
    check_endpoint "$BACKEND_URL/work_orders/" "Work Orders API" "x-api-key: $API_KEY"
    check_endpoint "$BACKEND_URL/assets/" "Assets API" "x-api-key: $API_KEY"
    check_endpoint "$BACKEND_URL/parts/" "Parts API" "x-api-key: $API_KEY"
    
    # Frontend health checks
    echo ""
    echo "üñ•Ô∏è Frontend Services:"
    check_endpoint "$FRONTEND_URL/health" "Frontend Health" ""
    check_endpoint "$FRONTEND_URL/" "Main Interface" ""
    
    # Authentication tests
    echo ""
    echo "üîí Security Tests:"
    
    # Test missing API key (should fail)
    echo -n "Testing missing API key... "
    status=$(curl -s -w "%{http_code}" -o /dev/null "$BACKEND_URL/work_orders/")
    if [ "$status" = "422" ]; then
        echo "‚úÖ OK (properly rejected)"
    else
        echo "‚ùå FAILED (status: $status)"
    fi
    
    # Test invalid API key (should fail)
    echo -n "Testing invalid API key... "
    status=$(curl -s -w "%{http_code}" -o /dev/null -H "x-api-key: invalid" "$BACKEND_URL/work_orders/")
    if [ "$status" = "401" ]; then
        echo "‚úÖ OK (properly rejected)"
    else
        echo "‚ùå FAILED (status: $status)"
    fi
    
    # Performance tests
    echo ""
    echo "‚ö° Performance Tests:"
    
    for endpoint in "health" "work_orders/" "assets/" "parts/"; do
        echo -n "Testing $endpoint response time... "
        start_time=$(date +%s%N)
        curl -s -H "x-api-key: $API_KEY" "$BACKEND_URL/$endpoint" > /dev/null
        end_time=$(date +%s%N)
        duration=$(( (end_time - start_time) / 1000000 ))
        
        if [ $duration -lt 2000 ]; then
            echo "‚úÖ ${duration}ms"
        else
            echo "‚ö†Ô∏è ${duration}ms (slow)"
        fi
    done
    
    echo ""
    echo "‚úÖ Health check completed!"
    echo "=========================================="