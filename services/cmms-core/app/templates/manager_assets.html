{% extends "base.html" %}

{% block title %}Asset Management - ChatterFix CMMS{% endblock %}

{% block extra_head %}
<style>
    /* Manager Pages - Consistent CMMS Styling */
    .container-fluid {
        background: transparent !important;
        color: var(--text-primary) !important;
        min-height: 100vh;
        padding: 2rem;
    }
    
    /* CMMS Card styling - glassmorphism */
    .card, .asset-card {
        background: var(--bg-card) !important;
        border-radius: 15px !important;
        padding: 2rem !important;
        backdrop-filter: blur(15px) !important;
        -webkit-backdrop-filter: blur(15px) !important;
        border: var(--card-border) !important;
        margin-bottom: 2rem !important;
        transition: all 0.3s ease !important;
        box-shadow: var(--shadow-card) !important;
        color: var(--text-primary) !important;
    }
    
    .card:hover, .asset-card:hover {
        transform: translateY(-5px) !important;
        background: var(--bg-glass-hover) !important;
        box-shadow: var(--shadow-glass) !important;
        border-color: rgba(79, 172, 254, 0.3) !important;
    }
    
    .card-header {
        background: var(--bg-glass) !important;
        border-bottom: var(--card-border) !important;
        color: var(--text-primary) !important;
        border-radius: 15px 15px 0 0 !important;
    }
    
    .card-body {
        background: transparent !important;
        color: var(--text-primary) !important;
    }
    
    h1, h2, h3, h4, h5, h6 {
        color: var(--text-primary) !important;
        text-shadow: none !important;
    }
    
    .text-muted {
        color: var(--text-muted) !important;
    }
    .asset-health-score {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        margin: 0 auto;
    }
    
    .health-excellent { background: #10b981; }
    .health-good { background: #3b82f6; }
    .health-fair { background: #f59e0b; }
    .health-poor { background: #ef4444; }
    
    .asset-card {
        transition: transform 0.2s;
        border-left: 4px solid transparent;
    }
    
    .asset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .asset-card.critical { border-left-color: #ef4444; }
    .asset-card.high { border-left-color: #f59e0b; }
    .asset-card.medium { border-left-color: #3b82f6; }
    .asset-card.low { border-left-color: #10b981; }
    
    .cost-indicator {
        padding: 0.5rem;
        border-radius: 0.25rem;
        text-align: center;
        font-weight: 600;
    }
    
    .cost-high { background: #fee2e2; color: #991b1b; }
    .cost-medium { background: #fef3c7; color: #92400e; }
    .cost-low { background: #dcfce7; color: #166534; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3">
                <i class="fas fa-cogs text-primary"></i>
                Asset Performance Management
            </h1>
            <p class="text-muted">Monitor asset health, schedule maintenance, and control costs</p>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="exportAssetReport()">
                    <i class="fas fa-download"></i> Export Report
                </button>
                <button class="btn btn-success" onclick="scheduleMaintenanceModal()">
                    <i class="fas fa-wrench"></i> Schedule Maintenance
                </button>
            </div>
        </div>
    </div>

    <!-- Asset Overview Cards -->
    <div class="row mb-4">
        {% for asset in assets_overview %}
        <div class="col-lg-4 mb-4">
            <div class="card asset-card {{ asset.criticality.lower() }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-8">
                            <h6 class="card-title mb-2">{{ asset.name }}</h6>
                            <p class="text-muted small mb-2">{{ asset.type }} â€¢ {{ asset.location }}</p>
                            <span class="badge {% if asset.status == 'Excellent' %}bg-success{% elif asset.status == 'Good' %}bg-primary{% elif asset.status == 'Needs Attention' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ asset.status }}
                            </span>
                        </div>
                        <div class="col-4 text-center">
                            <div class="asset-health-score health-{% if asset.health_score >= 85 %}excellent{% elif asset.health_score >= 70 %}good{% elif asset.health_score >= 50 %}fair{% else %}poor{% endif %}">
                                {{ asset.health_score }}
                            </div>
                            <small class="text-muted">Health Score</small>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    
                    <div class="row small text-muted">
                        <div class="col-6">
                            <strong>Last Service:</strong><br>
                            {{ asset.last_service }}
                        </div>
                        <div class="col-6">
                            <strong>Next Service:</strong><br>
                            {{ asset.next_service }}
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <div class="cost-indicator cost-{% if asset.total_cost_ytd > 5000 %}high{% elif asset.total_cost_ytd > 2000 %}medium{% else %}low{% endif %}">
                            YTD Cost: ${{ "{:,.2f}".format(asset.total_cost_ytd) }}
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex justify-content-between">
                        <small class="text-muted">Downtime: {{ asset.downtime_hours }}h</small>
                        <small class="text-muted">{{ asset.criticality }} Priority</small>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-primary" onclick="viewAssetDetail({{ asset.id }})">
                            <i class="fas fa-eye"></i> Details
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="scheduleAssetMaintenance({{ asset.id }})">
                            <i class="fas fa-wrench"></i> Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Tabs for Different Views -->
    <ul class="nav nav-tabs mb-4" id="assetTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button">
                <i class="fas fa-calendar"></i> Maintenance Schedule
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="costs-tab" data-bs-toggle="tab" data-bs-target="#costs" type="button">
                <i class="fas fa-dollar-sign"></i> Cost Analysis
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button">
                <i class="fas fa-exclamation-triangle"></i> Critical Alerts
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="assetTabContent">
        <!-- Maintenance Schedule Tab -->
        <div class="tab-pane fade show active" id="schedule" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Upcoming Maintenance Schedule</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Asset</th>
                                    <th>Type</th>
                                    <th>Scheduled Date</th>
                                    <th>Assigned Technician</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for maintenance in maintenance_schedule %}
                                <tr>
                                    <td>
                                        <strong>{{ maintenance.asset }}</strong>
                                    </td>
                                    <td>
                                        <span class="badge {% if maintenance.type == 'Urgent' %}bg-danger{% elif maintenance.type == 'Preventive' %}bg-success{% else %}bg-primary{% endif %}">
                                            {{ maintenance.type }}
                                        </span>
                                    </td>
                                    <td>{{ maintenance.scheduled_date }}</td>
                                    <td>{{ maintenance.technician }}</td>
                                    <td>{{ maintenance.estimated_duration }}h</td>
                                    <td>
                                        <span class="badge {% if maintenance.status == 'Urgent' %}bg-danger{% elif maintenance.status == 'Scheduled' %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ maintenance.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="editSchedule('{{ maintenance.asset }}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-success" onclick="completeSchedule('{{ maintenance.asset }}')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cost Analysis Tab -->
        <div class="tab-pane fade" id="costs" role="tabpanel">
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Cost Breakdown by Category</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="costChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">Cost Categories</h6>
                        </div>
                        <div class="card-body">
                            {% for category in cost_analysis %}
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <strong>{{ category.category }}</strong>
                                    <div class="small text-muted">${{ "{:,.2f}".format(category.total_cost) }}</div>
                                </div>
                                <div class="text-end">
                                    <div class="h6 mb-0">{{ category.percentage }}%</div>
                                    <div class="small {% if category.trend == 'up' %}text-danger{% elif category.trend == 'down' %}text-success{% else %}text-muted{% endif %}">
                                        {% if category.trend == 'up' %}
                                        <i class="fas fa-arrow-up"></i> Increasing
                                        {% elif category.trend == 'down' %}
                                        <i class="fas fa-arrow-down"></i> Decreasing
                                        {% else %}
                                        <i class="fas fa-minus"></i> Stable
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 6px;">
                                <div class="progress-bar" style="width: {{ category.percentage }}%"></div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Critical Alerts Tab -->
        <div class="tab-pane fade" id="alerts" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Critical Asset Alerts</h5>
                        <ul class="mb-0">
                            <li>Pump Station A - Health score dropped below 60% (Action Required)</li>
                            <li>HVAC Unit #12 - Overdue maintenance by 15 days (Immediate Action)</li>
                            <li>Generator #3 - Unusual vibration detected (Investigation Needed)</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-circle"></i> Warning Alerts</h5>
                        <ul class="mb-0">
                            <li>Elevator #2 - Inspection due within 7 days</li>
                            <li>Chiller Unit B - Energy efficiency declining</li>
                            <li>Compressor #5 - Parts inventory running low</li>
                        </ul>
                    </div>
                    
                    <div class="alert alert-info">
                        <h5><i class="fas fa-info-circle"></i> Recommendations</h5>
                        <ul class="mb-0">
                            <li>Consider upgrading HVAC filters for better efficiency</li>
                            <li>Schedule quarterly deep maintenance for critical assets</li>
                            <li>Implement predictive maintenance for high-cost assets</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal fade" id="scheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Maintenance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form onsubmit="submitMaintenanceSchedule(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Asset</label>
                        <select class="form-select" name="asset_id" required>
                            <option value="">Select Asset</option>
                            {% for asset in assets_overview %}
                            <option value="{{ asset.id }}">{{ asset.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maintenance Type</label>
                        <select class="form-select" name="maintenance_type" required>
                            <option value="">Select Type</option>
                            <option value="preventive">Preventive</option>
                            <option value="corrective">Corrective</option>
                            <option value="inspection">Inspection</option>
                            <option value="emergency">Emergency</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Scheduled Date</label>
                        <input type="datetime-local" class="form-control" name="scheduled_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Assign Technician</label>
                        <select class="form-select" name="technician_id" required>
                            <option value="">Select Technician</option>
                            <option value="1">Sarah Johnson</option>
                            <option value="2">Mike Rodriguez</option>
                            <option value="3">Lisa Chen</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Priority</label>
                        <select class="form-select" name="priority" required>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3" placeholder="Additional maintenance instructions..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Cost breakdown chart
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('costChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [{% for category in cost_analysis %}'{{ category.category }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Cost ($)',
                data: [{% for category in cost_analysis %}{{ category.total_cost }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
});

function viewAssetDetail(assetId) {
    window.location.href = `/manager/assets/${assetId}/detail`;
}

function scheduleAssetMaintenance(assetId) {
    document.querySelector('select[name="asset_id"]').value = assetId;
    scheduleMaintenanceModal();
}

function scheduleMaintenanceModal() {
    new bootstrap.Modal(document.getElementById('scheduleModal')).show();
}

function submitMaintenanceSchedule(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    fetch(`/manager/api/asset/${formData.get('asset_id')}/schedule-maintenance`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('scheduleModal')).hide();
            showAlert('success', 'Maintenance scheduled successfully!');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('error', data.error || 'Failed to schedule maintenance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to schedule maintenance');
    });
}

function editSchedule(asset) {
    alert(`Edit schedule for ${asset}`);
}

function completeSchedule(asset) {
    if (confirm(`Mark maintenance as complete for ${asset}?`)) {
        showAlert('success', `Maintenance marked complete for ${asset}`);
    }
}

function exportAssetReport() {
    const reportData = {
        generated: new Date().toISOString(),
        assets: {{ assets_overview | tojson }},
        schedule: {{ maintenance_schedule | tojson }},
        costs: {{ cost_analysis | tojson }}
    };
    
    const blob = new Blob([JSON.stringify(reportData, null, 2)], 
        { type: 'application/json' });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `asset-report-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}