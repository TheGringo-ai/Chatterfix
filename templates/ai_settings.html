{% extends "base.html" %}

{% block title %}ChatterFix CMMS - AI Settings{% endblock %}
{% block page_icon %}🤖{% endblock %}
{% block page_title %}AI Provider Settings{% endblock %}
{% block page_subtitle %}Configure your AI providers for Fix It Fred{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="testConnections()">
    ⚡ Test All Connections
</button>
<button class="btn btn-info" onclick="loadSettings()">
    🔄 Refresh Settings
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card" style="background: linear-gradient(135deg, #2c3e50, #34495e);">
        <h3>Available Providers</h3>
        <div class="value" id="providerCount">5</div>
        <div class="subtitle">AI Services</div>
        <div class="ai-insight">🤖 Multiple AI options</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #27ae60, #2ecc71);">
        <h3>Active Connections</h3>
        <div class="value" id="activeCount">1</div>
        <div class="subtitle">Enabled providers</div>
        <div class="ai-insight">🟢 Ollama running</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #3498db, #5dade2);">
        <h3>Models Available</h3>
        <div class="value" id="modelCount">8+</div>
        <div class="subtitle">AI Models</div>
        <div class="ai-insight">🧠 Multiple options</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #9b59b6, #bb8fce);">
        <h3>Default Provider</h3>
        <div class="value" id="defaultProvider">Ollama</div>
        <div class="subtitle">Primary AI</div>
        <div class="ai-insight">🏠 Local & Private</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="chatterfix-grid grid-cols-1">
    <!-- AI Provider Configuration -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">🤖 AI Provider Configuration</h3>
        
        <div id="providersList">
            <!-- Ollama Provider -->
            <div class="provider-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">🏠 Ollama (Local AI)</h4>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">Run AI models locally on your server - Private & Free</p>
                    </div>
                    <div>
                        <span id="ollama-status" class="status-badge status-operational">🟢 Active</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Status:</label>
                        <div id="ollama-connection" style="color: #27ae60; font-weight: 600;">✅ Connected</div>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Models:</label>
                        <select id="ollama-model" class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="mistral:7b">Mistral 7B (Recommended)</option>
                            <option value="llama3:8b">Llama3 8B</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Default:</label>
                        <input type="checkbox" id="ollama-default" checked style="transform: scale(1.2);">
                    </div>
                    <div>
                        <button onclick="testProvider('ollama')" class="btn btn-sm btn-success">🧪 Test</button>
                    </div>
                </div>
            </div>

            <!-- OpenAI Provider -->
            <div class="provider-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">🚀 OpenAI GPT</h4>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">GPT-4, GPT-3.5-turbo - Requires API key</p>
                    </div>
                    <div>
                        <span id="openai-status" class="status-badge status-pending">⚪ Not Configured</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">API Key:</label>
                    <input type="password" id="openai-key" placeholder="sk-..." class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                    <small style="color: #666;">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a></small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Model:</label>
                        <select id="openai-model" class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Faster)</option>
                            <option value="gpt-4">GPT-4 (Better)</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Default:</label>
                        <input type="checkbox" id="openai-default" style="transform: scale(1.2);">
                    </div>
                    <div>
                        <button onclick="saveProvider('openai')" class="btn btn-sm btn-primary">💾 Save</button>
                    </div>
                    <div>
                        <button onclick="testProvider('openai')" class="btn btn-sm btn-success">🧪 Test</button>
                    </div>
                </div>
            </div>

            <!-- Anthropic Claude Provider -->
            <div class="provider-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">🔮 Anthropic Claude</h4>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">Claude-3 Opus, Sonnet, Haiku - Requires API key</p>
                    </div>
                    <div>
                        <span id="anthropic-status" class="status-badge status-pending">⚪ Not Configured</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">API Key:</label>
                    <input type="password" id="anthropic-key" placeholder="sk-ant-..." class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                    <small style="color: #666;">Get your API key from <a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a></small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Model:</label>
                        <select id="anthropic-model" class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="claude-3-haiku-20240307">Claude-3 Haiku (Fast)</option>
                            <option value="claude-3-sonnet-20240229">Claude-3 Sonnet (Balanced)</option>
                            <option value="claude-3-opus-20240229">Claude-3 Opus (Best)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Default:</label>
                        <input type="checkbox" id="anthropic-default" style="transform: scale(1.2);">
                    </div>
                    <div>
                        <button onclick="saveProvider('anthropic')" class="btn btn-sm btn-primary">💾 Save</button>
                    </div>
                    <div>
                        <button onclick="testProvider('anthropic')" class="btn btn-sm btn-success">🧪 Test</button>
                    </div>
                </div>
            </div>

            <!-- Google Gemini Provider -->
            <div class="provider-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">🌟 Google Gemini</h4>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">Gemini-1.5-Pro, Flash - Requires API key</p>
                    </div>
                    <div>
                        <span id="google-status" class="status-badge status-pending">⚪ Not Configured</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">API Key:</label>
                    <input type="password" id="google-key" placeholder="AIza..." class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                    <small style="color: #666;">Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Model:</label>
                        <select id="google-model" class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="gemini-1.5-flash-latest">Gemini-1.5 Flash (Fast)</option>
                            <option value="gemini-1.5-pro-latest">Gemini-1.5 Pro (Better)</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Default:</label>
                        <input type="checkbox" id="google-default" style="transform: scale(1.2);">
                    </div>
                    <div>
                        <button onclick="saveProvider('google')" class="btn btn-sm btn-primary">💾 Save</button>
                    </div>
                    <div>
                        <button onclick="testProvider('google')" class="btn btn-sm btn-success">🧪 Test</button>
                    </div>
                </div>
            </div>

            <!-- xAI Grok Provider -->
            <div class="provider-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="color: #2c3e50; margin-bottom: 0.5rem;">⚡ xAI Grok</h4>
                        <p style="color: #666; margin: 0; font-size: 0.9rem;">Grok Beta, Grok Vision - Requires API key</p>
                    </div>
                    <div>
                        <span id="xai-status" class="status-badge status-pending">⚪ Not Configured</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">API Key:</label>
                    <input type="password" id="xai-key" placeholder="xai-..." class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; width: 100%;">
                    <small style="color: #666;">Get your API key from <a href="https://console.x.ai/" target="_blank">xAI Console</a></small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 1rem; align-items: center;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Model:</label>
                        <select id="xai-model" class="form-control" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="grok-beta">Grok Beta</option>
                            <option value="grok-vision-beta">Grok Vision Beta</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.25rem; color: #2c3e50;">Default:</label>
                        <input type="checkbox" id="xai-default" style="transform: scale(1.2);">
                    </div>
                    <div>
                        <button onclick="saveProvider('xai')" class="btn btn-sm btn-primary">💾 Save</button>
                    </div>
                    <div>
                        <button onclick="testProvider('xai')" class="btn btn-sm btn-success">🧪 Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.9rem;
}

.provider-card {
    transition: box-shadow 0.3s ease;
}

.provider-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
</style>

<script>
// AI Settings JavaScript
let aiSettings = {};

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
});

async function loadSettings() {
    try {
        const response = await fetch('/api/ai/providers');
        if (response.ok) {
            aiSettings = await response.json();
            updateSettingsUI();
        }
    } catch (error) {
        console.error('Failed to load AI settings:', error);
    }
}

function updateSettingsUI() {
    // Update summary stats
    const enabledCount = Object.values(aiSettings.providers || {}).filter(p => p.enabled).length;
    document.getElementById('activeCount').textContent = enabledCount;
    
    // Update provider status indicators
    for (const [name, provider] of Object.entries(aiSettings.providers || {})) {
        const statusEl = document.getElementById(`${name}-status`);
        if (statusEl) {
            if (provider.enabled) {
                statusEl.className = 'status-badge status-operational';
                statusEl.textContent = '🟢 Active';
            } else {
                statusEl.className = 'status-badge status-pending';
                statusEl.textContent = '⚪ Not Configured';
            }
        }
    }
}

async function saveProvider(providerName) {
    const apiKey = document.getElementById(`${providerName}-key`).value.trim();
    if (!apiKey) {
        alert('Please enter an API key');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('api_key', apiKey);
        
        const response = await fetch(`/api/ai/providers/${providerName}/configure`, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`✅ ${providerName} configured successfully!`);
            loadSettings(); // Refresh settings
        } else {
            alert('❌ Failed to configure provider');
        }
    } catch (error) {
        console.error(`Failed to configure ${providerName}:`, error);
        alert('❌ Error configuring provider');
    }
}

async function testProvider(providerName) {
    const testButton = document.querySelector(`button[onclick="testProvider('${providerName}')"]`);
    const originalText = testButton.innerHTML;
    testButton.innerHTML = '⏳ Testing...';
    testButton.disabled = true;
    
    try {
        const model = document.getElementById(`${providerName}-model`)?.value || '';
        const apiKey = document.getElementById(`${providerName}-key`)?.value || '';
        
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: 'Hello, this is a test message. Please respond briefly.',
                provider: providerName,
                model: model,
                context: 'AI Provider Test'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                alert(`✅ ${providerName} test successful!\n\nResponse: ${result.response.substring(0, 100)}...`);
            } else {
                alert(`❌ ${providerName} test failed: ${result.error}`);
            }
        } else {
            alert(`❌ ${providerName} test failed: HTTP ${response.status}`);
        }
    } catch (error) {
        console.error(`Test failed for ${providerName}:`, error);
        alert(`❌ ${providerName} test failed: ${error.message}`);
    } finally {
        testButton.innerHTML = originalText;
        testButton.disabled = false;
    }
}

async function testConnections() {
    const providers = ['ollama', 'openai', 'anthropic', 'google', 'xai'];
    let results = [];
    
    for (const provider of providers) {
        const apiKey = document.getElementById(`${provider}-key`)?.value;
        if (provider === 'ollama' || apiKey) {
            try {
                await testProvider(provider);
                results.push(`✅ ${provider}: OK`);
            } catch (error) {
                results.push(`❌ ${provider}: Failed`);
            }
        } else {
            results.push(`⚪ ${provider}: Not configured`);
        }
    }
    
    alert('Connection Test Results:\n\n' + results.join('\n'));
}
</script>
{% endblock %}