{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Assets{% endblock %}
{% block page_icon %}🏭{% endblock %}
{% block page_title %}Assets Management{% endblock %}
{% block page_subtitle %}Monitor and manage all facility assets{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="addAsset()">
    ➕ Add Asset
</button>
<button class="btn btn-info" onclick="assetHealthReport()">
    📊 Health Report
</button>
<button class="btn btn-warning" onclick="scheduleMaintenanceMode()">
    🔧 Schedule Maintenance
</button>
<button class="btn btn-primary" onclick="importAssets()">
    📥 Import Assets
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card">
        <h3>Total Assets</h3>
        <div class="value">{{ assets|length }}</div>
        <div class="subtitle">Under management</div>
        <div class="ai-insight">🤖 📈 3 new assets this month</div>
    </div>
    
    <div class="summary-card">
        <h3>Operational</h3>
        <div class="value">{{ assets|selectattr("status", "equalto", "operational")|list|length }}</div>
        <div class="subtitle">Running normally</div>
        <div class="ai-insight">🤖 ✅ 95% uptime</div>
    </div>
    
    <div class="summary-card">
        <h3>Needs Maintenance</h3>
        <div class="value">{{ assets|selectattr("status", "equalto", "maintenance")|list|length }}</div>
        <div class="subtitle">Requires attention</div>
        <div class="ai-insight">🤖 ⚠️ Schedule soon</div>
    </div>
    
    <div class="summary-card">
        <h3>Avg Health Score</h3>
        <div class="value">88%</div>
        <div class="subtitle">Overall condition</div>
        <div class="ai-insight">🤖 🎯 Above target (85%)</div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Asset Filter Controls -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1rem;">🔍 Filter Assets</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <select id="typeFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Types</option>
            <option value="pump">Pumps</option>
            <option value="hvac">HVAC</option>
            <option value="conveyor">Conveyors</option>
            <option value="motor">Motors</option>
        </select>
        
        <select id="statusFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Status</option>
            <option value="operational">Operational</option>
            <option value="maintenance">Maintenance</option>
            <option value="down">Down</option>
        </select>
        
        <select id="locationFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Locations</option>
            <option value="building-a">Building A</option>
            <option value="building-b">Building B</option>
            <option value="warehouse">Warehouse</option>
        </select>
        
        <input type="text" id="searchAssets" placeholder="Search assets..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; flex-grow: 1; min-width: 200px;">
        
        <button class="btn btn-primary" onclick="applyAssetFilters()">Apply</button>
        <button class="btn btn-secondary" onclick="clearAssetFilters()">Clear</button>
    </div>
</div>

<div class="chatterfix-grid grid-cols-2">
    
    <!-- Assets Grid View -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">🏭 Asset Overview</h3>
        <div class="chatterfix-grid grid-cols-2" style="gap: 1rem;">
            {% for asset in assets %}
            <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); 
                        border-left: 4px solid {% if asset.health_score >= 90 %}var(--success-green){% elif asset.health_score >= 70 %}var(--warning-amber){% else %}var(--error-red){% endif %};" 
                 data-type="{{ asset.type|lower }}" data-status="{{ asset.status }}" data-location="{{ asset.location|lower|replace(' ', '-') }}">
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h4 style="margin-bottom: 0.5rem;">{{ asset.name }}</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">{{ asset.type }} • {{ asset.location }}</p>
                        <span class="status-badge status-{{ asset.status }}">{{ asset.status }}</span>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                            {% if asset.type == 'Pump' %}💧{% elif asset.type == 'HVAC' %}🌡️{% elif asset.type == 'Conveyor' %}📦{% else %}⚙️{% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Health Score -->
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <strong>Health Score</strong>
                        <span style="font-weight: bold; color: {% if asset.health_score >= 90 %}var(--success-green){% elif asset.health_score >= 70 %}var(--warning-amber){% else %}var(--error-red){% endif %};">
                            {{ asset.health_score }}%
                        </span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ asset.health_score }}%; 
                                                           background: {% if asset.health_score >= 90 %}var(--success-green){% elif asset.health_score >= 70 %}var(--warning-amber){% else %}var(--error-red){% endif %};"></div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button onclick="viewAssetDetails('{{ asset.id }}')" class="btn btn-sm btn-primary">👁️ Details</button>
                    <button onclick="scheduleAssetMaintenance('{{ asset.id }}')" class="btn btn-sm btn-warning">🔧 Maintain</button>
                    <button onclick="getAssetAIInsights('{{ asset.id }}')" class="btn btn-sm btn-info">🤖 AI Insights</button>
                    <button onclick="viewAssetHistory('{{ asset.id }}')" class="btn btn-sm btn-secondary">📊 History</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Asset Analytics & AI Insights -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">📊 Asset Analytics</h3>
        
        <!-- Health Distribution -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">🎯 Health Score Distribution</h4>
            <div style="display: flex; gap: 1rem;">
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 2rem; color: var(--success-green);">85%</div>
                    <small>Excellent (90%+)</small>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 2rem; color: var(--warning-amber);">12%</div>
                    <small>Good (70-89%)</small>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 2rem; color: var(--error-red);">3%</div>
                    <small>Poor (<70%)</small>
                </div>
            </div>
        </div>
        
        <!-- Critical Assets -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">⚠️ Assets Requiring Attention</h4>
            {% for asset in assets %}
            {% if asset.health_score < 80 or asset.status == 'maintenance' %}
            <div style="background: rgba(244, 67, 54, 0.1); padding: 1rem; border-radius: var(--border-radius); border-left: 3px solid var(--error-red); margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ asset.name }}</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            Health: {{ asset.health_score }}% • Status: {{ asset.status }}
                        </div>
                    </div>
                    <button onclick="prioritizeAsset('{{ asset.id }}')" class="btn btn-sm btn-warning">Prioritize</button>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <!-- AI Recommendations -->
        <div style="background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue)); color: white; padding: 1.5rem; border-radius: var(--border-radius);">
            <h4 style="margin-bottom: 1rem;">🤖 AI Asset Recommendations</h4>
            <div style="margin-bottom: 1rem;">
                <div style="margin-bottom: 0.5rem;">• Schedule preventive maintenance for Pump #1</div>
                <div style="margin-bottom: 0.5rem;">• Replace filters in HVAC Unit A within 7 days</div>
                <div style="margin-bottom: 0.5rem;">• Monitor vibration levels on Conveyor #3</div>
                <div style="margin-bottom: 0.5rem;">• Order replacement parts for Motor #2</div>
            </div>
            <button onclick="getDetailedAIAnalysis()" class="btn btn-sm" style="background: white; color: var(--primary-blue);">
                📋 Full AI Analysis Report
            </button>
        </div>
    </div>
</div>

<!-- Asset Performance Metrics -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1.5rem;">⚡ Performance Metrics</h3>
    <div style="display: flex; gap: 2rem; overflow-x: auto; padding-bottom: 1rem;">
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--success-green); margin-bottom: 0.5rem;">Uptime</h4>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">99.2%</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Last 30 days</div>
            <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(0, 200, 81, 0.1); border-radius: 4px; font-size: 0.8rem;">
                🤖 Above target (99%)
            </div>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--primary-blue); margin-bottom: 0.5rem;">Efficiency</h4>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">87%</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Average score</div>
            <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(102, 126, 234, 0.1); border-radius: 4px; font-size: 0.8rem;">
                🤖 Optimizing performance
            </div>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--warning-amber); margin-bottom: 0.5rem;">Maintenance Cost</h4>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">$12.4K</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">This month</div>
            <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(255, 152, 0, 0.1); border-radius: 4px; font-size: 0.8rem;">
                🤖 15% below budget
            </div>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--info-purple); margin-bottom: 0.5rem;">Energy Usage</h4>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">156 kWh</div>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">Daily average</div>
            <div style="margin-top: 1rem; padding: 0.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 4px; font-size: 0.8rem;">
                🤖 Consider efficiency upgrades
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Assets-specific JavaScript
function addAsset() {
    alert('Add new asset - Feature coming soon! Will include asset registration wizard.');
}

function viewAssetDetails(id) {
    alert(`View detailed information for Asset ${id} - Feature coming soon!`);
}

function scheduleAssetMaintenance(id) {
    if (confirm(`Schedule maintenance for Asset ${id}?`)) {
        alert(`Maintenance scheduled for Asset ${id}!`);
    }
}

async function getAssetAIInsights(id) {
    try {
        const response = await fetch(`/api/assets/${id}/ai-insights`);
        const data = await response.json();
        
        if (data.ai_insights) {
            alert(`🤖 AI Insights for ${data.asset.name}:\n\n${data.ai_insights}\n\nRecommendations:\n${data.recommendations.join('\n')}`);
        }
    } catch (error) {
        alert('Unable to get AI insights at this time.');
    }
}

function viewAssetHistory(id) {
    alert(`Asset history for Asset ${id} - Feature coming soon! Will show maintenance records, work orders, and performance trends.`);
}

function prioritizeAsset(id) {
    if (confirm(`Add Asset ${id} to priority maintenance list?`)) {
        alert(`Asset ${id} added to priority list!`);
    }
}

function assetHealthReport() {
    alert('Generating comprehensive asset health report - Feature coming soon!');
}

function scheduleMaintenanceMode() {
    alert('Bulk maintenance scheduling - Feature coming soon!');
}

function importAssets() {
    alert('Asset import wizard - Feature coming soon! Will support CSV, Excel, and API imports.');
}

function applyAssetFilters() {
    const typeFilter = document.getElementById('typeFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const locationFilter = document.getElementById('locationFilter').value;
    const searchFilter = document.getElementById('searchAssets').value.toLowerCase();
    
    const assetCards = document.querySelectorAll('[data-type]');
    
    assetCards.forEach(card => {
        const type = card.dataset.type;
        const status = card.dataset.status;
        const location = card.dataset.location;
        const text = card.textContent.toLowerCase();
        
        const matchesType = !typeFilter || type === typeFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesLocation = !locationFilter || location === locationFilter;
        const matchesSearch = !searchFilter || text.includes(searchFilter);
        
        card.style.display = matchesType && matchesStatus && matchesLocation && matchesSearch ? '' : 'none';
    });
}

function clearAssetFilters() {
    document.getElementById('typeFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('locationFilter').value = '';
    document.getElementById('searchAssets').value = '';
    applyAssetFilters();
}

async function getDetailedAIAnalysis() {
    try {
        const response = await sendChatMessage('Generate a comprehensive asset analysis report with recommendations for all assets', 'manager');
        alert('🤖 Detailed AI Analysis:\n\nGenerating comprehensive report based on current asset data, maintenance history, and predictive analytics...\n\nReport will include:\n• Risk assessment for each asset\n• Maintenance scheduling optimization\n• Cost reduction opportunities\n• Performance improvement recommendations');
    } catch (error) {
        alert('Unable to generate detailed analysis at this time.');
    }
}

// Asset search and filtering
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchAssets');
    if (searchInput) {
        searchInput.addEventListener('input', applyAssetFilters);
    }
});

// Helper function to send AI messages with asset context
async function sendChatMessage(message, context = 'technician') {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                user_role: context,
                context: 'Asset management'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add to chat window
            addChatMessage(message, 'user');
            addChatMessage(data.response, 'ai');
            return data.response;
        }
    } catch (error) {
        console.error('Asset AI message error:', error);
    }
}
{% endblock %}