{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Dashboard{% endblock %}
{% block page_icon %}📊{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Overview of your maintenance operations{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="createWorkOrder()">
    ➕ Create Work Order
</button>
<button class="btn btn-info" onclick="viewAnalytics()">
    📈 Analytics
</button>
<button class="btn btn-warning" onclick="generateReport()">
    📋 Generate Report
</button>
<button class="btn btn-primary" onclick="refreshData()">
    🔄 Refresh Data
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card">
        <h3>Active Work Orders</h3>
        <div class="value">{{ stats.active_workorders }}</div>
        <div class="subtitle">In progress</div>
        <div class="ai-insight">🤖 📈 5% increase this week</div>
    </div>
    
    <div class="summary-card">
        <h3>Assets Monitored</h3>
        <div class="value">{{ stats.total_assets }}</div>
        <div class="subtitle">Under management</div>
        <div class="ai-insight">🤖 ✅ 92% operational</div>
    </div>
    
    <div class="summary-card">
        <h3>Parts in Stock</h3>
        <div class="value">{{ stats.parts_in_stock }}</div>
        <div class="subtitle">Available parts</div>
        <div class="ai-insight">🤖 ⚠️ 3 low stock alerts</div>
    </div>
    
    <div class="summary-card">
        <h3>System Health</h3>
        <div class="value">{{ stats.system_health }}%</div>
        <div class="subtitle">Overall performance</div>
        <div class="ai-insight">🤖 🎯 Excellent status</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="chatterfix-grid grid-cols-2">
    
    <!-- Recent Work Orders -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">📋 Recent Work Orders</h3>
        {% for wo in recent_workorders %}
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); cursor: pointer;" onclick="viewWorkOrder('{{ wo.id }}')">
            <div>
                <strong>WO-{{ wo.id }}</strong> - {{ wo.title }}<br>
                <small style="color: var(--text-secondary);">{{ wo.asset_name }} • {{ wo.technician }}</small>
            </div>
            <div style="text-align: right;">
                <span class="status-badge status-{{ wo.status|lower|replace(' ', '-') }}">{{ wo.status }}</span><br>
                <small style="color: var(--text-muted);">{{ wo.priority }} Priority</small>
                <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button onclick="event.stopPropagation(); viewWorkOrder('{{ wo.id }}')" class="btn btn-sm btn-primary">View</button>
                    <button onclick="event.stopPropagation(); editWorkOrder('{{ wo.id }}')" class="btn btn-sm btn-warning">Edit</button>
                    {% if wo.status == 'assigned' %}
                    <button onclick="event.stopPropagation(); startWork('{{ wo.id }}')" class="btn btn-sm btn-success">Start</button>
                    {% elif wo.status == 'in_progress' %}
                    <button onclick="event.stopPropagation(); completeWork('{{ wo.id }}')" class="btn btn-sm btn-success">Complete</button>
                    {% endif %}
                    <button onclick="event.stopPropagation(); addPhoto('{{ wo.id }}')" class="btn btn-sm btn-info">📷</button>
                    <button onclick="event.stopPropagation(); addNote('{{ wo.id }}')" class="btn btn-sm btn-secondary">📝</button>
                </div>
            </div>
        </div>
        {% endfor %}
        <div style="text-align: center; margin-top: 1rem;">
            <a href="/work-orders" class="btn btn-primary">View All Work Orders</a>
        </div>
    </div>
    
    <!-- Asset Health Overview -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">🏭 Asset Health Overview</h3>
        {% for asset in top_assets %}
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <strong>{{ asset.name }}</strong>
                <span style="font-size: 0.8rem; color: var(--text-secondary);">{{ asset.health_score }}% Health</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ asset.health_score }}%;"></div>
            </div>
            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                <span class="status-badge status-{{ asset.status }}">{{ asset.status }}</span>
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="viewAsset('{{ asset.id }}')" class="btn btn-sm btn-primary">View</button>
                    <button onclick="getAIInsights('{{ asset.id }}')" class="btn btn-sm btn-info">🤖 AI Insights</button>
                </div>
            </div>
        </div>
        {% endfor %}
        <div style="text-align: center; margin-top: 1rem;">
            <a href="/assets" class="btn btn-primary">View All Assets</a>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1.5rem;">⚡ Quick Actions</h3>
    <div class="chatterfix-grid grid-cols-4">
        <button class="btn btn-primary" onclick="createWorkOrder()" style="padding: 2rem; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <span style="font-size: 2rem;">📋</span>
            Create Work Order
        </button>
        <button class="btn btn-success" onclick="addAsset()" style="padding: 2rem; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <span style="font-size: 2rem;">🏭</span>
            Add Asset
        </button>
        <button class="btn btn-warning" onclick="addPart()" style="padding: 2rem; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <span style="font-size: 2rem;">🔧</span>
            Add Part
        </button>
        <button class="btn btn-info" onclick="scheduleMaintenace()" style="padding: 2rem; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
            <span style="font-size: 2rem;">📅</span>
            Schedule Maintenance
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Dashboard-specific JavaScript
function viewWorkOrder(id) {
    window.location.href = `/work-orders?id=${id}`;
}

function editWorkOrder(id) {
    // In a real app, this would open an edit modal
    alert(`Edit Work Order ${id} - Feature coming soon!`);
}

function startWork(id) {
    if (confirm(`Start work on Work Order ${id}?`)) {
        // Update work order status
        alert(`Work Order ${id} started!`);
        refreshData();
    }
}

function completeWork(id) {
    if (confirm(`Mark Work Order ${id} as complete?`)) {
        // Update work order status
        alert(`Work Order ${id} completed!`);
        refreshData();
    }
}

function addPhoto(id) {
    alert(`Add photo to Work Order ${id} - Feature coming soon!`);
}

function addNote(id) {
    const note = prompt(`Add note to Work Order ${id}:`);
    if (note) {
        alert(`Note added to Work Order ${id}: ${note}`);
    }
}

function viewAsset(id) {
    window.location.href = `/assets?id=${id}`;
}

async function getAIInsights(id) {
    try {
        const response = await fetch(`/api/assets/${id}/ai-insights`);
        const data = await response.json();
        
        if (data.ai_insights) {
            alert(`🤖 AI Insights for ${data.asset.name}:\n\n${data.ai_insights}`);
        }
    } catch (error) {
        alert('Unable to get AI insights at this time.');
    }
}

function createWorkOrder() {
    window.location.href = '/work-orders?action=create';
}

function addAsset() {
    window.location.href = '/assets?action=create';
}

function addPart() {
    window.location.href = '/parts?action=create';
}

function scheduleMaintenace() {
    window.location.href = '/scheduler';
}

function viewAnalytics() {
    alert('Analytics dashboard coming soon!');
}

function generateReport() {
    alert('Report generation coming soon!');
}
{% endblock %}