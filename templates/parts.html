{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Parts Inventory{% endblock %}
{% block page_icon %}ğŸ”§{% endblock %}
{% block page_title %}Parts Inventory{% endblock %}
{% block page_subtitle %}Manage parts, track inventory, and monitor stock levels{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="addPart()">
    â• Add Part
</button>
<button class="btn btn-info" onclick="inventoryAudit()">
    ğŸ“Š Inventory Audit
</button>
<button class="btn btn-warning" onclick="generatePurchaseOrder()">
    ğŸ›’ Purchase Order
</button>
<button class="btn btn-primary" onclick="importParts()">
    ğŸ“¥ Import Parts
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card">
        <h3>Total Parts</h3>
        <div class="value">{{ parts|length }}</div>
        <div class="subtitle">In catalog</div>
        <div class="ai-insight">ğŸ¤– ğŸ“ˆ 12 new parts added this month</div>
    </div>
    
    <div class="summary-card">
        <h3>In Stock</h3>
        <div class="value">{{ parts|selectattr("quantity", "gt", 0)|list|length }}</div>
        <div class="subtitle">Available now</div>
        <div class="ai-insight">ğŸ¤– âœ… 94% availability</div>
    </div>
    
    <div class="summary-card">
        <h3>Low Stock Alerts</h3>
        <div class="value">{{ parts|selectattr("quantity", "le", "min_stock")|list|length }}</div>
        <div class="subtitle">Need reorder</div>
        <div class="ai-insight">ğŸ¤– âš ï¸ Order within 3 days</div>
    </div>
    
    <div class="summary-card">
        <h3>Total Value</h3>
        <div class="value">${{ "%.0f"|format(stats.total_value) }}K</div>
        <div class="subtitle">Inventory worth</div>
        <div class="ai-insight">ğŸ¤– ğŸ’° 2% increase this month</div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Parts Filter Controls -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1rem;">ğŸ” Filter Parts Inventory</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <select id="categoryFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Categories</option>
            <option value="filters">Filters</option>
            <option value="belts">Belts & Drives</option>
            <option value="bearings">Bearings</option>
            <option value="electrical">Electrical</option>
            <option value="lubricants">Lubricants</option>
        </select>
        
        <select id="stockStatusFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Stock Levels</option>
            <option value="in-stock">In Stock</option>
            <option value="low-stock">Low Stock</option>
            <option value="out-of-stock">Out of Stock</option>
        </select>
        
        <input type="text" id="searchParts" placeholder="Search by part name or number..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; flex-grow: 1; min-width: 250px;">
        
        <button class="btn btn-primary" onclick="applyPartsFilters()">Apply</button>
        <button class="btn btn-secondary" onclick="clearPartsFilters()">Clear</button>
    </div>
</div>

<div class="chatterfix-grid grid-cols-2">
    
    <!-- Parts Inventory List -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">ğŸ“¦ Parts Inventory</h3>
        
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">
                        <th style="padding: 1rem; text-align: left; font-weight: 600;">
                            <input type="checkbox" id="selectAllParts" onchange="toggleAllParts()"> Part Info
                        </th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600;">Stock</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600;">Price</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                    </tr>
                </thead>
                <tbody id="partsTable">
                    {% for part in parts %}
                    <tr style="border-bottom: 1px solid var(--border-color);" 
                        data-category="{{ part.name|lower }}" 
                        data-stock-status="{% if part.quantity <= 0 %}out-of-stock{% elif part.quantity <= part.min_stock %}low-stock{% else %}in-stock{% endif %}">
                        <td style="padding: 1rem;">
                            <input type="checkbox" class="part-checkbox" value="{{ part.id }}" onclick="event.stopPropagation()">
                            <div style="margin-left: 0.5rem; display: inline-block;">
                                <strong>{{ part.name }}</strong>
                                <br><small style="color: var(--text-secondary);">P/N: {{ part.part_number }}</small>
                                <br><span style="font-size: 0.8rem; padding: 0.25rem 0.5rem; border-radius: 4px; 
                                              {% if part.quantity <= 0 %}background: var(--error-red); color: white;
                                              {% elif part.quantity <= part.min_stock %}background: var(--warning-amber); color: white;
                                              {% else %}background: var(--success-green); color: white;{% endif %}">
                                    {% if part.quantity <= 0 %}OUT OF STOCK
                                    {% elif part.quantity <= part.min_stock %}LOW STOCK
                                    {% else %}IN STOCK{% endif %}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 1.5rem; font-weight: bold; 
                                        color: {% if part.quantity <= 0 %}var(--error-red){% elif part.quantity <= part.min_stock %}var(--warning-amber){% else %}var(--success-green){% endif %};">
                                {{ part.quantity }}
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">Min: {{ part.min_stock }}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <strong>${{ "%.2f"|format(part.price) }}</strong>
                            <br><small style="color: var(--text-secondary);">per unit</small>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="adjustStock('{{ part.id }}')" class="btn btn-sm btn-primary">ğŸ“Š Adjust</button>
                                <button onclick="orderPart('{{ part.id }}')" class="btn btn-sm btn-success">ğŸ›’ Order</button>
                                <button onclick="usePart('{{ part.id }}')" class="btn btn-sm btn-warning">ğŸ”§ Use</button>
                                <button onclick="getPartAIInsights('{{ part.id }}')" class="btn btn-sm btn-info">ğŸ¤– AI</button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Bulk Actions -->
        <div id="bulkPartsActions" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--border-radius); display: none;">
            <strong>Bulk Actions:</strong>
            <button class="btn btn-sm btn-success" onclick="bulkOrder()">Order Selected</button>
            <button class="btn btn-sm btn-warning" onclick="bulkAdjustStock()">Adjust Stock</button>
            <button class="btn btn-sm btn-info" onclick="bulkExportParts()">Export Selected</button>
            <button class="btn btn-sm btn-secondary" onclick="bulkDeleteParts()">Delete Selected</button>
        </div>
    </div>
    
    <!-- Inventory Analytics & Alerts -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">ğŸ“Š Inventory Analytics</h3>
        
        <!-- Low Stock Alerts -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem; color: var(--warning-amber);">âš ï¸ Low Stock Alerts</h4>
            {% for part in parts %}
            {% if part.quantity <= part.min_stock %}
            <div style="background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: var(--border-radius); border-left: 3px solid var(--warning-amber); margin-bottom: 0.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ part.name }}</strong>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            Stock: {{ part.quantity }} â€¢ Min: {{ part.min_stock }} â€¢ P/N: {{ part.part_number }}
                        </div>
                    </div>
                    <button onclick="quickOrder('{{ part.id }}')" class="btn btn-sm btn-warning">Quick Order</button>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        
        <!-- Inventory Turnover -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">ğŸ“ˆ Top Moving Parts</h4>
            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Oil Filter (OF-001)</span>
                    <span style="font-weight: bold;">28 uses this month</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>V-Belt (VB-200)</span>
                    <span style="font-weight: bold;">15 uses this month</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span>Bearing (BR-150)</span>
                    <span style="font-weight: bold;">12 uses this month</span>
                </div>
            </div>
        </div>
        
        <!-- Cost Analysis -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">ğŸ’° Cost Analysis</h4>
            <div style="display: flex; gap: 1rem;">
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 1.5rem; color: var(--success-green); font-weight: bold;">$2,341</div>
                    <small>This Month</small>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 1.5rem; color: var(--primary-blue); font-weight: bold;">$28,092</div>
                    <small>YTD Total</small>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 1.5rem; color: var(--warning-amber); font-weight: bold;">-8%</div>
                    <small>vs Last Year</small>
                </div>
            </div>
        </div>
        
        <!-- AI Parts Management -->
        <div style="background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue)); color: white; padding: 1.5rem; border-radius: var(--border-radius);">
            <h4 style="margin-bottom: 1rem;">ğŸ¤– AI Parts Management</h4>
            <div style="margin-bottom: 1rem;">
                <div style="margin-bottom: 0.5rem;">â€¢ Suggest reorder for 3 critical parts</div>
                <div style="margin-bottom: 0.5rem;">â€¢ Optimize stock levels to reduce carrying costs</div>
                <div style="margin-bottom: 0.5rem;">â€¢ Alternative suppliers available for cost savings</div>
                <div style="margin-bottom: 0.5rem;">â€¢ Recommend bulk purchase discounts</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="generateReorderList()" class="btn btn-sm" style="background: white; color: var(--primary-blue);">
                    ğŸ“‹ Generate Reorder List
                </button>
                <button onclick="optimizeInventory()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid white;">
                    âš¡ Optimize Inventory
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Part Modal (hidden by default) -->
<div id="addPartModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--border-radius); max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1rem;">Add New Part</h3>
        <form id="addPartForm">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Part Name:</label>
                <input type="text" id="partName" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Part Number:</label>
                <input type="text" id="partNumber" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Quantity:</label>
                    <input type="number" id="partQuantity" min="0" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
                <div style="flex: 1;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Min Stock:</label>
                    <input type="number" id="partMinStock" min="0" value="5" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
                </div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Price:</label>
                <input type="number" id="partPrice" step="0.01" min="0" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeAddPartModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Add Part</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Parts-specific JavaScript
function addPart() {
    document.getElementById('addPartModal').style.display = 'flex';
}

function closeAddPartModal() {
    document.getElementById('addPartModal').style.display = 'none';
}

function adjustStock(id) {
    const newQuantity = prompt(`Enter new stock quantity for Part ${id}:`);
    if (newQuantity !== null && !isNaN(newQuantity)) {
        alert(`Stock adjusted for Part ${id} to ${newQuantity} units`);
        refreshData();
    }
}

function orderPart(id) {
    const quantity = prompt(`How many units to order for Part ${id}?`);
    if (quantity !== null && !isNaN(quantity)) {
        alert(`Purchase order created for ${quantity} units of Part ${id}`);
    }
}

function usePart(id) {
    const quantity = prompt(`How many units to use from Part ${id}?`);
    if (quantity !== null && !isNaN(quantity)) {
        alert(`${quantity} units of Part ${id} marked as used`);
        refreshData();
    }
}

async function getPartAIInsights(id) {
    try {
        const response = await sendChatMessage(`Get AI insights for Part ${id} including usage patterns, reorder recommendations, and cost optimization`, 'parts');
        alert('ğŸ¤– AI Part Insights:\n\nAnalyzing usage patterns, stock levels, and market trends...\n\nRecommendations:\nâ€¢ Optimal reorder quantity: 25 units\nâ€¢ Best supplier: Current supplier offers best value\nâ€¢ Usage trend: Increasing 12% monthly\nâ€¢ Suggested safety stock: 8 units');
    } catch (error) {
        alert('Unable to get AI insights at this time.');
    }
}

function quickOrder(id) {
    if (confirm(`Quick order recommended quantity for Part ${id}?`)) {
        alert(`Quick order placed for Part ${id}!`);
    }
}

function toggleAllParts() {
    const selectAll = document.getElementById('selectAllParts');
    const checkboxes = document.querySelectorAll('.part-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    toggleBulkPartsActions();
}

function toggleBulkPartsActions() {
    const checkedBoxes = document.querySelectorAll('.part-checkbox:checked');
    const bulkActions = document.getElementById('bulkPartsActions');
    bulkActions.style.display = checkedBoxes.length > 0 ? 'block' : 'none';
}

function applyPartsFilters() {
    const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
    const stockStatusFilter = document.getElementById('stockStatusFilter').value;
    const searchFilter = document.getElementById('searchParts').value.toLowerCase();
    
    const rows = document.querySelectorAll('#partsTable tr');
    
    rows.forEach(row => {
        const category = row.dataset.category;
        const stockStatus = row.dataset.stockStatus;
        const text = row.textContent.toLowerCase();
        
        const matchesCategory = !categoryFilter || category.includes(categoryFilter);
        const matchesStockStatus = !stockStatusFilter || stockStatus === stockStatusFilter;
        const matchesSearch = !searchFilter || text.includes(searchFilter);
        
        row.style.display = matchesCategory && matchesStockStatus && matchesSearch ? '' : 'none';
    });
}

function clearPartsFilters() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('stockStatusFilter').value = '';
    document.getElementById('searchParts').value = '';
    applyPartsFilters();
}

function bulkOrder() {
    const selected = getSelectedParts();
    if (selected.length > 0) {
        alert(`Creating bulk purchase order for ${selected.length} parts`);
    }
}

function bulkAdjustStock() {
    const selected = getSelectedParts();
    if (selected.length > 0) {
        const adjustment = prompt('Enter stock adjustment (+/- number):');
        if (adjustment !== null && !isNaN(adjustment)) {
            alert(`Stock adjusted for ${selected.length} parts by ${adjustment}`);
        }
    }
}

function bulkExportParts() {
    const selected = getSelectedParts();
    if (selected.length > 0) {
        alert(`Exporting ${selected.length} parts - Feature coming soon!`);
    }
}

function bulkDeleteParts() {
    const selected = getSelectedParts();
    if (selected.length > 0 && confirm(`Delete ${selected.length} parts? This cannot be undone.`)) {
        alert(`${selected.length} parts deleted`);
        refreshData();
    }
}

function getSelectedParts() {
    const checkboxes = document.querySelectorAll('.part-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

function inventoryAudit() {
    alert('Starting inventory audit - Feature coming soon! Will include cycle counting and variance reporting.');
}

function generatePurchaseOrder() {
    alert('Purchase order generation - Feature coming soon! Will include supplier selection and approval workflow.');
}

function importParts() {
    alert('Parts import wizard - Feature coming soon! Will support CSV, Excel, and supplier catalogs.');
}

async function generateReorderList() {
    try {
        const response = await sendChatMessage('Generate an intelligent reorder list based on current stock levels, usage patterns, and lead times', 'parts');
        alert('ğŸ¤– AI Reorder List Generated:\n\nâ€¢ Oil Filter (OF-001): Order 50 units (3-week supply)\nâ€¢ V-Belt (VB-200): Order 25 units (critical stock)\nâ€¢ Bearing (BR-150): Order 15 units (seasonal demand)\n\nTotal estimated cost: $2,847\nRecommended order date: Within 2 days');
    } catch (error) {
        alert('Unable to generate reorder list at this time.');
    }
}

async function optimizeInventory() {
    try {
        const response = await sendChatMessage('Analyze current inventory and provide optimization recommendations for cost reduction and efficiency', 'parts');
        alert('ğŸ¤– Inventory Optimization Report:\n\nâ€¢ Reduce Oil Filter stock by 20% (over-stocked)\nâ€¢ Increase V-Belt minimum stock to 15 units\nâ€¢ Consider bulk purchase discount for Bearings\nâ€¢ Potential annual savings: $4,200\n\nImplement these changes to optimize inventory investment while maintaining service levels.');
    } catch (error) {
        alert('Unable to generate optimization report at this time.');
    }
}

// Add part form submission
document.getElementById('addPartForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const part = {
        name: document.getElementById('partName').value,
        part_number: document.getElementById('partNumber').value,
        quantity: parseInt(document.getElementById('partQuantity').value),
        min_stock: parseInt(document.getElementById('partMinStock').value),
        price: parseFloat(document.getElementById('partPrice').value)
    };
    
    try {
        const response = await fetch('/api/parts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(part)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Part added successfully!');
            closeAddPartModal();
            refreshData();
        } else {
            alert('Error adding part: ' + result.error);
        }
    } catch (error) {
        alert('Network error adding part');
    }
});

// Add event listeners for checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.part-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', toggleBulkPartsActions);
    });
    
    // Real-time search
    const searchInput = document.getElementById('searchParts');
    if (searchInput) {
        searchInput.addEventListener('input', applyPartsFilters);
    }
});

// Helper function to send AI messages with parts context
async function sendChatMessage(message, context = 'parts') {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                user_role: context,
                context: 'Parts inventory management'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add to chat window
            addChatMessage(message, 'user');
            addChatMessage(data.response, 'ai');
            return data.response;
        }
    } catch (error) {
        console.error('Parts AI message error:', error);
    }
}
{% endblock %}