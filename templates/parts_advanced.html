{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Advanced Parts Intelligence{% endblock %}
{% block page_icon %}🧠{% endblock %}
{% block page_title %}Advanced Parts Intelligence{% endblock %}
{% block page_subtitle %}AI-Powered Inventory with Predictive Analytics & Fix It Fred Brain{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="fredSmartOrder()">
    🤖 Fred Smart Order
</button>
<button class="btn btn-info" onclick="predictiveAnalytics()">
    🔮 Predictive Analytics
</button>
<button class="btn btn-warning" onclick="autoOptimize()">
    ⚡ Auto-Optimize
</button>
<button class="btn btn-primary" onclick="fredInventoryAssist()">
    🧠 Fred Inventory Brain
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card" style="background: linear-gradient(135deg, #2c3e50, #34495e);">
        <h3>AI Predictions</h3>
        <div class="value">94%</div>
        <div class="subtitle">Accuracy this month</div>
        <div class="ai-insight">🤖 Fred's learning improving</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #667eea, #764ba2);">
        <h3>Smart Orders</h3>
        <div class="value">$12.4K</div>
        <div class="subtitle">Cost savings this quarter</div>
        <div class="ai-insight">🤖 Fred's optimization wins</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #00c851, #00a86b);">
        <h3>Stockout Prevention</h3>
        <div class="value">99.2%</div>
        <div class="subtitle">Success rate</div>
        <div class="ai-insight">🤖 Fred prevented 23 stockouts</div>
    </div>
    
    <div class="summary-card" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
        <h3>Fred Intelligence</h3>
        <div class="value">Advanced</div>
        <div class="subtitle">Learning mode active</div>
        <div class="ai-insight">🤖 Processing 1M+ data points</div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Fix It Fred AI Command Center -->
<div class="chatterfix-card" style="background: linear-gradient(135deg, #2c3e50, #3498db); color: white; margin-bottom: 2rem;">
    <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
        <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;">🧠</div>
        Fix It Fred - Advanced Parts Intelligence
    </h3>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
            <h4>🔮 Predictive Insights</h4>
            <p style="margin: 0.5rem 0; opacity: 0.9;">"Based on usage patterns, you'll need V-Belts in 8 days"</p>
            <button onclick="fredPredictiveInsight()" class="btn btn-sm" style="background: white; color: #2c3e50;">Ask Fred</button>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
            <h4>💰 Cost Optimization</h4>
            <p style="margin: 0.5rem 0; opacity: 0.9;">"I found 3 suppliers with 15% better pricing"</p>
            <button onclick="fredCostOptimize()" class="btn btn-sm" style="background: white; color: #2c3e50;">Optimize Now</button>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
            <h4>⚡ Auto-Reorder</h4>
            <p style="margin: 0.5rem 0; opacity: 0.9;">"I can handle all reorders automatically"</p>
            <button onclick="fredAutoReorder()" class="btn btn-sm" style="background: white; color: #2c3e50;">Enable Auto</button>
        </div>
        
        <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px;">
            <h4>🔧 Work Order Integration</h4>
            <p style="margin: 0.5rem 0; opacity: 0.9;">"Linked to 5 active work orders"</p>
            <button onclick="fredWorkOrderLink()" class="btn btn-sm" style="background: white; color: #2c3e50;">View Links</button>
        </div>
    </div>
    
    <!-- Advanced Fred Chat Interface -->
    <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px;">
        <h4 style="margin-bottom: 1rem;">🤖 Chat with Fix It Fred - Advanced AI Assistant</h4>
        
        <!-- Chat Messages Area -->
        <div id="fredChatMessages" style="background: rgba(255,255,255,0.9); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; max-height: 300px; overflow-y: auto; min-height: 150px;">
            <div style="padding: 0.5rem; background: #f8f9fa; border-radius: 4px; margin-bottom: 0.5rem; border-left: 4px solid #2c3e50;">
                <strong style="color: #2c3e50;">🤖 Fix It Fred:</strong>
                <div style="color: #333; margin-top: 0.25rem;">Hello! I'm Fix It Fred, your AI parts intelligence assistant. I can help with inventory optimization, cost analysis, supplier recommendations, and predictive insights. What would you like to know?</div>
            </div>
        </div>
        
        <!-- File Upload Area -->
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.1); border-radius: 6px; border: 2px dashed rgba(255,255,255,0.3);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                <span style="font-size: 0.9rem; opacity: 0.9;">📎 Attach files for Fred to analyze:</span>
                <input type="file" id="fredFileUpload" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.txt" style="display: none;">
                <button onclick="document.getElementById('fredFileUpload').click()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">📎 Choose Files</button>
                <button onclick="document.getElementById('fredPhotoUpload').click()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">📷 Take Photo</button>
            </div>
            <input type="file" id="fredPhotoUpload" accept="image/*" capture="camera" style="display: none;">
            <div id="fredUploadedFiles" style="font-size: 0.8rem; opacity: 0.8;"></div>
        </div>
        
        <!-- Chat Input Area -->
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
            <div style="flex: 1;">
                <textarea id="fredChatInput" placeholder="Ask Fred about inventory, suppliers, costs, predictions, work orders, or upload documents for analysis..." style="width: 100%; padding: 0.75rem; border: none; border-radius: 6px; color: #333; resize: vertical; min-height: 60px; font-family: inherit;" rows="2"></textarea>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <button onclick="sendFredMessage()" class="btn btn-sm" style="background: white; color: #2c3e50; font-weight: bold; padding: 0.75rem 1rem;">🚀 Send</button>
                <button onclick="fredVoiceInput()" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; font-size: 0.8rem;">🎤 Voice</button>
            </div>
        </div>
        
        <!-- Quick Action Buttons -->
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button onclick="askFredQuickQuestion('Show me critical parts that need immediate attention')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem;">🚨 Critical Parts</button>
            <button onclick="askFredQuickQuestion('What are your cost optimization recommendations?')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem;">💰 Cost Optimization</button>
            <button onclick="askFredQuickQuestion('Predict next 30 days inventory needs')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem;">🔮 Predictions</button>
            <button onclick="askFredQuickQuestion('Analyze supplier performance')" class="btn btn-sm" style="background: rgba(255,255,255,0.1); color: white; font-size: 0.8rem;">📊 Suppliers</button>
        </div>
    </div>
</div>

<div class="chatterfix-grid grid-cols-2">
    
    <!-- Smart Inventory Dashboard -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">🧠 Smart Inventory Dashboard</h3>
        
        <!-- AI-Powered Alerts -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem; color: #2c3e50;">🚨 Fred's Priority Alerts</h4>
            
            <div style="background: rgba(244, 67, 54, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #f44336; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #f44336;">🔥 CRITICAL: Circuit Breaker (CB-20A)</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                            Out of stock • Used in WO-124 (due today) • Lead time: 3 days
                        </div>
                        <div style="font-size: 0.8rem; color: #2c3e50; margin-top: 0.25rem;">
                            🤖 Fred suggests: Emergency order from Supplier B (+$50 rush fee)
                        </div>
                    </div>
                    <button onclick="fredEmergencyOrder('CB-20A')" class="btn btn-sm" style="background: #f44336; color: white;">Emergency Order</button>
                </div>
            </div>
            
            <div style="background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 8px; border-left: 4px solid #ff9800; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: #ff9800;">⚠️ URGENT: Hydraulic Hose (HH-300)</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                            Only 1 left • High usage trend detected • 3 work orders pending
                        </div>
                        <div style="font-size: 0.8rem; color: #2c3e50; margin-top: 0.25rem;">
                            🤖 Fred recommends: Order 12 units, bulk discount available
                        </div>
                    </div>
                    <button onclick="fredSmartReorder('HH-300')" class="btn btn-sm" style="background: #ff9800; color: white;">Smart Order</button>
                </div>
            </div>
        </div>
        
        <!-- Predictive Analytics -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem; color: #667eea;">📊 Fred's Predictive Analytics</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="margin-bottom: 1rem;">
                    <strong>Oil Filter (OF-001)</strong>
                    <div style="font-size: 0.9rem; color: #666;">Stock: 15 units • Predicted depletion: 12 days</div>
                    <div class="progress-bar" style="margin: 0.5rem 0;">
                        <div class="progress-fill" style="width: 65%; background: #00c851;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #2c3e50;">🤖 Fred: Order in 5 days for optimal timing</div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <strong>V-Belt (VB-200)</strong>
                    <div style="font-size: 0.9rem; color: #666;">Stock: 3 units • Predicted depletion: 8 days</div>
                    <div class="progress-bar" style="margin: 0.5rem 0;">
                        <div class="progress-fill" style="width: 30%; background: #ff9800;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #2c3e50;">🤖 Fred: ORDER NOW - High probability of stockout</div>
                </div>
            </div>
        </div>
        
        <!-- Work Order Integration -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #6366f1;">🔗 Work Order Integration</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span>WO-123: Pump #1 Maintenance</span>
                    <span style="color: #00c851;">✅ Parts Available</span>
                </div>
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span>WO-124: Electrical Repair</span>
                    <span style="color: #f44336;">❌ Missing Circuit Breaker</span>
                </div>
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span>WO-125: Belt Replacement</span>
                    <span style="color: #ff9800;">⚠️ Low Stock Warning</span>
                </div>
                <button onclick="viewWorkOrderParts()" class="btn btn-sm btn-primary" style="margin-top: 0.5rem;">View All Dependencies</button>
            </div>
        </div>
    </div>
    
    <!-- Advanced Parts Management -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">⚡ Advanced Parts Management</h3>
        
        <!-- Smart Filters -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">🔍 Fred's Smart Filters</h4>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                <button onclick="fredFilter('critical')" class="btn btn-sm" style="background: #f44336; color: white;">🔥 Critical</button>
                <button onclick="fredFilter('lowstock')" class="btn btn-sm" style="background: #ff9800; color: white;">📉 Low Stock</button>
                <button onclick="fredFilter('trending')" class="btn btn-sm" style="background: #667eea; color: white;">📈 Trending</button>
                <button onclick="fredFilter('obsolete')" class="btn btn-sm" style="background: #6c757d; color: white;">🗑️ Obsolete</button>
                <button onclick="fredFilter('workorders')" class="btn btn-sm" style="background: #00c851; color: white;">🔗 In Work Orders</button>
            </div>
        </div>
        
        <!-- Parts List with AI Insights -->
        <div style="max-height: 500px; overflow-y: auto;">
            {% for part in parts %}
            <div style="background: {% if part.quantity == 0 %}rgba(244, 67, 54, 0.1){% elif part.quantity <= part.min_stock %}rgba(255, 152, 0, 0.1){% else %}#f8f9fa{% endif %}; 
                        padding: 1rem; margin-bottom: 1rem; border-radius: 8px; 
                        border-left: 4px solid {% if part.quantity == 0 %}#f44336{% elif part.quantity <= part.min_stock %}#ff9800{% else %}#00c851{% endif %};">
                
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                            <strong style="font-size: 1.1rem;">{{ part.name }}</strong>
                            <span style="background: {% if part.quantity == 0 %}#f44336{% elif part.quantity <= part.min_stock %}#ff9800{% else %}#00c851{% endif %}; 
                                         color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                {% if part.quantity == 0 %}OUT OF STOCK{% elif part.quantity <= part.min_stock %}LOW STOCK{% else %}IN STOCK{% endif %}
                            </span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                            <div><small>P/N:</small> <strong>{{ part.part_number }}</strong></div>
                            <div><small>Stock:</small> <strong style="color: {% if part.quantity == 0 %}#f44336{% elif part.quantity <= part.min_stock %}#ff9800{% else %}#00c851{% endif %};">{{ part.quantity }}</strong></div>
                            <div><small>Min:</small> {{ part.min_stock }}</div>
                            <div><small>Location:</small> {{ part.location }}</div>
                            <div><small>Price:</small> ${{ "%.2f"|format(part.price) }}</div>
                            <div><small>Category:</small> {{ part.category|title }}</div>
                        </div>
                        
                        <!-- AI Insights for this part -->
                        <div style="background: rgba(255, 107, 53, 0.1); padding: 0.75rem; border-radius: 6px; margin: 0.5rem 0;">
                            <div style="font-size: 0.9rem; color: #2c3e50; font-weight: 600; margin-bottom: 0.25rem;">🤖 Fix It Fred Insights:</div>
                            <div style="font-size: 0.85rem; color: #666;">
                                {% if part.quantity == 0 %}
                                "URGENT: This part is blocking WO-124. I found 3 suppliers with same-day delivery. Supplier A costs +$25 but saves 2 days downtime worth $500."
                                {% elif part.quantity <= part.min_stock %}
                                "Usage trend +{{ [15, 23, 8, 12, 19]|random }}% this month. Recommend ordering {{ (part.min_stock * 3)|int }} units. Bulk pricing available at 15+ units."
                                {% else %}
                                "Stock levels optimal. Next order recommended in {{ [8, 12, 15, 21, 28]|random }} days based on current usage patterns."
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-left: 1rem;">
                        <button onclick="fredPartAnalysis('{{ part.id }}')" class="btn btn-sm" style="background: #2c3e50; color: white;">🧠 Fred Analysis</button>
                        <button onclick="fredSmartOrder('{{ part.id }}')" class="btn btn-sm btn-success">🛒 Smart Order</button>
                        <button onclick="fredPartHistory('{{ part.id }}')" class="btn btn-sm btn-info">📊 History</button>
                        <button onclick="fredPartPredict('{{ part.id }}')" class="btn btn-sm btn-warning">🔮 Predict</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Advanced Analytics Dashboard -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1.5rem;">📈 Fix It Fred Advanced Analytics</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        
        <!-- Supplier Intelligence -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #667eea;">🏪 Supplier Intelligence</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Industrial Supply Co.</span>
                        <span style="color: #00c851; font-weight: bold;">98% Performance</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">Avg delivery: 2.1 days • Price trend: -3%</div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Parts Warehouse Inc.</span>
                        <span style="color: #ff9800; font-weight: bold;">87% Performance</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">Avg delivery: 3.5 days • Price trend: +1%</div>
                </div>
                
                <div style="background: rgba(255, 107, 53, 0.1); padding: 0.75rem; border-radius: 6px;">
                    <div style="font-size: 0.9rem; color: #2c3e50; font-weight: 600;">🤖 Fred Recommends:</div>
                    <div style="font-size: 0.85rem; color: #666;">"Switch V-Belt orders to Industrial Supply Co. for 12% cost savings and faster delivery."</div>
                </div>
            </div>
        </div>
        
        <!-- Cost Optimization -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #00c851;">💰 Cost Optimization</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="text-align: center; margin-bottom: 1rem;">
                    <div style="font-size: 2rem; color: #00c851; font-weight: bold;">$12,847</div>
                    <div style="font-size: 0.9rem; color: #666;">Saved this quarter</div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">Bulk Purchase Savings</div>
                    <div style="background: #e9ecef; height: 6px; border-radius: 3px;">
                        <div style="width: 78%; height: 100%; background: #00c851; border-radius: 3px;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">$4,230 (78% of target)</div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">Supplier Optimization</div>
                    <div style="background: #e9ecef; height: 6px; border-radius: 3px;">
                        <div style="width: 92%; height: 100%; background: #667eea; border-radius: 3px;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #666;">$8,617 (92% of potential)</div>
                </div>
            </div>
        </div>
        
        <!-- Predictive Maintenance -->
        <div>
            <h4 style="margin-bottom: 1rem; color: #6366f1;">🔮 Predictive Insights</h4>
            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                <div style="margin-bottom: 1rem; font-size: 0.9rem;">
                    <strong>Next 30 Days Forecast:</strong>
                </div>
                
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 0.9rem;">Oil Filters</span>
                        <span style="color: #00c851; font-weight: bold;">8 units needed</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 0.75rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 0.9rem;">V-Belts</span>
                        <span style="color: #ff9800; font-weight: bold;">6 units needed</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 0.9rem;">Bearings</span>
                        <span style="color: #667eea; font-weight: bold;">3 units needed</span>
                    </div>
                </div>
                
                <button onclick="fredFullForecast()" class="btn btn-sm btn-primary" style="width: 100%;">🔮 Full 90-Day Forecast</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Fix It Fred Advanced Parts Intelligence JavaScript

// Core Fred AI Functions
async function fredSmartOrder() {
    const response = await sendFredMessage('Analyze all parts and create the optimal order list considering cost, lead times, and work order requirements');
    alert('🤖 Fix It Fred Smart Order:\n\n' + 
          '• Circuit Breaker (CB-20A): Emergency order - 2 units from Supplier B (+$50 rush)\n' +
          '• V-Belt (VB-200): Urgent order - 15 units (bulk discount -12%)\n' +
          '• Hydraulic Hose (HH-300): Standard order - 12 units\n' +
          '• Oil Filter (OF-001): Delayed order - wait 5 days for better pricing\n\n' +
          'Total savings: $347 | Prevented stockouts: 2 | Order value: $1,847');
}

async function fredInventoryAssist() {
    toggleAIChat();
    setTimeout(() => {
        document.getElementById('chatInput').value = 'Help me optimize my entire inventory system';
        sendChatMessage();
    }, 500);
}

async function fredPredictiveInsight() {
    const response = await sendFredMessage('Provide advanced predictive insights for the next 90 days including seasonal trends and maintenance cycles');
    alert('🔮 Fix It Fred Predictive Intelligence:\n\n' +
          'SEASONAL TRENDS DETECTED:\n' +
          '• HVAC filters: +40% demand in 3 weeks (summer prep)\n' +
          '• Hydraulic components: Peak usage in 45 days\n' +
          '• Electrical parts: Stable demand pattern\n\n' +
          'MAINTENANCE CYCLES:\n' +
          '• Pump overhauls due in 21 days (high bearing usage)\n' +
          '• Quarterly HVAC maintenance in 18 days\n\n' +
          'RISK ASSESSMENT:\n' +
          '• 23% chance of V-Belt shortage without action\n' +
          '• Circuit breaker failure could cost $15K downtime');
}

async function fredCostOptimize() {
    const response = await sendFredMessage('Find all cost optimization opportunities across suppliers, bulk purchasing, and timing');
    alert('💰 Fix It Fred Cost Optimization:\n\n' +
          'IMMEDIATE OPPORTUNITIES:\n' +
          '• Switch V-Belt supplier: Save $127/month (15% reduction)\n' +
          '• Bulk order Oil Filters: Save $89 on next order\n' +
          '• Negotiate annual contract with Industrial Supply: Save $2,400/year\n\n' +
          'TIMING OPTIMIZATION:\n' +
          '• Delay Bearing orders by 8 days: Save $156 (price drop expected)\n' +
          '• Combine 3 small orders into bulk: Save $78 shipping\n\n' +
          'TOTAL ANNUAL SAVINGS POTENTIAL: $18,947');
}

async function fredAutoReorder() {
    if (confirm('🤖 Enable Fix It Fred Auto-Reorder?\n\nFred will automatically:\n• Monitor stock levels\n• Predict usage patterns\n• Place optimal orders\n• Negotiate with suppliers\n• Handle emergency situations\n\nYou maintain full oversight and can override any decision.')) {
        alert('✅ Fix It Fred Auto-Reorder ACTIVATED!\n\n' +
              '🧠 Learning your patterns...\n' +
              '📊 Analyzing 6 months of data...\n' +
              '🤝 Connecting to supplier APIs...\n' +
              '⚡ Smart algorithms ready!\n\n' +
              'Fred will now handle routine reorders and alert you for major decisions. You\'ll save 15+ hours per week!');
    }
}

async function fredWorkOrderLink() {
    const response = await sendFredMessage('Show me how parts inventory connects to active work orders and identify any risks');
    alert('🔗 Fix It Fred Work Order Integration:\n\n' +
          'ACTIVE CONNECTIONS:\n' +
          '• WO-123: Pump #1 - All parts available ✅\n' +
          '• WO-124: Electrical repair - Missing Circuit Breaker ❌\n' +
          '• WO-125: Belt replacement - V-Belt low stock ⚠️\n' +
          '• WO-126: HVAC service - Parts ready ✅\n' +
          '• WO-127: Hydraulic repair - Only 1 hose left ⚠️\n\n' +
          'RISK ANALYSIS:\n' +
          '• WO-124 blocked until circuit breaker arrives\n' +
          '• WO-125 may be delayed if V-Belt stock depletes\n' +
          '• High-priority parts needed for 3 emergency repairs this week\n\n' +
          'RECOMMENDATIONS:\n' +
          '• Emergency order circuit breaker (same-day delivery +$50)\n' +
          '• Reserve V-Belts for WO-125\n' +
          '• Pre-order hydraulic hoses for upcoming maintenance');
}

// Quick Fred Chat
async function quickFredChat() {
    const input = document.getElementById('fredQuickChat');
    const message = input.value.trim();
    if (!message) return;
    
    const response = await sendFredMessage(message);
    input.value = '';
    
    // Show response in a styled alert
    alert('🤖 Fix It Fred responds:\n\n' + 
          (response || 'I\'m analyzing that for you! Based on current inventory patterns and predictive models, I can help optimize your parts management strategy.'));
}

// Part-specific Fred functions
async function fredPartAnalysis(partId) {
    const response = await sendFredMessage(`Provide comprehensive analysis for part ID ${partId} including usage trends, cost analysis, and optimization recommendations`);
    alert('🧠 Fix It Fred Part Analysis:\n\n' +
          'USAGE ANALYSIS:\n' +
          '• Consumption rate: 2.3 units/week (trending +15%)\n' +
          '• Seasonal pattern: Peak in Q3, Low in Q1\n' +
          '• Work order correlation: High usage during pump maintenance\n\n' +
          'COST ANALYSIS:\n' +
          '• Current supplier: Best price for <10 units\n' +
          '• Alternative supplier: 18% cheaper for 15+ units\n' +
          '• Market trend: Prices stable, no major changes expected\n\n' +
          'OPTIMIZATION:\n' +
          '• Optimal order quantity: 18 units\n' +
          '• Best timing: Order when stock hits 7 units\n' +
          '• Annual savings potential: $247');
}

async function fredSmartReorder(partId) {
    if (confirm('🤖 Let Fix It Fred place the optimal order for this part?\n\nFred will:\n• Calculate optimal quantity\n• Choose best supplier\n• Time the order perfectly\n• Negotiate best price\n• Handle all paperwork')) {
        alert('✅ Fred is placing your smart order!\n\n' +
              '🔍 Analyzing 47 suppliers...\n' +
              '💰 Found 23% bulk discount opportunity\n' +
              '📅 Optimal delivery timing calculated\n' +
              '🤝 Negotiating final price...\n\n' +
              'ORDER PLACED:\n' +
              '• Quantity: 18 units (optimized)\n' +
              '• Supplier: Industrial Supply Co.\n' +
              '• Price: $127.44 (was $156.80)\n' +
              '• Delivery: 3 business days\n' +
              '• Savings: $29.36 (23% off)\n\n' +
              'You\'ll receive confirmation email in 5 minutes!');
    }
}

async function fredPartHistory(partId) {
    alert('📊 Fix It Fred Historical Analysis:\n\n' +
          'USAGE HISTORY (Last 12 months):\n' +
          '• Total consumed: 127 units\n' +
          '• Average monthly: 10.6 units\n' +
          '• Peak month: March (18 units)\n' +
          '• Low month: December (4 units)\n\n' +
          'COST HISTORY:\n' +
          '• Price trend: -8% over 12 months\n' +
          '• Best purchase: $18.50/unit (bulk order)\n' +
          '• Worst purchase: $28.75/unit (emergency)\n' +
          '• Average: $23.40/unit\n\n' +
          'SUPPLIER PERFORMANCE:\n' +
          '• Best delivery: Industrial Supply (2.1 days avg)\n' +
          '• Most reliable: Parts Warehouse (99% on-time)\n' +
          '• Best price: Direct Manufacturer (15% discount)\n\n' +
          'FRED\'S LEARNING:\n' +
          '"I\'ve optimized your ordering pattern and saved $1,247 on this part alone!"');
}

async function fredPartPredict(partId) {
    alert('🔮 Fix It Fred Predictive Analysis:\n\n' +
          'NEXT 90 DAYS FORECAST:\n' +
          '• Week 1-2: 5 units needed (normal usage)\n' +
          '• Week 3-4: 8 units needed (pump maintenance cycle)\n' +
          '• Week 5-8: 12 units needed (peak season)\n' +
          '• Week 9-12: 6 units needed (return to normal)\n\n' +
          'RISK FACTORS:\n' +
          '• 73% probability of usage spike in week 6\n' +
          '• Supply chain delay risk: 12% (monitored daily)\n' +
          '• Price volatility: Low (stable market)\n\n' +
          'RECOMMENDED ACTIONS:\n' +
          '• Order 20 units now for optimal coverage\n' +
          '• Set automatic reorder at 8 units remaining\n' +
          '• Pre-negotiate bulk pricing for peak season\n\n' +
          'CONFIDENCE LEVEL: 94% (Based on 18 months of pattern learning)');
}

// Advanced filtering
function fredFilter(type) {
    let message = '';
    switch(type) {
        case 'critical':
            message = '🔥 Critical Parts (Out of stock or blocking work orders)';
            break;
        case 'lowstock':
            message = '📉 Low Stock Parts (Below minimum threshold)';
            break;
        case 'trending':
            message = '📈 Trending Parts (Increasing usage patterns)';
            break;
        case 'obsolete':
            message = '🗑️ Potentially Obsolete Parts (No usage in 90+ days)';
            break;
        case 'workorders':
            message = '🔗 Parts Linked to Active Work Orders';
            break;
    }
    
    // This would filter the parts list in a real implementation
    alert(`🤖 Fred is filtering: ${message}\n\nIn the full system, this would instantly show only relevant parts with Fred's AI insights for each category.`);
}

// Advanced analytics functions
async function predictiveAnalytics() {
    alert('🔮 Fix It Fred Predictive Analytics:\n\n' +
          'MACHINE LEARNING INSIGHTS:\n' +
          '• Analyzed 2.3M data points across 18 months\n' +
          '• 94% prediction accuracy achieved\n' +
          '• Seasonal patterns identified for 73% of parts\n' +
          '• Maintenance cycles correlated with 89% accuracy\n\n' +
          'KEY PREDICTIONS:\n' +
          '• V-Belt usage will spike 340% in 3 weeks (conveyor maintenance)\n' +
          '• Oil filter demand stable through Q4\n' +
          '• Bearing replacements due to increase 45% next month\n' +
          '• Electrical components entering peak failure season\n\n' +
          'BUSINESS IMPACT:\n' +
          '• Prevented stockouts: 23 incidents\n' +
          '• Cost savings: $12,847 this quarter\n' +
          '• Efficiency gain: 34% reduction in emergency orders');
}

async function autoOptimize() {
    if (confirm('🤖 Let Fix It Fred auto-optimize your entire inventory?\n\nThis will:\n• Rebalance all stock levels\n• Optimize reorder points\n• Negotiate better supplier terms\n• Implement predictive reordering\n• Set up automatic cost optimization\n\nEstimated annual savings: $25,000+')) {
        alert('🚀 Fix It Fred Auto-Optimization ACTIVATED!\n\n' +
              '⚡ Analyzing entire inventory...\n' +
              '📊 Processing 847 parts...\n' +
              '🤝 Contacting 23 suppliers...\n' +
              '💰 Calculating savings opportunities...\n' +
              '🔮 Setting up predictive algorithms...\n\n' +
              'OPTIMIZATION COMPLETE:\n' +
              '• Reorder points optimized for 847 parts\n' +
              '• 15 supplier contracts renegotiated\n' +
              '• Auto-reorder enabled for 234 high-volume parts\n' +
              '• Emergency stock levels optimized\n' +
              '• Seasonal adjustments programmed\n\n' +
              'IMMEDIATE RESULTS:\n' +
              '• 34% reduction in excess inventory\n' +
              '• 89% improvement in stockout prevention\n' +
              '• $2,347 immediate cost savings identified\n' +
              '• 23 hours/week time savings for staff\n\n' +
              'Your inventory is now FULLY OPTIMIZED by Fix It Fred! 🎉');
    }
}

async function fredFullForecast() {
    alert('🔮 Fix It Fred 90-Day Comprehensive Forecast:\n\n' +
          'DEMAND ANALYSIS:\n' +
          '• Total parts needed: 847 units across 67 SKUs\n' +
          '• Peak demand period: Days 45-60 (+67% above average)\n' +
          '• Low demand period: Days 75-90 (-23% below average)\n\n' +
          'CRITICAL WINDOWS:\n' +
          '• Days 18-21: Quarterly maintenance surge\n' +
          '• Days 44-48: Summer equipment prep\n' +
          '• Days 67-72: Annual pump overhauls\n\n' +
          'SUPPLY CHAIN INTEL:\n' +
          '• 3 suppliers have price increases planned (4-7%)\n' +
          '• 2 new suppliers offering better terms\n' +
          '• Lead times expected to increase 15% in peak season\n\n' +
          'FINANCIAL FORECAST:\n' +
          '• Total 90-day spend: $47,823 (optimized from $52,450)\n' +
          '• Savings opportunities: $4,627\n' +
          '• Cash flow optimization: Spread orders across 12 weeks\n\n' +
          'RECOMMENDATIONS:\n' +
          '• Pre-order 23 critical parts before price increases\n' +
          '• Negotiate locked-in pricing for Q4\n' +
          '• Build strategic safety stock for peak periods\n' +
          '• Implement supplier diversification for 8 high-risk parts');
}

// Purchase request workflow
function viewWorkOrderParts() {
    alert('🔗 Work Order Parts Dependencies:\n\n' +
          'WO-123: Pump #1 Maintenance\n' +
          '✅ Oil Filter (OF-001) - 2 units available\n' +
          '✅ Gasket Set (GS-PUMP1) - 1 unit available\n' +
          '✅ Bearing (BR-150) - 3 units needed, 8 available\n\n' +
          'WO-124: Electrical Panel Repair\n' +
          '❌ Circuit Breaker (CB-20A) - 1 unit needed, 0 available\n' +
          '⚠️ Emergency order required for completion\n\n' +
          'WO-125: Conveyor Belt Replacement\n' +
          '⚠️ V-Belt (VB-200) - 2 units needed, 3 available\n' +
          '📋 Consider ordering more for safety stock\n\n' +
          'WO-126: Hydraulic System Service\n' +
          '⚠️ Hydraulic Hose (HH-300) - 1 unit needed, 1 available\n' +
          '🚨 No backup if current unit fails\n\n' +
          '🤖 Fred recommends immediate action on 3 critical dependencies!');
}

// Helper function to send messages to Fred (Legacy)
async function sendFredMessage(message) {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                user_role: 'parts',
                context: 'Advanced Parts Intelligence with Fix It Fred'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            return data.response;
        }
    } catch (error) {
        console.error('Fred communication error:', error);
    }
    return null;
}

// Enhanced Fred Chat with File Upload Support
let fredChatHistory = [];
let uploadedFiles = [];

// Send message to Fred (Enhanced Interface)
async function sendFredMessage() {
    const input = document.getElementById('fredChatInput');
    const message = input.value.trim();
    if (!message && uploadedFiles.length === 0) return;
    
    // Add user message to chat
    addChatMessage('user', message, uploadedFiles);
    
    // Clear input and files
    input.value = '';
    const currentFiles = [...uploadedFiles];
    uploadedFiles = [];
    updateUploadedFilesDisplay();
    
    // Show typing indicator
    addTypingIndicator();
    
    try {
        // Get Fred's response
        const response = await getFredResponse(message, currentFiles);
        
        // Remove typing indicator and add Fred's response
        removeTypingIndicator();
        addChatMessage('fred', response);
        
    } catch (error) {
        removeTypingIndicator();
        addChatMessage('fred', 'Sorry, I\'m having trouble connecting right now. Please try again in a moment.');
    }
}

// Add message to chat interface
function addChatMessage(sender, message, files = []) {
    const chatMessages = document.getElementById('fredChatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; animation: fadeIn 0.3s ease;';
    
    if (sender === 'user') {
        messageDiv.style.cssText += 'background: #2c3e50; color: white; margin-left: 2rem; border-bottom-right-radius: 4px;';
        let content = `<strong>👤 You:</strong><div style="margin-top: 0.25rem;">${message}</div>`;
        
        if (files.length > 0) {
            content += '<div style="margin-top: 0.5rem; font-size: 0.8rem; opacity: 0.8;">';
            files.forEach(file => {
                content += `📎 ${file.name} `;
            });
            content += '</div>';
        }
        messageDiv.innerHTML = content;
    } else {
        messageDiv.style.cssText += 'background: #f8f9fa; color: #333; margin-right: 2rem; border-left: 4px solid #2c3e50; border-bottom-left-radius: 4px;';
        messageDiv.innerHTML = `<strong style="color: #2c3e50;">🤖 Fix It Fred:</strong><div style="margin-top: 0.25rem;">${message.replace(/\n/g, '<br>')}</div>`;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Store in chat history
    fredChatHistory.push({ sender, message, files, timestamp: new Date() });
}

// Add typing indicator
function addTypingIndicator() {
    const chatMessages = document.getElementById('fredChatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'fredTyping';
    typingDiv.style.cssText = 'padding: 0.75rem; margin-bottom: 0.5rem; background: #f8f9fa; border-radius: 8px; margin-right: 2rem; border-left: 4px solid #2c3e50;';
    typingDiv.innerHTML = '<strong style="color: #2c3e50;">🤖 Fix It Fred:</strong><div style="margin-top: 0.25rem; opacity: 0.7;">💭 Analyzing your request...</div>';
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typing = document.getElementById('fredTyping');
    if (typing) typing.remove();
}

// Get Fred's response (enhanced AI simulation)
async function getFredResponse(message, files) {
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));
    
    const responses = {
        'cost': '💰 **Cost Analysis Results:**\n\n• Found 3 suppliers with 15% better pricing on V-Belts\n• Bulk ordering could save $2,400 this quarter\n• Emergency orders costing +$340/month - I can optimize this\n• Recommended: Switch to Supplier B for hydraulic parts (22% savings)',
        'critical': '🚨 **Critical Parts Alert:**\n\n• Circuit Breaker (CB-20A): OUT OF STOCK - Blocks WO-124\n• V-Belt (VB-200): Only 3 left - High usage trend\n• Hydraulic Hose: 1 remaining - Emergency order needed\n• **Action Required:** Place emergency orders within 4 hours',
        'predict': '🔮 **30-Day Predictions:**\n\n• Oil Filters: Will need 12 units (order in 5 days)\n• V-Belts: High risk of stockout by day 8\n• Bearings: Optimal stock levels maintained\n• **Confidence:** 94% accuracy based on usage patterns',
        'supplier': '📊 **Supplier Performance:**\n\n• Supplier A: 98% on-time, best quality\n• Supplier B: 89% on-time, 15% cheaper\n• Supplier C: Emergency specialist, +50% cost\n• **Recommendation:** Primary A, backup B, emergency C'
    };
    
    // Check for keywords
    const lowerMessage = message.toLowerCase();
    if (lowerMessage.includes('cost') || lowerMessage.includes('price') || lowerMessage.includes('save')) return responses.cost;
    if (lowerMessage.includes('critical') || lowerMessage.includes('urgent') || lowerMessage.includes('stock')) return responses.critical;
    if (lowerMessage.includes('predict') || lowerMessage.includes('forecast') || lowerMessage.includes('future')) return responses.predict;
    if (lowerMessage.includes('supplier') || lowerMessage.includes('vendor') || lowerMessage.includes('performance')) return responses.supplier;
    
    // File analysis response
    if (files.length > 0) {
        let fileAnalysis = '📎 **File Analysis Complete:**\n\n';
        files.forEach(file => {
            if (file.type.includes('image')) {
                fileAnalysis += `• ${file.name}: Analyzed image - I can see equipment damage in sector B-3. Recommend ordering replacement bearing (Part #BR-150) and seals.\n`;
            } else if (file.type.includes('pdf') || file.type.includes('document')) {
                fileAnalysis += `• ${file.name}: Processed document - Found 12 parts references, cross-referenced with inventory. 3 items need attention.\n`;
            } else {
                fileAnalysis += `• ${file.name}: File processed successfully - extracted key data for inventory optimization.\n`;
            }
        });
        fileAnalysis += '\n**Next Steps:** I\'ve updated your inventory recommendations based on this analysis.';
        return fileAnalysis;
    }
    
    // Default intelligent response
    return `🧠 **Smart Analysis:**\n\nBased on your inventory patterns, I recommend:\n\n• Review low-stock items (5 parts below minimum)\n• Optimize reorder points for seasonal demands\n• Consider bulk ordering for 3 high-usage items\n• Schedule supplier review next week\n\nWould you like me to elaborate on any of these recommendations?`;
}

// Quick question helper
function askFredQuickQuestion(question) {
    document.getElementById('fredChatInput').value = question;
    sendFredMessage();
}

// File upload handling
function handleFileUpload(files) {
    Array.from(files).forEach(file => {
        if (file.size > 10 * 1024 * 1024) { // 10MB limit
            alert(`File ${file.name} is too large. Maximum size is 10MB.`);
            return;
        }
        uploadedFiles.push(file);
    });
    updateUploadedFilesDisplay();
}

function updateUploadedFilesDisplay() {
    const display = document.getElementById('fredUploadedFiles');
    if (uploadedFiles.length === 0) {
        display.innerHTML = '';
        return;
    }
    
    let html = 'Ready to send: ';
    uploadedFiles.forEach((file, index) => {
        html += `<span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; margin-right: 0.5rem;">📎 ${file.name} <button onclick="removeFile(${index})" style="background: none; border: none; color: white; margin-left: 0.25rem; cursor: pointer;">×</button></span>`;
    });
    display.innerHTML = html;
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    updateUploadedFilesDisplay();
}

// Voice input (placeholder)
function fredVoiceInput() {
    if ('webkitSpeechRecognition' in window) {
        const recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = false;
        
        recognition.onstart = function() {
            document.getElementById('fredChatInput').placeholder = 'Listening... speak now';
        };
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('fredChatInput').value = transcript;
            document.getElementById('fredChatInput').placeholder = 'Ask Fred about inventory, suppliers, costs, predictions...';
        };
        
        recognition.onerror = function() {
            document.getElementById('fredChatInput').placeholder = 'Voice input failed. Please type your message.';
        };
        
        recognition.start();
    } else {
        alert('Voice input not supported in this browser.');
    }
}

// Initialize Fred's advanced features
document.addEventListener('DOMContentLoaded', function() {
    console.log('🤖 Fix It Fred Advanced Parts Intelligence initialized!');
    
    // Enhanced Chat Interface Setup
    const fileUpload = document.getElementById('fredFileUpload');
    const photoUpload = document.getElementById('fredPhotoUpload');
    
    if (fileUpload) {
        fileUpload.addEventListener('change', function(e) {
            handleFileUpload(e.target.files);
        });
    }
    
    if (photoUpload) {
        photoUpload.addEventListener('change', function(e) {
            handleFileUpload(e.target.files);
        });
    }
    
    // Enter key support for chat
    const chatInput = document.getElementById('fredChatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendFredMessage();
            }
        });
    }
    
    // Add Fred's smart tooltips
    addFredTooltips();
    
    // Enable Fred's real-time monitoring
    setInterval(fredRealTimeMonitoring, 30000);
});

function addFredTooltips() {
    // In a full implementation, this would add intelligent tooltips
    console.log('🧠 Fred\'s smart tooltips activated');
}

function fredRealTimeMonitoring() {
    // In a full implementation, this would monitor for changes
    console.log('🔍 Fred monitoring inventory status...');
}
{% endblock %}