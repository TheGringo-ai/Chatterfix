{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Technician Dashboard{% endblock %}
{% block page_icon %}👷{% endblock %}
{% block page_title %}Technician Dashboard{% endblock %}
{% block page_subtitle %}Your assigned work orders and maintenance tasks{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="startNextWork()">
    ▶️ Start Next Work
</button>
<button class="btn btn-info" onclick="viewTools()">
    🔧 My Tools
</button>
<button class="btn btn-warning" onclick="reportIssue()">
    ⚠️ Report Issue
</button>
<button class="btn btn-primary" onclick="askAI()">
    🤖 Ask AI Assistant
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card">
        <h3>My Work Orders</h3>
        <div class="value">{{ my_workorders|length }}</div>
        <div class="subtitle">Assigned to me</div>
        <div class="ai-insight">🤖 ⚡ 2 high priority today</div>
    </div>
    
    <div class="summary-card">
        <h3>In Progress</h3>
        <div class="value">{{ my_workorders|selectattr("status", "equalto", "in_progress")|list|length }}</div>
        <div class="subtitle">Currently working</div>
        <div class="ai-insight">🤖 📊 On schedule</div>
    </div>
    
    <div class="summary-card">
        <h3>Completed Today</h3>
        <div class="value">3</div>
        <div class="subtitle">Tasks finished</div>
        <div class="ai-insight">🤖 🎯 Above average</div>
    </div>
    
    <div class="summary-card">
        <h3>Efficiency Score</h3>
        <div class="value">94%</div>
        <div class="subtitle">This week</div>
        <div class="ai-insight">🤖 🏆 Excellent performance</div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="chatterfix-grid grid-cols-2">
    
    <!-- My Work Orders -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">📋 My Work Orders</h3>
        {% for wo in my_workorders %}
        <div style="background: {% if wo.status == 'in_progress' %}rgba(102, 126, 234, 0.1){% else %}var(--bg-secondary){% endif %}; 
                    padding: 1.5rem; margin-bottom: 1rem; border-radius: var(--border-radius); 
                    border-left: 4px solid {% if wo.priority == 'high' %}var(--error-red){% elif wo.priority == 'medium' %}var(--warning-amber){% else %}var(--success-green){% endif %};">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <div>
                    <h4 style="margin-bottom: 0.5rem;">WO-{{ wo.id }}: {{ wo.title }}</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Asset: {{ wo.asset_name }}</p>
                    <span class="status-badge status-{{ wo.status|lower|replace(' ', '-') }}">{{ wo.status }}</span>
                    <span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; 
                                 {% if wo.priority == 'high' %}background: var(--error-red); color: white;
                                 {% elif wo.priority == 'medium' %}background: var(--warning-amber); color: white;
                                 {% else %}background: var(--success-green); color: white;{% endif %}">
                        {{ wo.priority|upper }} PRIORITY
                    </span>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                        {% if wo.priority == 'high' %}🔥{% elif wo.priority == 'medium' %}⚡{% else %}📝{% endif %}
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% if wo.status == 'assigned' %}
                <button onclick="startWork('{{ wo.id }}')" class="btn btn-success">▶️ Start Work</button>
                {% elif wo.status == 'in_progress' %}
                <button onclick="pauseWork('{{ wo.id }}')" class="btn btn-warning">⏸️ Pause</button>
                <button onclick="completeWork('{{ wo.id }}')" class="btn btn-success">✅ Complete</button>
                {% endif %}
                <button onclick="viewDetails('{{ wo.id }}')" class="btn btn-primary">👁️ Details</button>
                <button onclick="addNote('{{ wo.id }}')" class="btn btn-secondary">📝 Add Note</button>
                <button onclick="addPhoto('{{ wo.id }}')" class="btn btn-info">📷 Photo</button>
                <button onclick="getAIHelp('{{ wo.id }}')" class="btn btn-info">🤖 AI Help</button>
            </div>
            
            <!-- Timer for in-progress work -->
            {% if wo.status == 'in_progress' %}
            <div style="margin-top: 1rem; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 4px;">
                <strong>⏱️ Time Tracking:</strong>
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-blue);" id="timer-{{ wo.id }}">
                    02:45:30
                </div>
                <small style="color: var(--text-secondary);">Started at 9:15 AM</small>
            </div>
            {% endif %}
        </div>
        {% endfor %}
        
        {% if my_workorders|length == 0 %}
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
            <h4>All caught up!</h4>
            <p>No work orders assigned at the moment.</p>
            <button onclick="requestWork()" class="btn btn-primary" style="margin-top: 1rem;">Request More Work</button>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Tools & AI Assistant -->
    <div class="chatterfix-card">
        <h3 style="margin-bottom: 1.5rem;">🛠️ Technician Tools</h3>
        
        <!-- Quick Actions -->
        <div style="margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">⚡ Quick Actions</h4>
            <div class="chatterfix-grid grid-cols-2" style="gap: 1rem;">
                <button class="btn btn-primary" onclick="scanQRCode()" style="padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">📱</span>
                    Scan QR Code
                </button>
                <button class="btn btn-warning" onclick="reportIssue()" style="padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">⚠️</span>
                    Report Issue
                </button>
                <button class="btn btn-info" onclick="checkParts()" style="padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">🔧</span>
                    Check Parts
                </button>
                <button class="btn btn-success" onclick="safetyCheck()" style="padding: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.5rem;">🦺</span>
                    Safety Check
                </button>
            </div>
        </div>
        
        <!-- AI Assistant Panel -->
        <div style="background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue)); color: white; padding: 1.5rem; border-radius: var(--border-radius);">
            <h4 style="margin-bottom: 1rem;">🤖 AI Technician Assistant</h4>
            <p style="margin-bottom: 1rem; opacity: 0.9;">Get instant help with troubleshooting, procedures, and safety guidelines.</p>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button onclick="askAI('troubleshooting')" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">🔧 Troubleshooting</button>
                <button onclick="askAI('safety')" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">🦺 Safety</button>
                <button onclick="askAI('procedures')" class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">📋 Procedures</button>
            </div>
            
            <button onclick="openAIChat()" class="btn btn-sm" style="background: white; color: var(--primary-blue); width: 100%;">
                💬 Open Full AI Assistant
            </button>
        </div>
    </div>
</div>

<!-- Today's Schedule -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1.5rem;">📅 Today's Schedule</h3>
    <div style="display: flex; gap: 2rem; overflow-x: auto; padding-bottom: 1rem;">
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">Morning</h4>
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🌅</div>
            <p><strong>9:00 AM</strong><br>Pump #1 Maintenance</p>
            <span class="status-badge status-in-progress">In Progress</span>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">Midday</h4>
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">☀️</div>
            <p><strong>1:00 PM</strong><br>HVAC Filter Check</p>
            <span class="status-badge status-assigned">Assigned</span>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">Afternoon</h4>
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🌤️</div>
            <p><strong>3:30 PM</strong><br>Conveyor Inspection</p>
            <span class="status-badge status-pending">Pending</span>
        </div>
        
        <div style="min-width: 200px; background: var(--bg-secondary); padding: 1rem; border-radius: var(--border-radius); text-align: center;">
            <h4 style="color: var(--text-secondary); margin-bottom: 0.5rem;">End of Day</h4>
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🌆</div>
            <p><strong>5:00 PM</strong><br>Daily Report</p>
            <span class="status-badge status-pending">Pending</span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Technician-specific JavaScript
function startWork(id) {
    if (confirm(`Start work on Work Order ${id}?`)) {
        // Start timer and update status
        alert(`Work started on WO-${id}! Timer is now running.`);
        refreshData();
    }
}

function pauseWork(id) {
    if (confirm(`Pause work on Work Order ${id}?`)) {
        alert(`Work paused on WO-${id}. Timer stopped.`);
        refreshData();
    }
}

function completeWork(id) {
    if (confirm(`Mark Work Order ${id} as complete?`)) {
        alert(`Work Order ${id} completed! Great job!`);
        refreshData();
    }
}

function viewDetails(id) {
    // In a real app, this would show detailed work order information
    alert(`Viewing detailed information for Work Order ${id} - Feature coming soon!`);
}

function addNote(id) {
    const note = prompt(`Add note to Work Order ${id}:`);
    if (note) {
        alert(`Note added to Work Order ${id}: "${note}"`);
    }
}

function addPhoto(id) {
    // In a real app, this would open camera/file picker
    alert(`Photo capture for Work Order ${id} - Feature coming soon!`);
}

async function getAIHelp(id) {
    // Send AI request with technician context
    const message = `I need help with Work Order ${id}. What troubleshooting steps should I follow?`;
    await sendAIMessage(message, 'technician');
}

function startNextWork() {
    const assignedWork = document.querySelector('.status-assigned');
    if (assignedWork) {
        // Find the work order ID and start it
        alert('Starting next assigned work order!');
    } else {
        alert('No work orders assigned. Request more work from your supervisor.');
    }
}

function viewTools() {
    alert('Tool inventory and checkout system - Feature coming soon!');
}

function reportIssue() {
    const issue = prompt('Describe the issue you want to report:');
    if (issue) {
        alert(`Issue reported: "${issue}"\nA supervisor has been notified.`);
    }
}

function askAI(category) {
    let message = '';
    switch(category) {
        case 'troubleshooting':
            message = 'I need troubleshooting help with equipment. What diagnostic steps should I follow?';
            break;
        case 'safety':
            message = 'What safety procedures should I follow for maintenance work?';
            break;
        case 'procedures':
            message = 'Can you guide me through the standard maintenance procedures?';
            break;
        default:
            message = 'I need help with my maintenance work. Can you assist me?';
    }
    
    // Open AI chat with pre-filled message
    toggleAIChat();
    document.getElementById('chatInput').value = message;
}

function scanQRCode() {
    alert('QR Code scanner - Feature coming soon!\nWill allow quick asset identification and work order lookup.');
}

function checkParts() {
    window.location.href = '/parts';
}

function safetyCheck() {
    alert('Safety checklist - Feature coming soon!\nWill provide safety verification steps.');
}

function requestWork() {
    alert('Work request sent to supervisor!');
}

// Timer functionality for in-progress work orders
function updateTimers() {
    const timers = document.querySelectorAll('[id^="timer-"]');
    timers.forEach(timer => {
        // In a real app, this would calculate actual elapsed time
        // For demo, just show a running timer
        const current = timer.textContent;
        // Simple timer increment logic would go here
    });
}

// Update timers every second
setInterval(updateTimers, 1000);

// Helper function to send AI messages with technician context
async function sendAIMessage(message, context = 'technician') {
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: message,
                user_role: context,
                context: 'Technician assistance'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Add to chat window
            addChatMessage(message, 'user');
            addChatMessage(data.response, 'ai');
            return data.response;
        }
    } catch (error) {
        console.error('AI message error:', error);
    }
}
{% endblock %}