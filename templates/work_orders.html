{% extends "base.html" %}

{% block title %}ChatterFix CMMS - Work Orders{% endblock %}
{% block page_icon %}📋{% endblock %}
{% block page_title %}Work Orders{% endblock %}
{% block page_subtitle %}Manage and track all maintenance work orders{% endblock %}

{% block action_buttons %}
<button class="btn btn-success" onclick="createWorkOrder()">
    ➕ Create Work Order
</button>
<button class="btn btn-info" onclick="filterWorkOrders()">
    🔍 Filter
</button>
<button class="btn btn-warning" onclick="bulkActions()">
    📤 Bulk Actions
</button>
<button class="btn btn-primary" onclick="exportWorkOrders()">
    📊 Export
</button>
{% endblock %}

{% block summary_stats %}
<div class="summary-grid">
    <div class="summary-card">
        <h3>Total Work Orders</h3>
        <div class="value">{{ work_orders|length }}</div>
        <div class="subtitle">All time</div>
        <div class="ai-insight">🤖 📈 15% increase this month</div>
    </div>
    
    <div class="summary-card">
        <h3>In Progress</h3>
        <div class="value">{{ work_orders|selectattr("status", "equalto", "in_progress")|list|length }}</div>
        <div class="subtitle">Active work</div>
        <div class="ai-insight">🤖 ⚡ On track for completion</div>
    </div>
    
    <div class="summary-card">
        <h3>Pending</h3>
        <div class="value">{{ work_orders|selectattr("status", "equalto", "pending")|list|length }}</div>
        <div class="subtitle">Awaiting assignment</div>
        <div class="ai-insight">🤖 ⏰ Needs attention</div>
    </div>
    
    <div class="summary-card">
        <h3>Avg Completion Time</h3>
        <div class="value">2.3</div>
        <div class="subtitle">Days</div>
        <div class="ai-insight">🤖 📊 Below target (3 days)</div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Work Order Filters -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1rem;">🔍 Filter Work Orders</h3>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <select id="statusFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Status</option>
            <option value="pending">Pending</option>
            <option value="assigned">Assigned</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
        </select>
        
        <select id="priorityFilter" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px;">
            <option value="">All Priority</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
        </select>
        
        <input type="text" id="searchFilter" placeholder="Search work orders..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; flex-grow: 1; min-width: 200px;">
        
        <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
        <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
    </div>
</div>

<!-- Work Orders List -->
<div class="chatterfix-card">
    <h3 style="margin-bottom: 1.5rem;">📋 All Work Orders</h3>
    
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">
                        <input type="checkbox" id="selectAll" onchange="toggleAllWorkOrders()"> ID
                    </th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Title</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Asset</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Technician</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Status</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Priority</th>
                    <th style="padding: 1rem; text-align: left; font-weight: 600;">Actions</th>
                </tr>
            </thead>
            <tbody id="workOrdersTable">
                {% for wo in work_orders %}
                <tr style="border-bottom: 1px solid var(--border-color); cursor: pointer;" 
                    onclick="viewWorkOrder('{{ wo.id }}')" 
                    data-status="{{ wo.status }}" 
                    data-priority="{{ wo.priority }}">
                    <td style="padding: 1rem;">
                        <input type="checkbox" class="wo-checkbox" value="{{ wo.id }}" onclick="event.stopPropagation()">
                        <strong>WO-{{ wo.id }}</strong>
                    </td>
                    <td style="padding: 1rem;">
                        <strong>{{ wo.title }}</strong>
                        <br><small style="color: var(--text-secondary);">Created: Today</small>
                    </td>
                    <td style="padding: 1rem;">{{ wo.asset_name }}</td>
                    <td style="padding: 1rem;">{{ wo.technician }}</td>
                    <td style="padding: 1rem;">
                        <span class="status-badge status-{{ wo.status|lower|replace(' ', '-') }}">{{ wo.status }}</span>
                    </td>
                    <td style="padding: 1rem;">
                        <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; 
                                     {% if wo.priority == 'high' %}background: var(--error-red); color: white;
                                     {% elif wo.priority == 'medium' %}background: var(--warning-amber); color: white;
                                     {% else %}background: var(--text-secondary); color: white;{% endif %}">
                            {{ wo.priority|upper }}
                        </span>
                    </td>
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); viewWorkOrder('{{ wo.id }}')" class="btn btn-sm btn-primary">View</button>
                            <button onclick="event.stopPropagation(); editWorkOrder('{{ wo.id }}')" class="btn btn-sm btn-warning">Edit</button>
                            {% if wo.status == 'assigned' %}
                            <button onclick="event.stopPropagation(); startWork('{{ wo.id }}')" class="btn btn-sm btn-success">Start</button>
                            {% elif wo.status == 'in_progress' %}
                            <button onclick="event.stopPropagation(); completeWork('{{ wo.id }}')" class="btn btn-sm btn-success">Complete</button>
                            {% endif %}
                            <button onclick="event.stopPropagation(); getAIHelp('{{ wo.id }}')" class="btn btn-sm btn-info">🤖</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Bulk Actions -->
    <div id="bulkActions" style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--border-radius); display: none;">
        <strong>Bulk Actions:</strong>
        <button class="btn btn-sm btn-warning" onclick="bulkAssign()">Assign Selected</button>
        <button class="btn btn-sm btn-success" onclick="bulkComplete()">Mark Complete</button>
        <button class="btn btn-sm btn-info" onclick="bulkExport()">Export Selected</button>
        <button class="btn btn-sm btn-secondary" onclick="bulkDelete()">Delete Selected</button>
    </div>
</div>

<!-- Create Work Order Modal (hidden by default) -->
<div id="createWorkOrderModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: var(--border-radius); max-width: 500px; width: 90%;">
        <h3 style="margin-bottom: 1rem;">Create New Work Order</h3>
        <form id="createWorkOrderForm">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Title:</label>
                <input type="text" id="woTitle" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Description:</label>
                <textarea id="woDescription" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;"></textarea>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Priority:</label>
                <select id="woPriority" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
                    <option value="low">Low</option>
                    <option value="medium" selected>Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Assign to:</label>
                <select id="woAssignee" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px;">
                    <option value="">Select Technician</option>
                    <option value="John Smith">John Smith</option>
                    <option value="Sarah Johnson">Sarah Johnson</option>
                    <option value="Mike Wilson">Mike Wilson</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-success">Create Work Order</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
// Work Orders specific JavaScript
function createWorkOrder() {
    document.getElementById('createWorkOrderModal').style.display = 'flex';
}

function closeCreateModal() {
    document.getElementById('createWorkOrderModal').style.display = 'none';
}

function viewWorkOrder(id) {
    alert(`View Work Order ${id} - Full details view coming soon!`);
}

function editWorkOrder(id) {
    alert(`Edit Work Order ${id} - Edit form coming soon!`);
}

function startWork(id) {
    if (confirm(`Start work on Work Order ${id}?`)) {
        alert(`Work Order ${id} started!`);
        refreshData();
    }
}

function completeWork(id) {
    if (confirm(`Mark Work Order ${id} as complete?`)) {
        alert(`Work Order ${id} completed!`);
        refreshData();
    }
}

async function getAIHelp(id) {
    const response = await sendChatMessage(`Get AI assistance for Work Order ${id}`, 'technician');
}

function toggleAllWorkOrders() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.wo-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    toggleBulkActions();
}

function toggleBulkActions() {
    const checkedBoxes = document.querySelectorAll('.wo-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    bulkActions.style.display = checkedBoxes.length > 0 ? 'block' : 'none';
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#workOrdersTable tr');
    
    rows.forEach(row => {
        const status = row.dataset.status;
        const priority = row.dataset.priority;
        const text = row.textContent.toLowerCase();
        
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesPriority = !priorityFilter || priority === priorityFilter;
        const matchesSearch = !searchFilter || text.includes(searchFilter);
        
        row.style.display = matchesStatus && matchesPriority && matchesSearch ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('priorityFilter').value = '';
    document.getElementById('searchFilter').value = '';
    applyFilters();
}

function bulkAssign() {
    const selected = getSelectedWorkOrders();
    if (selected.length > 0) {
        const technician = prompt('Assign to which technician?');
        if (technician) {
            alert(`Assigned ${selected.length} work orders to ${technician}`);
        }
    }
}

function bulkComplete() {
    const selected = getSelectedWorkOrders();
    if (selected.length > 0 && confirm(`Mark ${selected.length} work orders as complete?`)) {
        alert(`${selected.length} work orders marked as complete`);
        refreshData();
    }
}

function bulkExport() {
    const selected = getSelectedWorkOrders();
    if (selected.length > 0) {
        alert(`Exporting ${selected.length} work orders - Feature coming soon!`);
    }
}

function bulkDelete() {
    const selected = getSelectedWorkOrders();
    if (selected.length > 0 && confirm(`Delete ${selected.length} work orders? This cannot be undone.`)) {
        alert(`${selected.length} work orders deleted`);
        refreshData();
    }
}

function getSelectedWorkOrders() {
    const checkboxes = document.querySelectorAll('.wo-checkbox:checked');
    return Array.from(checkboxes).map(cb => cb.value);
}

// Create work order form submission
document.getElementById('createWorkOrderForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const workOrder = {
        title: document.getElementById('woTitle').value,
        description: document.getElementById('woDescription').value,
        priority: document.getElementById('woPriority').value,
        assigned_to: document.getElementById('woAssignee').value
    };
    
    try {
        const response = await fetch('/api/work-orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(workOrder)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Work order created successfully!');
            closeCreateModal();
            refreshData();
        } else {
            alert('Error creating work order: ' + result.error);
        }
    } catch (error) {
        alert('Network error creating work order');
    }
});

// Add event listeners for checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.wo-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', toggleBulkActions);
    });
});
{% endblock %}