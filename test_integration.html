<!DOCTYPE html>
<html>
<head>
    <title>ü§ñ ChatterFix + Fix It Fred AI - Test Integration</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .header { background: linear-gradient(135deg, #006fee, #4285f4); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px; }
        .chat-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chat-messages { height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; overflow-y: auto; background: #f8f9fa; margin-bottom: 15px; }
        .message { margin: 10px 0; padding: 10px; border-radius: 8px; max-width: 80%; }
        .user-message { background: #007bff; color: white; margin-left: auto; }
        .assistant-message { background: white; border: 1px solid #e9ecef; }
        .input-container { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        .send-btn { padding: 12px 20px; background: linear-gradient(135deg, #006fee, #4285f4); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .send-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 111, 238, 0.3); }
        .status { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 6px; margin-bottom: 15px; }
        .status.error { background: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Fix It Fred AI + ChatterFix CMMS</h1>
            <p>Advanced AI Assistant Integration Test</p>
        </div>
        
        <div id="status" class="status">
            üîÑ Loading Fix It Fred AI integration...
        </div>
        
        <div class="chat-container">
            <h3>üí¨ Chat with Fix It Fred AI</h3>
            <div id="chat-messages" class="chat-messages">
                <div class="message assistant-message">
                    <strong>üîß Fix It Fred:</strong> Hello! I'm your AI maintenance assistant. I can help you with ChatterFix CMMS, equipment troubleshooting, safety protocols, and maintenance planning. What can I help you with today?
                </div>
            </div>
            <div class="input-container">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask about maintenance, equipment, safety, or ChatterFix features..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Fix It Fred AI Integration Class
        class FixItFredAI {
            constructor() {
                this.apiBase = 'http://localhost:8005';
                this.name = 'Fix It Fred';
                this.version = '3.0 Pro';
            }

            async sendMessage(message, context = 'maintenance') {
                try {
                    const response = await fetch(`${this.apiBase}/api/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: message,
                            context: context,
                            provider: 'ollama'
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.response) {
                            return {
                                success: true,
                                response: data.response,
                                provider: data.provider || 'unknown'
                            };
                        }
                    }
                    return { success: false, error: 'API Error' };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
        }

        const fredAI = new FixItFredAI();

        async function testConnection() {
            const statusDiv = document.getElementById('status');
            try {
                const response = await fetch('http://localhost:8005/health');
                const data = await response.json();
                
                if (data.status === 'healthy') {
                    statusDiv.className = 'status';
                    statusDiv.innerHTML = `
                        ‚úÖ <strong>Fix It Fred AI Connected!</strong><br>
                        Service: ${data.service}<br>
                        Ollama Status: ${data.ollama_status}<br>
                        Available Providers: ${Object.entries(data.providers).filter(([k,v]) => v).map(([k,v]) => k).join(', ')}
                    `;
                } else {
                    throw new Error('Service not healthy');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `‚ùå <strong>Connection Error:</strong> ${error.message}<br>Please ensure Fix It Fred AI is running on port 8005`;
            }
        }

        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'assistant-message'}`;
            
            if (isUser) {
                messageDiv.innerHTML = content;
            } else {
                messageDiv.innerHTML = `<strong>üîß Fix It Fred:</strong> ${content}`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addThinkingMessage() {
            const messagesDiv = document.getElementById('chat-messages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant-message';
            thinkingDiv.id = 'thinking-message';
            thinkingDiv.innerHTML = '<strong>ü§ñ Fix It Fred:</strong> <em>Analyzing your question...</em>';
            messagesDiv.appendChild(thinkingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return thinkingDiv;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            addMessage(message, true);
            input.value = '';
            
            // Add thinking indicator
            const thinkingDiv = addThinkingMessage();
            
            try {
                const result = await fredAI.sendMessage(message);
                
                // Remove thinking message
                thinkingDiv.remove();
                
                if (result.success) {
                    let response = result.response;
                    
                    // Add provider info if available
                    if (result.provider) {
                        response += `<br><br><small><em>Powered by ${result.provider}</em></small>`;
                    }
                    
                    addMessage(response);
                } else {
                    addMessage(`Sorry, I encountered an error: ${result.error}. Let me try to help you anyway with my built-in knowledge!`);
                }
            } catch (error) {
                thinkingDiv.remove();
                addMessage(`I'm having trouble connecting right now, but I'm still here to help! Error: ${error.message}`);
            }
        }

        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize
        window.onload = function() {
            testConnection();
        };
    </script>
</body>
</html>